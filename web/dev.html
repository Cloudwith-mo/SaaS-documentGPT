<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocumentGPT - AI Document Summarizer & Free AI Writing Assistant</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Free AI writing assistant and document summarizer. Upload PDF and summarize instantly. Chat with your documents using AI. Get instant insights, smart highlights, and contextual AI chat for research and writing.">
    <meta name="keywords" content="AI document summarizer, AI writing assistant, upload PDF and summarize, chat with your documents, free AI research assistant, PDF to summary AI, AI document analysis tool, contextual chat for documents, document AI, smart document assistant">
    <meta name="author" content="DocumentGPT">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://documentgpt.io/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://documentgpt.io/">
    <meta property="og:title" content="DocumentGPT - AI Document Summarizer & Free AI Writing Assistant">
    <meta property="og:description" content="Free AI writing assistant and document summarizer. Upload PDF and summarize instantly. Chat with your documents using AI.">
    <meta property="og:image" content="https://documentgpt.io/og-image.png">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://documentgpt.io/">
    <meta property="twitter:title" content="DocumentGPT - AI Document Summarizer & Free AI Writing Assistant">
    <meta property="twitter:description" content="Free AI writing assistant and document summarizer. Upload PDF and summarize instantly. Chat with your documents using AI.">
    <meta property="twitter:image" content="https://documentgpt.io/og-image.png">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XXXXXXXXXX');
    </script>
    
    <!-- PostHog Analytics -->
    <script>
    !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    posthog.init('phc_GrNKEAMxwvXlW0U5um2f2ALKuDRrygJAIFloTGsmrtS',{api_host:'https://app.posthog.com', loaded: function(ph) { console.log('PostHog loaded'); }});
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1563.0.min.js"></script>
    <script src="https://unpkg.com/amazon-cognito-identity-js@6.3.12/dist/amazon-cognito-identity.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js" integrity="sha512-0fF/nVZgZxI5OGucs5cjox96D65gis6pZeRAgvIJ5zsxFrqOeCzvY4xXHzkwmo7aXstixkmKuuNHYsYvwdivdw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        /* Phase 1: Visual Ergonomics */
        :root { --emerald: #10b981; --cyan: #06b6d4; --purple: #a855f7; --pink: #ec4899; }
        @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        body { 
            background: linear-gradient(135deg, #ecfdf5, #f0f9ff, #faf5ff, #fef3c7);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            transition: background 0.3s ease;
        }
        
        /* Soft shadows with emerald tint */
        .shadow-soft { box-shadow: 0 4px 16px rgba(16,185,129,0.08), 0 2px 8px rgba(0,0,0,0.04); }
        .shadow-soft-lg { box-shadow: 0 8px 28px rgba(16,185,129,0.12), 0 4px 12px rgba(0,0,0,0.06); }
        
        /* Enhanced hover lift effects */
        button, .btn {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }
        button::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(16,185,129,0.3), rgba(6,182,212,0.3), rgba(168,85,247,0.2)); opacity: 0; transition: opacity 0.4s; }
        button:hover:not(:disabled)::before { opacity: 1; }
        button:hover:not(:disabled), .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(16,185,129,0.15), 0 4px 12px rgba(0,0,0,0.06);
        }
        button:active, .btn:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16,185,129,0.1);
        }
        
        /* Enhanced panel depth with glass morphism */
        aside, main {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px) saturate(150%);
            border: 1px solid rgba(16,185,129,0.1);
            box-shadow: 0 4px 20px rgba(16,185,129,0.06), inset 0 0 40px rgba(255,255,255,0.4);
        }
        
        /* Enhanced editor with glass effect */
        #editorContainer {
            box-shadow: 0 6px 28px rgba(16,185,129,0.1), 0 2px 12px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            border: 1px solid rgba(16,185,129,0.12);
            background: white;
            border-radius: 18px;
        }
        #editorContainer:focus-within {
            box-shadow: 0 12px 40px rgba(16,185,129,0.18), 0 0 0 3px rgba(16,185,129,0.12);
            transform: translateY(-4px);
        }
        
        /* Enhanced input focus */
        input:focus, textarea:focus, select:focus {
            box-shadow: 0 4px 16px rgba(16,185,129,0.12), 0 0 0 3px rgba(16,185,129,0.15);
            outline: none;
            border-color: rgba(16,185,129,0.4);
            transition: all 0.2s ease;
        }
        
        /* Phase 2: Ambient Focus Rings */
        #editor p:focus, #editor div:focus {
            outline: none;
            box-shadow: 0 0 24px rgba(16, 185, 129, 0.12);
            border-radius: 4px;
            transition: box-shadow 0.2s ease;
        }
        
        /* ChatPDF-style layout adjustments */
        body.chatpdf-mode #leftSidebar {
            display: none;
        }
        body.chatpdf-mode #leftSidebar.sidebar-open {
            display: flex;
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 30;
            background: rgba(255, 255, 255, 0.95);
        }
        body.chatpdf-mode main {
            max-width: calc(100% - 24rem);
            margin: 0 auto;
            overflow-y: auto;
        }
        body.chatpdf-mode #docControls,
        body.chatpdf-mode #formatToolbar,
        body.chatpdf-mode #docStatsBar {
            display: none !important;
        }
        body.chatpdf-mode #editor {
            padding: 2rem;
            max-width: 48rem;
            margin: 0 auto;
        }
        body.chatpdf-mode #rightSidebar {
            width: 28rem;
        }
        
        /* Micro-animations for AI actions */
        @keyframes thinkwave {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }
        .ai-thinking {
            background: linear-gradient(270deg, #f0f9ff, #e0f2fe, #f0f9ff);
            background-size: 400% 400%;
            animation: thinkwave 2s ease infinite;
        }
        
        /* Fluid dock animation */
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .dock-enter {
            animation: slideUp 0.3s cubic-bezier(0.23, 1, 0.32, 1);
        }
        
        /* Glow pulse for active elements */
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.15); }
            50% { box-shadow: 0 0 30px rgba(16, 185, 129, 0.25); }
        }
        .active-glow {
            animation: glow 2s ease-in-out infinite;
        }
        
        /* Phase 3: Advanced Features */
        /* Smooth momentum scroll */
        * {
            scroll-behavior: smooth;
        }
        
        /* Chat smooth scrolling */
        #chatMessages {
            scroll-behavior: smooth;
        }
        
        /* Prevent layout shift */
        #chatMessages > div {
            min-height: 40px;
        }
        
        /* Contextual tooltips */
        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-4px);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            animation: tooltipFade 0.2s ease;
            pointer-events: none;
        }
        @keyframes tooltipFade {
            from { opacity: 0; transform: translateX(-50%) translateY(-8px); }
            to { opacity: 1; transform: translateX(-50%) translateY(-4px); }
        }
        
        /* Button press ripple effect */
        button, .btn {
            position: relative;
            overflow: hidden;
        }
        button::after, .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        button:active::after, .btn:active::after {
            width: 200px;
            height: 200px;
        }
        
        /* Progress bar for operations */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, #10b981, #06b6d4);
            z-index: 9999;
            transition: width 0.3s ease;
        }
        
        /* Success state animation */
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(16, 185, 129, 0.4); }
            100% { transform: scale(1); }
        }
        .success-pulse {
            animation: successPulse 0.5s ease;
        }
        
        /* Keyboard shortcuts overlay */
        #shortcutsOverlay {
            backdrop-filter: blur(8px);
        }
        .shortcut-key {
            display: inline-block;
            padding: 4px 8px;
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Global emerald-tinted borders */
        .border, .border-t, .border-b, .border-l, .border-r { border-color: rgba(16,185,129,0.15); }
        
        /* Sidebar collapse */
        #leftSidebar { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #leftSidebar.collapsed { width: 60px; }
        #leftSidebar .sidebar-text { transition: opacity 0.2s ease, transform 0.2s ease; }
        #leftSidebar.collapsed .sidebar-text { opacity: 0; transform: translateX(-10px); display: none; }
        #leftSidebar.collapsed button { justify-content: center; padding-left: 0; padding-right: 0; transition: all 0.2s ease; }
        #leftSidebar.collapsed #logoBtn { padding: 0.5rem; }
        #leftSidebar.collapsed #chatsList { opacity: 0; transform: translateX(-20px); transition: opacity 0.2s ease, transform 0.2s ease; display: none; }
        #leftSidebar.collapsed .chats-header { opacity: 0; transition: opacity 0.2s ease; display: none; }
        #leftSidebar button { transition: all 0.2s ease; }
        #leftSidebar #chatsList { transition: opacity 0.3s ease 0.1s, transform 0.3s ease 0.1s; }
        #leftSidebar .chats-header { transition: opacity 0.3s ease 0.1s; }
        .chat-item:hover .chat-delete { opacity: 1; }
        .chat-item { position: relative; }
        .chat-item:hover { box-shadow: 0 2px 8px rgba(16,185,129,0.1); }
        #leftSidebar button { position: relative; }
        #leftSidebar.collapsed button:hover::after { content: attr(aria-label); position: absolute; left: 100%; top: 50%; transform: translateY(-50%); margin-left: 12px; background: linear-gradient(135deg, rgba(16,185,129,0.95), rgba(6,182,212,0.95)); color: white; padding: 8px 14px; border-radius: 10px; font-size: 11px; font-weight: 500; white-space: nowrap; z-index: 1000; pointer-events: none; box-shadow: 0 6px 16px rgba(16,185,129,0.25), 0 0 24px rgba(6,182,212,0.15); animation: slideIn 0.2s ease; }
        
        /* Phase 4: Polish & Performance */
        /* Offline banner */
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ef4444;
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 12px;
            z-index: 10000;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        
        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Error boundary */
        .error-boundary {
            padding: 40px;
            text-align: center;
            background: #fef2f2;
            border: 2px solid #fca5a5;
            border-radius: 12px;
            margin: 20px;
        }
        
        /* Phase 6: Mobile Responsive */
        @media (max-width: 768px) {
            #leftSidebar { width: 100%; position: fixed; left: -100%; transition: left 0.3s; z-index: 50; }
            #leftSidebar.mobile-open { left: 0; }
            #rightSidebar { width: 100%; }
            #app { flex-direction: column; }
            main { width: 100% !important; }
            #editorContainer { margin: 0 !important; max-width: 100% !important; }
            #tabsContainer { max-width: 200px; }
            #insightsPanel { width: 90vw !important; right: 5vw !important; }
            #insightsBtn { right: 20px !important; }
            .focus-mode #leftSidebar, .focus-mode #rightSidebar { display: none !important; }
        }
        @media (max-width: 1024px) {
            #leftSidebar { width: 200px; }
            #rightSidebar { width: 300px; }
        }
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; }
        }
        
        /* AI Writing Suggestions */
        #aiSuggestionCard {
            position: absolute;
            display: none;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(16,185,129,0.3);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 24px rgba(16,185,129,0.15), 0 0 40px rgba(6,182,212,0.1);
            z-index: 1000;
            max-width: 300px;
        }
        #aiSuggestionCard.visible { display: block; }
        .suggestion-text {
            font-size: 13px;
            color: #374151;
            margin-bottom: 8px;
            line-height: 1.5;
        }
        .suggestion-actions {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
        }
        .suggestion-btn {
            padding: 4px 10px;
            font-size: 11px;
            border-radius: 6px;
            border: 1px solid rgba(16,185,129,0.3);
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .suggestion-btn:hover {
            background: #f0fdf4;
            border-color: #10b981;
        }
        .suggestion-btn.accept {
            background: linear-gradient(135deg, #10b981, #06b6d4);
            color: white;
            border: none;
        }
        .prediction-text {
            color: #9ca3af;
            font-style: italic;
            opacity: 0.6;
        }
        
        /* Dark mode */
        body[data-theme="dark"] { background: linear-gradient(to bottom, #0f172a, #1e293b); color: #e2e8f0; }
        body[data-theme="dark"] aside, body[data-theme="dark"] main { background: rgba(30, 41, 59, 0.9); border-color: #334155; }
        body[data-theme="dark"] .bg-white { background: #1e293b !important; }
        body[data-theme="dark"] #editor, body[data-theme="dark"] #chatMessages { background: #1e293b; color: #e2e8f0; }
        body[data-theme="dark"] .border { border-color: #334155; }
        body[data-theme="dark"] input, body[data-theme="dark"] textarea, body[data-theme="dark"] select { background: #334155; color: #e2e8f0; border-color: #475569; }
        body[data-theme="dark"] .bg-emerald-50 { background: #064e3b !important; }
        body[data-theme="dark"] .bg-blue-50 { background: #1e3a8a !important; }
        .tab-active { background: linear-gradient(to right, #ecfdf5, #f0f9ff) !important; color: #059669 !important; border-color: #6ee7b7 !important; font-weight: 600 !important; }
        #editor u { text-decoration: underline !important; }
        #editor strong, #editor b { font-weight: 900 !important; color: inherit !important; }
        #editor[contenteditable="false"] { background: #e5e5e5; cursor: default; padding: 40px 20px; }
        #pdfMenu { width: 200px; background: #f5f5f5; border-right: 1px solid #ddd; overflow-y: auto; }
        .pdf-thumb { cursor: pointer; padding: 8px; border: 2px solid transparent; margin: 8px; background: white; }
        .pdf-thumb:hover { border-color: #10b981; }
        .pdf-thumb.active { border-color: #10b981; background: #f0fdf4; }
        #editor em, #editor i { font-style: italic !important; color: inherit !important; }
        #editor ul { list-style: disc !important; margin-left: 20px; color: #000 !important; }
        #editor ol { list-style: decimal !important; margin-left: 20px; color: #000 !important; }
        #editor li { margin: 4px 0; color: #000 !important; display: list-item !important; }
        .focus-mode #leftSidebar, .focus-mode #rightSidebar { display: none !important; }
        .loading-dots { animation: blink 1.4s infinite; }
        .loading-dots:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0%, 60%, 100% { opacity: 0.3; } 30% { opacity: 1; } }
        
        .chat-loading{display:flex;align-items:center;gap:8px;padding:12px 16px;border-radius:16px;background:linear-gradient(135deg,rgba(16,185,129,0.08),rgba(6,182,212,0.08));border:1px solid rgba(16,185,129,0.2)}
        .typing-indicator{display:flex;gap:4px}
        .typing-dot{width:8px;height:8px;border-radius:50%;background:linear-gradient(135deg,#10b981,#06b6d4);animation:typingBounce 1.4s infinite ease-in-out}
        .typing-dot:nth-child(1){animation-delay:0s}
        .typing-dot:nth-child(2){animation-delay:0.2s}
        .typing-dot:nth-child(3){animation-delay:0.4s}
        @keyframes typingBounce{0%,60%,100%{transform:translateY(0);opacity:0.4}30%{transform:translateY(-10px);opacity:1}}
        .ai-thinking-text{font-size:12px;color:#10b981;font-weight:600;animation:fadeInOut 2s infinite}
        @keyframes fadeInOut{0%,100%{opacity:0.5}50%{opacity:1}}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.6}}
        
        /* Transparent loading overlay */
        #loadingScreen {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }
        .loading-character {
            font-size: 80px;
            animation: bounce 1s ease-in-out infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        .loading-text {
            font-size: 18px;
            font-weight: 600;
            color: white;
            background: rgba(16, 185, 129, 0.9);
            padding: 12px 24px;
            border-radius: 12px;
        }
        
        /* Lumina UX Features */
        .lumina-active-block { position: relative; z-index: 0; border-radius: 12px; }
        .lumina-active-block::after { content: ''; position: absolute; inset: -6px -10px; border-radius: 14px; background: radial-gradient(60% 80% at 50% 50%, rgba(16,185,129,0.12), transparent 70%); z-index: -1; opacity: 0.7; pointer-events: none; transition: opacity 0.2s ease; }
        #luminaHUD { display: none; }
        #luminaHUD button { background: #fff; border: 1px solid rgba(16,185,129,0.15); border-radius: 10px; padding: 8px 10px; font-weight: 600; color: #0b1220; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        #luminaHUD button:hover { background: #f0fdf4; }
        #luminaDock { position: fixed; left: 50%; bottom: 60px; transform: translateX(-50%) scale(0.98); opacity: 0; display: flex; gap: 12px; padding: 12px 16px; border-radius: 24px; background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(240,253,244,0.12)); border: 1px solid rgba(16,185,129,0.12); box-shadow: 0 4px 20px rgba(16,185,129,0.06), 0 0 40px rgba(6,182,212,0.04), inset 0 0 30px rgba(255,255,255,0.15); backdrop-filter: blur(24px) saturate(140%); transition: opacity 0.18s ease, transform 0.18s ease; z-index: 90; }
        #luminaDock.visible { opacity: 1; transform: translateX(-50%) scale(1); }
        #luminaDock button { padding: 10px 14px; border-radius: 16px; border: 1px solid rgba(16,185,129,0.12); background: rgba(255,255,255,0.2); box-shadow: 0 2px 6px rgba(16,185,129,0.04), inset 0 0 15px rgba(255,255,255,0.2); font-weight: 600; backdrop-filter: blur(8px); transition: all 0.2s ease; }
        #luminaDock button:hover { background: rgba(240,253,244,0.4); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(16,185,129,0.08); }
        #thinkingPulse { position: fixed; inset: 0; pointer-events: none; z-index: 80; opacity: 0; transition: opacity 0.25s ease; }
        #thinkingPulse.thinking { opacity: 1; }
        #thinkingPulse::after { content: ''; position: absolute; inset: 0; background: radial-gradient(60% 40% at 50% 40%, rgba(16,185,129,0.1), transparent 70%); animation: luminaPulse 1.8s ease-in-out infinite; }
        @keyframes luminaPulse { 0%, 100% { filter: blur(14px); opacity: 0.55; } 50% { filter: blur(22px); opacity: 0.85; } }
        #focusHorizon { position: absolute; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, rgba(16,185,129,0.35), transparent); pointer-events: none; opacity: 0.6; transform: translateY(0); z-index: 1; }
        
        /* Lightning Button Glow Animation */
        @keyframes lightningGlow {
            0%, 100% { box-shadow: 0 0 30px rgba(16,185,129,0.6), 0 0 60px rgba(6,182,212,0.4), 0 8px 32px rgba(0,0,0,0.2), inset 0 0 20px rgba(255,255,255,0.3); }
            50% { box-shadow: 0 0 40px rgba(16,185,129,0.8), 0 0 80px rgba(6,182,212,0.6), 0 8px 32px rgba(0,0,0,0.2), inset 0 0 30px rgba(255,255,255,0.4); }
        }
        #insightsBtn.dimmed {
            opacity: 0.4;
            animation: none;
            box-shadow: 0 0 10px rgba(16,185,129,0.3), 0 4px 12px rgba(0,0,0,0.1);
        }
        
        /* AI Co-Editor */
        .suggestion-card {
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(16,185,129,0.2);
            background: rgba(255,255,255,0.8);
            margin-bottom: 12px;
        }
        .suggestion-card.grammar { border-color: rgba(239,68,68,0.3); background: rgba(254,242,242,0.5); }
        .suggestion-card.style { border-color: rgba(59,130,246,0.3); background: rgba(239,246,255,0.5); }
        .suggestion-card.clarity { border-color: rgba(251,191,36,0.3); background: rgba(254,252,232,0.5); }
        .suggestion-type {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 4px;
            opacity: 0.7;
        }
        .suggestion-text {
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        .suggestion-actions {
            display: flex;
            gap: 6px;
        }
        .suggestion-actions button {
            flex: 1;
            padding: 6px 12px;
            font-size: 11px;
            border-radius: 8px;
            border: 1px solid rgba(16,185,129,0.3);
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .suggestion-actions button:hover { background: #f0fdf4; }
        .suggestion-actions button.primary {
            background: linear-gradient(135deg, #10b981, #06b6d4);
            color: white;
            border: none;
        }
        
        /* R1: Enhanced Smart Highlights */
        .highlight-yellow{background:linear-gradient(120deg,#fef3c7 0%,#fde68a 100%);padding:2px 4px;border-radius:3px;cursor:pointer}
        .highlight-blue{background:linear-gradient(120deg,#dbeafe 0%,#bfdbfe 100%);padding:2px 4px;border-radius:3px;cursor:pointer}
        .highlight-green{background:linear-gradient(120deg,#d1fae5 0%,#a7f3d0 100%);padding:2px 4px;border-radius:3px;cursor:pointer}
        .highlight-red{background:linear-gradient(120deg,#fecaca 0%,#fca5a5 100%);padding:2px 4px;border-radius:3px;cursor:pointer}
        .highlight-purple{background:linear-gradient(120deg,#e9d5ff 0%,#d8b4fe 100%);padding:2px 4px;border-radius:3px;cursor:pointer}
        #selectionToolbar{position:absolute;display:none;background:rgba(255,255,255,0.98);backdrop-filter:blur(20px);border:1px solid rgba(16,185,129,0.25);border-radius:12px;padding:8px;box-shadow:0 8px 28px rgba(16,185,129,0.2);z-index:1001;gap:4px}
        #selectionToolbar.visible{display:flex}
        #selectionToolbar button{padding:6px 10px;border-radius:8px;border:1px solid rgba(16,185,129,0.2);background:white;font-size:11px;font-weight:600;cursor:pointer;transition:all 0.2s}
        #selectionToolbar button:hover{background:#f0fdf4;transform:translateY(-1px)}

        .legend-item{padding:10px 12px;border-bottom:1px solid rgba(16,185,129,0.1);cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:8px}
        .legend-item:hover{background:rgba(16,185,129,0.05)}
        .legend-color{width:20px;height:20px;border-radius:4px;flex-shrink:0}
        .legend-text{flex:1;font-size:12px;line-height:1.4}
        .legend-actions{display:flex;gap:4px}
        .legend-actions button{padding:2px 6px;font-size:10px;border-radius:4px;border:1px solid rgba(16,185,129,0.3);background:white;cursor:pointer}
        .legend-actions button:hover{background:#f0fdf4}
        
        /* Autocomplete Ghost Text */
        .ghost-text{color:#9ca3af;opacity:0.5;pointer-events:none;user-select:none;}
        /* Knowledge Graph UI */
        .entity-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 9999px;
            border: 1px solid rgba(16,185,129,0.2);
            background: rgba(16,185,129,0.08);
            color: #047857;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }
        .entity-chip[data-source="global"] {
            background: rgba(6,182,212,0.08);
            color: #0e7490;
            border-color: rgba(6,182,212,0.2);
        }
        .entity-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 14px rgba(16,185,129,0.12);
        }
        .entity-chip[data-source="global"]:hover {
            box-shadow: 0 6px 14px rgba(6,182,212,0.12);
        }
        .entity-spark {
            width: 6px;
            height: 6px;
            border-radius: 9999px;
            background: currentColor;
            opacity: 0.5;
        }
        .entity-inline {
            background: linear-gradient(120deg, rgba(16,185,129,0.12), rgba(6,182,212,0.1));
            border-radius: 6px;
            padding: 0 4px;
            cursor: pointer;
            transition: background 0.15s ease, box-shadow 0.15s ease;
            border-bottom: 1px dotted rgba(16,185,129,0.4);
        }
        .entity-inline:hover {
            background: linear-gradient(120deg, rgba(16,185,129,0.2), rgba(6,182,212,0.18));
            box-shadow: 0 0 0 2px rgba(16,185,129,0.1);
        }
        #entityHoverCard {
            position: fixed;
            pointer-events: none;
            z-index: 200;
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(18px);
            border: 1px solid rgba(16,185,129,0.15);
            box-shadow: 0 12px 34px rgba(15,118,110,0.16);
            border-radius: 14px;
            padding: 10px 12px;
            font-size: 11px;
            color: #065f46;
            min-width: 180px;
            max-width: 260px;
            opacity: 0;
            transform: translateY(4px);
            transition: opacity 0.15s ease, transform 0.15s ease;
        }
        #entityHoverCard.visible {
            opacity: 1;
            transform: translateY(0);
        }
        #entityDetailPanel .entity-doc-link {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid rgba(16,185,129,0.15);
            background: rgba(255,255,255,0.92);
            font-size: 12px;
            cursor: pointer;
            transition: border 0.2s ease, transform 0.2s ease;
        }
        #entityDetailPanel .entity-doc-link:hover {
            border-color: rgba(16,185,129,0.4);
            transform: translateY(-1px);
        }
        .graph-pill {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(16,185,129,0.15);
            color: #047857;
        }
        .kg-node-faded circle {
            fill-opacity: 0.2 !important;
            stroke-opacity: 0.2 !important;
        }
        .kg-node-faded text {
            opacity: 0.35 !important;
        }
        #knowledgeGraphOverlay {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 200;
        }
        #knowledgeGraphOverlay.active {
            display: block;
        }
        #knowledgeGraphOverlay .overlay-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            backdrop-filter: blur(8px);
        }
        #knowledgeGraphOverlay .overlay-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(900px, 88vw);
            height: min(620px, 80vh);
            background: rgba(255,255,255,0.96);
            border-radius: 20px;
            border: 1px solid rgba(16,185,129,0.25);
            box-shadow: 0 20px 60px rgba(15,118,110,0.22);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #knowledgeGraphOverlayHeader {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(16,185,129,0.18);
            background: linear-gradient(120deg, rgba(16,185,129,0.12), rgba(6,182,212,0.12));
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        #knowledgeGraphSvg {
            flex: 1;
            width: 100%;
        }
        #knowledgeGraphOverlayFooter {
            padding: 12px 20px;
            border-top: 1px solid rgba(16,185,129,0.1);
            background: rgba(250, 253, 250, 0.9);
            font-size: 11px;
            color: #047857;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        #knowledgeGraphOverlayFooter .legend {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #knowledgeGraphOverlayFooter .legend span {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        #knowledgeGraphOverlayFooter .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
        }
    </style>
</head>
<body data-theme="light" class="h-screen w-full font-sans">
    <!-- Loading Skeleton -->
    <div id="appSkeleton" class="flex h-screen w-full overflow-hidden">
        <div class="w-60 border-r bg-white/90 backdrop-blur p-3 space-y-3">
            <div class="h-8 bg-gray-200 rounded-lg animate-pulse"></div>
            <div class="h-10 bg-emerald-100 rounded-xl animate-pulse"></div>
            <div class="h-10 bg-gray-100 rounded-xl animate-pulse"></div>
            <div class="space-y-2 mt-4">
                <div class="h-6 bg-gray-200 rounded animate-pulse"></div>
                <div class="h-6 bg-gray-200 rounded animate-pulse"></div>
                <div class="h-6 bg-gray-200 rounded animate-pulse"></div>
            </div>
        </div>
        <div class="flex-1 flex flex-col">
            <div class="h-12 border-b bg-white/90 backdrop-blur flex items-center gap-2 px-3">
                <div class="h-6 w-24 bg-gray-200 rounded animate-pulse"></div>
                <div class="h-6 w-24 bg-gray-200 rounded animate-pulse"></div>
            </div>
            <div class="flex-1 p-4">
                <div class="h-full bg-white rounded-2xl border p-6 space-y-3">
                    <div class="h-4 bg-gray-200 rounded animate-pulse"></div>
                    <div class="h-4 bg-gray-200 rounded animate-pulse w-5/6"></div>
                    <div class="h-4 bg-gray-200 rounded animate-pulse w-4/6"></div>
                </div>
            </div>
        </div>
        <div class="w-96 border-l bg-white/90 backdrop-blur p-3 space-y-3">
            <div class="h-8 bg-gray-200 rounded-lg animate-pulse"></div>
            <div class="flex-1 space-y-2">
                <div class="h-16 bg-emerald-50 rounded-2xl animate-pulse"></div>
                <div class="h-16 bg-gray-100 rounded-2xl animate-pulse"></div>
            </div>
        </div>
    </div>
    
    <!-- Real App (hidden until loaded) -->
    <div id="app" class="flex h-screen w-full overflow-hidden" style="display: none;">
    
    <!-- Transparent Loading Overlay -->
    <div id="loadingScreen">
        <div class="loading-character">🧙‍♂️</div>
        <div class="loading-text" id="loadingText">Processing your document...</div>
    </div>
        <aside id="leftSidebar" class="w-60 border-r flex flex-col transition-all duration-300">
            <div class="p-3 flex items-center justify-between">
                <button id="logoBtn" class="flex items-center gap-2 hover:bg-gray-100 rounded-lg px-2 py-1.5 transition" aria-label="DocumentGPT Home">
                    <span class="text-2xl sidebar-icon">📄</span>
                    <span class="text-sm font-semibold text-emerald-600 sidebar-text">DocumentGPT</span>
                </button>
                <button id="toggleSidebarBtn" class="p-2 hover:bg-gray-100 rounded-lg sidebar-text" aria-label="Toggle sidebar"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
            <div class="px-3 pb-3 space-y-2">
                <button id="newBtn" class="w-full flex items-center gap-3 rounded-xl border-2 border-emerald-200 bg-gradient-to-r from-emerald-100 to-cyan-100 px-3 py-2.5 text-sm font-semibold text-emerald-700 hover:from-emerald-200 hover:to-cyan-200 transition" aria-label="Create new chat" style="box-shadow: 0 4px 12px rgba(16,185,129,0.15);">
                    <svg class="w-5 h-5 sidebar-icon text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <span class="sidebar-text">New chat</span>
                </button>
                <button id="uploadBtn" class="w-full flex items-center gap-3 rounded-xl border border-emerald-300 px-3 py-2.5 text-sm font-semibold text-emerald-700 hover:bg-emerald-50 transition" aria-label="Upload document">
                    <svg class="w-5 h-5 sidebar-icon text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <span class="sidebar-text">Upload PDF</span>
                </button>
            </div>
            <div class="px-3 pt-2 pb-1 flex items-center justify-between chats-header">
                <span class="text-xs uppercase opacity-60 font-semibold">Folders</span>
                <button id="newFolderBtn" class="text-xs px-1.5 py-0.5 rounded hover:bg-emerald-50 text-emerald-600" title="New folder">+</button>
            </div>
            <div id="foldersList" class="px-2 pb-2 space-y-1"></div>
            <div class="px-3 pt-2 pb-1 text-xs uppercase opacity-60 font-semibold chats-header">Documents</div>
            <div id="chatsList" class="px-2 pb-2 space-y-1 flex-1 overflow-auto"></div>
            <div class="border-t p-3 space-y-1 mt-auto">
                <button id="upgradeBtn" class="w-full hidden items-center gap-2 px-3 py-2.5 rounded-lg bg-gradient-to-r from-emerald-500 to-cyan-500 text-white hover:opacity-90 transition text-sm font-semibold" aria-label="Upgrade" style="display: none;">
                    <span class="sidebar-text">⚡ Upgrade</span>
                </button>
                <button id="searchBtn" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-emerald-50 transition text-sm text-gray-700" aria-label="Search">
                    <svg class="w-5 h-5 sidebar-icon text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <span class="sidebar-text">Search</span>
                </button>
                <button id="libraryBtn" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-emerald-50 transition text-sm text-gray-700" aria-label="Library">
                    <svg class="w-5 h-5 sidebar-icon text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path>
                    </svg>
                    <span class="sidebar-text">Library</span>
                </button>
                <div class="pt-2 border-t border-emerald-100 space-y-2">
                    <button id="loginBtn" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-emerald-50 transition text-sm text-gray-700" aria-label="Login">
                        <svg class="w-5 h-5 sidebar-icon text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span class="sidebar-text">Login</span>
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col">
            <div id="docControls" class="flex items-center gap-2 px-3 py-2 border-b" style="background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(6,182,212,0.08)); backdrop-filter: blur(20px); border-color: rgba(16,185,129,0.15);">
                <div id="tabsContainer" class="flex items-center gap-1 overflow-x-auto flex-1"></div>
                <button id="addTabBtn" class="text-xs px-2 py-1 rounded-full border hover:shadow-sm">+</button>
                <div class="flex items-center gap-2 border rounded-xl px-2 py-1 text-xs">
                    <input id="findInput" placeholder="Find..." class="bg-transparent outline-none w-32" autocomplete="off" />
                    <button id="findBtn" class="text-emerald-500">🔍</button>
                </div>
                <div class="flex items-center gap-1 text-xs">
                    <button id="zoomOut" class="px-2 py-1 rounded-lg border">−</button>
                    <div id="zoomLabel" class="w-10 text-center">100%</div>
                    <button id="zoomIn" class="px-2 py-1 rounded-lg border">+</button>
                </div>
                <div class="relative" style="z-index: 10000;">
                    <button id="moreBtn" class="text-xs px-2 py-1 rounded-lg border" data-tooltip="More options">⋯</button>
                    <div id="moreMenu" class="hidden absolute right-0 top-full mt-1 bg-white border rounded-xl shadow-lg p-2 w-48" style="backdrop-filter: blur(16px); background: rgba(255,255,255,0.95); border-color: rgba(16,185,129,0.2);">
                        <button id="focusBtnMenu" class="w-full text-left px-3 py-2 rounded-lg hover:bg-emerald-50 text-sm flex items-center gap-2"><span>👁️</span> Focus Mode</button>
                        <button id="highlightLegendBtn" class="w-full text-left px-3 py-2 rounded-lg hover:bg-emerald-50 text-sm flex items-center gap-2"><span>🎨</span> Highlights</button>
                        <button id="historyBtn" class="w-full text-left px-3 py-2 rounded-lg hover:bg-emerald-50 text-sm flex items-center gap-2"><span>🕐</span> Version History</button>
                        <button id="coachBtn" class="w-full text-left px-3 py-2 rounded-lg hover:bg-emerald-50 text-sm flex items-center gap-2"><span>🎓</span> Writing Coach</button>
                        <button id="themeBtn" class="w-full text-left px-3 py-2 rounded-lg hover:bg-emerald-50 text-sm flex items-center gap-2"><span id="themeIcon">🌞</span> Toggle Theme</button>
                        <button id="settingsBtn" class="w-full text-left px-3 py-2 rounded-lg hover:bg-emerald-50 text-sm flex items-center gap-2"><span>⚙️</span> Settings</button>
                <button id="autocompleteSettingsBtn" class="w-full text-left px-3 py-2 rounded-lg hover:bg-emerald-50 text-sm flex items-center gap-2"><span>✨</span> Autocomplete</button>
                    </div>
                </div>
            </div>
            <div class="flex-1 overflow-auto p-4 flex">
                <div id="pdfMenu" style="display: none;"></div>
                <div class="h-full flex-1">
                    <div id="editorContainer" class="h-full flex flex-col rounded-2xl border shadow-sm bg-white" style="transform-origin: top center;">
                        <div id="formatToolbar" class="px-3 py-2 border-b flex items-center gap-1 flex-wrap" style="background: linear-gradient(135deg, rgba(16,185,129,0.05), rgba(6,182,212,0.05)); border-color: rgba(16,185,129,0.1);">
                            <button id="boldBtn" class="p-1.5 hover:bg-gray-100 rounded" title="Bold (Ctrl+B)"><strong>B</strong></button>
                            <button id="italicBtn" class="p-1.5 hover:bg-gray-100 rounded" title="Italic (Ctrl+I)"><em>I</em></button>
                            <button id="underlineBtn" class="p-1.5 hover:bg-gray-100 rounded" title="Underline (Ctrl+U)"><u>U</u></button>
                            <div class="w-px h-6 bg-gray-300 mx-1"></div>
                            <select id="fontSizeSelect" class="text-xs border rounded px-2 py-1">
                                <option value="">Size</option>
                                <option value="1">Small</option>
                                <option value="3">Normal</option>
                                <option value="5">Large</option>
                            </select>
                            <div class="w-px h-6 bg-gray-300 mx-1"></div>
                            <button id="bulletBtn" class="p-1.5 hover:bg-gray-100 rounded" title="Bullet List">•</button>
                            <button id="numberBtn" class="p-1.5 hover:bg-gray-100 rounded" title="Numbered List">1.</button>
                            <button id="indentBtn" class="p-1.5 hover:bg-gray-100 rounded" title="Indent">→</button>
                            <button id="outdentBtn" class="p-1.5 hover:bg-gray-100 rounded" title="Outdent">←</button>
                            <div class="w-px h-6 bg-gray-300 mx-1"></div>
                            <button id="alignLeftBtn" class="p-1.5 hover:bg-gray-100 rounded" title="Align Left">⫷</button>
                            <button id="alignCenterBtn" class="p-1.5 hover:bg-gray-100 rounded" title="Align Center">⫸</button>
                            <button id="alignRightBtn" class="p-1.5 hover:bg-gray-100 rounded" title="Align Right">⫸</button>
                            <div class="flex-1"></div>
                            <button id="toneBtn" class="px-3 py-1 text-xs hover:bg-emerald-50 rounded-lg border border-emerald-300 text-emerald-600 font-semibold" title="Adjust Tone">✨ Tone</button>
                        </div>
                        <div id="docEntityChipBar" class="px-6 py-2 border-t border-b border-emerald-100/60 bg-emerald-50/30 hidden">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-[11px] uppercase tracking-wide text-emerald-700 font-semibold">Knowledge Graph</div>
                                <button id="refreshDocEntitiesBtn" class="text-[11px] px-2 py-0.5 rounded-full border border-emerald-200 text-emerald-600 hover:bg-emerald-50">
                                    ↻ Refresh
                                </button>
                            </div>
                            <div id="docEntityChipList" class="flex flex-wrap gap-2"></div>
                            <div id="docEntityEmpty" class="text-xs text-gray-500 hidden">
                                No entities detected yet. Add more detail or refresh after saving.
                            </div>
                        </div>
                        <div id="editor" contenteditable="true" class="flex-1 overflow-auto px-6 py-4 text-base leading-7 outline-none"></div>
                        <div id="docStatsBar" class="px-4 py-2 border-t flex gap-4 text-xs opacity-60" style="background: linear-gradient(135deg, rgba(16,185,129,0.03), rgba(6,182,212,0.03)); border-color: rgba(16,185,129,0.1);">
                            <span>Words: <b id="wordCount">0</b>/<b id="dailyGoal">500</b></span>
                            <span id="streakDisplay" class="cursor-pointer" onclick="showStreakModal()" title="Click for details">🔥 <b id="streakCount">0</b> day</span>
                            <span>DocIQ: <b id="docIQ" class="text-emerald-600">--</b> <span id="docIQBadge" class="text-xs"></span></span>
                            <span>Mode: <b id="modeLabel" class="text-cyan-600">Research</b></span>
                            <div class="ml-auto flex items-center gap-3">
                                <span>Clarity: <b id="clarityPct">--</b>%</span>
                                <span>Complete: <b id="completePct">--</b>%</span>
                                <span>Actionable: <b id="actionPct">--</b>%</span>
                                <button id="docIQTips" class="text-emerald-600 underline">Tips</button>
                                <span class="text-emerald-500" id="saveStatus">Saved</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <aside id="rightSidebar" class="w-96 border-l flex flex-col">
            <div class="px-3 py-2 border-b flex items-center justify-between">
                <div class="text-sm font-medium">Assistant</div>
                <div class="flex items-center gap-2">
                    <button id="focusBtn" class="text-xs px-2 py-1 rounded-lg border hover:bg-gray-50" data-tooltip="Focus Mode" title="Focus Mode">👁️</button>
                    <button id="modeToggle" class="text-xs px-2 py-1 rounded-lg border border-cyan-500 text-cyan-500 hover:bg-cyan-50" title="Toggle mode">📊 Research</button>
                </div>
            </div>
            <div id="knowledgeGraphSidebar" class="px-3 py-3 border-b hidden" style="background: rgba(236, 253, 245, 0.55);">
                <div class="flex items-center justify-between">
                    <span class="text-[11px] uppercase tracking-wide text-emerald-700 font-semibold">Knowledge Graph</span>
                    <div class="flex items-center gap-2">
                        <button id="refreshKnowledgeGraphBtn" class="text-[11px] px-2 py-0.5 rounded-full border border-emerald-200 text-emerald-600 hover:bg-emerald-50">↻</button>
                        <button id="collapseKGBtn" class="text-[11px] px-2 py-0.5 rounded-full border border-emerald-200 text-emerald-600 hover:bg-emerald-50" data-state="open">Hide</button>
                    </div>
                </div>
                <div id="knowledgeGraphBody" class="space-y-3 mt-3">
                    <div>
                        <div class="text-[11px] font-semibold text-emerald-600 mb-1">Top entities</div>
                        <div id="userEntityChips" class="flex flex-wrap gap-2"></div>
                        <div id="knowledgeGraphEmpty" class="text-xs text-gray-500 mt-1 hidden">No entities yet. Keep writing or refresh.</div>
                    </div>
                    <div id="knowledgeGraphActions" class="flex items-center justify-between text-[11px]">
                        <button id="openGraphViewBtn" class="px-2 py-1 rounded-full border border-emerald-200 text-emerald-600 hover:bg-emerald-50">Graph View</button>
                        <span class="text-gray-400 text-[10px]" id="knowledgeGraphMeta"></span>
                    </div>
                    <div id="entityDetailPanel" class="hidden space-y-2 rounded-xl border border-emerald-200/60 bg-white/90 p-3 shadow-inner">
                        <div class="flex items-start justify-between gap-2">
                            <div>
                                <div id="entityDetailName" class="text-sm font-semibold text-emerald-700"></div>
                                <div id="entityDetailMeta" class="text-[11px] text-gray-500"></div>
                            </div>
                            <button id="closeEntityDetail" class="text-[11px] px-2 py-0.5 rounded-full border border-emerald-200 text-emerald-600 hover:bg-emerald-50">✕</button>
                        </div>
                        <div id="entityDetailMentions" class="text-[11px] text-gray-600 leading-relaxed"></div>
                        <div>
                            <div class="text-[11px] font-semibold text-emerald-600 mb-1">Appears in</div>
                            <div id="entityDetailDocs" class="space-y-2"></div>
                        </div>
                        <div id="entityWikiActions" class="flex items-center justify-between text-[11px] hidden">
                            <div class="text-gray-500">Build knowledge wiki from this entity.</div>
                            <div class="flex items-center gap-2">
                                <button id="openEntityWikiBtn" class="px-2 py-0.5 rounded-full border border-emerald-200 text-emerald-600 hover:bg-emerald-50">Open Wiki</button>
                                <button id="refreshEntityWikiBtn" class="px-2 py-0.5 rounded-full border border-emerald-200 text-emerald-600 hover:bg-emerald-50">↻</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="chatMessages" class="flex-1 overflow-auto p-3 space-y-2">
                <div class="text-sm p-3 rounded-2xl border bg-emerald-50">
                    I'm here to help you write better or analyze documents. Start typing or upload a file!
                </div>
            </div>

            <div class="p-3 flex gap-2">
                <div class="relative">
                    <button id="agentsBtn" class="rounded-xl px-3 py-3 border hover:bg-gray-50" title="AI Agents" aria-label="Open AI agents menu" aria-expanded="false">+</button>
                    <div id="agentsMenu" class="hidden absolute bottom-full left-0 mb-2 bg-white border rounded-xl shadow-lg p-2 w-40">
                        <button onclick="runAgent('summary')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-50 text-sm">📝 Summary</button>
                        <button onclick="runAgent('email')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-50 text-sm">📧 Email</button>
                        <button onclick="runAgent('sheets')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-50 text-sm">📊 Sheets</button>
                        <button onclick="runAgent('calendar')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-50 text-sm">📅 Calendar</button>
                        <button onclick="runAgent('save')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-50 text-sm">💾 Save</button>
                        <button onclick="runAgent('export')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-50 text-sm">📤 Export</button>
                    </div>
                </div>
                <textarea id="chatInput" rows="2" placeholder="Ask anything..." class="flex-1 rounded-xl border p-3 text-sm resize-none"></textarea>
                <button id="micBtn" class="rounded-xl px-3 py-3 border" title="Voice input" aria-label="Voice input">🎙️</button>
                <button id="sendBtn" class="rounded-xl px-4 py-3 bg-emerald-500 text-white hover:bg-emerald-600" aria-label="Send message">➤</button>
            </div>
        </aside>
    </div>

    <div id="palette" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden items-center justify-center" style="z-index: 100;">
        <div class="bg-white rounded-2xl shadow-2xl w-[600px] max-h-[500px] flex flex-col">
            <div class="px-4 py-3 border-b flex items-center justify-between">
                <span class="text-sm font-semibold">Command Palette</span>
                <button onclick="hideModal('palette')" class="text-2xl opacity-50 hover:opacity-100">&times;</button>
            </div>
            <input id="paletteInput" placeholder="Type a command..." class="w-full px-4 py-3 border-b outline-none" />
            <div id="paletteItems" class="overflow-auto p-2">
                <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 text-sm" data-cmd="new">📄 New document</button>
                <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 text-sm" data-cmd="upload">📤 Upload file</button>
                <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 text-sm" data-cmd="summary">📝 Summarize</button>
                <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 text-sm" data-cmd="sheets">📊 Extract to CSV</button>
                <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 text-sm" data-cmd="email">📧 Send Email</button>
                <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 text-sm" data-cmd="export">📤 Export Document</button>
                <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 text-sm" data-cmd="theme">🌓 Toggle Theme</button>
                <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 text-sm" data-cmd="focus">👁️ Toggle Focus</button>
            </div>
        </div>
    </div>

    <div id="upgradeModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden items-center justify-center" style="z-index: 100;">
        <div class="bg-white rounded-2xl shadow-2xl w-[700px] p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Choose Your Plan</h2>
                <button id="closeUpgrade" class="text-2xl opacity-50 hover:opacity-100">×</button>
            </div>
            <div id="upgradeError" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700"></div>
            <div class="grid grid-cols-2 gap-4">
                <div class="border-2 border-emerald-500 rounded-xl p-4 relative">
                    <div class="absolute -top-2 left-1/2 -translate-x-1/2 bg-emerald-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">POPULAR</div>
                    <div class="text-xs uppercase text-emerald-600 font-semibold mb-2">Monthly</div>
                    <div class="text-2xl font-bold mb-1">$14.99<span class="text-sm text-gray-500">/mo</span></div>
                    <div class="text-xs text-gray-500 mb-4">Billed monthly</div>
                    <div class="space-y-2 text-xs mb-4">
                        <div>✓ Unlimited chats</div>
                        <div>✓ Unlimited documents</div>
                        <div>✓ All 6 AI agents</div>
                        <div>✓ Priority support</div>
                    </div>
                    <button class="selectPlan w-full text-xs px-3 py-2 rounded-lg bg-gradient-to-r from-emerald-500 to-cyan-500 text-white hover:opacity-90 font-semibold" data-plan="monthly">Get Monthly</button>
                </div>
                <div class="border-2 border-purple-500 rounded-xl p-4 relative">
                    <div class="absolute -top-2 left-1/2 -translate-x-1/2 bg-purple-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">SAVE 60%</div>
                    <div class="text-xs uppercase text-purple-600 font-semibold mb-2">Annual</div>
                    <div class="text-2xl font-bold mb-1">$5.99<span class="text-sm text-gray-500">/mo</span></div>
                    <div class="text-xs text-gray-500 mb-4">Billed $71.95 yearly</div>
                    <div class="space-y-2 text-xs mb-4">
                        <div>✓ Unlimited chats</div>
                        <div>✓ Unlimited documents</div>
                        <div>✓ All 6 AI agents</div>
                        <div>✓ Priority support</div>
                    </div>
                    <button class="selectPlan w-full text-xs px-3 py-2 rounded-lg bg-gradient-to-r from-purple-500 to-pink-500 text-white hover:opacity-90 font-semibold" data-plan="annual">Get Annual</button>
                </div>
            </div>
            <div class="text-center text-xs text-gray-500 mt-4">Cancel anytime • Secure payment via Stripe</div>
        </div>
    </div>

    <div id="loginModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden items-center justify-center" style="z-index: 100;">
        <div class="bg-white rounded-2xl shadow-2xl w-[400px] p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold">Login to DocumentGPT</h2>
                <button id="closeLogin" class="text-2xl opacity-50 hover:opacity-100">×</button>
            </div>
            <div id="loginError" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700"></div>
            <div class="space-y-4">
                <input type="email" id="loginEmail" placeholder="Email" class="w-full rounded-lg border px-3 py-2" />
                <input type="password" id="loginPassword" placeholder="Password" class="w-full rounded-lg border px-3 py-2" />
                <button id="loginSubmit" class="w-full bg-emerald-500 text-white rounded-lg px-3 py-2 hover:bg-emerald-600">Login</button>
                <div class="text-center text-sm opacity-70">
                    <button id="forgotPassword" class="text-emerald-500 hover:underline">Forgot password?</button>
                </div>
                <div class="text-center text-sm opacity-70">
                    Don't have an account? <button id="showSignup" class="text-emerald-500 hover:underline">Sign up</button>
                </div>
            </div>
        </div>
    </div>

    <div id="signupModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden items-center justify-center" style="z-index: 100;">
        <div class="bg-white rounded-2xl shadow-2xl w-[400px] p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold">Create Account</h2>
                <button id="closeSignup" class="text-2xl opacity-50 hover:opacity-100">×</button>
            </div>
            <div id="signupError" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700"></div>
            <div class="space-y-4">
                <input type="text" id="signupName" placeholder="Full Name" class="w-full rounded-lg border px-3 py-2" />
                <input type="email" id="signupEmail" placeholder="Email" class="w-full rounded-lg border px-3 py-2" />
                <div>
                    <input type="password" id="signupPassword" placeholder="Password" class="w-full rounded-lg border px-3 py-2" />
                    <div class="text-xs text-gray-500 mt-1 ml-1">
                        Must be 8+ chars with uppercase, lowercase, and number
                    </div>
                </div>
                <button id="signupSubmit" class="w-full bg-emerald-500 text-white rounded-lg px-3 py-2 hover:bg-emerald-600">Create Account</button>
                <div class="text-center text-sm opacity-70">
                    Already have an account? <button id="showLogin" class="text-emerald-500 hover:underline">Login</button>
                </div>
            </div>
        </div>
    </div>

    <div id="forgotPasswordModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden items-center justify-center" style="z-index: 100;">
        <div class="bg-white rounded-2xl shadow-2xl w-[400px] p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold">Reset Password</h2>
                <button id="closeForgotPassword" class="text-2xl opacity-50 hover:opacity-100">×</button>
            </div>
            <div id="forgotPasswordError" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700"></div>
            <div id="forgotPasswordSuccess" class="hidden mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-sm text-green-700"></div>
            <div class="space-y-4">
                <input type="email" id="forgotPasswordEmail" placeholder="Enter your email" class="w-full rounded-lg border px-3 py-2" />
                <button id="forgotPasswordSubmit" class="w-full bg-emerald-500 text-white rounded-lg px-3 py-2 hover:bg-emerald-600">Send Reset Code</button>
                <div class="text-center text-sm opacity-70">
                    <button id="backToLogin" class="text-emerald-500 hover:underline">Back to login</button>
                </div>
            </div>
        </div>
    </div>

    <div id="verifyEmailModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden items-center justify-center" style="z-index: 100;">
        <div class="bg-white rounded-2xl shadow-2xl w-[400px] p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold">Verify Email</h2>
                <button id="closeVerifyEmail" class="text-2xl opacity-50 hover:opacity-100">×</button>
            </div>
            <div id="verifyEmailError" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700"></div>
            <div class="space-y-4">
                <p class="text-sm text-gray-600">Enter the verification code sent to your email</p>
                <input type="text" id="verificationCode" placeholder="Enter 6-digit code" class="w-full rounded-lg border px-3 py-2" maxlength="6" />
                <input type="hidden" id="verifyEmail" />
                <button id="verifyEmailSubmit" class="w-full bg-emerald-500 text-white rounded-lg px-3 py-2 hover:bg-emerald-600">Verify</button>
                <div class="text-center text-sm opacity-70">
                    <button id="resendCodeBtn" class="text-emerald-500 hover:underline">Resend code</button>
                </div>
            </div>
        </div>
    </div>

    <div id="folderModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden items-center justify-center" style="z-index: 100;">
        <div class="bg-white rounded-2xl shadow-2xl w-[400px] p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold">New Folder</h2>
                <button id="closeFolderModal" class="text-2xl opacity-50 hover:opacity-100">×</button>
            </div>
            <input type="text" id="folderName" placeholder="Folder name" class="w-full rounded-lg border px-3 py-2 mb-4" />
            <button id="createFolderBtn" class="w-full bg-emerald-500 text-white rounded-lg px-3 py-2 hover:bg-emerald-600">Create</button>
        </div>
    </div>

    <input type="file" id="fileInput" class="hidden" accept=".pdf,.txt,.md,.docx" />

    <!-- Lightning Menu Button (Middle panel, under More button, Draggable) -->
    <div class="fixed" style="top: 60px; right: 50%; transform: translateX(50%); margin-right: 50px; z-index:91;" id="lightningContainer">
        <button id="insightsBtn" class="w-14 h-14 rounded-full flex items-center justify-center text-3xl hover:scale-110 transition-all duration-300 cursor-pointer" style="background: linear-gradient(135deg, #10b981, #06b6d4); backdrop-filter: blur(20px); border: 2px solid rgba(255,255,255,0.8); box-shadow: 0 0 30px rgba(16,185,129,0.6), 0 0 60px rgba(6,182,212,0.4), 0 8px 32px rgba(0,0,0,0.2), inset 0 0 20px rgba(255,255,255,0.3); animation: lightningGlow 2s ease-in-out infinite;">⚡</button>
        
        <!-- Lightning Dropdown Menu -->
        <div id="lightningMenu" class="hidden absolute top-full left-0 mt-2 bg-white border rounded-xl shadow-lg p-2 w-48" style="backdrop-filter: blur(16px); background: rgba(255,255,255,0.95); border-color: rgba(16,185,129,0.2);">
            <button onclick="openInsightsPanel();document.getElementById('lightningMenu').classList.add('hidden')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-emerald-50 text-sm flex items-center gap-2"><span>⚡</span> Instant Insights</button>
            <button onclick="openHighlightLegend();document.getElementById('lightningMenu').classList.add('hidden')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-emerald-50 text-sm flex items-center gap-2"><span>🎨</span> Highlights</button>
            <button onclick="openCoEditor();document.getElementById('lightningMenu').classList.add('hidden')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-emerald-50 text-sm flex items-center gap-2"><span>✨</span> AI Co-Editor</button>
            <button onclick="showDocIQTips();document.getElementById('lightningMenu').classList.add('hidden')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-emerald-50 text-sm flex items-center gap-2"><span>💡</span> DocIQ Tips</button>
            <button onclick="showVersionHistory();document.getElementById('lightningMenu').classList.add('hidden')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-emerald-50 text-sm flex items-center gap-2"><span>🕐</span> Version History</button>
                <button onclick="showWritingCoach();document.getElementById('lightningMenu').classList.add('hidden')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-emerald-50 text-sm flex items-center gap-2"><span>🎓</span> Writing Coach</button>
        </div>
    </div>
    
    <!-- Instant Insights Panel (Drops down from button) -->
    <div id="insightsPanel" class="fixed w-80 rounded-2xl hidden" style="z-index:90; background: rgba(255,255,255,0.92); backdrop-filter: blur(16px); border: 1px solid rgba(16,185,129,0.25); box-shadow: 0 8px 32px rgba(16,185,129,0.18), 0 0 50px rgba(6,182,212,0.12), inset 0 0 30px rgba(255,255,255,0.5);">
        <div class="px-4 py-3 border-b flex items-center justify-between bg-gradient-to-r from-emerald-500/10 to-cyan-500/10" style="border-color: rgba(16,185,129,0.2);">
            <span class="text-sm font-bold text-emerald-700">⚡ Instant Insights</span>
            <button onclick="closeInsightsPanel()" class="text-emerald-600 text-xl opacity-80 hover:opacity-100">×</button>
        </div>
        <div id="insightsContent" class="p-4 max-h-96 overflow-auto text-sm space-y-3"></div>
        <div id="highlightNav" class="px-4 py-3 border-t flex items-center justify-between" style="display: none;">
            <button onclick="prevHighlight()" class="px-3 py-1.5 rounded-lg border border-emerald-500 text-emerald-600 hover:bg-emerald-50 text-sm flex items-center gap-1">← Prev</button>
            <span id="highlightCount" class="text-xs font-semibold text-gray-700">0 of 0</span>
            <button onclick="nextHighlight()" class="px-3 py-1.5 rounded-lg border border-emerald-500 text-emerald-600 hover:bg-emerald-50 text-sm flex items-center gap-1">Next →</button>
        </div>
    </div>

    <!-- R1: Selection Toolbar -->
    <div id="selectionToolbar">
        <button onclick="highlightSelection('yellow')" title="Facts">💛</button>
        <button onclick="highlightSelection('blue')" title="Dates">💙</button>
        <button onclick="highlightSelection('green')" title="Names">💚</button>
        <button onclick="highlightSelection('red')" title="Important">❤️</button>
        <button onclick="highlightSelection('purple')" title="Ideas">💜</button>
        <button onclick="removeHighlight()" title="Remove">🚫</button>
    </div>

    <!-- AI Co-Editor Panel -->
    <div id="coEditorPanel" class="fixed w-80 rounded-2xl hidden" style="z-index:90; background: rgba(255,255,255,0.92); backdrop-filter: blur(16px); border: 1px solid rgba(16,185,129,0.25); box-shadow: 0 8px 32px rgba(16,185,129,0.18), 0 0 50px rgba(6,182,212,0.12), inset 0 0 30px rgba(255,255,255,0.5);">
        <div class="px-4 py-3 border-b flex items-center justify-between bg-gradient-to-r from-emerald-500/10 to-cyan-500/10" style="border-color: rgba(16,185,129,0.2);">
            <span class="text-sm font-bold text-emerald-700">✨ AI Co-Editor</span>
            <button onclick="closeCoEditor()" class="text-emerald-600 text-xl opacity-80 hover:opacity-100">×</button>
        </div>
        <div id="coEditorContent" class="p-4 max-h-96 overflow-auto text-sm space-y-3"></div>
        <div class="px-4 py-3 border-t">
            <label class="flex items-center gap-2 text-xs">
                <input type="checkbox" id="autoSuggest" checked onchange="toggleAutoSuggest()" />
                <span>Auto-suggest as I type</span>
            </label>
        </div>
    </div>

    <!-- R1: Highlight Legend (Drops down from lightning) -->
    <div id="highlightLegend" class="fixed w-80 rounded-2xl hidden" style="z-index:90; background: rgba(255,255,255,0.92); backdrop-filter: blur(16px); border: 1px solid rgba(16,185,129,0.25); box-shadow: 0 8px 32px rgba(16,185,129,0.18), 0 0 50px rgba(6,182,212,0.12), inset 0 0 30px rgba(255,255,255,0.5);">
        <div class="px-4 py-3 border-b flex items-center justify-between bg-gradient-to-r from-emerald-500/10 to-cyan-500/10" style="border-color: rgba(16,185,129,0.2);">
            <span class="text-sm font-bold text-emerald-700">🎨 Highlights</span>
            <button onclick="closeHighlightLegend()" class="text-emerald-600 text-xl opacity-80 hover:opacity-100">×</button>
        </div>
        <div id="legendContent" class="p-4 max-h-96 overflow-auto text-sm space-y-2"></div>
        <div class="px-4 py-3 border-t flex gap-2">
            <button onclick="exportHighlights()" class="flex-1 text-xs px-3 py-2 rounded-lg border border-emerald-500 text-emerald-600 hover:bg-emerald-50">📥 Export</button>
            <button onclick="clearAllHighlights()" class="flex-1 text-xs px-3 py-2 rounded-lg border border-red-500 text-red-600 hover:bg-red-50">🗑️ Clear</button>
        </div>
    </div>

    <!-- Progress Bar -->
    <div id="progressBar" class="progress-bar"></div>
    
    <!-- AI Suggestion Card -->
    <div id="aiSuggestionCard">
        <div class="suggestion-text" id="suggestionText"></div>
        <div class="suggestion-actions">
            <button class="suggestion-btn" onclick="dismissSuggestion()">Dismiss</button>
            <button class="suggestion-btn accept" onclick="acceptSuggestion()">Accept</button>
        </div>
    </div>
    
    <!-- Lumina UX Elements (HUD disabled) -->
    <div id="luminaHUD" aria-hidden="true" style="display:none;"></div>
    <div id="luminaDock" aria-hidden="true">
        <button id="dockFocus" data-click>Focus</button>
        <button id="dockThemes" data-click>Themes</button>
        <button id="dockAgents" data-click>Agents</button>
        <button id="dockStats" data-click>Stats</button>
    </div>
    <div id="thinkingPulse"></div>
    <div id="focusHorizon"></div>

    <!-- Keyboard Shortcuts Overlay -->
    <div id="shortcutsOverlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center" style="z-index: 200;">
        <div class="bg-white rounded-2xl shadow-2xl w-[600px] p-6 max-h-[80vh] overflow-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">⌨️ Keyboard Shortcuts</h2>
                <button onclick="hideShortcuts()" class="text-2xl opacity-50 hover:opacity-100">×</button>
            </div>
            <div class="space-y-4">
                <div class="flex justify-between items-center py-2 border-b">
                    <span class="text-sm">Command Palette</span>
                    <span class="shortcut-key">⌘K</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b">
                    <span class="text-sm">Bold Text</span>
                    <span class="shortcut-key">⌘B</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b">
                    <span class="text-sm">Italic Text</span>
                    <span class="shortcut-key">⌘I</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b">
                    <span class="text-sm">Underline Text</span>
                    <span class="shortcut-key">⌘U</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b">
                    <span class="text-sm">Send Chat</span>
                    <span class="shortcut-key">Enter</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b">
                    <span class="text-sm">New Line in Chat</span>
                    <span class="shortcut-key">Shift+Enter</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b">
                    <span class="text-sm">Close Modals</span>
                    <span class="shortcut-key">Esc</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b">
                    <span class="text-sm">Show Shortcuts</span>
                    <span class="shortcut-key">?</span>
                </div>
            </div>
        </div>
    </div>

    <script>
const API = 'https://w6poeb2pzi5v6lglx5jbygv3uu0uarkd.lambda-url.us-east-1.on.aws';
const COGNITO = {UserPoolId: 'us-east-1_UcrfhrZOs', ClientId: '570a98p0qringma32hnf13olue'};
const userPool = new AmazonCognitoIdentity.CognitoUserPool(COGNITO);

const CONFIG = {
    CHAT_LIMIT: 10,
    DOC_LIMIT: 2,
    ENABLE_STREAMING: true
};

document.body.classList.add('chatpdf-mode');
const textDecoder = new TextDecoder();
let activeChatAbort = null;

// Settings Store (MUST be defined before use)
const SETTINGS_KEY = 'dgpt:settings:v1';
const DEFAULT_SETTINGS = {
    theme: 'light',
    autosaveMs: 3000,
    dnd: false,
    journalMode: false
};

function loadSettings() {
    return {...DEFAULT_SETTINGS, ...JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}')};
}

function saveSettings(patch) {
    const settings = {...loadSettings(), ...patch};
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
    return settings;
}

// Apply settings on load - default to light
const initialSettings = loadSettings();
if (initialSettings.theme === 'dark') {
    document.body.setAttribute('data-theme', 'dark');
} else {
    document.body.setAttribute('data-theme', 'light');
}

// Load state from localStorage or use defaults
function loadState() {
    // Clear old state versions
    const oldKeys = ['dgpt:state:v1', 'dgpt:state', 'documentgpt:state'];
    oldKeys.forEach(k => localStorage.removeItem(k));
    
    const saved = localStorage.getItem('dgpt:state:v3');
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            // Always use current CONFIG limits, not saved ones
            parsed.limits = {chats: CONFIG.CHAT_LIMIT, documents: CONFIG.DOC_LIMIT};
            if (!parsed.streak) parsed.streak = {count: 0, lastDate: null, dailyGoal: 500, todayWords: 0};
            if (!parsed.docEntities) parsed.docEntities = {};
            if (!parsed.docInsights) parsed.docInsights = parsed.docInsights || {};
            if (!parsed.docHighlights) parsed.docHighlights = parsed.docHighlights || {};
            if (!parsed.chatHistory) parsed.chatHistory = parsed.chatHistory || {};
            if (!parsed.knowledgeGraph) parsed.knowledgeGraph = {entities: [], docRelationships: [], docMeta: {}, lastFetched: 0, loading: false};
            if (!parsed.knowledgeGraph.docRelationships) parsed.knowledgeGraph.docRelationships = [];
            if (!parsed.knowledgeGraph.docMeta) parsed.knowledgeGraph.docMeta = {};
            if (!parsed.entityDetailCache) parsed.entityDetailCache = {};
            if (!parsed.userHighlights) parsed.userHighlights = parsed.userHighlights || {};
            if (!parsed.docCache) parsed.docCache = {};
            if (!parsed.docFetchMeta) parsed.docFetchMeta = {};
            if (!parsed.ui) parsed.ui = {knowledgeGraphCollapsed: false};
            if (parsed.ui.knowledgeGraphCollapsed === undefined) parsed.ui.knowledgeGraphCollapsed = false;
            if (parsed.activeEntityId === undefined) parsed.activeEntityId = null;
            if (!parsed.knowledgeGraphFilters) parsed.knowledgeGraphFilters = {...defaultGraphFilters};
            if (!parsed.temporalAnalytics) parsed.temporalAnalytics = {data: null, lastFetched: 0, loading: false, error: null};
            if (!parsed.wikiCache) parsed.wikiCache = {};
            if (!parsed.wikiMeta) parsed.wikiMeta = {pages: [], lastFetched: 0};
            return parsed;
        } catch (e) {
            console.error('Failed to parse saved state:', e);
        }
    }
    return {
        user: null,
        docs: [{id: 'doc1', name: 'Welcome', content: 'Start writing...'}],
        activeId: 'doc1',
        usage: {chats_used: 0, documents_uploaded: 0},
        limits: {chats: CONFIG.CHAT_LIMIT, documents: CONFIG.DOC_LIMIT},
        zoom: 1,
        focus: false,
        streak: {count: 0, lastDate: null, dailyGoal: 500, todayWords: 0},
        docEntities: {},
        docInsights: {},
        docHighlights: {},
        chatHistory: {},
        knowledgeGraph: {entities: [], docRelationships: [], docMeta: {}, lastFetched: 0, loading: false},
        entityDetailCache: {},
        userHighlights: {},
        docCache: {},
        docFetchMeta: {},
        ui: {knowledgeGraphCollapsed: false},
        knowledgeGraphFilters: {...defaultGraphFilters},
        activeEntityId: null,
        temporalAnalytics: {data: null, lastFetched: 0, loading: false, error: null},
        wikiCache: {},
        wikiMeta: {pages: [], lastFetched: 0}
    };
}

// Phase 4: Compressed state save + Phase 8: Cloud sync
function saveState() {
    try {
        const stateStr = JSON.stringify(state);
        localStorage.setItem('dgpt:state:v3', stateStr);
        if (stateStr.length > 500000) console.warn('State size large:', (stateStr.length/1024).toFixed(1), 'KB');
        
        // Cloud sync for non-guest users
        if (state.user && !state.user.isGuest) {
            syncToCloud();
        }
    } catch (e) {
        console.error('Save failed:', e);
        toast('⚠️ Save failed - storage full');
    }
}

// Phase 8: Cloud document sync
let syncTimeout;
async function syncToCloud() {
    clearTimeout(syncTimeout);
    syncTimeout = setTimeout(async () => {
        try {
            const doc = state.docs.find(d => d.id === state.activeId);
            if (!doc) return;
            
            const headers = {'Content-Type': 'application/json'};
            if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
            
            await fetch(`${API}/documents`, {
                method: 'POST',
                headers,
                body: JSON.stringify({
                    user_id: state.user.sub,
                    doc_id: doc.backendId || doc.id,
                    name: doc.name,
                    content: doc.content,
                    summary: doc.summary,
                    questions: doc.questions,
                    isPdf: doc.isPdf || false,
                    chat_history: state.chatHistory[state.activeId] || []
                })
            });
            console.log('☁️ Synced to cloud');
        } catch (e) {
            console.error('Cloud sync failed:', e);
        }
    }, 5000);
}

// Phase 8: Load docs from cloud on login
async function loadCloudDocs() {
    if (!state.user || state.user.isGuest) return;
    
    try {
        const headers = {'Content-Type': 'application/json'};
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
        const res = await fetch(`${API}/documents?user_id=${state.user.sub}`, {headers});
        if (res.ok) {
            const data = await res.json();
            if (data.documents && data.documents.length > 0) {
                state.docs = data.documents.map(d => ({
                    id: d.doc_id,
                    backendId: d.doc_id,
                    name: d.filename,
                    content: d.content || '',
                    plainText: d.content || '',
                    summary: d.summary || '',
                    questions: d.questions || [],
                    isPdf: d.isPdf || false,
                    updated_at: d.created_at || d.updated_at,
                    entities: d.entities || []
                }));
                
                // Restore chat history
                data.documents.forEach(d => {
                    if (d.chat_history && d.chat_history.length > 0) {
                        state.chatHistory[d.doc_id] = d.chat_history;
                    }
                    if (d.entities && d.entities.length > 0) {
                        state.docEntities[d.doc_id] = d.entities;
                    }
                    state.docCache = state.docCache || {};
                    state.docCache[d.doc_id] = state.docCache[d.doc_id] || {
                        doc_id: d.doc_id,
                        filename: d.filename,
                        summary: d.summary,
                        content: d.content,
                        created_at: d.created_at,
                        updated_at: d.updated_at,
                        entities: d.entities || [],
                        highlights: d.highlights || [],
                        media_type: d.media_type
                    };
                });
                
                if (!state.activeId || !state.docs.find(d => d.id === state.activeId)) {
                    state.activeId = state.docs[0].id;
                }
                saveState();
                toast('☁️ Loaded from cloud', true);
                fetchUserEntities(true);
            }
        }
    } catch (e) {
        console.error('Load cloud docs failed:', e);
    }
}

let state = loadState();

// Per-document chat history, insights, and version history
if (!state.chatHistory) state.chatHistory = {};
if (!state.docInsights) state.docInsights = {};
if (!state.docHighlights) state.docHighlights = {};
if (!state.versions) state.versions = {};
if (!state.userHighlights) state.userHighlights = {};
if (!state.folders) state.folders = [{id: 'default', name: 'All Documents', docs: []}];
if (!state.activeFolder) state.activeFolder = 'default';
state.docs = state.docs.map(doc => {
    if (!doc.backendId && /^doc_\\d+$/.test(doc.id || '')) {
        return {...doc, backendId: doc.id};
    }
    return {...doc, backendId: doc.backendId || null};
});

// Phase 4: Offline detection & error boundary
window.addEventListener('online', () => {
    document.getElementById('offlineBanner')?.remove();
    toast('🟢 Back online', true);
});

window.addEventListener('offline', () => {
    if (!document.getElementById('offlineBanner')) {
        const banner = document.createElement('div');
        banner.id = 'offlineBanner';
        banner.className = 'offline-banner';
        banner.textContent = '⚠️ No internet connection - working offline';
        document.body.prepend(banner);
    }
});

window.addEventListener('error', (e) => {
    console.error('Global error:', e);
    toast('⚠️ Something went wrong');
});

document.addEventListener('DOMContentLoaded', async () => {
    console.log('DOM loaded, initializing...');
    try {
        await initAuth();
        render();
        attachAllEvents();
        wireExtraButtons();
        document.getElementById('appSkeleton').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        console.log('Initialization complete');
        console.log('Testing button availability...');
        const testButtons = ['uploadBtn', 'newBtn', 'sendBtn', 'summaryAgent', 'upgradeBtn'];
        testButtons.forEach(id => {
            const btn = document.getElementById(id);
            console.log(`${id}: ${btn ? '✅ found' : '❌ missing'}, handler: ${btn?.onclick ? '✅' : '❌'}`);
        });
        
        // Check for Stripe success/cancel
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('success') === 'true') {
            showStripeSuccess();
        } else if (urlParams.get('canceled') === 'true') {
            toast('Payment canceled');
        }
    } catch (e) {
        console.error('Init failed:', e);
        document.getElementById('app').innerHTML = `
            <div class="error-boundary">
                <h2 class="text-2xl font-bold mb-4">⚠️ Failed to Load</h2>
                <p class="mb-4">${e.message}</p>
                <button onclick="location.reload()" class="px-4 py-2 bg-emerald-500 text-white rounded-lg">Reload App</button>
            </div>
        `;
    }
});

let authToken = null;

async function initAuth() {
    try {
        const cognitoUser = userPool.getCurrentUser();
        if (cognitoUser) {
            const session = await new Promise((resolve, reject) => {
                cognitoUser.getSession((err, session) => err ? reject(err) : resolve(session));
            });
            if (session.isValid()) {
                const payload = session.getIdToken().payload;
                authToken = session.getIdToken().getJwtToken();
                state.user = {email: payload.email, sub: payload.sub, name: payload.name};
                await loadUsage();
                await loadCloudDocs();
                await fetchUserEntities(true);
                updateAuthUI();
                return;
            }
        }
    } catch (e) { console.log('No auth session'); }
    
    const guestId = localStorage.getItem('guest_id') || 'guest_' + Math.random().toString(36).slice(2, 11);
    localStorage.setItem('guest_id', guestId);
    state.user = {email: 'guest@documentgpt.io', sub: guestId, isGuest: true};
    authToken = null;
    await loadUsage();
    renderUserEntities();
    updateAuthUI();
}

function updateAuthUI() {
    const loginBtn = document.getElementById('loginBtn');
    if (!loginBtn) return;
    
    const tier = state.user?.tier || (state.user?.isGuest ? 'Free' : 'Free');
    const chatsUsed = state.usage?.chats_used || 0;
    const chatsLimit = state.limits?.chats || 50;
    const isPremium = ['premium', 'pro', 'business', 'Premium', 'Pro', 'Business'].includes(tier);
    const tierColor = isPremium ? 'text-emerald-600' : 'text-gray-500';
    const usageText = isPremium ? 'Unlimited' : `${chatsUsed}/${chatsLimit} chats`;
    
    // Show upgrade button only for free users
    const upgradeBtn = document.getElementById('upgradeBtn');
    if (upgradeBtn) {
        upgradeBtn.style.display = isPremium ? 'none' : 'flex';
        upgradeBtn.onclick = () => showModal('upgradeModal');
    }
    
    if (state.user && !state.user.isGuest) {
        const cancelBtn = isPremium ? `<button onclick="event.stopPropagation();cancelSubscription();document.getElementById('accountMenu').classList.add('hidden')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-orange-50 text-sm flex items-center gap-2 text-orange-600"><span>❌</span> Cancel Subscription</button>` : '';
        
        loginBtn.innerHTML = `
            <div class="flex items-center gap-2 w-full" id="accountBtnContent">
                <svg class="w-5 h-5 sidebar-icon text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                <div class="sidebar-text flex-1">
                    <div class="text-sm font-semibold">${state.user.name || state.user.email.split('@')[0]}</div>
                    <div class="text-xs ${tierColor}">${tier} • ${usageText}</div>
                </div>
            </div>`;
        
        // Remove all old handlers
        const newLoginBtn = loginBtn.cloneNode(true);
        loginBtn.parentNode.replaceChild(newLoginBtn, loginBtn);
        
        // Add new click handler to show modal
        newLoginBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            showAccountMenu(isPremium);
        });
    } else {
        loginBtn.innerHTML = `
            <div class="flex items-center gap-2 w-full">
                <svg class="w-5 h-5 sidebar-icon text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                <div class="sidebar-text flex-1">
                    <div class="text-sm font-semibold">Guest</div>
                    <div class="text-xs text-gray-500">${chatsUsed}/${chatsLimit} chats left</div>
                </div>
            </div>`;
        loginBtn.onclick = () => showModal('loginModal');
    }
}

async function signIn(email, password) {
    return new Promise((resolve, reject) => {
        const authDetails = new AmazonCognitoIdentity.AuthenticationDetails({Username: email, Password: password});
        const cognitoUser = new AmazonCognitoIdentity.CognitoUser({Username: email, Pool: userPool});
        cognitoUser.authenticateUser(authDetails, {onSuccess: resolve, onFailure: reject});
    });
}

async function signUp(email, password, name) {
    return new Promise((resolve, reject) => {
        const attrs = [
            new AmazonCognitoIdentity.CognitoUserAttribute({Name: 'email', Value: email}),
            new AmazonCognitoIdentity.CognitoUserAttribute({Name: 'name', Value: name})
        ];
        userPool.signUp(email, password, attrs, null, (err, result) => err ? reject(err) : resolve(result));
    });
}

function signOut() {
    const cognitoUser = userPool.getCurrentUser();
    if (cognitoUser) cognitoUser.signOut();
    localStorage.removeItem('guest_id');
    location.reload();
}

// Phase 4: Cached usage with 30s TTL
let usageCache = null;
let usageCacheTime = 0;
async function loadUsage() {
    const now = Date.now();
    if (usageCache && (now - usageCacheTime) < 30000) {
        state.usage = usageCache;
        state.limits = {chats: CONFIG.CHAT_LIMIT, documents: CONFIG.DOC_LIMIT};
        return;
    }
    try {
        const headers = {'Content-Type': 'application/json'};
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
        const res = await fetch(`${API}/usage?user_id=${state.user.sub}`, {headers});
        if (res.ok) {
            const data = await res.json();
            state.usage = data.usage || {chats_used: 0, documents_uploaded: 0};
            state.user.tier = data.plan || 'Free';
            // Use limits from backend (-1 means unlimited)
            state.limits = data.limits || {chats: CONFIG.CHAT_LIMIT, documents: CONFIG.DOC_LIMIT};
            usageCache = state.usage;
            usageCacheTime = now;
            return;
        }
    } catch (e) {
        state.usage = usageCache || {chats_used: 0, documents_uploaded: 0};
    }
    state.limits = {chats: CONFIG.CHAT_LIMIT, documents: CONFIG.DOC_LIMIT};
}

function render() {
    const doc = state.docs.find(d => d.id === state.activeId);
    if (!doc) return;
    if (state.user && !state.user.isGuest) {
        fetchTemporalAnalytics();
    } else {
        state.temporalAnalytics = {data: null, lastFetched: 0, loading: false, error: null};
        renderTemporalAnalyticsInsights();
    }
    const editor = document.getElementById('editor');
    editor.innerHTML = doc.content;
    
    // Restore highlights after render
    restoreHighlights();
    
    renderDocEntities(doc);
    ensureDocEntities(doc);
    if (state.user && !state.user.isGuest) {
        fetchUserEntities();
    } else {
        renderUserEntities();
    }
    if (state.activeEntityId && state.entityDetailCache?.[state.activeEntityId]) {
        renderEntityDetail(state.entityDetailCache[state.activeEntityId].detail);
    }
    
    // Make PDFs read-only and show menu
    const pdfMenu = document.getElementById('pdfMenu');
    if (doc.isPdf) {
        editor.contentEditable = 'false';
        document.getElementById('formatToolbar').style.display = 'none';
        pdfMenu.style.display = 'block';
        
        // Generate page thumbnails
        const pages = editor.querySelectorAll('div[style*="page-break-after"]');
        pdfMenu.innerHTML = Array.from(pages).map((page, idx) => 
            `<div class="pdf-thumb ${idx === 0 ? 'active' : ''}" onclick="scrollToPage(${idx})">
                <div style="font-size: 10px; font-weight: bold; margin-bottom: 4px;">Page ${idx + 1}</div>
                <div style="font-size: 8px; color: #666; overflow: hidden; height: 60px;">${page.textContent.substring(0, 100)}...</div>
            </div>`
        ).join('');
    } else {
        editor.contentEditable = 'true';
        document.getElementById('formatToolbar').style.display = 'flex';
        pdfMenu.style.display = 'none';
    }
    
    // Restore chat history for this document with loading skeleton
    const chatContainer = document.getElementById('chatMessages');
    chatContainer.innerHTML = '<div class="skeleton h-16 rounded-2xl"></div>';
    setTimeout(() => {
        chatContainer.innerHTML = '';
        const history = state.chatHistory[state.activeId] || [];
        if (history.length === 0) {
            chatContainer.innerHTML = '<div class="text-sm p-3 rounded-2xl border bg-emerald-50 text-gray-900">I\'m here to help you write better or analyze documents. Start typing or upload a file!</div>';
        } else {
            history.forEach(msg => {
                if (msg.artifact) {
                    renderArtifacts(msg.artifact);
                } else {
                    const div = document.createElement('div');
                    div.className = msg.sender === 'user' 
                        ? 'text-sm p-3 rounded-2xl border bg-blue-50 ml-8 text-gray-900'
                        : 'text-sm p-3 rounded-2xl border bg-emerald-50 mr-8 text-gray-900';
                    div.innerHTML = msg.sender === 'bot' ? renderMarkdown(msg.text) : msg.text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    chatContainer.appendChild(div);
                }
            });
        }
    }, 100);

    

    
    const tabs = document.getElementById('tabsContainer');
    if (tabs) {
        tabs.innerHTML = state.docs.map(d => 
            `<div class="flex items-center gap-2 px-3 py-1 rounded-lg text-xs border ${d.id === state.activeId ? 'tab-active' : ''} cursor-pointer">
                <span onclick="setActive('${d.id}')">${d.name}</span>
                <button onclick="event.stopPropagation(); deleteDoc('${d.id}')" class="ml-2 px-1 text-base opacity-70 hover:opacity-100 hover:bg-red-100 rounded">×</button>
            </div>`
        ).join('');
    }
    
    const foldersList = document.getElementById('foldersList');
    if (foldersList) {
        foldersList.innerHTML = state.folders.map(f => 
            `<div class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs ${f.id === state.activeFolder ? 'bg-emerald-50 border border-emerald-200' : 'hover:bg-gray-50'} cursor-pointer" onclick="setActiveFolder('${f.id}')">
                <span class="sidebar-text">📁</span>
                <span class="flex-1 truncate sidebar-text">${f.name}</span>
            </div>`
        ).join('');
    }
    
    const chatsList = document.getElementById('chatsList');
    if (chatsList) {
        const filteredDocs = state.activeFolder === 'default' ? state.docs : state.docs.filter(d => d.folder === state.activeFolder);
        const sortedDocs = [...filteredDocs].sort((a, b) => {
            const timeA = a.updated_at || '';
            const timeB = b.updated_at || '';
            return timeB.localeCompare(timeA);
        });
        chatsList.innerHTML = sortedDocs.map(d => {
            const chatHistory = state.chatHistory[d.id] || [];
            const lastMsg = chatHistory.length > 0 ? chatHistory[chatHistory.length - 1].text : '';
            const preview = lastMsg.substring(0, 40) + (lastMsg.length > 40 ? '...' : '');
            const timestamp = d.updated_at ? getTimeAgo(new Date(d.updated_at).getTime()) : '';
            return `<div class="chat-item flex flex-col gap-1 px-3 py-2 rounded-lg text-xs border ${d.id === state.activeId ? 'tab-active' : 'hover:bg-gray-50'} cursor-pointer transition-all duration-200" onclick="setActive('${d.id}')">
                <div class="flex items-center gap-2">
                    <span class="flex-1 truncate sidebar-text font-semibold">${d.name}</span>
                    <button onclick="event.stopPropagation(); deleteDoc('${d.id}')" class="chat-delete opacity-0 px-1 text-sm hover:bg-red-100 rounded sidebar-text transition-opacity duration-200">×</button>
                </div>
                ${preview ? `<div class="sidebar-text text-gray-500 truncate text-[10px]">${preview}</div>` : ''}
                ${timestamp ? `<div class="sidebar-text text-gray-400 text-[10px]">${timestamp}</div>` : ''}
            </div>`;
        }).join('');
    }
    

    
    updateStats();
    
    // Restore insights and highlights for this document
    const insights = state.docInsights[state.activeId];
    const highlights = state.docHighlights[state.activeId];
    
    const insightsContentEl = document.getElementById('insightsContent');
    if (insightsContentEl) {
        let html = '';
        if (insights) {
            if (insights.keyPoints && insights.keyPoints.length > 0) {
                html += '<div><div class="font-bold text-emerald-600 mb-1">💡 Key Points</div><ul class="list-disc ml-4 space-y-1">';
                insights.keyPoints.forEach(p => html += `<li>${p}</li>`);
                html += '</ul></div>';
            }
            if (insights.actionItems && insights.actionItems.length > 0) {
                html += '<div><div class="font-bold text-cyan-600 mb-1">✅ Action Items</div><ul class="list-disc ml-4 space-y-1">';
                insights.actionItems.forEach(a => html += `<li>${a}</li>`);
                html += '</ul></div>';
            }
            if (insights.questions && insights.questions.length > 0) {
                html += '<div><div class="font-bold text-purple-600 mb-1">❓ Questions</div><ul class="list-disc ml-4 space-y-1">';
                insights.questions.forEach(q => html += `<li>${q}</li>`);
                html += '</ul></div>';
            }
        } else {
            html += '<div class="text-xs text-gray-500">No document insights yet. Keep writing to unlock AI summaries.</div>';
        }
        html += '<div id="temporalAnalyticsSection" class="mt-4 space-y-2"></div>';
        insightsContentEl.innerHTML = html;
        renderTemporalAnalyticsInsights();
    }
    
    const focusHighlight = pendingHighlight && pendingHighlight.docId === state.activeId ? pendingHighlight : null;
    if (highlights && highlights.length > 0) {
        setTimeout(() => applySmartHighlights(highlights, {focus: focusHighlight}), 100);
        if (focusHighlight) pendingHighlight = null;
    } else {
        document.getElementById('highlightNav').classList.add('hidden');
    }
    
    updateInsightsVisibility();

    if (knowledgeGraphOverlayOpen) {
        renderKnowledgeGraphOverlay();
    }
}

function updateStats() {
    const text = document.getElementById('editor').textContent;
    const words = text.trim().split(/\s+/).filter(w => w).length;
    const sentences = Math.max(1, (text.match(/[.!?]/g) || []).length);
    const syllables = (text.toLowerCase().match(/[aeiouy]{1,2}/g) || []).length;
    const readability = Math.max(0, Math.min(100, Math.round(206.835 - 1.015 * (words / sentences) - 84.6 * (syllables / Math.max(1, words)))));
    
    document.getElementById('wordCount').textContent = words;
    document.getElementById('dailyGoal').textContent = state.streak.dailyGoal;
    updateStreak(words);
    
    const docIQEl = document.getElementById('docIQ');
    const docIQBadge = document.getElementById('docIQBadge');
    if (docIQEl && words > 10) {
        const uniqueWords = new Set(text.toLowerCase().match(/\b\w+\b/g) || []).size;
        const lexicalDiversity = words > 0 ? (uniqueWords / words) * 100 : 0;
        const avgSentenceLength = words / sentences;
        const docIQ = Math.round((readability * 0.4) + (Math.min(100, lexicalDiversity * 2) * 0.3) + (Math.min(100, (avgSentenceLength / 20) * 100) * 0.3));
        docIQEl.textContent = docIQ;
        docIQEl.className = docIQ >= 70 ? 'text-emerald-600' : (docIQ >= 50 ? 'text-yellow-600' : 'text-red-600');
        if (docIQBadge) {
            if (docIQ >= 90) docIQBadge.textContent = '🏆';
            else if (docIQ >= 80) docIQBadge.textContent = '⭐';
            else if (docIQ >= 70) docIQBadge.textContent = '✨';
            else docIQBadge.textContent = '';
        }
    } else if (docIQEl) {
        docIQEl.textContent = '--';
        docIQEl.className = 'text-emerald-600';
        if (docIQBadge) docIQBadge.textContent = '';
    }
    
    const ex = (text.match(/!/g) || []).length, qs = (text.match(/\?/g) || []).length;
    const headings = (text.match(/\n[A-Z][^\n]{0,40}:|\n#{1,6}\s/g) || []).length;
    const bullets = (text.match(/\n[-*•]\s/g) || []).length;
    const imper = (text.match(/\b(must|should|do|schedule|send|review|decide|confirm|update)\b/i) || []).length;
    const dates = (text.match(/\b(\d{1,2}\/\d{1,2}\/\d{2,4}|\d{4}-\d{2}-\d{2}|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\b/gi) || []).length;
    const names = (text.match(/\b[A-Z][a-z]+ [A-Z][a-z]+\b/g) || []).length;
    const jargon = (text.match(/\b(utilize|leverage|synergy|paradigm|optimize)\b/gi) || []).length;
    
    const clarity = Math.max(20, Math.min(100, 70 + Math.min(10, headings * 3) - Math.min(10, qs) - Math.min(15, jargon * 3)));
    const completeness = Math.max(20, Math.min(100, 50 + Math.min(25, Math.floor(words / 300)) + Math.min(15, headings * 2) + Math.min(10, dates)));
    const actionability = Math.max(20, Math.min(100, 40 + Math.min(30, imper * 5) + Math.min(20, bullets * 2) + Math.min(10, dates)));
    
    document.getElementById('clarityPct').textContent = clarity;
    document.getElementById('completePct').textContent = completeness;
    document.getElementById('actionPct').textContent = actionability;
    
    const tips = [];
    if (clarity < 80) {
        if (headings === 0) tips.push('Add section headings to structure your document (e.g., "Overview", "Key Points", "Next Steps")');
        if (jargon > 2) tips.push(`Replace ${jargon} jargon words with simpler alternatives (e.g., "use" instead of "utilize")`);
        if (qs > 5) tips.push('Convert rhetorical questions into clear statements for better clarity');
        if (headings < 3 && words > 200) tips.push('Break content into 3-5 sections with descriptive headings');
    }
    if (completeness < 80) {
        if (words < 100) tips.push('Expand to at least 100 words to provide sufficient context and detail');
        if (headings < 2) tips.push('Add "Background" and "Conclusion" sections to frame your content');
        if (dates === 0 && imper > 0) tips.push('Add specific dates or timeframes to action items (e.g., "by Friday, Dec 15")');
        if (names === 0 && words > 100) tips.push('Specify who is responsible for each action or decision');
    }
    if (actionability < 80) {
        if (imper === 0) tips.push('Add action verbs: "Review X", "Schedule Y", "Decide on Z"');
        if (bullets === 0 && imper > 0) tips.push('Convert action items into a bulleted list for easy scanning');
        if (dates === 0) tips.push('Add deadlines to each action item (e.g., "Complete by EOD Monday")');
        if (names === 0 && imper > 0) tips.push('Assign owners to each task (e.g., "@John to review", "Sarah will schedule")');
    }
    
    const i = state.docInsights[state.activeId] || {};
    i.metrics = {clarity, completeness, actionability, tips};
    state.docInsights[state.activeId] = i;
    
    const modeLabelEl = document.getElementById('modeLabel');
    if (modeLabelEl) modeLabelEl.textContent = loadSettings().journalMode ? 'Journal' : 'Research';
}

const KG_CACHE_TTL = 5 * 60 * 1000;
const KG_DETAIL_TTL = 2 * 60 * 1000;
const TEMPORAL_CACHE_TTL = 5 * 60 * 1000;
const WIKI_CACHE_TTL = 3 * 60 * 1000;
const docEntityFetchLocks = {};
const docFetchLocks = {};
const defaultGraphFilters = {
    search: '',
    minLinks: 1,
    includeEntities: true,
    includeDocs: true,
    includeDocConnections: true,
    minSharedEntities: 1,
    recentOnly: false,
};
let graphSearchDebounce = null;

function escapeHtmlAttr(value) {
    return (value || '').replace(/["'\\<>]/g, c => ({'"': '&quot;', "'": '&#39;', '<': '&lt;', '>': '&gt;', '\\': '&#92;'}[c] || c));
}

function escapeHtml(value) {
    return (value || '').replace(/[&<>"']/g, c => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
    }[c] || c));
}

function buildEntityChip(entity, source = 'doc') {
    const mention = entity.mentions && entity.mentions.length > 0 ? entity.mentions[0] : '';
    const metrics = source === 'doc'
        ? `<span class=\"graph-pill\">${Math.round((entity.salience || 0) * 100)}%</span>`
        : `<span class=\"graph-pill\">${entity.doc_count || 0} docs</span>`;
    return `<span class=\"entity-chip\" data-entity-id=\"${escapeHtmlAttr(entity.entity_id)}\" data-entity-source=\"${source}\" data-entity-mention=\"${escapeHtmlAttr(mention)}\">` +
        `<span class=\"entity-spark\"></span>${escapeHtmlAttr(entity.name || 'Unknown')} ${metrics}</span>`;
}

function setKnowledgeGraphCollapsed(collapsed) {
    const body = document.getElementById('knowledgeGraphBody');
    const collapseBtn = document.getElementById('collapseKGBtn');
    if (!body || !collapseBtn) return;
    const alreadyCollapsed = body.classList.contains('hidden');
    if (collapsed) {
        body.classList.add('hidden');
        collapseBtn.dataset.state = 'closed';
        collapseBtn.textContent = 'Show';
    } else {
        body.classList.remove('hidden');
        collapseBtn.dataset.state = 'open';
        collapseBtn.textContent = 'Hide';
    }
    if (!state.ui) state.ui = {};
    const prev = state.ui.knowledgeGraphCollapsed;
    state.ui.knowledgeGraphCollapsed = collapsed;
    if (prev !== collapsed || alreadyCollapsed !== collapsed) {
        saveState();
    }
}

function renderDocEntities(doc, {loading = false} = {}) {
    const bar = document.getElementById('docEntityChipBar');
    const listEl = document.getElementById('docEntityChipList');
    const emptyEl = document.getElementById('docEntityEmpty');
    if (!bar || !listEl || !emptyEl) return;

    if (!doc) {
        bar.classList.add('hidden');
        return;
    }

    const docId = doc.backendId || doc.id;
    if (doc.entities && doc.entities.length) {
        if (!state.docEntities) state.docEntities = {};
        state.docEntities[docId] = doc.entities;
    }
    const docEntities = state.docEntities?.[docId] || doc.entities || [];

    if (loading) {
        bar.classList.remove('hidden');
        emptyEl.classList.add('hidden');
        listEl.innerHTML = '<div class="flex gap-2">' +
            '<div class="h-6 w-20 rounded-full bg-emerald-100 animate-pulse"></div>' +
            '<div class="h-6 w-24 rounded-full bg-emerald-100 animate-pulse"></div>' +
            '<div class="h-6 w-16 rounded-full bg-emerald-100 animate-pulse"></div>' +
            '</div>';
        return;
    }

    if (!docEntities || docEntities.length === 0) {
        bar.classList.remove('hidden');
        listEl.innerHTML = '';
        emptyEl.classList.remove('hidden');
        applyEntityLinks(doc, []);
        return;
    }

    const topEntities = [...docEntities].sort((a, b) => (b.salience || 0) - (a.salience || 0)).slice(0, 20);
    listEl.innerHTML = topEntities.map(entity => buildEntityChip(entity, 'doc')).join('');
    emptyEl.classList.add('hidden');
    bar.classList.remove('hidden');
    requestAnimationFrame(() => applyEntityLinks(doc, topEntities));
}

function applyEntityLinks(doc, entities) {
    const editor = document.getElementById('editor');
    if (!editor) return;
    const docId = doc.backendId || doc.id;

    // Clear previous links
    editor.querySelectorAll('.entity-inline').forEach(span => {
        const parent = span.parentNode;
        while (span.firstChild) parent.insertBefore(span.firstChild, span);
        parent.removeChild(span);
    });

    if (!entities || entities.length === 0) return;

    const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT, null);
    const nodes = [];
    while (walker.nextNode()) {
        nodes.push(walker.currentNode);
    }

    const docHighlights = getDocHighlights(docId);

    const linkedEntities = new Set();

    entities.forEach(entity => {
        if (linkedEntities.has(entity.entity_id)) return;
        const mentions = [...(entity.mentions || []), entity.name].filter(Boolean);
        const lowerMentions = mentions.map(m => String(m).toLowerCase());
        const highlightCandidates = docHighlights
            .filter(hl => {
                const text = (hl.text || '').trim();
                if (!text) return false;
                const lower = text.toLowerCase();
                return lowerMentions.some(m => m && lower.includes(m));
            })
            .map(hl => hl.text)
            .filter(Boolean);
        const candidates = [...highlightCandidates, ...mentions].filter(Boolean);
        for (const phrase of candidates) {
            const trimmed = (phrase || '').trim();
            if (!trimmed || trimmed.length > 200) continue;
            const regex = new RegExp(trimmed.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
            for (const node of nodes) {
                if (!node.parentElement || node.parentElement.closest('.entity-inline')) continue;
                const text = node.textContent;
                const match = regex.exec(text);
                if (match) {
                    const range = document.createRange();
                    range.setStart(node, match.index);
                    range.setEnd(node, match.index + match[0].length);
                    const span = document.createElement('span');
                    span.className = 'entity-inline';
                    span.dataset.entityId = entity.entity_id;
                    span.dataset.entitySource = 'doc';
                    span.dataset.entityMention = trimmed;
                    span.textContent = match[0];
                    range.deleteContents();
                    range.insertNode(span);
                    linkedEntities.add(entity.entity_id);
                    break;
                }
            }
            if (linkedEntities.has(entity.entity_id)) break;
        }
    });
}

async function ensureDocEntities(doc, force = false) {
    if (!doc) return;
    const docId = doc.backendId || doc.id;
    if (!docId) return;

    if (!force && state.docEntities && state.docEntities[docId]) {
        renderDocEntities(doc);
        return;
    }

    if (docEntityFetchLocks[docId]) {
        return;
    }
    docEntityFetchLocks[docId] = true;
    renderDocEntities(doc, {loading: true});

    try {
        const headers = {'Content-Type': 'application/json'};
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
        const res = await fetch(`${API}/dev/knowledge-graph/docs/${encodeURIComponent(docId)}`, {headers});
        if (res.ok) {
            const data = await res.json();
            const entities = data.entities || [];
            if (!state.docEntities) state.docEntities = {};
            state.docEntities[docId] = entities;
            const docRef = state.docs.find(d => (d.backendId || d.id) === docId);
            if (docRef) docRef.entities = entities;
        }
    } catch (error) {
        console.warn('Knowledge graph doc fetch failed', error);
    } finally {
        delete docEntityFetchLocks[docId];
        renderDocEntities(doc);
    }
}

async function fetchUserEntities(force = false) {
    if (!state.user || state.user.isGuest) {
        renderUserEntities();
        return;
    }
    const now = Date.now();
    if (!force && state.knowledgeGraph?.entities?.length && now - (state.knowledgeGraph.lastFetched || 0) < KG_CACHE_TTL) {
        renderUserEntities();
        return;
    }
    if (state.knowledgeGraph?.loading) return;

    if (!state.knowledgeGraph) state.knowledgeGraph = {entities: [], docRelationships: [], docMeta: {}, lastFetched: 0, loading: false};
    state.knowledgeGraph.loading = true;
    renderUserEntities();
    try {
        const headers = {'Content-Type': 'application/json'};
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
        const res = await fetch(`${API}/dev/knowledge-graph/entities?user_id=${encodeURIComponent(state.user.sub)}`, {headers});
        if (res.ok) {
            const data = await res.json();
            state.knowledgeGraph.entities = data.entities || [];
            state.knowledgeGraph.docRelationships = data.doc_relationships || [];
            state.knowledgeGraph.docMeta = data.doc_metadata || {};
            state.knowledgeGraph.lastFetched = Date.now();
        }
    } catch (error) {
        console.warn('Knowledge graph list failed', error);
    } finally {
        state.knowledgeGraph.loading = false;
        renderUserEntities();
        if (knowledgeGraphOverlayOpen) {
            renderKnowledgeGraphOverlay();
        }
    }
}

function renderUserEntities() {
    const panel = document.getElementById('knowledgeGraphSidebar');
    const chipsEl = document.getElementById('userEntityChips');
    const emptyEl = document.getElementById('knowledgeGraphEmpty');
    const refreshBtn = document.getElementById('refreshKnowledgeGraphBtn');
    const collapseBtn = document.getElementById('collapseKGBtn');
    const graphBtn = document.getElementById('openGraphViewBtn');
    const metaEl = document.getElementById('knowledgeGraphMeta');
    if (!panel || !chipsEl || !emptyEl) return;

    const entities = state.knowledgeGraph?.entities || [];
    const loading = !!state.knowledgeGraph?.loading;

    if (refreshBtn) {
        if (state.user && !state.user.isGuest) {
            refreshBtn.style.display = 'inline-flex';
        } else {
            refreshBtn.style.display = 'none';
        }
    }

    if (collapseBtn && state.ui?.knowledgeGraphCollapsed) {
        setKnowledgeGraphCollapsed(true);
    }

    const shouldShow = (entities && entities.length > 0) || loading || (state.activeEntityId && state.entityDetailCache?.[state.activeEntityId]);
    if (!shouldShow) {
        panel.classList.add('hidden');
        return;
    }
    panel.classList.remove('hidden');

    if (graphBtn) {
        graphBtn.style.display = (entities.length > 0 || loading) ? 'inline-flex' : 'none';
        graphBtn.disabled = loading || entities.length === 0;
    }
    if (metaEl) {
        if (loading) metaEl.textContent = 'Loading…';
        else if (entities.length > 0) metaEl.textContent = `${entities.length} entit${entities.length === 1 ? 'y' : 'ies'}`;
        else metaEl.textContent = '';
    }

    if (loading) {
        emptyEl.classList.remove('hidden');
        emptyEl.textContent = 'Loading knowledge graph...';
        chipsEl.innerHTML = '<div class="flex gap-2"><div class="h-6 w-16 rounded-full bg-emerald-100 animate-pulse"></div><div class="h-6 w-20 rounded-full bg-emerald-100 animate-pulse"></div></div>';
        return;
    }

    if (!entities || entities.length === 0) {
        chipsEl.innerHTML = '';
        emptyEl.classList.remove('hidden');
        emptyEl.textContent = state.user && !state.user.isGuest ? 'No entities yet. Keep writing or refresh.' : 'Sign in to build your knowledge graph across documents.';
        return;
    }

    emptyEl.classList.add('hidden');
    const topEntities = entities.slice(0, 18);
    chipsEl.innerHTML = topEntities.map(entity => buildEntityChip(entity, 'global')).join('');
}

function getDocHighlights(docId) {
    if (!docId) return [];
    if (state.docHighlights && state.docHighlights[docId] && state.docHighlights[docId].length) {
        return state.docHighlights[docId];
    }
    if (state.docCache && state.docCache[docId] && state.docCache[docId].highlights && state.docCache[docId].highlights.length) {
        return state.docCache[docId].highlights;
    }
    const doc = state.docs.find(d => (d.backendId || d.id) === docId);
    if (doc && doc.highlights && doc.highlights.length) {
        return doc.highlights;
    }
    return [];
}

function pickEntityHighlight(doc, entity) {
    if (!doc || !doc.doc_id) return null;
    const highlights = getDocHighlights(doc.doc_id);
    if (!highlights || highlights.length === 0) return null;
    const terms = new Set();
    if (entity?.name) terms.add(entity.name.toLowerCase());
    (entity?.mentions || []).forEach(mention => {
        if (mention) terms.add(String(mention).toLowerCase());
    });
    let bestHighlight = null;
    let bestScore = -Infinity;
    highlights.forEach((highlight, index) => {
        const text = (highlight.text || '').trim();
        if (!text) return;
        const lower = text.toLowerCase();
        let score = Number(highlight.score || 0);
        if (terms.size === 0) {
            score += 0.25;
        } else {
            terms.forEach(term => {
                if (term && lower.includes(term)) {
                    score += Math.min(2, term.length / 6) + 1;
                }
            });
        }
        if (!bestHighlight || score > bestScore) {
            bestScore = score;
            bestHighlight = {...highlight, index};
        }
    });
    if (!bestHighlight && highlights.length > 0) {
        bestHighlight = {...highlights[0], index: 0};
    }
    return bestHighlight;
}

function summarizeHighlightText(highlight) {
    if (!highlight || !highlight.text) return '';
    const text = highlight.text.trim().replace(/\s+/g, ' ');
    if (text.length <= 140) return text;
    return `${text.slice(0, 137)}…`;
}

function findHighlightIndex(docHighlights, highlight) {
    if (!docHighlights || !highlight) return -1;
    if (typeof highlight.index === 'number' && docHighlights[highlight.index]) {
        return highlight.index;
    }
    if (highlight.id) {
        const idxById = docHighlights.findIndex(item => item && item.id === highlight.id);
        if (idxById !== -1) return idxById;
    }
    if (highlight.text) {
        const normalized = highlight.text.trim().toLowerCase();
        const idxByText = docHighlights.findIndex(item => (item?.text || '').trim().toLowerCase() === normalized);
        if (idxByText !== -1) return idxByText;
    }
    return -1;
}

function focusHighlightNow(highlight) {
    if (!highlight) return;
    const activeDocId = state.activeId;
    if (!activeDocId) return;
    const docHighlights = getDocHighlights(activeDocId);
    if (!docHighlights || docHighlights.length === 0) return;
    const index = findHighlightIndex(docHighlights, highlight);
    if (index === -1) return;
    const resolvedHighlight = {
        id: highlight.id || docHighlights[index]?.id || null,
        text: highlight.text || docHighlights[index]?.text || '',
        index
    };

    if (!allHighlights || allHighlights.length === 0) {
        applySmartHighlights(docHighlights, {focus: resolvedHighlight});
        return;
    }

    let targetIndex = -1;
    if (resolvedHighlight.id) {
        targetIndex = allHighlights.findIndex(el => el.dataset.hlId === resolvedHighlight.id);
    }
    if (targetIndex === -1) {
        targetIndex = allHighlights.findIndex(el => parseInt(el.dataset.index || '-1', 10) === index);
    }
    if (targetIndex === -1 && resolvedHighlight.text) {
        const normalized = resolvedHighlight.text.trim().toLowerCase();
        targetIndex = allHighlights.findIndex(el => (el.textContent || '').trim().toLowerCase() === normalized);
    }
    if (targetIndex === -1) {
        applySmartHighlights(docHighlights, {focus: resolvedHighlight});
        return;
    }
    currentHighlightIndex = targetIndex;
    scrollToHighlight(targetIndex);
    pendingHighlight = null;
}

function renderEntityDetail(detail) {
    const panel = document.getElementById('entityDetailPanel');
    if (!panel) return;
    if (!detail) {
        panel.classList.add('hidden');
        panel.querySelector?.('#entityDetailDocs')?.replaceChildren();
        if (!state.activeEntityId) {
            const kgPanel = document.getElementById('knowledgeGraphSidebar');
            if (kgPanel && !(state.knowledgeGraph?.entities && state.knowledgeGraph.entities.length)) {
                kgPanel.classList.add('hidden');
            }
        }
        return;
    }
    document.getElementById('knowledgeGraphSidebar')?.classList.remove('hidden');
    panel.classList.remove('hidden');
    const nameEl = document.getElementById('entityDetailName');
    const metaEl = document.getElementById('entityDetailMeta');
    const mentionsEl = document.getElementById('entityDetailMentions');
    const docsEl = document.getElementById('entityDetailDocs');
    const entity = detail.entity || {};
    if (nameEl) nameEl.textContent = entity.name || 'Entity';
    if (metaEl) metaEl.textContent = `${entity.type || 'Unknown'} • ${entity.doc_count || detail.documents?.length || 0} doc(s)`;
    if (mentionsEl) {
        const mentions = entity.mentions || [];
        if (mentions.length === 0) {
            mentionsEl.textContent = 'No context snippets available.';
        } else {
            mentionsEl.innerHTML = mentions.map(m => `<div class="text-[11px] text-gray-600 leading-relaxed">“${escapeHtmlAttr(m)}”</div>`).join('');
        }
    }
    if (docsEl) {
        if (!detail.documents || detail.documents.length === 0) {
            docsEl.innerHTML = '<div class="text-xs text-gray-500">Only appears in this document so far.</div>';
        } else {
            docsEl.innerHTML = detail.documents.map(doc => {
                const localDoc = state.docs.find(d => (d.backendId || d.id) === doc.doc_id);
                const label = escapeHtmlAttr(localDoc?.name || doc.title || doc.doc_id);
                const timestamp = doc.created_at ? new Date(doc.created_at).toLocaleDateString() : '';
                const isActive = (localDoc && localDoc.id === state.activeId) || doc.doc_id === state.activeId;
                const buttonLabel = isActive ? 'Current' : 'Open';
                const buttonState = isActive ? 'disabled class="text-[11px] px-2 py-0.5 rounded-full border border-emerald-200 text-emerald-400 bg-emerald-50"' : 'class="text-[11px] px-2 py-0.5 rounded-full border border-emerald-200 text-emerald-600 hover:bg-emerald-50"';
                const highlight = pickEntityHighlight(doc, entity);
                const highlightAttrs = highlight
                    ? ` data-highlight-id="${escapeHtmlAttr(highlight.id || '')}" data-highlight-index="${highlight.index ?? ''}" data-highlight-offset="${highlight.offset ?? ''}" data-highlight-text="${escapeHtmlAttr(highlight.text || '')}"`
                    : '';
                const snippet = highlight ? `<div class="text-[11px] text-gray-500 mt-1 leading-snug">${escapeHtml(summarizeHighlightText(highlight))}</div>` : '';
                return `<div class="entity-doc-link" data-doc-id="${escapeHtmlAttr(doc.doc_id)}"${highlightAttrs}>` +
                    `<div class="flex-1"><div class="font-medium text-emerald-700">${label}</div>` +
                    `<div class="text-[11px] text-gray-500">${timestamp}</div>${snippet}</div>` +
                    `<button ${buttonState}>${buttonLabel}</button>` +
                    `</div>`;
            }).join('');
        }
    }
    const wikiActions = document.getElementById('entityWikiActions');
    const openWikiBtn = document.getElementById('openEntityWikiBtn');
    const refreshWikiBtn = document.getElementById('refreshEntityWikiBtn');
    if (wikiActions && openWikiBtn && refreshWikiBtn) {
        if (state.user && !state.user.isGuest && entity?.entity_id) {
            wikiActions.classList.remove('hidden');
            openWikiBtn.onclick = () => openWikiForEntity(entity.entity_id);
            refreshWikiBtn.onclick = () => openWikiForEntity(entity.entity_id, {force: true});
        } else {
            wikiActions.classList.add('hidden');
        }
    }
}

function clearEntityDetail() {
    state.activeEntityId = null;
    renderEntityDetail(null);
}

function buildGuestEntityDetail(entityId) {
    const doc = state.docs.find(d => d.id === state.activeId);
    if (!doc) return null;
    const docId = doc.backendId || doc.id;
    const docEntities = state.docEntities?.[docId] || doc.entities || [];
    const entity = docEntities.find(e => e.entity_id === entityId);
    if (!entity) return null;
    return {
        entity: {
            entity_id: entity.entity_id,
            name: entity.name,
            type: entity.type,
            doc_count: 1,
            salience: entity.salience,
            mentions: entity.mentions || []
        },
        documents: [{
            doc_id: docId,
            title: doc.name,
            summary: doc.summary,
            created_at: doc.updated_at || doc.created_at
        }]
    };
}

async function showEntityDetail(entityId, source = 'doc') {
    if (!entityId) return;
    const kgPanel = document.getElementById('knowledgeGraphSidebar');
    kgPanel?.classList.remove('hidden');
    const docsEl = document.getElementById('entityDetailDocs');
    if (docsEl) {
        docsEl.innerHTML = '<div class="text-xs text-gray-500">Loading...</div>';
    }

    if (!state.entityDetailCache) state.entityDetailCache = {};
    const cached = state.entityDetailCache[entityId];
    const now = Date.now();
    if (cached && now - cached.cachedAt < KG_DETAIL_TTL) {
        state.activeEntityId = entityId;
        renderEntityDetail(cached.detail);
        return;
    }

    if (!state.user || state.user.isGuest) {
        const guestDetail = buildGuestEntityDetail(entityId);
        state.activeEntityId = entityId;
        if (guestDetail) {
            state.entityDetailCache[entityId] = {detail: guestDetail, cachedAt: Date.now()};
            renderEntityDetail(guestDetail);
        } else {
            renderEntityDetail(null);
            toast('Entity details available after you sign in.', true);
        }
        return;
    }

    try {
        const headers = {'Content-Type': 'application/json'};
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
        const res = await fetch(`${API}/dev/knowledge-graph/entities/${encodeURIComponent(entityId)}?user_id=${encodeURIComponent(state.user.sub)}`, {headers});
        if (res.ok) {
            const detail = await res.json();
            state.entityDetailCache[entityId] = {detail, cachedAt: Date.now()};
            if (detail?.documents && detail.documents.length) {
                state.docCache = state.docCache || {};
                if (!state.docHighlights) state.docHighlights = {};
                detail.documents.forEach(doc => {
                    if (!doc || !doc.doc_id) return;
                    const cacheEntry = state.docCache[doc.doc_id] || {};
                    state.docCache[doc.doc_id] = {
                        ...cacheEntry,
                        doc_id: doc.doc_id,
                        filename: doc.title || cacheEntry.filename || doc.doc_id,
                        summary: doc.summary ?? cacheEntry.summary ?? '',
                        content: cacheEntry.content || doc.summary || '',
                        created_at: doc.created_at || cacheEntry.created_at,
                        updated_at: doc.updated_at || cacheEntry.updated_at,
                        highlights: doc.highlights || cacheEntry.highlights || [],
                        questions: doc.questions || cacheEntry.questions || [],
                        entities: cacheEntry.entities || [],
                        media_type: doc.media_type || cacheEntry.media_type
                    };
                    if ((doc.highlights && doc.highlights.length) || (cacheEntry.highlights && cacheEntry.highlights.length)) {
                        state.docHighlights[doc.doc_id] = doc.highlights && doc.highlights.length ? doc.highlights : cacheEntry.highlights || [];
                    }
                });
            }
            state.activeEntityId = entityId;
            renderEntityDetail(detail);
            return;
        }
    } catch (error) {
        console.warn('Entity detail fetch failed', error);
    }
    const fallback = buildGuestEntityDetail(entityId);
    if (fallback) {
        state.entityDetailCache[entityId] = {detail: fallback, cachedAt: Date.now()};
        state.activeEntityId = entityId;
        renderEntityDetail(fallback);
    } else {
        renderEntityDetail(null);
        toast('Unable to load entity details right now.', true);
    }
}

function showEntityHoverCard(target, text) {
    const card = document.getElementById('entityHoverCard');
    if (!card || !text) return;
    card.textContent = text;
    const rect = target.getBoundingClientRect();
    card.style.left = `${rect.left + window.scrollX}px`;
    card.style.top = `${rect.bottom + window.scrollY + 8}px`;
    card.classList.add('visible');
}

function hideEntityHoverCard() {
    const card = document.getElementById('entityHoverCard');
    if (card) card.classList.remove('visible');
}

function hydrateDocFromResponse(data) {
    if (!data) return null;
    const docId = data.doc_id;
    const filename = data.filename || docId || 'Document';
    let content = data.content || '';
    const hasHtml = /<(div|p|br|span|h[1-6]|ul|ol|li|table|section|article)[^>]*>/i.test(content);
    if (!hasHtml) {
        content = escapeHtml(content).replace(/\n/g, '<br>');
    }
    const doc = {
        id: docId,
        backendId: docId,
        name: filename,
        content,
        plainText: data.content || '',
        summary: data.summary || '',
        questions: data.questions || [],
        isPdf: data.media_type === 'application/pdf',
        media_type: data.media_type,
        updated_at: data.updated_at || data.created_at,
        created_at: data.created_at,
        entities: data.entities || [],
        highlights: data.highlights || []
    };
    return doc;
}

function addDocToState(doc, rawData) {
    if (!doc) return null;
    let existing = state.docs.find(d => (d.backendId || d.id) === doc.id);
    if (existing) {
        Object.assign(existing, doc);
        existing.backendId = existing.backendId || doc.id;
        if (rawData?.entities) existing.entities = rawData.entities;
        if (!state.docHighlights) state.docHighlights = {};
        if (doc.highlights && doc.highlights.length) {
            state.docHighlights[doc.id] = doc.highlights;
        }
        return existing;
    }
    state.docs.push(doc);
    if (!state.docHighlights) state.docHighlights = {};
    if (doc.highlights && doc.highlights.length) {
        state.docHighlights[doc.id] = doc.highlights;
    }
    return doc;
}

async function ensureDocLoaded(docId, {silent = false} = {}) {
    if (!docId) return null;
    let doc = state.docs.find(d => (d.backendId || d.id) === docId);
    if (doc) return doc;

    if (state.docCache && state.docCache[docId]) {
        doc = hydrateDocFromResponse(state.docCache[docId]);
        addDocToState(doc, state.docCache[docId]);
        if (state.docEntities) state.docEntities[docId] = state.docCache[docId].entities || [];
        if (!state.docHighlights) state.docHighlights = {};
        state.docHighlights[docId] = state.docCache[docId].highlights || [];
        return doc;
    }

    if (!state.user || state.user.isGuest) {
        if (!silent) toast('Sign in to open this document from the knowledge graph.', true);
        return null;
    }

    if (docFetchLocks[docId]) {
        try {
            return await docFetchLocks[docId];
        } catch (err) {
            return null;
        }
    }

    const fetchPromise = (async () => {
        try {
            const headers = {'Content-Type': 'application/json'};
            if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
            const res = await fetch(`${API}/dev/documents/${encodeURIComponent(docId)}?user_id=${encodeURIComponent(state.user.sub)}`, {headers});
            if (!res.ok) {
                if (!silent) toast('Unable to load document metadata.', true);
                return null;
            }
            const data = await res.json();
            state.docCache = state.docCache || {};
            state.docCache[docId] = data;
            state.docFetchMeta = state.docFetchMeta || {};
            state.docFetchMeta[docId] = {fetchedAt: Date.now()};
            if (!state.docEntities) state.docEntities = {};
            state.docEntities[docId] = data.entities || [];
            if (!state.docHighlights) state.docHighlights = {};
            state.docHighlights[docId] = data.highlights || [];
            const hydrated = hydrateDocFromResponse(data);
            return addDocToState(hydrated, data);
        } catch (error) {
            console.warn('Document fetch failed', error);
            if (!silent) toast('Unable to load document metadata.', true);
            return null;
        } finally {
            delete docFetchLocks[docId];
        }
    })();

    docFetchLocks[docId] = fetchPromise;
    return await fetchPromise;
}

window.openDocFromEntity = async (docId, options = {}) => {
    if (!docId) return;
    const highlightRequest = options.highlight || null;
    let targetDoc = state.docs.find(d => (d.backendId || d.id) === docId);
    if (!targetDoc) {
        const fetched = await ensureDocLoaded(docId);
        if (!fetched) return;
        targetDoc = fetched;
        saveState();
    }

    let normalizedHighlight = null;
    if (highlightRequest) {
        const docHighlights = getDocHighlights(docId);
        const index = findHighlightIndex(docHighlights, highlightRequest);
        if (index !== -1) {
            normalizedHighlight = {...highlightRequest, index};
            pendingHighlight = {docId, ...normalizedHighlight};
        } else {
            pendingHighlight = null;
        }
    } else {
        pendingHighlight = null;
    }

    if (state.activeId !== targetDoc.id) {
        state.activeId = targetDoc.id;
        render();
        saveState();
        toast(`📄 Switched to ${targetDoc.name}`, true);
    } else if (normalizedHighlight) {
        focusHighlightNow(normalizedHighlight);
    }
};

let knowledgeGraphOverlayOpen = false;
let knowledgeGraphSimulation = null;
let pendingHighlight = null;

function getGraphFilters() {
    if (!state.knowledgeGraphFilters) {
        state.knowledgeGraphFilters = {...defaultGraphFilters};
    }
    return state.knowledgeGraphFilters;
}

function updateGraphFilters(partial) {
    const current = getGraphFilters();
    state.knowledgeGraphFilters = {...current, ...partial};
    saveState();
    if (knowledgeGraphOverlayOpen) {
        renderKnowledgeGraphOverlay();
    }
}

function syncGraphFilterControls() {
    const filters = getGraphFilters();
    const searchInput = document.getElementById('graphSearchInput');
    if (searchInput && searchInput.value !== (filters.search || '')) {
        searchInput.value = filters.search || '';
    }
    const minSelect = document.getElementById('graphMinLinksSelect');
    if (minSelect) {
        const targetValue = String(filters.minLinks || 1);
        if (minSelect.value !== targetValue) minSelect.value = targetValue;
    }
    const includeEntities = document.getElementById('graphIncludeEntities');
    if (includeEntities) includeEntities.checked = filters.includeEntities !== false;
    const includeDocs = document.getElementById('graphIncludeDocs');
    if (includeDocs) includeDocs.checked = filters.includeDocs !== false;
    const includeDocLinks = document.getElementById('graphIncludeDocLinks');
    if (includeDocLinks) includeDocLinks.checked = filters.includeDocConnections !== false;
    const minShared = document.getElementById('graphMinSharedSelect');
    if (minShared) {
        const targetValue = String(filters.minSharedEntities || 1);
        if (minShared.value !== targetValue) minShared.value = targetValue;
    }
    const recentOnly = document.getElementById('graphRecentOnly');
    if (recentOnly) recentOnly.checked = !!filters.recentOnly;
}

function buildKnowledgeGraphData() {
    const entities = state.knowledgeGraph?.entities || [];
    const docRelationshipsRaw = state.knowledgeGraph?.docRelationships || [];
    const docMetaServer = state.knowledgeGraph?.docMeta || {};
    const filters = getGraphFilters();

    const entityNodes = [];
    const entityDocLinks = [];
    const docCounts = {};

    entities.forEach(entity => {
        const docIds = entity.doc_ids || [];
        entityNodes.push({
            id: `entity:${entity.entity_id}`,
            rawId: entity.entity_id,
            label: entity.name || entity.entity_id,
            type: 'entity',
            weight: entity.doc_count || docIds.length || 1,
            docIds,
        });
        docIds.forEach(docId => {
            docCounts[docId] = (docCounts[docId] || 0) + 1;
            entityDocLinks.push({
                source: `entity:${entity.entity_id}`,
                target: `doc:${docId}`,
                rawDocId: docId,
                type: 'entity-doc',
            });
        });
    });

    const cacheSources = [];
    if (state.entityDetailCache) {
        Object.values(state.entityDetailCache).forEach(entry => {
            const detail = entry?.detail;
            if (detail?.documents) cacheSources.push(...detail.documents);
        });
    }

    cacheSources.forEach(doc => {
        if (doc && doc.doc_id && !docCounts[doc.doc_id]) {
            docCounts[doc.doc_id] = 0;
        }
    });

    docRelationshipsRaw.forEach(rel => {
        if (!rel || !rel.source || !rel.target) return;
        docCounts[rel.source] = docCounts[rel.source] || 0;
        docCounts[rel.target] = docCounts[rel.target] || 0;
    });

    const docMeta = new Map();
    const docRecencyScores = new Map();
    const docSentimentScores = new Map();
    const docEmotions = new Map();
    const now = Date.now();
    const recentOnly = !!filters.recentOnly;
    const recentCutoffMs = 30 * 24 * 60 * 60 * 1000;

    const docNodes = [];
    Object.keys(docCounts).forEach(docId => {
        const doc = state.docs.find(d => (d.backendId || d.id) === docId);
        const cached = state.docCache?.[docId];
        const detailDoc = cacheSources.find(d => d.doc_id === docId);
        const metaServer = docMetaServer[docId] || {};

        const label = doc?.name || cached?.filename || detailDoc?.title || metaServer.title || docId;
        const summary = doc?.summary || cached?.summary || detailDoc?.summary || metaServer.summary || '';
        const createdAt = doc?.created_at || cached?.created_at || detailDoc?.created_at || metaServer.created_at || null;
        const updatedAt = doc?.updated_at || cached?.updated_at || detailDoc?.updated_at || metaServer.updated_at || createdAt;

        let updatedTime = updatedAt ? Date.parse(updatedAt) : NaN;
        if (Number.isNaN(updatedTime) && metaServer.updated_at) {
            updatedTime = Date.parse(metaServer.updated_at);
        }

        let recencyScore = typeof metaServer.recency_score === 'number' ? metaServer.recency_score : 0.3;
        if (!Number.isNaN(updatedTime)) {
            const ageDays = Math.max(0, (now - updatedTime) / (1000 * 60 * 60 * 24));
            recencyScore = Math.max(0, 1 - Math.min(ageDays, 150) / 150);
        }

        if (recentOnly && (Number.isNaN(updatedTime) || (now - updatedTime) > recentCutoffMs)) {
            return;
        }

        const sentimentScore = typeof metaServer.sentiment_score === 'number' ? metaServer.sentiment_score : 0;
        const emotion = metaServer.emotion || (sentimentScore >= 0.3 ? 'positive' : sentimentScore <= -0.3 ? 'negative' : 'neutral');
        const wordCount = metaServer.word_count || (doc?.plainText ? doc.plainText.trim().split(/\s+/).filter(Boolean).length : 0);
        const entityCount = metaServer.entity_count || docCounts[docId] || 0;

        docRecencyScores.set(docId, recencyScore);
        docSentimentScores.set(docId, sentimentScore);
        docEmotions.set(docId, emotion);
        docMeta.set(docId, {
            label,
            summary,
            created_at: createdAt,
            updated_at: updatedAt,
            recencyScore,
            sentiment_score: sentimentScore,
            emotion,
            word_count: wordCount,
            entity_count: entityCount,
        });
        docNodes.push({
            id: `doc:${docId}`,
            rawId: docId,
            label,
            type: 'doc',
            weight: docCounts[docId] || 1,
            recencyScore,
            sentimentScore,
            emotion,
            summary,
        });
    });

    let nodes = [...entityNodes, ...docNodes];
    let links = [...entityDocLinks];

    const includeEntities = filters?.includeEntities !== false;
    const includeDocs = filters?.includeDocs !== false;
    if (!includeEntities || !includeDocs) {
        nodes = nodes.filter(node => {
            if (node.type === 'entity' && !includeEntities) return false;
            if (node.type === 'doc' && !includeDocs) return false;
            return true;
        });
    }

    const allowedNodeIds = new Set(nodes.map(node => node.id));
    const allowedDocIds = new Set(nodes.filter(node => node.type === 'doc').map(node => node.rawId));
    links = links.filter(link => allowedNodeIds.has(link.source) && allowedNodeIds.has(link.target));

    const includeDocConnections = filters.includeDocConnections !== false;
    const minShared = Math.max(1, parseInt(filters.minSharedEntities, 10) || 1);
    if (includeDocConnections) {
        docRelationshipsRaw.forEach(rel => {
            if (!rel || !rel.source || !rel.target) return;
            if ((rel.weight || 0) < minShared) return;
            if (!allowedDocIds.has(rel.source) || !allowedDocIds.has(rel.target)) return;
            links.push({
                source: `doc:${rel.source}`,
                target: `doc:${rel.target}`,
                type: 'doc-link',
                weight: rel.weight || 1,
                sharedEntities: rel.shared_entities || [],
            });
        });
    }

    const searchTerm = (filters?.search || '').trim().toLowerCase();
    let searchScope = null;
    let searchMatches = null;
    if (searchTerm) {
        const matched = new Set(
            nodes
                .filter(node => {
                    if ((node.label || '').toLowerCase().includes(searchTerm)) return true;
                    if ((node.rawId || '').toLowerCase().includes(searchTerm)) return true;
                    if (node.type === 'doc') {
                        const meta = docMeta.get(node.rawId);
                        if (meta && (meta.summary || '').toLowerCase().includes(searchTerm)) return true;
                    }
                    return false;
                })
                .map(node => node.id)
        );
        if (matched.size > 0) {
            searchMatches = new Set(matched);
            const expanded = new Set(matched);
            links.forEach(link => {
                if (matched.has(link.source) || matched.has(link.target)) {
                    expanded.add(link.source);
                    expanded.add(link.target);
                }
            });
            searchScope = expanded;
            nodes = nodes.filter(node => expanded.has(node.id));
            const allowed = new Set(nodes.map(node => node.id));
            links = links.filter(link => allowed.has(link.source) && allowed.has(link.target));
        } else {
            nodes = [];
            links = [];
        }
    }

    const degreeMap = {};
    links.forEach(link => {
        degreeMap[link.source] = (degreeMap[link.source] || 0) + 1;
        degreeMap[link.target] = (degreeMap[link.target] || 0) + 1;
    });

    nodes.forEach(node => {
        node.degree = degreeMap[node.id] || 0;
        if (node.type === 'entity') {
            const docIds = node.docIds || [];
            const bestScore = docIds.reduce((score, docId) => {
                const candidate = docRecencyScores.get(docId);
                return candidate !== undefined && candidate > score ? candidate : score;
            }, 0);
            node.recencyScore = bestScore;
        } else if (node.type === 'doc') {
            node.recencyScore = docRecencyScores.get(node.rawId) || node.recencyScore || 0;
            node.sentimentScore = docSentimentScores.get(node.rawId) || node.sentimentScore || 0;
            node.emotion = docEmotions.get(node.rawId) || node.emotion || 'neutral';
        }
    });

    const minLinks = Math.max(0, parseInt(filters?.minLinks, 10) || 1);
    if (minLinks > 1) {
        const preservedBySearch = searchScope ? new Set(searchScope) : null;
        nodes = nodes.filter(node => {
            if (preservedBySearch && preservedBySearch.has(node.id)) return true;
            return (node.degree || 0) >= minLinks;
        });
        const allowed = new Set(nodes.map(node => node.id));
        links = links.filter(link => allowed.has(link.source) && allowed.has(link.target));
    }

    if (searchMatches) {
        nodes.forEach(node => {
            node.isSearchMatch = searchMatches.has(node.id);
        });
    }

    links = links.map(link => {
        if (link.type === 'doc-link') {
            const sourceScore = docRecencyScores.get(link.source.replace('doc:', '')) || 0.3;
            const targetScore = docRecencyScores.get(link.target.replace('doc:', '')) || 0.3;
            return {...link, recencyScore: Math.max(sourceScore, targetScore)};
        }
        const docId = link.rawDocId || (link.target && String(link.target).startsWith('doc:') ? String(link.target).slice(4) : null);
        const recency = docId ? (docRecencyScores.get(docId) ?? 0.3) : 0.3;
        return {...link, recencyScore: recency};
    });

    const visibleDocIds = new Set(nodes.filter(node => node.type === 'doc').map(node => node.rawId));
    const filteredDocMeta = new Map();
    visibleDocIds.forEach(docId => {
        if (docMeta.has(docId)) filteredDocMeta.set(docId, docMeta.get(docId));
    });

    return {
        nodes,
        links,
        stats: {
            entityCount: nodes.filter(node => node.type === 'entity').length,
            docCount: nodes.filter(node => node.type === 'doc').length,
            linkCount: links.length,
        },
        docMeta: filteredDocMeta,
    };
}

async function openKnowledgeGraphOverlay(options = {}) {
    if (typeof d3 === 'undefined') {
        toast('Graph view requires D3. Please refresh the page.', true);
        return;
    }
    const {forceRefresh = false} = options;
    if (forceRefresh || !state.knowledgeGraph?.entities?.length) {
        await fetchUserEntities(true);
    }
    const overlay = document.getElementById('knowledgeGraphOverlay');
    if (!overlay) return;
    overlay.classList.add('active');
    knowledgeGraphOverlayOpen = true;
    syncGraphFilterControls();
    renderKnowledgeGraphOverlay();
}

function closeKnowledgeGraphOverlay() {
    const overlay = document.getElementById('knowledgeGraphOverlay');
    if (!overlay) return;
    overlay.classList.remove('active');
    knowledgeGraphOverlayOpen = false;
    if (knowledgeGraphSimulation) {
        knowledgeGraphSimulation.stop();
        knowledgeGraphSimulation = null;
    }
}

function renderKnowledgeGraphOverlay() {
    const overlay = document.getElementById('knowledgeGraphOverlay');
    if (!overlay || !knowledgeGraphOverlayOpen) return;
    const svgEl = document.getElementById('knowledgeGraphSvg');
    const infoEl = document.getElementById('knowledgeGraphOverlayInfo');
    const subtitleEl = document.getElementById('knowledgeGraphOverlaySubtitle');
    if (!svgEl) return;

    const {nodes, links, stats, docMeta} = buildKnowledgeGraphData();
    const filters = getGraphFilters();
    const filterActive = !!((filters?.search || '').length || (parseInt(filters?.minLinks, 10) || 1) > 1 || filters?.includeDocs === false || filters?.includeEntities === false || filters?.includeDocConnections === false || filters?.recentOnly);
    const hasData = nodes.length > 0;
    if (subtitleEl) {
        subtitleEl.textContent = hasData
            ? 'Entities connected to your documents'
            : filterActive
                ? 'No graph matches the current filters.'
                : 'Knowledge graph will grow as you tag more entities.';
    }
    if (!hasData) {
        const message = filterActive
            ? 'Adjust your filters to explore more knowledge graph connections.'
            : 'Add more entities across documents to visualize your knowledge graph.';
        svgEl.innerHTML = `<foreignObject x="0" y="0" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="height:100%;display:flex;align-items:center;justify-content:center;color:#047857;font-size:12px;padding:0 32px;text-align:center;">${message}</div></foreignObject>`;
        if (infoEl) infoEl.textContent = '0 entities • 0 documents • 0 connections';
        return;
    }

    const rect = svgEl.getBoundingClientRect();
    const width = rect.width || 760;
    const height = rect.height || 520;

    svgEl.setAttribute('viewBox', `0 0 ${width} ${height}`);
    const svg = d3.select(svgEl);
    svg.selectAll('*').remove();

    const docMetaMap = docMeta || new Map();

    const colorForDoc = (node) => {
        const emotion = (node.emotion || '').toLowerCase();
        if (emotion === 'joy' || emotion === 'positive' || emotion === 'delight') return '#0ea5e9';
        if (emotion === 'anger' || emotion === 'sadness' || emotion === 'fear' || emotion === 'negative') return '#f97316';
        return '#38bdf8';
    };

    nodes.forEach(node => {
        const base = node.type === 'entity' ? 20 : 14;
        const weightFactor = Math.max(1, node.weight || 1);
        const recency = typeof node.recencyScore === 'number' ? node.recencyScore : 0.2;
        const boost = 0.8 + recency * 0.7;
        let radius = Math.max(base, Math.min(base * boost + weightFactor * 3, 54));
        if (node.isSearchMatch) {
            radius = Math.min(radius + 6, 60);
        }
        node.radius = radius;
        node.fillOpacity = 0.45 + recency * 0.55;
        node.strokeOpacity = 0.5 + recency * 0.5;
        node.strokeWidth = 1.8 + recency * 1.2;
        if (node.type === 'doc') {
            node.fillColor = colorForDoc(node);
        }
    });

    knowledgeGraphSimulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links).id(d => d.id).distance(d => {
            if (d.rawDocId) {
                const recency = d.recencyScore || 0.3;
                return Math.max(90, 160 - recency * 60);
            }
            return 110;
        }).strength(0.6))
        .force('charge', d3.forceManyBody().strength(-320))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(d => d.radius + 12));

    const link = svg.append('g')
        .selectAll('line')
        .data(links)
        .enter()
        .append('line')
        .attr('stroke', d => d.type === 'doc-link' ? '#f59e0b' : '#0f766e')
        .attr('stroke-width', d => d.type === 'doc-link' ? Math.min(4, 1.2 + (d.weight || 1)) : 1.4)
        .attr('stroke-dasharray', d => d.type === 'doc-link' ? '4 3' : null)
        .attr('stroke-opacity', d => 0.25 + (d.recencyScore || 0.3) * 0.55);

    const node = svg.append('g')
        .selectAll('g')
        .data(nodes)
        .enter()
        .append('g')
        .call(d3.drag()
            .on('start', (event, d) => {
                if (!event.active) knowledgeGraphSimulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            })
            .on('drag', (event, d) => {
                d.fx = event.x;
                d.fy = event.y;
            })
            .on('end', (event, d) => {
                if (!event.active) knowledgeGraphSimulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            })
        );

    node.append('circle')
        .attr('r', d => d.radius)
        .attr('fill', d => d.type === 'entity' ? '#047857' : (d.fillColor || colorForDoc(d)))
        .attr('fill-opacity', d => d.fillOpacity || 0.75)
        .attr('stroke', d => d.isSearchMatch ? '#f97316' : '#ffffff')
        .attr('stroke-opacity', d => d.strokeOpacity || 0.8)
        .attr('stroke-width', d => d.strokeWidth || 2);

    node.append('text')
        .attr('text-anchor', 'middle')
        .attr('dy', d => d.type === 'entity' ? d.radius + 14 : d.radius + 12)
        .attr('fill', '#0f172a')
        .attr('font-size', '11px')
        .attr('font-weight', d => d.isSearchMatch ? 700 : (d.type === 'entity' ? 600 : 500))
        .text(d => d.label.length > 24 ? `${d.label.slice(0, 24)}…` : d.label);

    node.append('title').text(d => {
        if (d.type === 'entity') {
            return `${d.label} • ${d.weight || 0} doc${(d.weight || 0) === 1 ? '' : 's'}`;
        }
        const meta = docMetaMap.get(d.rawId);
        const updatedLabel = meta?.updated_at ? `Updated ${getTimeAgo(new Date(meta.updated_at).getTime())}` : 'Recently unseen';
        const summary = meta?.summary ? `\n${meta.summary.slice(0, 280)}` : '';
        const sentiment = typeof d.sentimentScore === 'number' ? `Sentiment ${d.sentimentScore >= 0 ? '+' : ''}${(d.sentimentScore * 100).toFixed(0)}% ${d.emotion || ''}` : '';
        const entitiesCount = meta?.entity_count ? `${meta.entity_count} shared entities` : '';
        const details = [updatedLabel, sentiment, entitiesCount].filter(Boolean).join(' • ');
        return `${d.label}${details ? `\n${details}` : ''}${summary}`;
    });

    link.append('title').text(d => {
        if (d.type === 'doc-link' && d.sharedEntities && d.sharedEntities.length) {
            return `Shared entities: ${d.sharedEntities.slice(0, 6).join(', ')}`;
        }
        if (d.rawDocId) {
            return `Linked via ${d.rawDocId}`;
        }
        return '';
    });

    node.on('click', (event, d) => {
        event.preventDefault();
        if (d.type === 'entity') {
            showEntityDetail(d.rawId, 'global');
        } else {
            openDocFromEntity(d.rawId);
        }
    });

    knowledgeGraphSimulation.on('tick', () => {
        node.attr('transform', d => {
            d.x = Math.max(d.radius + 10, Math.min(width - d.radius - 10, d.x));
            d.y = Math.max(d.radius + 10, Math.min(height - d.radius - 10, d.y));
            return `translate(${d.x},${d.y})`;
        });
        link
            .attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);
    });

    if (infoEl) {
        const filterSuffix = filterActive ? ' • Filters applied' : '';
        infoEl.textContent = `${stats.entityCount} entit${stats.entityCount === 1 ? 'y' : 'ies'} • ${stats.docCount} document${stats.docCount === 1 ? '' : 's'} • ${stats.linkCount} connection${stats.linkCount === 1 ? '' : 's'}${filterSuffix}`;
    }
}

async function fetchTemporalAnalytics(force = false) {
    if (!state.temporalAnalytics) state.temporalAnalytics = {data: null, lastFetched: 0, loading: false, error: null};
    const now = Date.now();
    if (!force && state.temporalAnalytics.data && now - (state.temporalAnalytics.lastFetched || 0) < TEMPORAL_CACHE_TTL) {
        return;
    }
    if (state.temporalAnalytics.loading) return;
    if (!state.user || state.user.isGuest) {
        state.temporalAnalytics = {data: null, lastFetched: 0, loading: false, error: null};
        renderTemporalAnalyticsInsights();
        return;
    }
    state.temporalAnalytics.loading = true;
    state.temporalAnalytics.error = null;
    renderTemporalAnalyticsInsights();
    try {
        const headers = {'Content-Type': 'application/json'};
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
        const res = await fetch(`${API}/dev/analytics/temporal?user_id=${encodeURIComponent(state.user.sub)}`, {headers});
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        state.temporalAnalytics = {
            data,
            lastFetched: Date.now(),
            loading: false,
            error: null,
        };
        saveState();
    } catch (error) {
        console.warn('Temporal analytics fetch failed', error);
        state.temporalAnalytics.loading = false;
        state.temporalAnalytics.error = 'Unable to load analytics right now.';
    }
    renderTemporalAnalyticsInsights();
}

function buildTemporalSparkline(points, options = {}) {
    if (!points || points.length === 0) return '';
    const width = options.width || 220;
    const height = options.height || 60;
    const values = points.map(p => (typeof p === 'number' ? p : (p.moving_average ?? p.sentiment ?? 0)));
    const min = Math.min(...values, 0);
    const max = Math.max(...values, 0.001);
    const range = max - min || 1;
    const step = width / Math.max(1, points.length - 1);
    const path = points
        .map((point, idx) => {
            const value = typeof point === 'number' ? point : (point.moving_average ?? point.sentiment ?? 0);
            const x = Math.round(idx * step);
            const y = Math.round(height - ((value - min) / range) * height);
            return `${idx === 0 ? 'M' : 'L'}${x},${y}`;
        })
        .join(' ');
    return `<svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none" class="w-full h-16">
        <path d="${path}" fill="none" stroke="url(#sparkGradient)" stroke-width="2"/>
        <defs>
            <linearGradient id="sparkGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#10b981"/>
                <stop offset="100%" stop-color="#0ea5e9"/>
            </linearGradient>
        </defs>
    </svg>`;
}

function renderTemporalAnalyticsInsights() {
    const container = document.getElementById('temporalAnalyticsSection');
    if (!container) return;
    const analyticsState = state.temporalAnalytics || {data: null, loading: false};
    if (analyticsState.loading) {
        container.innerHTML = '<div class="text-xs text-gray-500">Analyzing your timeline…</div>';
        return;
    }
    if (analyticsState.error) {
        container.innerHTML = `<div class="text-xs text-red-500">${analyticsState.error}</div>`;
        return;
    }
    if (!analyticsState.data) {
        container.innerHTML = '<div class="text-xs text-gray-500">Temporal analytics will appear once you have a few entries.</div>';
        return;
    }
    const data = analyticsState.data;
    const generatedAt = data.generated_at ? new Date(data.generated_at).toLocaleString() : '';
    const sentimentPoints = (data.sentiment_timeline || []).map(point => ({
        sentiment: point.sentiment,
        moving_average: point.moving_average ?? point.sentiment,
    }));
    const sparkline = sentimentPoints.length > 1 ? buildTemporalSparkline(sentimentPoints) : '';
    const insightsList = (data.insights || []).map(item => `<li class="leading-snug">${escapeHtml(item)}</li>`).join('');
    const topics = (data.monthly_topics || []).slice(-2).map(entry => {
        const chips = (entry.topics || []).map(topicEntry => `<span class="inline-flex items-center gap-1 px-2 py-1 bg-emerald-50 border border-emerald-100 rounded-full text-[10px] text-emerald-700">${escapeHtml(topicEntry.topic)}<span class="opacity-60">×${topicEntry.count}</span></span>`).join(' ');
        return `<div class="flex flex-col gap-1">
            <div class="text-[10px] uppercase tracking-wide text-gray-400">${escapeHtml(entry.month)}</div>
            <div class="flex flex-wrap gap-1">${chips}</div>
        </div>`;
    }).join('');
    const weeklyTotals = data.velocity?.weekly_totals || [];
    const latestWeek = weeklyTotals.length ? weeklyTotals[weeklyTotals.length - 1] : null;
    const prevWeek = weeklyTotals.length > 1 ? weeklyTotals[weeklyTotals.length - 2] : null;
    const weekDelta = latestWeek && prevWeek ? latestWeek.words - prevWeek.words : 0;
    const deltaBadge = latestWeek
        ? `<span class="text-[10px] font-semibold ${weekDelta >= 0 ? 'text-emerald-600' : 'text-orange-600'}">
            ${weekDelta >= 0 ? '▲' : '▼'} ${Math.abs(weekDelta)}
        </span>`
        : '';
    container.innerHTML = `
        <div class="border border-emerald-100 rounded-xl p-3 bg-white/80 space-y-3">
            <div class="flex items-center justify-between">
                <div class="text-xs font-semibold text-emerald-700">📈 Temporal Analytics</div>
                <button id="refreshTemporalBtn" class="text-[10px] px-2 py-0.5 rounded-full border border-emerald-200 text-emerald-600 hover:bg-emerald-50">Refresh</button>
            </div>
            ${sparkline ? `<div class="w-full">${sparkline}</div>` : ''}
            <div class="grid grid-cols-2 gap-2 text-[11px]">
                <div class="rounded-lg bg-emerald-50/70 border border-emerald-100 px-3 py-2">
                    <div class="text-[10px] uppercase tracking-wide text-emerald-500">Weekly Words</div>
                    <div class="text-emerald-700 font-semibold">${latestWeek ? latestWeek.words : 0}</div>
                    ${deltaBadge}
                </div>
                <div class="rounded-lg bg-cyan-50/70 border border-cyan-100 px-3 py-2">
                    <div class="text-[10px] uppercase tracking-wide text-cyan-500">Streak</div>
                    <div class="text-cyan-700 font-semibold">${data.velocity?.streak_days || 0} days</div>
                </div>
            </div>
            ${topics ? `<div class="space-y-2">
                <div class="text-[10px] uppercase tracking-wide text-gray-400">Trending Topics</div>
                ${topics}
            </div>` : ''}
            ${insightsList ? `<div>
                <div class="text-[10px] uppercase tracking-wide text-gray-400">Predictive Insights</div>
                <ul class="list-disc ml-4 text-xs space-y-1">${insightsList}</ul>
            </div>` : ''}
            <div class="text-[10px] text-gray-400">Updated ${generatedAt}</div>
        </div>
    `;
    const refreshBtn = document.getElementById('refreshTemporalBtn');
    if (refreshBtn) {
        refreshBtn.onclick = () => fetchTemporalAnalytics(true);
    }
}

async function fetchWikiPage(pageId, options = {}) {
    if (!state.user || state.user.isGuest) return null;
    if (!state.wikiCache) state.wikiCache = {};
    const cacheEntry = state.wikiCache[pageId];
    const force = options.force === true;
    if (!force && cacheEntry && Date.now() - (cacheEntry.cachedAt || 0) < WIKI_CACHE_TTL) {
        return cacheEntry.page;
    }
    const params = new URLSearchParams({user_id: state.user.sub});
    if (options.autoCreate) {
        params.set('auto_create', 'true');
        if (options.entityId) params.set('entity_id', options.entityId);
    }
    const headers = {'Content-Type': 'application/json'};
    if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
    const res = await fetch(`${API}/dev/wiki/${encodeURIComponent(pageId)}?${params.toString()}`, {headers});
    if (res.ok) {
        const page = await res.json();
        state.wikiCache[pageId] = {page, cachedAt: Date.now()};
        saveState();
        return page;
    }
    if (res.status === 404 && !options.autoCreate) {
        return null;
    }
    throw new Error(`wiki_fetch_failed:${res.status}`);
}

async function saveWikiPage(pageId, payload) {
    if (!state.user || state.user.isGuest) throw new Error('not_authenticated');
    const headers = {'Content-Type': 'application/json'};
    if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
    const body = {
        user_id: state.user.sub,
        page_id: pageId,
        entity_id: payload.entityId,
        title: payload.title,
        sections: payload.sections,
        version: payload.version,
    };
    const res = await fetch(`${API}/dev/wiki`, {
        method: 'POST',
        headers,
        body: JSON.stringify(body),
    });
    if (res.status === 409) {
        const data = await res.json();
        return {conflict: true, latest: data.page};
    }
    if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        throw new Error(data.error || 'Unable to save wiki page');
    }
    const data = await res.json();
    if (data.page) {
        state.wikiCache = state.wikiCache || {};
        state.wikiCache[data.page.page_id] = {page: data.page, cachedAt: Date.now()};
        saveState();
    }
    return {page: data.page, warnings: data.warnings || []};
}

async function openWikiForEntity(entityId, options = {}) {
    if (!state.user || state.user.isGuest) {
        toast('Sign in to build your knowledge wiki.', true);
        return;
    }
    try {
        const pageId = entityId || `wiki-${state.user.sub}`;
        const page = await fetchWikiPage(pageId, {entityId, autoCreate: true, force: options.force});
        if (page) {
            showWikiModal(page, {entityId});
        } else {
            toast('Wiki page not found.', true);
        }
    } catch (error) {
        console.warn('Wiki load failed', error);
        toast('Unable to load wiki right now.', true);
    }
}

async function exportWikiPage(pageId, title) {
    if (!state.user || state.user.isGuest) return;
    const params = new URLSearchParams({user_id: state.user.sub});
    const headers = {};
    if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
    const res = await fetch(`${API}/dev/wiki/${encodeURIComponent(pageId)}/export?${params.toString()}`, {headers});
    if (!res.ok) {
        toast('Unable to export wiki page.', true);
        return;
    }
    const markdown = await res.text();
    const blob = new Blob([markdown], {type: 'text/markdown'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${(title || 'wiki').replace(/[^a-z0-9-_]+/gi, '_')}.md`;
    document.body.appendChild(link);
    link.click();
    setTimeout(() => {
        URL.revokeObjectURL(link.href);
        link.remove();
    }, 0);
}

function showWikiModal(page, options = {}) {
    let overlay = document.getElementById('wikiOverlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'wikiOverlay';
        overlay.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-[120]';
        document.body.appendChild(overlay);
    }
    overlay.dataset.pageId = page.page_id;
    overlay.dataset.version = page.version || 1;
    overlay.dataset.entityId = options.entityId || page.entity_id || '';
    const sections = page.sections || [];
    overlay.innerHTML = `
        <div class="w-[720px] max-h-[85vh] bg-white/95 rounded-3xl border border-emerald-200 shadow-2xl flex flex-col">
            <div class="flex items-center justify-between px-5 py-4 border-b border-emerald-100 bg-gradient-to-r from-emerald-50 via-white to-cyan-50 rounded-t-3xl">
                <div class="flex flex-col gap-1">
                    <input id="wikiTitleInput" class="text-lg font-semibold text-emerald-700 bg-transparent focus:outline-none" value="${escapeHtmlAttr(page.title || 'Untitled Wiki')}" maxlength="120"/>
                    <div class="text-[11px] text-gray-500">Last updated ${page.updated_at ? new Date(page.updated_at).toLocaleString() : '—'} • ${sections.length} section${sections.length === 1 ? '' : 's'}</div>
                </div>
                <div class="flex gap-2">
                    <button id="wikiExportBtn" class="text-[11px] px-3 py-1 rounded-full border border-emerald-200 text-emerald-600 hover:bg-emerald-50">Export</button>
                    <button id="wikiCloseBtn" class="text-[11px] px-3 py-1 rounded-full border border-emerald-200 text-emerald-600 hover:bg-emerald-50">Close</button>
                </div>
            </div>
            <div class="flex-1 overflow-auto px-5 py-4 space-y-4" id="wikiSectionsContainer">
                ${sections.map(section => `
                    <div class="wiki-section border border-emerald-100 rounded-xl p-4 bg-white/80" data-section-id="${escapeHtmlAttr(section.id)}">
                        <div class="flex items-center justify-between gap-2 mb-2">
                            <input class="wiki-section-title w-full text-sm font-semibold text-emerald-700 bg-transparent border-b border-emerald-100 focus:outline-none focus:border-emerald-300" value="${escapeHtmlAttr(section.title || '')}" maxlength="200"/>
                            <button class="wiki-remove-section text-[10px] px-2 py-0.5 rounded-full border border-red-200 text-red-500 hover:bg-red-50">Remove</button>
                        </div>
                        <textarea class="wiki-section-content w-full h-28 text-xs leading-relaxed border border-emerald-100 rounded-lg px-3 py-2 focus:outline-none focus:border-emerald-300" placeholder="Add details">${escapeHtml(section.content || '')}</textarea>
                    </div>
                `).join('')}
            </div>
            <div class="px-5 py-4 border-t border-emerald-100 flex items-center justify-between bg-white/90 rounded-b-3xl">
                <div class="flex items-center gap-2 text-[11px] text-gray-500">
                    <button id="wikiAddSectionBtn" class="px-3 py-1 rounded-full border border-emerald-200 text-emerald-600 hover:bg-emerald-50">+ Section</button>
                    <span>Auto-saved pages are versioned for safe collaboration.</span>
                </div>
                <div class="flex items-center gap-2">
                    <span id="wikiStatusMessage" class="text-[11px] text-gray-400"></span>
                    <button id="wikiSaveBtn" class="px-4 py-1 rounded-full bg-emerald-500 text-white text-[11px] hover:bg-emerald-600">Save</button>
                </div>
            </div>
        </div>
    `;
    overlay.onclick = (event) => {
        if (event.target === overlay) closeWikiModal();
    };
    const closeBtn = overlay.querySelector('#wikiCloseBtn');
    if (closeBtn) closeBtn.onclick = () => closeWikiModal();
    const addBtn = overlay.querySelector('#wikiAddSectionBtn');
    if (addBtn) addBtn.onclick = () => addWikiSection(overlay);
    overlay.querySelectorAll('.wiki-remove-section').forEach(btn => {
        btn.addEventListener('click', (event) => {
            event.preventDefault();
            const section = btn.closest('.wiki-section');
            section?.remove();
        });
    });
    const saveBtn = overlay.querySelector('#wikiSaveBtn');
    if (saveBtn) {
        saveBtn.onclick = async () => {
            try {
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving…';
                const titleInput = overlay.querySelector('#wikiTitleInput');
                const sectionsToSave = collectWikiSectionsFromModal(overlay);
                const pageId = overlay.dataset.pageId;
                const version = parseInt(overlay.dataset.version || '1', 10);
                const response = await saveWikiPage(pageId, {
                    title: titleInput.value.trim() || 'Untitled Wiki',
                    sections: sectionsToSave,
                    version,
                    entityId: overlay.dataset.entityId || null,
                });
                if (response.conflict && response.latest) {
                    showWikiModal(response.latest, {entityId: response.latest.entity_id});
                    toast('Wiki updated elsewhere. Showing latest version.', true);
                } else if (response.page) {
                    showWikiModal(response.page, {entityId: response.page.entity_id});
                    toast('✅ Wiki saved');
                }
            } catch (error) {
                console.warn('Wiki save failed', error);
                toast('Unable to save wiki page.', true);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save';
            }
        };
    }
    const exportBtn = overlay.querySelector('#wikiExportBtn');
    if (exportBtn) {
        exportBtn.onclick = () => exportWikiPage(page.page_id, page.title);
    }
    document.addEventListener('keydown', wikiEscapeHandler, {once: true});
}

function collectWikiSectionsFromModal(modal) {
    const sections = [];
    modal.querySelectorAll('.wiki-section').forEach(section => {
        const id = section.dataset.sectionId || `section-${Date.now().toString(36)}`;
        const title = section.querySelector('.wiki-section-title')?.value || '';
        const content = section.querySelector('.wiki-section-content')?.value || '';
        sections.push({id, title, content});
    });
    return sections;
}

function addWikiSection(modal) {
    const container = modal.querySelector('#wikiSectionsContainer');
    if (!container) return;
    const newId = `section-${Date.now().toString(36)}`;
    const wrapper = document.createElement('div');
    wrapper.className = 'wiki-section border border-emerald-100 rounded-xl p-4 bg-white/80';
    wrapper.dataset.sectionId = newId;
    wrapper.innerHTML = `
        <div class="flex items-center justify-between gap-2 mb-2">
            <input class="wiki-section-title w-full text-sm font-semibold text-emerald-700 bg-transparent border-b border-emerald-100 focus:outline-none focus:border-emerald-300" placeholder="Section title" maxlength="200"/>
            <button class="wiki-remove-section text-[10px] px-2 py-0.5 rounded-full border border-red-200 text-red-500 hover:bg-red-50">Remove</button>
        </div>
        <textarea class="wiki-section-content w-full h-28 text-xs leading-relaxed border border-emerald-100 rounded-lg px-3 py-2 focus:outline-none focus:border-emerald-300" placeholder="Add details"></textarea>
    `;
    container.appendChild(wrapper);
    wrapper.querySelector('.wiki-remove-section')?.addEventListener('click', (event) => {
        event.preventDefault();
        wrapper.remove();
    });
    wrapper.querySelector('.wiki-section-title')?.focus();
}

function closeWikiModal() {
    const overlay = document.getElementById('wikiOverlay');
    if (overlay) overlay.remove();
}

function wikiEscapeHandler(event) {
    if (event.key === 'Escape') {
        closeWikiModal();
    }
}

function attachAllEvents() {
    console.log('Attaching all event handlers...');
    
    // Helper to safely attach events
    const on = (id, event, handler) => {
        const el = document.getElementById(id);
        if (el) el[event] = handler;
    };
    
    // Document management
    on('uploadBtn', 'onclick', () => document.getElementById('fileInput').click());
    on('newBtn', 'onclick', createNewDoc);
    on('addTabBtn', 'onclick', createNewDoc);
    on('toggleSidebarBtn', 'onclick', () => {
        const sidebar = document.getElementById('leftSidebar');
        if (document.body.classList.contains('chatpdf-mode')) {
            sidebar.classList.toggle('sidebar-open');
        } else {
            sidebar.classList.toggle('collapsed');
        }
    });
    on('logoBtn', 'onclick', () => {
        const sidebar = document.getElementById('leftSidebar');
        if (sidebar.classList.contains('collapsed')) {
            sidebar.classList.remove('collapsed');
        } else {
            window.location.href = 'https://documentgpt.io';
        }
    });
    on('searchBtn', 'onclick', () => { const q = prompt('Search documents:'); if (q) toast('Search: ' + q); });
    on('libraryBtn', 'onclick', openLibrary);
    on('newFolderBtn', 'onclick', () => showModal('folderModal'));
    on('closeFolderModal', 'onclick', () => hideModal('folderModal'));
    on('createFolderBtn', 'onclick', createFolder);
    on('settingsBtn', 'onclick', openSettings);
    on('docIQTips', 'onclick', showDocIQTips);
    on('refreshDocEntitiesBtn', 'onclick', () => {
        const doc = state.docs.find(d => d.id === state.activeId);
        if (doc) ensureDocEntities(doc, true);
    });
    on('refreshKnowledgeGraphBtn', 'onclick', () => fetchUserEntities(true));
    on('openGraphViewBtn', 'onclick', () => openKnowledgeGraphOverlay());
    on('graphRefreshBtn', 'onclick', async () => {
        await fetchUserEntities(true);
        renderKnowledgeGraphOverlay();
    });
    on('closeKnowledgeGraphOverlayBtn', 'onclick', () => closeKnowledgeGraphOverlay());
    const graphBackdrop = document.getElementById('knowledgeGraphOverlayBackdrop');
    if (graphBackdrop) graphBackdrop.onclick = () => closeKnowledgeGraphOverlay();
    on('collapseKGBtn', 'onclick', () => {
        const btn = document.getElementById('collapseKGBtn');
        const collapsed = (btn?.dataset.state || 'open') === 'open';
        setKnowledgeGraphCollapsed(collapsed);
    });
    on('closeEntityDetail', 'onclick', () => clearEntityDetail());
    on('graphMinLinksSelect', 'onchange', (e) => updateGraphFilters({minLinks: parseInt(e.target.value, 10) || 1}));
    on('graphIncludeEntities', 'onchange', (e) => updateGraphFilters({includeEntities: !!e.target.checked}));
    on('graphIncludeDocs', 'onchange', (e) => updateGraphFilters({includeDocs: !!e.target.checked}));
    on('graphIncludeDocLinks', 'onchange', (e) => updateGraphFilters({includeDocConnections: !!e.target.checked}));
    on('graphMinSharedSelect', 'onchange', (e) => updateGraphFilters({minSharedEntities: parseInt(e.target.value, 10) || 1}));
    on('graphRecentOnly', 'onchange', (e) => updateGraphFilters({recentOnly: !!e.target.checked}));
    on('graphSearchInput', 'oninput', (e) => {
        const value = e.target.value || '';
        clearTimeout(graphSearchDebounce);
        graphSearchDebounce = setTimeout(() => updateGraphFilters({search: value.trim()}), 180);
    });
    
    // File upload
    on('fileInput', 'onchange', handleFileUpload);
    
    // Chat with debounce
    on('sendBtn', 'onclick', sendChat);
    let chatDebounce;
    on('chatInput', 'onkeydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            clearTimeout(chatDebounce);
            chatDebounce = setTimeout(() => sendChat(), 200);
        }
        // Shift+Enter creates newline (default behavior, don't prevent)
    });
    
    // Agents menu
    on('agentsBtn', 'onclick', (e) => {
        e.stopPropagation();
        const menu = document.getElementById('agentsMenu');
        const isHidden = menu.classList.toggle('hidden');
        e.target.setAttribute('aria-expanded', !isHidden);
    });
    document.addEventListener('click', () => {
        document.getElementById('agentsMenu')?.classList.add('hidden');
    });
    
    // Modals
    on('upgradeBtn', 'onclick', () => showModal('upgradeModal'));
    on('closeUpgrade', 'onclick', () => hideModal('upgradeModal'));
    on('signupBtn', 'onclick', () => showModal('signupModal'));
    on('closeLogin', 'onclick', () => hideModal('loginModal'));
    on('closeSignup', 'onclick', () => hideModal('signupModal'));
    on('showSignup', 'onclick', () => { hideModal('loginModal'); showModal('signupModal'); });
    on('showLogin', 'onclick', () => { hideModal('signupModal'); showModal('loginModal'); });
    on('forgotPassword', 'onclick', () => { hideModal('loginModal'); showModal('forgotPasswordModal'); });
    on('backToLogin', 'onclick', () => { hideModal('forgotPasswordModal'); showModal('loginModal'); });
    on('closeForgotPassword', 'onclick', () => hideModal('forgotPasswordModal'));
    on('forgotPasswordSubmit', 'onclick', handleForgotPassword);
    on('closeVerifyEmail', 'onclick', () => hideModal('verifyEmailModal'));
    on('verifyEmailSubmit', 'onclick', handleVerifyEmail);
    on('resendCodeBtn', 'onclick', () => {
        const email = document.getElementById('verifyEmail').value;
        resendVerificationCode(email);
    });
    
    // Auth
    on('loginSubmit', 'onclick', handleLogin);
    on('signupSubmit', 'onclick', handleSignup);
    

    
    // Command palette
    const paletteBtn = document.getElementById('paletteBtn');
    if (paletteBtn) paletteBtn.onclick = () => showModal('palette');
    const paletteItems = document.getElementById('paletteItems');
    if (paletteItems) {
        paletteItems.querySelectorAll('button').forEach(btn => {
            btn.onclick = () => {
                const cmd = btn.dataset.cmd;
                hideModal('palette');
                executeCommand(cmd);
            };
        });
    }
    
    // More menu
    on('moreBtn', 'onclick', (e) => {
        e.stopPropagation();
        document.getElementById('toneMenu')?.remove();
        document.getElementById('moreMenu').classList.toggle('hidden');
    });
    document.addEventListener('click', () => {
        document.getElementById('moreMenu')?.classList.add('hidden');
    });
    
    // Theme & Focus & History & Mode
    on('themeBtn', 'onclick', () => { toggleTheme(); document.getElementById('moreMenu').classList.add('hidden'); });
    on('focusBtn', 'onclick', toggleFocus);
    on('focusBtnMenu', 'onclick', () => { toggleFocus(); document.getElementById('moreMenu').classList.add('hidden'); });
    on('historyBtn', 'onclick', () => { showVersionHistory(); document.getElementById('moreMenu').classList.add('hidden'); });
    on('coachBtn', 'onclick', () => { showWritingCoach(); document.getElementById('moreMenu').classList.add('hidden'); });
    on('settingsBtn', 'onclick', () => { openSettings(); document.getElementById('moreMenu').classList.add('hidden'); });
    on('autocompleteSettingsBtn', 'onclick', () => { openAutocompleteSettings(); document.getElementById('moreMenu').classList.add('hidden'); });
    on('modeToggle', 'onclick', toggleMode);
    
    // R1: Highlights
    on('highlightLegendBtn','onclick',()=>{toggleHighlightLegend();document.getElementById('moreMenu').classList.add('hidden');});
    document.addEventListener('mouseup',handleTextSelection);
    document.addEventListener('selectionchange',handleTextSelection);
    
    // Voice input with editor support
    const micBtn = document.getElementById('micBtn');
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SR) {
        const rec = new SR();
        rec.continuous = true;
        rec.interimResults = true;
        rec.lang = 'en-US';
        let listening = false;
        let finalTranscript = '';
        rec.onresult = (e) => {
            let interim = '';
            for (let i = e.resultIndex; i < e.results.length; i++) {
                if (e.results[i].isFinal) {
                    finalTranscript += e.results[i][0].transcript + ' ';
                } else {
                    interim += e.results[i][0].transcript;
                }
            }
            const chatInput = document.getElementById('chatInput');
            if (document.activeElement === chatInput) {
                chatInput.value = finalTranscript + interim;
            } else {
                const editor = document.getElementById('editor');
                const sel = window.getSelection();
                if (sel.rangeCount > 0) {
                    const range = sel.getRangeAt(0);
                    range.deleteContents();
                    range.insertNode(document.createTextNode(finalTranscript + interim));
                    range.collapse(false);
                    handleEditorInput();
                }
            }
        };
        rec.onend = () => {
            listening = false;
            finalTranscript = '';
            micBtn.classList.remove('active-glow');
            micBtn.textContent = '🎤️';
        };
        micBtn.onclick = () => {
            if (!listening) {
                rec.start();
                listening = true;
                micBtn.classList.add('active-glow');
                micBtn.textContent = '⏹️';
                toast('🎤️ Listening...');
            } else {
                rec.stop();
            }
        };
    } else {
        micBtn.disabled = true;
        micBtn.title = 'Voice not supported';
    }
    
    // Find
    on('findBtn', 'onclick', handleFind);
    const findInput = document.getElementById('findInput');
    if (findInput) {
        findInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                handleFind();
                return false;
            }
        });
        findInput.addEventListener('input', (e) => {
            e.stopPropagation();
        });
    }
    
    // Zoom
    on('zoomIn', 'onclick', () => adjustZoom(0.1));
    on('zoomOut', 'onclick', () => adjustZoom(-0.1));
    
    // Formatting toolbar
    on('boldBtn', 'onclick', () => formatDoc('bold'));
    on('italicBtn', 'onclick', () => formatDoc('italic'));
    on('underlineBtn', 'onclick', () => formatDoc('underline'));
    on('bulletBtn', 'onclick', () => formatDoc('insertUnorderedList'));
    on('numberBtn', 'onclick', () => formatDoc('insertOrderedList'));
    on('indentBtn', 'onclick', () => formatDoc('indent'));
    on('outdentBtn', 'onclick', () => formatDoc('outdent'));
    on('alignLeftBtn', 'onclick', () => formatDoc('justifyLeft'));
    on('alignCenterBtn', 'onclick', () => formatDoc('justifyCenter'));
    on('alignRightBtn', 'onclick', () => formatDoc('justifyRight'));
    on('fontSizeSelect', 'onchange', (e) => {
        if (e.target.value) {
            formatDoc('fontSize', e.target.value);
            e.target.value = '';
        }
    });
    
    // Editor
    on('editor', 'oninput', handleEditorInput);
    on('editor', 'onkeydown', handleEditorKeydown);
    
    // Tone button
    const toneBtn = document.getElementById('toneBtn');
    if (toneBtn) toneBtn.onclick = (e) => { e.stopPropagation(); showToneMenu(e); };
    
    // Keyboard shortcuts
    document.addEventListener('keydown', handleKeyboardShortcuts);
    
    // Plan selection
    document.querySelectorAll('.selectPlan').forEach(btn => {
        btn.onclick = () => selectPlan(btn.dataset.plan);
    });
    
    console.log('All event handlers attached');
}

document.addEventListener('click', (event) => {
    const chip = event.target.closest('[data-entity-id]');
    if (chip) {
        event.preventDefault();
        showEntityDetail(chip.dataset.entityId, chip.dataset.entitySource || 'doc');
        hideEntityHoverCard();
        return;
    }
    const docLink = event.target.closest('.entity-doc-link');
    if (docLink) {
        const button = event.target.closest('button');
        if (button && button.disabled) return;
        const docId = docLink.dataset.docId;
        if (docId) {
            const highlightData = docLink.dataset.highlightId || docLink.dataset.highlightText
                ? {
                    id: docLink.dataset.highlightId || null,
                    text: docLink.dataset.highlightText || null,
                    offset: docLink.dataset.highlightOffset ? parseInt(docLink.dataset.highlightOffset, 10) : null,
                    index: docLink.dataset.highlightIndex ? parseInt(docLink.dataset.highlightIndex, 10) : null,
                }
                : null;
            openDocFromEntity(docId, {highlight: highlightData});
            hideEntityHoverCard();
        }
    }
});

document.addEventListener('mouseenter', (event) => {
    const target = event.target.closest('[data-entity-id]');
    if (!target) return;
    const mention = target.dataset.entityMention;
    if (mention) showEntityHoverCard(target, mention);
}, true);

document.addEventListener('mouseleave', (event) => {
    if (event.target.closest('[data-entity-id]')) {
        hideEntityHoverCard();
    }
}, true);

document.addEventListener('keydown', (event) => {
    if (knowledgeGraphOverlayOpen && event.key === 'Escape') {
        closeKnowledgeGraphOverlay();
    }
});

function createNewDoc() {
    const isPremiumUser = state.user?.sub === 'f4486468-b0f1-70ed-c84c-385c4fecbc7c';
    if (!isPremiumUser && state.limits.documents !== -1 && state.docs.length >= state.limits.documents) {
        showModal('upgradeModal');
        toast(`Document limit reached! (${state.limits.documents} max)`);
        return;
    }
    const doc = {id: 'doc' + Date.now(), backendId: null, name: 'Untitled ' + (state.docs.length + 1), content: '', folder: state.activeFolder};
    state.docs.push(doc);
    state.activeId = doc.id;
    saveState();
    render();
    toast('✨ New document created', true);
}

function createFolder() {
    const name = document.getElementById('folderName').value.trim();
    if (!name) return toast('Enter folder name');
    const folder = {id: 'folder' + Date.now(), name, docs: []};
    state.folders.push(folder);
    state.activeFolder = folder.id;
    saveState();
    render();
    hideModal('folderModal');
    document.getElementById('folderName').value = '';
    toast('📁 Folder created', true);
}

function setActiveFolder(id) {
    state.activeFolder = id;
    render();
    saveState();
}

async function handleFileUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    e.target.value = '';
    
    // Check local document count, not backend upload count (-1 means unlimited)
    // Bypass for premium user
    const isPremiumUser = state.user?.sub === 'f4486468-b0f1-70ed-c84c-385c4fecbc7c';
    if (!isPremiumUser && state.limits.documents !== -1 && state.docs.length >= state.limits.documents) {
        showModal('upgradeModal');
        toast(`Document limit reached! (${state.limits.documents} max)`);
        return;
    }
    
    // File size validation
    if (file.size > 10 * 1024 * 1024) {
        toast('File too large (max 10MB)');
        return;
    }
    
    // Show transparent loading overlay
    const loadingScreen = document.getElementById('loadingScreen');
    const loadingText = document.getElementById('loadingText');
    loadingText.textContent = '📄 Uploading document...';
    loadingScreen.style.display = 'flex';
    
    showProgress(10);
    
    try {
        let content = '';
        
        if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
            loadingText.textContent = '🔍 Extracting text...';
            const arrayBuffer = await file.arrayBuffer();
            showProgress(30);
            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
            const pages = [];
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                pages.push(pageText);
                showProgress(30 + (i / pdf.numPages) * 30);
            }
            content = pages.join('\n\n');
        } else {
            content = await file.text();
            showProgress(50);
        }
        
        loadingText.textContent = '🧠 Creating embeddings...';
        showProgress(65);
        const headers = {'Content-Type': 'application/json'};
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
        const processRes = await fetch(`${API}/dev/upload`, {
            method: 'POST',
            headers,
            body: JSON.stringify({
                user_id: state.user.sub,
                filename: file.name,
                content: content.substring(0, 50000),
                generate_summary: true
            })
        });
        loadingText.textContent = '💾 Indexing document...';
        showProgress(85);
        
        if (!processRes.ok) {
            const err = await processRes.json();
            throw new Error(err.error || 'Processing failed');
        }
        
        const result = await processRes.json();
        
        // Split into pages (roughly 3000 chars per page)
        const pages = [];
        const charsPerPage = 3000;
        for (let i = 0; i < content.length; i += charsPerPage) {
            pages.push(content.substring(i, i + charsPerPage));
        }
        const pagesHtml = pages.map((page, idx) => 
            `<div style="max-width: 8.5in; min-height: 11in; margin: 20px auto; padding: 1in; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-family: Georgia, 'Times New Roman', serif; font-size: 11pt; line-height: 1.8; color: #000; white-space: pre-wrap; page-break-after: always; position: relative;">
                ${page.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                <div style="position: absolute; bottom: 0.5in; right: 1in; font-size: 10pt; color: #666;">Page ${idx + 1} of ${pages.length}</div>
            </div>`
        ).join('');
        
        // Create new document with uploaded content
        const backendDocId = result.doc_id || ('doc' + Date.now());
        const newDoc = {
            id: backendDocId,
            backendId: backendDocId,
            name: file.name.replace(/\.[^/.]+$/, ''),
            content: pagesHtml,
            plainText: content,
            isPdf: file.type === 'application/pdf' || file.name.endsWith('.pdf'),
            summary: result.artifact?.summary || '',
            questions: result.artifact?.questions || []
        };
        state.docs.push(newDoc);
        state.activeId = newDoc.id;
        state.docEntities[backendDocId] = result.entities || [];
        if (newDoc.entities === undefined) newDoc.entities = result.entities || [];
        
        showProgress(100);
        loadingScreen.style.display = 'none';
        addChatMessage(`✅ Uploaded ${file.name}`, 'bot');
        
        if (result.artifact) {
            renderArtifacts(result.artifact);
        }
        
        posthog && posthog.capture('upload_doc', {file_type: file.type});
        
        // Show instant insights
        if (result.insights) showInsights(result.insights);
        
        await loadUsage();
        ensureDocEntities(newDoc, true);
        fetchUserEntities(true);
        // Don't call render() - it wipes the chat including summary/questions
        
        // Apply smart highlights after render
        if (result.highlights) {
            setTimeout(() => applySmartHighlights(result.highlights), 100);
        }
        document.getElementById('editor').focus();
        toast('✨ Upload complete!', true);
        gtag && gtag('event', 'document_uploaded', {file_type: file.type});
    } catch (e) {
        console.error('Upload error:', e);
        showProgress(0);
        loadingScreen.style.display = 'none';
        addChatMessage(`❌ Upload failed: ${e.message}`, 'bot');
        toast(`Upload failed: ${e.message}`);
    }
}

// Phase 4: Optimistic UI & retry
let isSubmitting = false;

async function sendChat() {
    if (isSubmitting) return;
    
    const input = document.getElementById('chatInput');
    const msg = input.value.trim();
    if (!msg) return;
    
    if (activeChatAbort) {
        activeChatAbort.abort();
        activeChatAbort = null;
    }
    
    isSubmitting = true;
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = true;
    sendBtn.style.opacity = '0.5';
    
    // Check if user is at free tier limit (skip if tier not loaded yet)
    const isPremium = state.user?.tier && ['premium', 'pro', 'business', 'Premium', 'Pro', 'Business'].includes(state.user.tier);
    const isGuest = state.user?.isGuest;
    
    if (!isPremium && !isGuest && state.user?.tier && state.usage.chats_used >= CONFIG.CHAT_LIMIT) {
        showPaywallModal({
            message: `You've used all ${CONFIG.CHAT_LIMIT} free chats this month. Upgrade to Premium for unlimited chats!`,
            used: state.usage.chats_used,
            limit: CONFIG.CHAT_LIMIT
        });
        return;
    }
    
    input.value = '';
    
    // Save editor state for undo
    lastEditorState = document.getElementById('editor').innerHTML;
    
    addChatMessage(msg, 'user');
    
    // Detect smart actions
    const lowerMsg = msg.toLowerCase();
    const doc = state.docs.find(d => d.id === state.activeId);
    const isJournalMode = loadSettings().journalMode;
    
    // Clear journal/document
    if ((lowerMsg.includes('clear') || lowerMsg.includes('delete') || lowerMsg.includes('erase')) && 
        (lowerMsg.includes('journal') || lowerMsg.includes('document') || lowerMsg.includes('doc') || lowerMsg.includes('this'))) {
        showClearDocConfirmation();
        return;
    }
    
    // Add content to journal/document
    if ((lowerMsg.includes('push') || lowerMsg.includes('add')) && 
        (lowerMsg.includes('journal') || lowerMsg.includes('document') || lowerMsg.includes('doc'))) {
        const contentMatch = msg.match(/^(.+?)(?:push|add)/i);
        if (contentMatch && contentMatch[1].trim()) {
            showAddToDocConfirmation(contentMatch[1].trim());
            return;
        }
    }
    
    // Optimistic update
    state.usage.chats_used++;
    // Don't render - it wipes chat
    
    // Show interactive loading indicator
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'chatLoading';
    loadingDiv.className = 'chat-loading mr-8';
    loadingDiv.innerHTML = '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div><span class="ai-thinking-text">AI is thinking...</span>';
    document.getElementById('chatMessages').appendChild(loadingDiv);
    loadingDiv.scrollIntoView({behavior: 'smooth'});
    
    // Send question with document context if available
    try {
        const headers = {'Content-Type': 'application/json'};
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
        
        // Try streaming first
        const useStreaming = CONFIG.ENABLE_STREAMING;
        
        if (useStreaming) {
            const doc = state.docs.find(d => d.id === state.activeId);
            const backendId = doc?.backendId || doc?.id;
            const controller = new AbortController();
            activeChatAbort = controller;
            let res;
            try {
                res = await fetch(`${API}/dev/chat`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({query: msg, stream: true, doc_id: backendId}),
                    signal: controller.signal
                });
            } catch (err) {
                if (controller.signal.aborted) {
                    return;
                }
                console.error('Streaming fetch failed', err);
            }
            
            if (res && res.ok && res.headers.get('content-type')?.includes('text/event-stream')) {
                loadingDiv.remove();
                const streamDiv = document.createElement('div');
                streamDiv.className = 'text-sm p-3 rounded-2xl border bg-emerald-50 mr-8 text-gray-900';
                document.getElementById('chatMessages').appendChild(streamDiv);
                
                let fullText = '';
                let citations = [];
                let rafId = null;
                const reader = res.body.getReader();
                
                const flush = () => {
                    streamDiv.innerHTML = renderMarkdown(fullText);
                    streamDiv.scrollIntoView({behavior: 'smooth', block: 'end'});
                };
                
                const scheduleFlush = () => {
                    if (rafId) return;
                    rafId = requestAnimationFrame(() => {
                        rafId = null;
                        flush();
                    });
                };
                
                reading: while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    
                    const chunk = textDecoder.decode(value, {stream: true});
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        if (line === 'data: [DONE]') break reading;
                        try {
                            const data = JSON.parse(line.slice(6));
                            if (data.event === 'metadata' && data.citations) {
                                citations = data.citations;
                                continue;
                            }
                            if (data.error) {
                                fullText = data.error;
                                scheduleFlush();
                                continue;
                            }
                            if (data.token) {
                                fullText += data.token;
                                scheduleFlush();
                            }
                            if (data.citations) citations = data.citations;
                        } catch (e) {
                            continue;
                        }
                    }
                }
                
                if (rafId) {
                    cancelAnimationFrame(rafId);
                    flush();
                } else {
                    flush();
                }
                
                isSubmitting = false;
                sendBtn.disabled = false;
                sendBtn.style.opacity = '1';
                activeChatAbort = null;
                
                if (!state.chatHistory[state.activeId]) state.chatHistory[state.activeId] = [];
                state.chatHistory[state.activeId].push({text: fullText, sender: 'bot', citations});
                saveState();
                return;
            } else if (controller.signal.aborted) {
                return;
            }
        }
        
        // Fallback to non-streaming
        const doc = state.docs.find(d => d.id === state.activeId);
        const backendId = doc?.backendId || doc?.id;
        const res = await fetch(`${API}/dev/chat`, {
            method: 'POST',
            headers,
            body: JSON.stringify({query: msg, doc_id: backendId})
        });
        
        const data = await res.json();
        loadingDiv.remove();
        isSubmitting = false;
        sendBtn.disabled = false;
        sendBtn.style.opacity = '1';
        activeChatAbort = null;
        if (res.ok) {
            const response = data.response;
            const citations = data.citations || [];
            
            // Auto-add content when AI generates it based on user request
            const lowerMsg = msg.toLowerCase();
            const lowerResponse = response.toLowerCase();
            
            // Check if user asked to "start it like" or "write" something
            const isContentRequest = lowerMsg.includes('start it') || lowerMsg.includes('write') || 
                                     lowerMsg.includes('add') || lowerMsg.includes('continue');
            
            // Check if AI is confirming OR providing content
            const isConfirmation = (lowerResponse.includes('added') || lowerResponse.includes('yep')) && 
                                   response.length < 100;
            
            if (isConfirmation) {
                // AI is just confirming - look at previous message for content
                const chatHistory = state.chatHistory[state.activeId] || [];
                const lastBotMsg = chatHistory.filter(m => m.sender === 'bot').slice(-2)[0];
                
                if (lastBotMsg && lastBotMsg.text && lastBotMsg.text.length > 50) {
                    const editor = document.getElementById('editor');
                    const contentToAdd = lastBotMsg.text.replace(/\*\*/g, '').replace(/\*/g, '').replace(/<[^>]*>/g, '');
                    editor.innerHTML += '<p><br></p><p>' + contentToAdd + '</p>';
                    handleEditorInput();
                    await addChatMessageStreaming('✅ Added to your journal!', 'bot');
                } else {
                    await addChatMessageStreaming(response, 'bot');
                }
            } else if (isContentRequest && response.length > 30) {
                // Extract only quoted content from AI response
                const quoteMatch = response.match(/"([^"]+)"/); 
                if (quoteMatch && quoteMatch[1].length > 20) {
                    // Found quoted content - add only that
                    const editor = document.getElementById('editor');
                    const contentToAdd = quoteMatch[1];
                    editor.innerHTML += '<p><br></p><p>' + contentToAdd + '</p>';
                    handleEditorInput();
                    await addChatMessageStreaming('✅ Added to journal!', 'bot');
                } else {
                    // No quotes found - show response with button
                    await addChatMessageStreaming(response, 'bot');
                }
            } else {
                // Use citation rendering if citations exist
                if (citations && citations.length > 0) {
                    renderAnswerWithCitations(data);
                } else {
                    await addChatMessageWithCitations(response, citations, 'bot');
                }
            }
            
            await loadUsage();
            // Don't render - it wipes chat
            gtag && gtag('event', 'chat_sent');
        } else {
            state.usage.chats_used--; // Rollback optimistic update
            if (res.status === 402) {
                showPaywallModal(data);
            } else {
                addChatMessage(`Error: ${data.error}`, 'bot');
            }
            // Don't render - it wipes chat
        }
    } catch (e) {
        state.usage.chats_used--; // Rollback optimistic update
        loadingDiv.remove();
        isSubmitting = false;
        sendBtn.disabled = false;
        sendBtn.style.opacity = '1';
        const retryBtn = document.createElement('button');
        retryBtn.textContent = '🔄 Retry';
        retryBtn.className = 'text-xs px-2 py-1 rounded border border-emerald-500 text-emerald-500 hover:bg-emerald-50 ml-2';
        retryBtn.onclick = () => { input.value = msg; sendChat(); };
        const errDiv = document.createElement('div');
        errDiv.className = 'text-sm p-3 rounded-2xl border bg-red-50 mr-8 text-gray-900 flex items-center justify-between';
        errDiv.innerHTML = `<span>❌ ${e.message}</span>`;
        errDiv.appendChild(retryBtn);
        document.getElementById('chatMessages').appendChild(errDiv);
        // Don't render - it wipes chat
    }
}

async function runAgent(type) {
    // Summary agent
    if (type === 'summary') {
        const doc = state.docs.find(d => d.id === state.activeId);
        const content = document.getElementById('editor').textContent;
        if (!content || content.length < 100) return toast('Write more content first');
        
        toast('Generating summary...');
        try {
            const headers = {'Content-Type': 'application/json'};
            if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
            const res = await fetch(`${API}/dev/chat`, {
                method: 'POST',
                headers,
                body: JSON.stringify({
                    user_id: state.user.sub,
                    messages: [{
                        role: 'user',
                        content: `Summarize this document in 3-5 bullet points highlighting key insights:\n\n${content.slice(0, 120000)}`
                    }]
                })
            });
            const data = await res.json();
            if (res.ok) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center';
                modal.style.zIndex = '100';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl w-[600px] max-h-[80vh] overflow-auto p-6">
                        <h2 class="text-lg font-bold mb-4">📝 Document Summary</h2>
                        <div class="prose prose-sm">${data.response.replace(/\n/g, '<br>')}</div>
                        <button onclick="this.closest('.fixed').remove()" class="w-full mt-4 px-4 py-2 rounded-lg bg-emerald-500 text-white hover:bg-emerald-600">Close</button>
                    </div>
                `;
                document.body.appendChild(modal);
                toast('✅ Summary generated', true);
            } else {
                toast('Failed to generate summary');
            }
        } catch (e) {
            toast('Error: ' + e.message);
        }
        return;
    }
    
    // Phase 9: Enhanced export with PDF/DOCX
    if (type === 'export') {
        const doc = state.docs.find(d => d.id === state.activeId);
        const content = document.getElementById('editor').textContent;
        
        // Show format selection modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center';
        modal.style.zIndex = '100';
        modal.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl w-[400px] p-6">
                <h2 class="text-lg font-bold mb-4">Export Format</h2>
                <div class="space-y-2">
                    <button onclick="exportAs('txt')" class="w-full text-left px-4 py-3 rounded-lg border hover:bg-gray-50">📄 Text (.txt)</button>
                    <button onclick="exportAs('pdf')" class="w-full text-left px-4 py-3 rounded-lg border hover:bg-gray-50">📕 PDF (.pdf)</button>
                    <button onclick="exportAs('html')" class="w-full text-left px-4 py-3 rounded-lg border hover:bg-gray-50">🌐 HTML (.html)</button>
                </div>
                <button onclick="this.closest('.fixed').remove()" class="w-full mt-4 px-4 py-2 rounded-lg border">Cancel</button>
            </div>
        `;
        document.body.appendChild(modal);
        
        window.exportAs = (format) => {
            modal.remove();
            if (format === 'txt') {
                const blob = new Blob([content], {type: 'text/plain'});
                downloadBlob(blob, `${doc.name}.txt`);
            } else if (format === 'pdf') {
                exportToPDF(doc.name, content);
            } else if (format === 'html') {
                const html = document.getElementById('editor').innerHTML;
                const blob = new Blob([html], {type: 'text/html'});
                downloadBlob(blob, `${doc.name}.html`);
            }
            toast('📥 Document exported', true);
            posthog && posthog.capture('export', {format: format});
        };
        return;
    }
    
    const content = document.getElementById('editor').textContent;
    
    try {
        const headers = {'Content-Type': 'application/json'};
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
        const res = await fetch(`${API}/agent`, {
            method: 'POST',
            headers,
            body: JSON.stringify({user_id: state.user.sub, agent_type: type, content, params: {}})
        });
        
        const data = await res.json();
        if (res.ok) {
            addChatMessage(`✅ ${type}: ${data.summary || data.message || data.result || 'Done'}`, 'bot');
        } else {
            if (res.status === 403) showModal('upgradeModal');
            addChatMessage(`❌ ${data.error}`, 'bot');
        }
    } catch (e) {
        addChatMessage(`❌ ${e.message}`, 'bot');
    }
}

async function handleLogin() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const errorDiv = document.getElementById('loginError');
    
    if (!email || !password) {
        errorDiv.textContent = '❌ Please fill in all fields';
        errorDiv.classList.remove('hidden');
        return;
    }
    
    errorDiv.classList.add('hidden');
    
    try {
        const result = await signIn(email, password);
        const session = result.getIdToken();
        authToken = session.getJwtToken();
        const payload = session.payload;
        state.user = {email: payload.email, sub: payload.sub, name: payload.name};
        usageCache = null;
        await loadUsage();
        hideModal('loginModal');
        updateAuthUI();
        toast('✅ Login successful!', true);
    } catch (e) {
        const errorMsg = e.message || e.toString();
        if (errorMsg.includes('UserNotFoundException') || errorMsg.includes('not found')) {
            errorDiv.innerHTML = '❌ No account found with this email. <a href="#" onclick="hideModal(\'loginModal\');showModal(\'signupModal\');return false;" class="text-emerald-600 underline">Sign up instead?</a>';
        } else if (errorMsg.includes('NotAuthorizedException') || errorMsg.includes('Incorrect')) {
            errorDiv.innerHTML = '❌ Incorrect password. <a href="#" onclick="hideModal(\'loginModal\');showModal(\'forgotPasswordModal\');return false;" class="text-emerald-600 underline">Forgot password?</a>';
        } else if (errorMsg.includes('UserNotConfirmedException') || errorMsg.includes('not confirmed')) {
            hideModal('loginModal');
            document.getElementById('verifyEmail').value = email;
            showModal('verifyEmailModal');
            return;
        } else {
            errorDiv.textContent = '❌ ' + errorMsg;
        }
        errorDiv.classList.remove('hidden');
    }
}

function handleVerifyEmail() {
    const email = document.getElementById('verifyEmail').value;
    const code = document.getElementById('verificationCode').value;
    const errorDiv = document.getElementById('verifyEmailError');
    
    if (!code) {
        errorDiv.textContent = '❌ Please enter the verification code';
        errorDiv.classList.remove('hidden');
        return;
    }
    
    const cognitoUser = new AmazonCognitoIdentity.CognitoUser({
        Username: email,
        Pool: userPool
    });
    
    cognitoUser.confirmRegistration(code, true, (err, result) => {
        if (err) {
            errorDiv.textContent = '❌ ' + err.message;
            errorDiv.classList.remove('hidden');
        } else {
            hideModal('verifyEmailModal');
            toast('✅ Email verified! You can now login.', true);
            showModal('loginModal');
        }
    });
}

function resendVerificationCode(email) {
    const cognitoUser = new AmazonCognitoIdentity.CognitoUser({
        Username: email,
        Pool: userPool
    });
    
    cognitoUser.resendConfirmationCode((err, result) => {
        if (err) {
            toast('❌ Failed to resend code: ' + err.message);
        } else {
            toast('✅ Verification code sent! Check your email.', true);
        }
    });
}

async function handleForgotPassword() {
    const email = document.getElementById('forgotPasswordEmail').value;
    const errorDiv = document.getElementById('forgotPasswordError');
    const successDiv = document.getElementById('forgotPasswordSuccess');
    
    errorDiv.classList.add('hidden');
    successDiv.classList.add('hidden');
    
    if (!email) {
        errorDiv.textContent = '❌ Please enter your email';
        errorDiv.classList.remove('hidden');
        return;
    }
    
    try {
        const cognitoUser = new AmazonCognitoIdentity.CognitoUser({
            Username: email,
            Pool: userPool
        });
        
        await new Promise((resolve, reject) => {
            cognitoUser.forgotPassword({
                onSuccess: resolve,
                onFailure: reject
            });
        });
        
        successDiv.textContent = '✅ Reset code sent! Check your email.';
        successDiv.classList.remove('hidden');
        
        // Show code input after 2 seconds
        setTimeout(() => {
            const codeInput = prompt('Enter the code from your email:');
            if (codeInput) {
                const newPassword = prompt('Enter your new password (8+ chars, upper, lower, number):');
                if (newPassword) {
                    cognitoUser.confirmPassword(codeInput, newPassword, {
                        onSuccess: () => {
                            hideModal('forgotPasswordModal');
                            toast('✅ Password reset! You can now login.', true);
                            showModal('loginModal');
                        },
                        onFailure: (err) => {
                            errorDiv.textContent = '❌ ' + err.message;
                            errorDiv.classList.remove('hidden');
                        }
                    });
                }
            }
        }, 2000);
    } catch (e) {
        const errorMsg = e.message || e.toString();
        if (errorMsg.includes('UserNotFoundException')) {
            errorDiv.textContent = '❌ Email not found. Please sign up first.';
        } else {
            errorDiv.textContent = '❌ ' + errorMsg;
        }
        errorDiv.classList.remove('hidden');
    }
}

async function handleSignup() {
    const name = document.getElementById('signupName').value;
    const email = document.getElementById('signupEmail').value;
    const password = document.getElementById('signupPassword').value;
    const errorDiv = document.getElementById('signupError');
    
    if (!name || !email || !password) {
        errorDiv.textContent = '❌ Please fill in all fields';
        errorDiv.classList.remove('hidden');
        return;
    }
    if (password.length < 8) {
        errorDiv.textContent = '❌ Password too short (minimum 8 characters)';
        errorDiv.classList.remove('hidden');
        return;
    }
    if (!/[A-Z]/.test(password)) {
        errorDiv.textContent = '❌ Password needs an uppercase letter (A-Z)';
        errorDiv.classList.remove('hidden');
        return;
    }
    if (!/[a-z]/.test(password)) {
        errorDiv.textContent = '❌ Password needs a lowercase letter (a-z)';
        errorDiv.classList.remove('hidden');
        return;
    }
    if (!/[0-9]/.test(password)) {
        errorDiv.textContent = '❌ Password needs a number (0-9)';
        errorDiv.classList.remove('hidden');
        return;
    }
    
    errorDiv.classList.add('hidden');
    
    try {
        await signUp(email, password, name);
        hideModal('signupModal');
        posthog && posthog.capture('signup', {email: email});
        toast('✅ Account created! Check email to verify.', true);
    } catch (e) {
        console.error('Signup error:', e);
        const errorMsg = e.message || e.toString();
        if (errorMsg.includes('UsernameExistsException') || errorMsg.includes('already exists')) {
            errorDiv.textContent = '❌ Email already registered. Try logging in instead.';
        } else if (errorMsg.includes('InvalidPasswordException')) {
            errorDiv.textContent = '❌ Password too weak. Use 8+ chars with upper, lower, and number.';
        } else if (errorMsg.includes('InvalidParameterException')) {
            errorDiv.textContent = '❌ Invalid email or password format';
        } else {
            errorDiv.textContent = '❌ ' + errorMsg;
        }
        errorDiv.classList.remove('hidden');
    }
}



function executeCommand(cmd) {
    if (cmd === 'new') createNewDoc();
    else if (cmd === 'upload') document.getElementById('uploadBtn').click();
    else if (cmd === 'theme') toggleTheme();
    else if (cmd === 'focus') toggleFocus();
    else runAgent(cmd);
}

function toggleTheme() {
    const current = document.body.getAttribute('data-theme');
    const newTheme = current === 'light' ? 'dark' : 'light';
    document.body.setAttribute('data-theme', newTheme);
    const icon = document.getElementById('themeIcon');
    if (icon) icon.textContent = newTheme === 'light' ? '🌞' : '🌙';
    saveSettings({theme: newTheme});
}

function toggleMode() {
    const settings = loadSettings();
    const newMode = !settings.journalMode;
    saveSettings({journalMode: newMode});
    const btn = document.getElementById('modeToggle');
    const label = document.getElementById('modeLabel');
    if (newMode) {
        btn.textContent = '✍️ Journal';
        btn.className = 'text-xs px-2 py-1 rounded-lg border border-purple-500 text-purple-500 hover:bg-purple-50';
        if (label) label.textContent = 'Journal';
        toast('✍️ Journal mode');
    } else {
        btn.textContent = '📊 Research';
        btn.className = 'text-xs px-2 py-1 rounded-lg border border-cyan-500 text-cyan-500 hover:bg-cyan-50';
        if (label) label.textContent = 'Research';
        toast('📊 Research mode');
    }
}

function toggleFocus() {
    state.focus = !state.focus;
    const left = document.getElementById('leftSidebar');
    const right = document.getElementById('rightSidebar');
    if (state.focus) {
        left.classList.add('hidden');
        right.classList.add('hidden');
        document.getElementById('focusBtn').textContent = 'Exit';
    } else {
        left.classList.remove('hidden');
        right.classList.remove('hidden');
        document.getElementById('focusBtn').textContent = 'Focus';
    }
    toast(state.focus ? 'Focus mode ON' : 'Focus mode OFF');
}

function handleFind() {
    const query = document.getElementById('findInput').value.trim();
    if (!query) return;
    
    // Clear previous highlights
    const editor = document.getElementById('editor');
    const content = editor.innerHTML;
    const cleanContent = content.replace(/<mark class="highlight">(.*?)<\/mark>/gi, '$1');
    editor.innerHTML = cleanContent;
    
    // Highlight all matches
    const regex = new RegExp(`(${query})`, 'gi');
    const highlighted = cleanContent.replace(regex, '<mark class="highlight" style="background: yellow; padding: 2px;">$1</mark>');
    editor.innerHTML = highlighted;
    
    const matches = (highlighted.match(/<mark/g) || []).length;
    if (matches > 0) {
        toast(`Found ${matches} match${matches > 1 ? 'es' : ''}`);
        // Scroll to first match
        const firstMark = editor.querySelector('mark.highlight');
        if (firstMark) firstMark.scrollIntoView({behavior: 'smooth', block: 'center'});
    } else {
        toast(`Not found: "${query}"`);
    }
}

function adjustZoom(delta) {
    state.zoom = Math.max(0.8, Math.min(1.5, state.zoom + delta));
    document.getElementById('editorContainer').style.transform = `scale(${state.zoom})`;
    document.getElementById('zoomLabel').textContent = Math.round(state.zoom * 100) + '%';
}

function formatDoc(cmd, value) {
    document.execCommand(cmd, false, value || null);
    document.getElementById('editor').focus();
}

// === AUTOCOMPLETE SYSTEM ===
let autocompleteTimeout;
let ghostTextNode = null;
let lastAutocompleteText = '';
let autocompleteAcceptances = 0;
let autocompleteSuggestions = 0;
let autocompleteSettings = {
    aggressiveness: 'medium', // low, medium, high
    enabled: true
};

const AGGRESSIVENESS_CONFIG = {
    low: { delay: 1500, tokens: 30 },
    medium: { delay: 1000, tokens: 50 },
    high: { delay: 500, tokens: 75 }
};

// === AI WRITING SUGGESTIONS ===
let suggestionTimeout;
let currentSuggestion = null;
let lastTypingTime = 0;
let lastTypingTimestamp = 0;
let suggestionCooldown = false;

async function checkForSuggestions() {
    const editor = document.getElementById('editor');
    const text = editor.textContent.trim();
    if (text.length < 10) return;
    
    // Get last sentence
    const sentences = text.split(/[.!?]\s+/);
    const lastSentence = sentences[sentences.length - 1];
    if (lastSentence.length < 5) return;
    
    try {
        const res = await fetch(`${API}/dev/chat`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                user_id: state.user.sub,
                messages: [{
                    role: 'user',
                    content: `Rewrite this sentence to be clearer (respond with ONLY the rewritten sentence, no explanation): "${lastSentence}"`
                }]
            })
        });
        
        if (res.ok) {
            const data = await res.json();
            const improved = data.response.replace(/^["']|["']$/g, '').trim();
            if (improved !== lastSentence) {
                showSuggestion(improved, lastSentence);
            }
        }
    } catch (e) {
        console.log('Suggestion failed:', e);
    }
}

function showSuggestion(improved, original) {
    currentSuggestion = {improved, original};
    const card = document.getElementById('aiSuggestionCard');
    const suggestionText = document.getElementById('suggestionText');
    
    suggestionText.textContent = improved;
    
    // Position near cursor
    const sel = window.getSelection();
    if (sel.rangeCount > 0) {
        const range = sel.getRangeAt(0);
        const rect = range.getBoundingClientRect();
        card.style.left = `${rect.left}px`;
        card.style.top = `${rect.bottom + 8}px`;
    }
    
    card.classList.add('visible');
}

window.acceptSuggestion = () => {
    if (!currentSuggestion) return;
    
    const editor = document.getElementById('editor');
    const content = editor.innerHTML;
    const original = currentSuggestion.original;
    const improved = currentSuggestion.improved;
    
    const lastIndex = content.lastIndexOf(original);
    if (lastIndex !== -1) {
        editor.innerHTML = content.substring(0, lastIndex) + improved + content.substring(lastIndex + original.length);
    }
    
    dismissSuggestion();
    suggestionCooldown = true;
    clearTimeout(suggestionTimeout);
    setTimeout(() => { suggestionCooldown = false; }, 10000);
    toast('✨ Applied', true);
};

window.dismissSuggestion = () => {
    const card = document.getElementById('aiSuggestionCard');
    card.classList.remove('visible');
    currentSuggestion = null;
    suggestionCooldown = true;
    clearTimeout(suggestionTimeout);
    setTimeout(() => { suggestionCooldown = false; }, 5000);
};

function showAddToDocConfirmation(content) {
    const doc = state.docs.find(d => d.id === state.activeId);
    const isJournal = loadSettings().journalMode;
    const docType = isJournal ? 'journal' : 'document';
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center';
    modal.style.zIndex = '100';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-[500px] p-6">
            <h2 class="text-lg font-bold mb-4">Add to ${docType}?</h2>
            <div class="p-4 bg-gray-50 rounded-lg mb-4 text-sm">
                <div class="font-semibold mb-2">Content to add:</div>
                <div class="text-gray-700">${content}</div>
            </div>
            <div class="flex gap-2">
                <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 rounded-lg border hover:bg-gray-50">Cancel</button>
                <button onclick="confirmAddToDoc('${content.replace(/'/g, "\\'").replace(/"/g, '&quot;')}');this.closest('.fixed').remove()" class="flex-1 px-4 py-2 rounded-lg bg-emerald-500 text-white hover:bg-emerald-600">Add to ${docType}</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

window.confirmAddToDoc = (content) => {
    const editor = document.getElementById('editor');
    const currentContent = editor.innerHTML;
    editor.innerHTML = currentContent + '<p><br></p><p>' + content + '</p>';
    handleEditorInput();
    toast('✅ Added to document', true);
    addChatMessage('Content added to your document!', 'bot');
};

function showClearDocConfirmation() {
    const doc = state.docs.find(d => d.id === state.activeId);
    const isJournal = loadSettings().journalMode;
    const docType = isJournal ? 'journal' : 'document';
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center';
    modal.style.zIndex = '100';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-[500px] p-6">
            <h2 class="text-lg font-bold mb-4">Clear ${docType}?</h2>
            <p class="text-sm text-gray-600 mb-4">This will delete all content in "${doc.name}". This action cannot be undone.</p>
            <div class="flex gap-2">
                <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 rounded-lg border hover:bg-gray-50">Cancel</button>
                <button onclick="confirmClearDoc();this.closest('.fixed').remove()" class="flex-1 px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600">Clear ${docType}</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

window.confirmClearDoc = () => {
    const editor = document.getElementById('editor');
    editor.innerHTML = '';
    handleEditorInput();
    toast('✅ Document cleared', true);
    addChatMessage('Your document has been cleared. Ready for a fresh start!', 'bot');
};

function showToneMenu(e) {
    const sel = window.getSelection();
    if (!sel || sel.isCollapsed) {
        toast('Select text first');
        return;
    }
    
    const btn = document.getElementById('toneBtn');
    const rect = btn.getBoundingClientRect();
    
    const menu = document.createElement('div');
    menu.id = 'toneMenu';
    menu.className = 'fixed p-2 z-50';
    menu.style.cssText = `top: ${rect.bottom + 4}px; left: ${rect.left}px; width: 100px; background: rgba(255,255,255,0.95); backdrop-filter: blur(16px); border: 1px solid rgba(16,185,129,0.3); border-radius: 12px; box-shadow: 0 8px 24px rgba(16,185,129,0.15), 0 0 40px rgba(6,182,212,0.1);`;
    menu.innerHTML = `
        <button onclick="adjustTone('formal');document.getElementById('toneMenu').remove()" class="w-full text-center px-2 py-2 rounded-lg hover:bg-emerald-50 text-xs font-medium text-gray-700">Formal</button>
        <button onclick="adjustTone('casual');document.getElementById('toneMenu').remove()" class="w-full text-center px-2 py-2 rounded-lg hover:bg-emerald-50 text-xs font-medium text-gray-700">Casual</button>
        <button onclick="adjustTone('friendly');document.getElementById('toneMenu').remove()" class="w-full text-center px-2 py-2 rounded-lg hover:bg-emerald-50 text-xs font-medium text-gray-700">Friendly</button>
    `;
    document.body.appendChild(menu);
    setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
            const m = document.getElementById('toneMenu');
            if (m && !m.contains(e.target) && e.target !== btn) {
                m.remove();
                document.removeEventListener('click', closeMenu);
            }
        });
    }, 100);
}

window.adjustTone = async function(tone) {
    const sel = window.getSelection();
    if (!sel || sel.isCollapsed) return;
    
    const selectedText = sel.toString().trim();
    if (!selectedText) return;
    
    setThinking(true);
    
    try {
        const res = await fetch(`${API}/dev/chat`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                user_id: state.user.sub,
                messages: [{
                    role: 'user',
                    content: `Rewrite this in a ${tone} tone (respond with ONLY the rewritten text, no quotes or explanation): "${selectedText}"`
                }]
            })
        });
        
        if (res.ok) {
            const data = await res.json();
            const rewritten = data.response.replace(/^["']|["']$/g, '').trim();
            const range = sel.getRangeAt(0);
            range.deleteContents();
            range.insertNode(document.createTextNode(rewritten));
            handleEditorInput();
            toast(`✨ Tone adjusted to ${tone}`, true);
        }
    } catch (e) {
        toast('Tone adjustment failed');
    } finally {
        setThinking(false);
    }
}

// Autocomplete keydown handler
function handleEditorKeydown(e) {
    if (e.key === 'Tab' && ghostTextNode) {
        e.preventDefault();
        acceptAutocomplete();
        return;
    }
    if (e.key === 'Escape' && ghostTextNode) {
        e.preventDefault();
        clearAutocomplete();
        return;
    }
}

// Trigger autocomplete on typing
async function triggerAutocomplete() {
    if (!autocompleteSettings.enabled) return;
    
    const editor = document.getElementById('editor');
    const text = editor.textContent.trim();
    if (text.length < 20) return;
    
    const sel = window.getSelection();
    if (!sel.rangeCount) return;
    
    const config = AGGRESSIVENESS_CONFIG[autocompleteSettings.aggressiveness];
    const contextLength = config.tokens * 5; // ~5 chars per token
    const context = text.slice(-contextLength);
    
    // Extract outline context
    const outline = extractOutlineContext();
    const fullContext = outline ? `${outline}\n\n${context}` : context;
    
    try {
        const res = await fetch(`${API}/autocomplete`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                user_id: state.user.sub,
                context: fullContext,
                max_tokens: config.tokens
            })
        });
        
        if (res.ok) {
            const data = await res.json();
            autocompleteSuggestions++;
            showAutocomplete(data.completion);
        }
    } catch (e) {
        console.log('Autocomplete failed:', e);
    }
}

function extractOutlineContext() {
    const editor = document.getElementById('editor');
    const text = editor.textContent;
    const headings = [];
    
    // Extract markdown-style headings
    const lines = text.split('\n');
    lines.forEach(line => {
        if (line.match(/^#{1,3}\s+/)) {
            headings.push(line.trim());
        } else if (line.match(/^[A-Z][^\n]{5,50}:$/)) {
            headings.push(line.trim());
        }
    });
    
    if (headings.length === 0) return null;
    return 'Document outline: ' + headings.slice(-3).join(' > ');
}

function showAutocomplete(text) {
    clearAutocomplete();
    
    const sel = window.getSelection();
    if (!sel.rangeCount) return;
    
    const range = sel.getRangeAt(0);
    ghostTextNode = document.createElement('span');
    ghostTextNode.className = 'ghost-text';
    ghostTextNode.textContent = text;
    ghostTextNode.contentEditable = 'false';
    
    range.insertNode(ghostTextNode);
    lastAutocompleteText = text;
}

function acceptAutocomplete() {
    if (!ghostTextNode) return;
    
    const text = lastAutocompleteText;
    const parent = ghostTextNode.parentNode;
    const textNode = document.createTextNode(text);
    parent.replaceChild(textNode, ghostTextNode);
    
    // Move cursor to end
    const range = document.createRange();
    const sel = window.getSelection();
    range.setStartAfter(textNode);
    range.collapse(true);
    sel.removeAllRanges();
    sel.addRange(range);
    
    ghostTextNode = null;
    lastAutocompleteText = '';
    autocompleteAcceptances++;
    
    // Update acceptance rate
    const acceptanceRate = autocompleteSuggestions > 0 ? (autocompleteAcceptances / autocompleteSuggestions * 100).toFixed(1) : 0;
    console.log(`Autocomplete: ${autocompleteAcceptances} accepts / ${autocompleteSuggestions} suggestions = ${acceptanceRate}%`);
    
    handleEditorInput();
    toast('✨ Accepted', true);
    gtag && gtag('event', 'autocomplete_accepted', {count: autocompleteAcceptances, rate: acceptanceRate});
}

function clearAutocomplete() {
    if (ghostTextNode && ghostTextNode.parentNode) {
        ghostTextNode.parentNode.removeChild(ghostTextNode);
    }
    ghostTextNode = null;
    lastAutocompleteText = '';
}

// Phase 4: Debounced autosave + Version History
let saveTimeout;
let coEditorTimeout;
function handleEditorInput() {
    const doc = state.docs.find(d => d.id === state.activeId);
    if (doc) {
        const oldContent = doc.content;
        doc.content = document.getElementById('editor').innerHTML;
        
        // Save version snapshot every 30 seconds if content changed
        if (oldContent !== doc.content) {
            saveVersion(doc.id, oldContent);
        }
    }
    updateStats();
    document.getElementById('saveStatus').textContent = 'Saving...';
    
    lastTypingTimestamp = Date.now();
    
    // Clear old autocomplete on new input
    clearAutocomplete();
    
    // Trigger autocomplete based on aggressiveness
    clearTimeout(autocompleteTimeout);
    const config = AGGRESSIVENESS_CONFIG[autocompleteSettings.aggressiveness];
    autocompleteTimeout = setTimeout(() => {
        if (Date.now() - lastTypingTimestamp >= config.delay) {
            triggerAutocomplete();
        }
    }, config.delay);
    
    const suggestionCard = document.getElementById('aiSuggestionCard');
    if (suggestionCard && suggestionCard.classList.contains('visible')) {
        suggestionCard.classList.remove('visible');
    }
    
    clearTimeout(suggestionTimeout);
    if (!suggestionCooldown) {
        suggestionTimeout = setTimeout(() => {
            if (Date.now() - lastTypingTimestamp >= 3000) {
                checkForSuggestions();
            }
        }, 3000);
    }
    
    // Auto-analyze for co-editor if enabled and panel is open
    if (autoSuggestEnabled && !document.getElementById('coEditorPanel').classList.contains('hidden')) {
        clearTimeout(coEditorTimeout);
        coEditorTimeout = setTimeout(() => {
            analyzeWriting();
        }, 2000);
    }
    
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
        document.getElementById('saveStatus').textContent = 'Saved';
        saveState();
    }, loadSettings().autosaveMs || 3000);
}

// Version History System
let versionTimeout;
function saveVersion(docId, content) {
    clearTimeout(versionTimeout);
    versionTimeout = setTimeout(() => {
        if (!state.versions[docId]) state.versions[docId] = [];
        
        // Only save if content is different from last version
        const lastVersion = state.versions[docId][state.versions[docId].length - 1];
        if (lastVersion && lastVersion.content === content) return;
        
        state.versions[docId].push({
            timestamp: Date.now(),
            content: content,
            wordCount: content.replace(/<[^>]*>/g, '').trim().split(/\s+/).filter(w => w).length
        });
        
        // Keep only last 20 versions
        if (state.versions[docId].length > 20) {
            state.versions[docId] = state.versions[docId].slice(-20);
        }
        
        saveState();
        console.log(`📸 Version saved for ${docId}`);
    }, 30000); // Save version every 30 seconds
}

function showVersionHistory() {
    const doc = state.docs.find(d => d.id === state.activeId);
    const versions = state.versions[state.activeId] || [];
    
    const modal = document.createElement('div');
    modal.id = 'versionModal';
    modal.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center';
    modal.style.zIndex = '100';
    
    let html = `
        <div class="bg-white rounded-2xl shadow-2xl w-[700px] max-h-[80vh] flex flex-col">
            <div class="px-4 py-3 border-b flex items-center justify-between">
                <h2 class="text-lg font-bold">🕐 Version History - ${doc.name}</h2>
                <button onclick="document.getElementById('versionModal').remove()" class="text-2xl opacity-50 hover:opacity-100">×</button>
            </div>
            <div class="overflow-auto p-4 space-y-2">`;
    
    if (versions.length === 0) {
        html += '<div class="text-center py-8 text-gray-500">No version history yet. Versions are saved automatically every 30 seconds.</div>';
    } else {
        versions.reverse().forEach((v, idx) => {
            const date = new Date(v.timestamp);
            const timeAgo = getTimeAgo(v.timestamp);
            html += `
                <div class="border rounded-lg p-3 hover:bg-gray-50 cursor-pointer" onclick="restoreVersion(${versions.length - 1 - idx})">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-semibold">${timeAgo}</span>
                        <span class="text-xs opacity-60">${date.toLocaleString()}</span>
                    </div>
                    <div class="text-xs opacity-60">${v.wordCount} words</div>
                    <div class="text-xs mt-2 opacity-75 line-clamp-2">${v.content.replace(/<[^>]*>/g, '').substring(0, 100)}...</div>
                </div>`;
        });
    }
    
    html += `
            </div>
            <div class="px-4 py-3 border-t text-xs text-gray-500 text-center">
                Click any version to restore it. Current version is saved automatically.
            </div>
        </div>
    `;
    
    modal.innerHTML = html;
    document.body.appendChild(modal);
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

function getTimeAgo(timestamp) {
    const seconds = Math.floor((Date.now() - timestamp) / 1000);
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
    return `${Math.floor(seconds / 86400)}d ago`;
}

window.restoreVersion = (index) => {
    const versions = state.versions[state.activeId];
    if (!versions || !versions[index]) return;
    
    if (!confirm('Restore this version? Current content will be saved as a new version.')) return;
    
    const doc = state.docs.find(d => d.id === state.activeId);
    
    // Save current as version before restoring
    saveVersion(doc.id, doc.content);
    clearTimeout(versionTimeout); // Force immediate save
    
    // Restore old version
    doc.content = versions[index].content;
    document.getElementById('editor').innerHTML = doc.content;
    saveState();
    
    document.getElementById('versionModal').remove();
    toast('✅ Version restored', true);
};

function handleKeyboardShortcuts(e) {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        showModal('palette');
    }
    if (e.key === 'Escape') {
        hideModal('palette');
        hideModal('upgradeModal');
        hideModal('folderModal');
        hideModal('loginModal');
        hideModal('signupModal');
        hideShortcuts();
    }
    if (e.key === '?' && !e.target.matches('input, textarea, [contenteditable]')) {
        e.preventDefault();
        showShortcuts();
    }
    if ((e.metaKey || e.ctrlKey) && e.key === 'b') { e.preventDefault(); formatDoc('bold'); }
    if ((e.metaKey || e.ctrlKey) && e.key === 'i') { e.preventDefault(); formatDoc('italic'); }
    if ((e.metaKey || e.ctrlKey) && e.key === 'u') { e.preventDefault(); formatDoc('underline'); }
}

function renderMarkdown(text) {
    return text
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>\n?)+/g, '<ul style="list-style: disc; margin-left: 20px; margin-top: 8px; margin-bottom: 8px;">$&</ul>')
        .replace(/\n/g, '<br>');
}

let lastEditorState = null;

async function addChatMessageWithCitations(text, citations, sender) {
    const div = document.createElement('div');
    div.className = 'text-sm p-3 rounded-2xl border bg-emerald-50 mr-8 text-gray-900';
    
    // Make [1], [2] clickable
    let html = renderMarkdown(text);
    if (citations && citations.length > 0) {
        html = html.replace(/\[(\d+)\]/g, (match, num) => {
            const idx = parseInt(num) - 1;
            if (idx < citations.length) {
                const cite = citations[idx];
                return `<a href="#" class="citation-link text-blue-600 hover:underline font-medium" data-cite="${num}" title="${cite.doc_name} - Page ${cite.page}">${match}</a>`;
            }
            return match;
        });
    }
    
    div.innerHTML = html;
    document.getElementById('chatMessages').appendChild(div);
    
    // Add click handlers for citations
    div.querySelectorAll('.citation-link').forEach(link => {
        link.onclick = (e) => {
            e.preventDefault();
            const num = parseInt(link.dataset.cite);
            showCitationPanel(citations[num - 1]);
        };
    });
    
    // Add citations panel if any
    if (citations && citations.length > 0) {
        const citationsDiv = document.createElement('div');
        citationsDiv.className = 'mt-2 pt-2 border-t border-emerald-200 text-xs text-gray-600';
        citationsDiv.innerHTML = `
            <div class="font-semibold mb-1">📚 Sources:</div>
            ${citations.map(c => `
                <div class="mb-1">
                    [${c.id}] ${c.doc_name} - Page ${c.page}
                    <span class="text-gray-400">(${(c.score * 100).toFixed(0)}% match)</span>
                </div>
            `).join('')}
        `;
        div.appendChild(citationsDiv);
    }
    
    div.scrollIntoView({behavior: 'smooth', block: 'end'});
    
    if (!state.chatHistory[state.activeId]) state.chatHistory[state.activeId] = [];
    state.chatHistory[state.activeId].push({text, sender, citations});
    saveState();
}

function showCitationPanel(citation) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-lg font-semibold">📄 Citation Details</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="space-y-3">
                <div>
                    <span class="font-semibold">Document:</span> ${citation.doc_name}
                </div>
                <div>
                    <span class="font-semibold">Page:</span> ${citation.page}
                </div>
                <div>
                    <span class="font-semibold">Relevance:</span> ${(citation.score * 100).toFixed(1)}%
                </div>
                <div>
                    <span class="font-semibold">Excerpt:</span>
                    <div class="mt-2 p-3 bg-gray-50 rounded border text-sm">
                        ${citation.text}
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

async function addChatMessageStreaming(text, sender) {
    const div = document.createElement('div');
    div.className = sender === 'user' 
        ? 'text-sm p-3 rounded-2xl border bg-blue-50 ml-8 text-gray-900'
        : 'text-sm p-3 rounded-2xl border bg-emerald-50 mr-8 text-gray-900';
    
    document.getElementById('chatMessages').appendChild(div);
    
    if (sender === 'bot') {
        const words = text.split(' ');
        let currentText = '';
        
        for (let i = 0; i < words.length; i++) {
            currentText += (i > 0 ? ' ' : '') + words[i];
            div.innerHTML = renderMarkdown(currentText);
            div.scrollIntoView({behavior: 'smooth', block: 'end'});
            await new Promise(resolve => setTimeout(resolve, 30));
        }
        
        if (text.length > 50 && !text.includes('❌') && !text.includes('✅')) {
            const btnContainer = document.createElement('div');
            btnContainer.className = 'flex gap-2 mt-2';
            
            const addBtn = document.createElement('button');
            addBtn.textContent = '➕ Add to Journal';
            addBtn.className = 'text-xs px-2 py-1 rounded border border-emerald-500 text-emerald-600 hover:bg-emerald-50';
            addBtn.onclick = () => {
                const editor = document.getElementById('editor');
                const cleanText = text.replace(/\*\*/g, '').replace(/\*/g, '').replace(/<[^>]*>/g, '');
                editor.innerHTML += '<p><br></p><p>' + cleanText + '</p>';
                handleEditorInput();
                toast('✅ Added to journal!', true);
                addBtn.disabled = true;
                addBtn.textContent = '✓ Added';
            };
            btnContainer.appendChild(addBtn);
            
            const undoBtn = document.createElement('button');
            undoBtn.textContent = '↩️ Undo';
            undoBtn.className = 'text-xs px-2 py-1 rounded border border-gray-400 hover:bg-gray-100';
            undoBtn.onclick = () => {
                if (lastEditorState) {
                    document.getElementById('editor').innerHTML = lastEditorState;
                    handleEditorInput();
                    toast('✅ Undone', true);
                    undoBtn.disabled = true;
                    undoBtn.textContent = '✓ Undone';
                }
            };
            btnContainer.appendChild(undoBtn);
            
            div.appendChild(btnContainer);
        }
    } else {
        div.innerHTML = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        div.scrollIntoView({behavior: 'smooth'});
    }
    
    if (!state.chatHistory[state.activeId]) state.chatHistory[state.activeId] = [];
    state.chatHistory[state.activeId].push({text, sender});
    saveState();
}

function addChatMessage(text, sender) {
    const div = document.createElement('div');
    div.className = sender === 'user' 
        ? 'text-sm p-3 rounded-2xl border bg-blue-50 ml-8 text-gray-900'
        : 'text-sm p-3 rounded-2xl border bg-emerald-50 mr-8 text-gray-900';
    div.innerHTML = sender === 'bot' ? renderMarkdown(text) : text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    
    if (sender === 'bot' && text.length > 50 && !text.includes('❌') && !text.includes('✅')) {
        const btnContainer = document.createElement('div');
        btnContainer.className = 'flex gap-2 mt-2';
        
        // Add to journal button
        const addBtn = document.createElement('button');
        addBtn.textContent = '➕ Add to Journal';
        addBtn.className = 'text-xs px-2 py-1 rounded border border-emerald-500 text-emerald-600 hover:bg-emerald-50';
        addBtn.onclick = () => {
            const editor = document.getElementById('editor');
            const cleanText = text.replace(/\*\*/g, '').replace(/\*/g, '').replace(/<[^>]*>/g, '');
            editor.innerHTML += '<p><br></p><p>' + cleanText + '</p>';
            handleEditorInput();
            toast('✅ Added to journal!', true);
            addBtn.disabled = true;
            addBtn.textContent = '✓ Added';
        };
        btnContainer.appendChild(addBtn);
        
        // Undo button
        const undoBtn = document.createElement('button');
        undoBtn.textContent = '↩️ Undo';
        undoBtn.className = 'text-xs px-2 py-1 rounded border border-gray-400 hover:bg-gray-100';
        undoBtn.onclick = () => {
            if (lastEditorState) {
                document.getElementById('editor').innerHTML = lastEditorState;
                handleEditorInput();
                toast('✅ Undone', true);
                undoBtn.disabled = true;
                undoBtn.textContent = '✓ Undone';
            }
        };
        btnContainer.appendChild(undoBtn);
        
        div.appendChild(btnContainer);
    }
    
    document.getElementById('chatMessages').appendChild(div);
    div.scrollIntoView({behavior: 'smooth'});
    
    if (!state.chatHistory[state.activeId]) state.chatHistory[state.activeId] = [];
    state.chatHistory[state.activeId].push({text, sender});
    saveState();
}

function addInteractiveChatMessage(text, sender) {
    const div = document.createElement('div');
    div.className = 'text-sm p-3 rounded-2xl border bg-emerald-50 mr-8 text-gray-900';
    div.innerHTML = renderMarkdown(text);
    
    const btnContainer = document.createElement('div');
    btnContainer.className = 'flex gap-2 mt-3';
    btnContainer.innerHTML = `
        <button onclick="document.getElementById('chatInput').value='yes';sendChat()" class="px-3 py-1 text-xs rounded-lg bg-emerald-500 text-white hover:bg-emerald-600">Yes</button>
        <button onclick="document.getElementById('chatInput').value='no';sendChat()" class="px-3 py-1 text-xs rounded-lg border hover:bg-gray-100">No</button>
    `;
    div.appendChild(btnContainer);
    
    document.getElementById('chatMessages').appendChild(div);
    div.scrollIntoView({behavior: 'smooth'});
    
    if (!state.chatHistory[state.activeId]) state.chatHistory[state.activeId] = [];
    state.chatHistory[state.activeId].push({text, sender});
    saveState();
}

function showInsights(insights) {
    state.docInsights[state.activeId] = insights;
    if (!state.docInsights[state.activeId].acceptedTips) state.docInsights[state.activeId].acceptedTips = [];
    saveState();
    
    const panel = document.getElementById('insightsPanel');
    const content = document.getElementById('insightsContent');
    const accepted = state.docInsights[state.activeId].acceptedTips;
    
    let html = '';
    if (insights.keyPoints && insights.keyPoints.length > 0) {
        html += '<div><div class="font-bold text-emerald-600 mb-2">💡 Key Points</div>';
        insights.keyPoints.forEach((p, i) => {
            const tipId = 'kp' + i;
            const isAccepted = accepted.includes(tipId);
            html += `<div class="flex items-start gap-2 mb-2 p-3 rounded-lg border border-emerald-200 hover:bg-emerald-50/50" style="background: rgba(255,255,255,0.8);"><div class="flex-1 text-sm">${p}</div><button onclick="acceptTip('${tipId}', 'clarity')" class="px-2 py-1 text-xs ${isAccepted ? 'bg-gray-300' : 'bg-emerald-500 hover:bg-emerald-600'} text-white rounded" ${isAccepted ? 'disabled' : ''}>${isAccepted ? '✓' : 'Apply'}</button></div>`;
        });
        html += '</div>';
    }
    if (insights.actionItems && insights.actionItems.length > 0) {
        html += '<div><div class="font-bold text-cyan-600 mb-2">✅ Action Items</div>';
        insights.actionItems.forEach((a, i) => {
            const tipId = 'ai' + i;
            const isAccepted = accepted.includes(tipId);
            html += `<div class="flex items-start gap-2 mb-2 p-3 rounded-lg border border-cyan-200 hover:bg-cyan-50/50" style="background: rgba(255,255,255,0.8);"><div class="flex-1 text-sm">${a}</div><button onclick="acceptTip('${tipId}', 'actionable')" class="px-2 py-1 text-xs ${isAccepted ? 'bg-gray-300' : 'bg-cyan-500 hover:bg-cyan-600'} text-white rounded" ${isAccepted ? 'disabled' : ''}>${isAccepted ? '✓' : 'Apply'}</button></div>`;
        });
        html += '</div>';
    }
    if (insights.questions && insights.questions.length > 0) {
        html += '<div><div class="font-bold text-purple-600 mb-1">❓ Questions</div><ul class="list-disc ml-4 space-y-1">';
        insights.questions.forEach(q => html += `<li>${q}</li>`);
        html += '</ul></div>';
    }
    
    content.innerHTML = html;
    panel.classList.remove('hidden');
    updateInsightsVisibility();
}

window.acceptTip = (tipId, type) => {
    const insights = state.docInsights[state.activeId];
    if (!insights || insights.acceptedTips.includes(tipId)) return;
    insights.acceptedTips.push(tipId);
    const boost = 8;
    if (insights.metrics) {
        if (type === 'clarity') insights.metrics.clarity = Math.min(100, insights.metrics.clarity + boost);
        if (type === 'actionable') insights.metrics.actionability = Math.min(100, insights.metrics.actionability + boost);
    }
    saveState();
    updateStats();
    toast(`✅ ${type === 'clarity' ? 'Clarity' : 'Actionability'} +${boost}%`, true);
    showInsights(insights);
};

let currentHighlightIndex = 0;
let allHighlights = [];

function updateInsightsVisibility() {
    const hasInsights = state.docInsights[state.activeId];
    const hasHighlights = state.docHighlights[state.activeId];
    const container = document.getElementById('lightningContainer');
    const panel = document.getElementById('insightsPanel');
    
    if (hasInsights || hasHighlights) {
        container.style.display = 'block';
    } else {
        container.style.display = 'none';
        panel.classList.add('hidden');
    }
}

window.openInsightsPanel = () => {
    closeHighlightLegend();
    const panel = document.getElementById('insightsPanel');
    const container = document.getElementById('lightningContainer');
    const btn = document.getElementById('insightsBtn');
    const rect = container.getBoundingClientRect();
    
    panel.style.top = `${rect.bottom + 8}px`;
    panel.style.left = `${rect.left}px`;
    panel.classList.remove('hidden');
    btn.classList.add('dimmed');
};

window.closeInsightsPanel = () => {
    const panel = document.getElementById('insightsPanel');
    const btn = document.getElementById('insightsBtn');
    panel.classList.add('hidden');
    btn.classList.remove('dimmed');
};

window.openHighlightLegend = () => {
    closeInsightsPanel();
    const panel = document.getElementById('highlightLegend');
    const container = document.getElementById('lightningContainer');
    const btn = document.getElementById('insightsBtn');
    const rect = container.getBoundingClientRect();
    
    panel.style.top = `${rect.bottom + 8}px`;
    panel.style.left = `${rect.left}px`;
    panel.classList.remove('hidden');
    btn.classList.add('dimmed');
    updateHighlightLegend();
};

window.closeHighlightLegend = () => {
    const panel = document.getElementById('highlightLegend');
    const btn = document.getElementById('insightsBtn');
    panel.classList.add('hidden');
    btn.classList.remove('dimmed');
};

window.toggleHighlightLegend = openHighlightLegend;

window.openCoEditor = () => {
    closeInsightsPanel();
    closeHighlightLegend();
    const panel = document.getElementById('coEditorPanel');
    const container = document.getElementById('lightningContainer');
    const btn = document.getElementById('insightsBtn');
    const rect = container.getBoundingClientRect();
    
    panel.style.top = `${rect.bottom + 8}px`;
    panel.style.left = `${rect.left}px`;
    panel.classList.remove('hidden');
    btn.classList.add('dimmed');
    analyzeWriting();
};

window.closeCoEditor = () => {
    const panel = document.getElementById('coEditorPanel');
    const btn = document.getElementById('insightsBtn');
    panel.classList.add('hidden');
    btn.classList.remove('dimmed');
};

let autoSuggestEnabled = true;
window.toggleAutoSuggest = () => {
    autoSuggestEnabled = document.getElementById('autoSuggest').checked;
    if (autoSuggestEnabled) toast('Auto-suggest enabled', true);
    else toast('Auto-suggest disabled');
};

function analyzeWriting() {
    const text = document.getElementById('editor').textContent.trim();
    if (text.length < 20) {
        document.getElementById('coEditorContent').innerHTML = '<div class="text-center py-8 text-sm text-gray-500">Start writing to get AI suggestions...</div>';
        currentSuggestions = [];
        return;
    }
    
    currentSuggestions = [];
    
    // Grammar checks
    if (/\b(there|their|they're)\b/gi.test(text)) {
        const matches = text.match(/\b(there|their|they're)\b/gi);
        if (matches) currentSuggestions.push({type: 'grammar', text: 'Check there/their/they\'re usage', action: 'review'});
    }
    if (/\b(its|it's)\b/gi.test(text)) {
        const matches = text.match(/\b(its|it's)\b/gi);
        if (matches) currentSuggestions.push({type: 'grammar', text: 'Verify its/it\'s usage', action: 'review'});
    }
    if (/[a-z]\.[A-Z]/g.test(text)) {
        currentSuggestions.push({type: 'grammar', text: 'Missing space after period', action: 'fix'});
    }
    
    // Style improvements
    if (/\b(very|really|just|actually|basically)\b/gi.test(text)) {
        currentSuggestions.push({type: 'style', text: 'Remove filler words (very, really, just)', action: 'improve'});
    }
    if (/\b(utilize|leverage|synergy)\b/gi.test(text)) {
        currentSuggestions.push({type: 'style', text: 'Replace jargon with simpler words', action: 'simplify'});
    }
    const sentences = text.split(/[.!?]/);
    const longSentences = sentences.filter(s => s.split(/\s+/).length > 25);
    if (longSentences.length > 0) {
        currentSuggestions.push({type: 'clarity', text: `${longSentences.length} sentence(s) are too long. Break them up.`, action: 'split'});
    }
    
    // Passive voice
    if (/\b(was|were|been|being)\s+\w+ed\b/gi.test(text)) {
        currentSuggestions.push({type: 'style', text: 'Consider using active voice instead of passive', action: 'rewrite'});
    }
    
    renderSuggestions();
}

let currentSuggestions = [];

window.dismissSuggestion = (index) => {
    currentSuggestions.splice(index, 1);
    renderSuggestions();
    toast('Dismissed', true);
};

window.applySuggestion = async (index, action) => {
    const text = document.getElementById('editor').textContent;
    toast('Applying suggestion...');
    
    try {
        const res = await fetch(`${API}/dev/chat`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                user_id: state.user.sub,
                messages: [{
                    role: 'user',
                    content: `${action === 'fix' ? 'Fix grammar' : action === 'simplify' ? 'Simplify' : action === 'split' ? 'Break into shorter sentences' : 'Improve'}: ${text.substring(0, 500)}`
                }]
            })
        });
        
        if (res.ok) {
            const data = await res.json();
            document.getElementById('editor').innerHTML = data.response;
            handleEditorInput();
            currentSuggestions.splice(index, 1);
            renderSuggestions();
            toast('✨ Applied!', true);
        }
    } catch (e) {
        toast('Failed to apply suggestion');
    }
};

function renderSuggestions() {
    const content = document.getElementById('coEditorContent');
    if (currentSuggestions.length === 0) {
        content.innerHTML = '<div class="text-center py-8 text-sm text-emerald-600">✨ Looking good! No suggestions right now.</div>';
    } else {
        content.innerHTML = currentSuggestions.map((s, i) => `
            <div class="suggestion-card ${s.type}">
                <div class="suggestion-type">${s.type}</div>
                <div class="suggestion-text">${s.text}</div>
                <div class="suggestion-actions">
                    <button onclick="dismissSuggestion(${i})">Dismiss</button>
                    <button class="primary" onclick="applySuggestion(${i}, '${s.action}')">Fix</button>
                </div>
            </div>
        `).join('');
    }
}

function generateMindMap_DISABLED() {
    const doc = state.docs.find(d => d.id === state.activeId);
    const text = doc.content.replace(/<[^>]*>/g, ' ').trim();
    const words = text.split(/\s+/);
    
    const stopWords = new Set(['the','a','an','and','or','but','in','on','at','to','for','of','with','by','from','as','is','was','are','were','be','been','being','have','has','had','do','does','did','will','would','should','could','may','might','must','can','this','that','these','those','i','you','he','she','it','we','they','what','which','who','when','where','why','how']);
    
    const wordFreq = {};
    const wordContext = {};
    words.forEach((w, idx) => {
        const word = w.toLowerCase().replace(/[^a-z]/g, '');
        if (word.length > 4 && !stopWords.has(word)) {
            wordFreq[word] = (wordFreq[word] || 0) + 1;
            if (!wordContext[word]) wordContext[word] = [];
            const context = words.slice(Math.max(0, idx-2), Math.min(words.length, idx+3)).join(' ');
            wordContext[word].push(context);
        }
    });
    
    const sorted = Object.entries(wordFreq).sort((a,b) => b[1] - a[1]).slice(0, 8);
    const concepts = sorted.map(([word]) => word);
    
    // Smart Clustering: Group concepts by co-occurrence
    const clusters = clusterConcepts(concepts, wordContext);
    
    const canvas = document.getElementById('mindMapCanvas');
    canvas.innerHTML = '';
    
    const colors = [
        {bg: 'rgba(16,185,129,0.1)', border: 'rgba(16,185,129,0.5)', glow: 'rgba(16,185,129,0.3)'},
        {bg: 'rgba(6,182,212,0.1)', border: 'rgba(6,182,212,0.5)', glow: 'rgba(6,182,212,0.3)'},
        {bg: 'rgba(168,85,247,0.1)', border: 'rgba(168,85,247,0.5)', glow: 'rgba(168,85,247,0.3)'},
        {bg: 'rgba(236,72,153,0.1)', border: 'rgba(236,72,153,0.5)', glow: 'rgba(236,72,153,0.3)'},
        {bg: 'rgba(251,191,36,0.1)', border: 'rgba(251,191,36,0.5)', glow: 'rgba(251,191,36,0.3)'},
        {bg: 'rgba(34,197,94,0.1)', border: 'rgba(34,197,94,0.5)', glow: 'rgba(34,197,94,0.3)'},
        {bg: 'rgba(59,130,246,0.1)', border: 'rgba(59,130,246,0.5)', glow: 'rgba(59,130,246,0.3)'},
        {bg: 'rgba(14,165,233,0.1)', border: 'rgba(14,165,233,0.5)', glow: 'rgba(14,165,233,0.3)'}
    ];
    
    const central = document.createElement('div');
    central.className = 'mind-node central';
    central.textContent = doc.name;
    central.style.left = '270px';
    central.style.top = '220px';
    canvas.appendChild(central);
    
    // Position clusters around center
    const nodes = [];
    clusters.forEach((cluster, clusterIdx) => {
        const clusterAngle = (clusterIdx / clusters.length) * 2 * Math.PI;
        const clusterRadius = 140;
        const clusterX = 270 + clusterRadius * Math.cos(clusterAngle);
        const clusterY = 220 + clusterRadius * Math.sin(clusterAngle);
        
        cluster.forEach((concept, i) => {
            const offset = (i - (cluster.length - 1) / 2) * 30;
            const perpAngle = clusterAngle + Math.PI / 2;
            const x = clusterX + offset * Math.cos(perpAngle);
            const y = clusterY + offset * Math.sin(perpAngle);
            
            const sentiment = analyzeSentiment(wordContext[concept] || []);
            const color = getSentimentColor(sentiment, colors[clusterIdx % colors.length]);
            const node = document.createElement('div');
            node.className = 'mind-node';
            node.textContent = concept;
            node.style.left = `${x}px`;
            node.style.top = `${y}px`;
            node.style.background = color.bg;
            node.style.borderColor = color.border;
            node.style.setProperty('--node-glow', color.glow);
            node.dataset.concept = concept;
            node.dataset.cluster = clusterIdx;
            node.dataset.sentiment = sentiment;
            node.dataset.expanded = 'false';
            node.dataset.contexts = JSON.stringify(wordContext[concept] || []);
            node.title = `${concept} (${sentiment})`;
            
            makeDraggable(node);
            canvas.appendChild(node);
            nodes.push({node, concept, x, y});
        });
    });
    
    // Draw relationship lines
    drawRelationships(nodes, concepts, wordContext);
    
    // Add particle effects
    createParticles(canvas);
}

function clusterConcepts(concepts, wordContext) {
    // Calculate co-occurrence scores
    const cooccurrence = {};
    concepts.forEach(c1 => {
        cooccurrence[c1] = {};
        concepts.forEach(c2 => {
            if (c1 === c2) return;
            let score = 0;
            const contexts1 = wordContext[c1] || [];
            const contexts2 = wordContext[c2] || [];
            contexts1.forEach(ctx1 => {
                contexts2.forEach(ctx2 => {
                    if (ctx1 === ctx2) score += 2;
                    else if (ctx1.includes(c2) || ctx2.includes(c1)) score += 1;
                });
            });
            cooccurrence[c1][c2] = score;
        });
    });
    
    // Simple clustering: group concepts with high co-occurrence
    const clusters = [];
    const used = new Set();
    
    concepts.forEach(concept => {
        if (used.has(concept)) return;
        const cluster = [concept];
        used.add(concept);
        
        // Find related concepts
        const scores = Object.entries(cooccurrence[concept])
            .filter(([c]) => !used.has(c))
            .sort((a, b) => b[1] - a[1]);
        
        if (scores.length > 0 && scores[0][1] > 0) {
            cluster.push(scores[0][0]);
            used.add(scores[0][0]);
        }
        
        clusters.push(cluster);
    });
    
    return clusters;
}

function analyzeSentiment(contexts) {
    const positive = ['good','great','excellent','amazing','wonderful','best','love','happy','success','achieve','improve','benefit','effective','strong','powerful','innovative','creative','opportunity','growth','win'];
    const negative = ['bad','poor','terrible','awful','worst','hate','sad','fail','problem','issue','difficult','challenge','risk','weak','threat','concern','loss','decline','error','wrong'];
    
    let score = 0;
    contexts.forEach(ctx => {
        const words = ctx.toLowerCase().split(/\s+/);
        words.forEach(w => {
            if (positive.includes(w)) score++;
            if (negative.includes(w)) score--;
        });
    });
    
    if (score > 0) return 'positive';
    if (score < 0) return 'negative';
    return 'neutral';
}

function getSentimentColor(sentiment, baseColor) {
    if (sentiment === 'positive') {
        return {
            bg: 'rgba(34,197,94,0.15)',
            border: 'rgba(34,197,94,0.6)',
            glow: 'rgba(34,197,94,0.4)'
        };
    } else if (sentiment === 'negative') {
        return {
            bg: 'rgba(239,68,68,0.15)',
            border: 'rgba(239,68,68,0.6)',
            glow: 'rgba(239,68,68,0.4)'
        };
    }
    return baseColor;
}

function createParticles(canvas) {
    const colors = ['', 'cyan', 'purple', 'pink'];
    for (let i = 0; i < 20; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle ' + colors[Math.floor(Math.random() * colors.length)];
        particle.style.left = Math.random() * 600 + 'px';
        particle.style.top = Math.random() * 500 + 'px';
        particle.style.setProperty('--tx', (Math.random() - 0.5) * 100 + 'px');
        particle.style.setProperty('--ty', (Math.random() - 0.5) * 100 + 'px');
        particle.style.animationDelay = Math.random() * 3 + 's';
        canvas.appendChild(particle);
    }
}

function drawRelationships(nodes, concepts, wordContext) {
    const canvas = document.getElementById('mindMapCanvas');
    const cooccurrence = {};
    
    concepts.forEach(c1 => {
        cooccurrence[c1] = {};
        concepts.forEach(c2 => {
            if (c1 === c2) return;
            let score = 0;
            const contexts1 = wordContext[c1] || [];
            const contexts2 = wordContext[c2] || [];
            contexts1.forEach(ctx1 => {
                contexts2.forEach(ctx2 => {
                    if (ctx1 === ctx2) score += 2;
                    else if (ctx1.includes(c2) || ctx2.includes(c1)) score += 1;
                });
            });
            cooccurrence[c1][c2] = score;
        });
    });
    
    nodes.forEach((n1, i) => {
        nodes.slice(i + 1).forEach(n2 => {
            const score = cooccurrence[n1.concept]?.[n2.concept] || 0;
            if (score > 0) {
                const x1 = n1.node.offsetLeft + n1.node.offsetWidth / 2;
                const y1 = n1.node.offsetTop + n1.node.offsetHeight / 2;
                const x2 = n2.node.offsetLeft + n2.node.offsetWidth / 2;
                const y2 = n2.node.offsetTop + n2.node.offsetHeight / 2;
                
                const line = document.createElement('div');
                line.className = score > 2 ? 'neural-line strong' : 'neural-line';
                const length = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
                const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
                
                line.style.width = length + 'px';
                line.style.left = x1 + 'px';
                line.style.top = y1 + 'px';
                line.style.transform = `rotate(${angle}deg)`;
                
                canvas.insertBefore(line, canvas.firstChild);
            }
        });
    });
}

function expandNode(node, concept, contexts, color) {
    node.classList.add('expanded');
    const subConcepts = contexts.slice(0, 3).map(c => c.split(' ').filter(w => w.length > 4 && w !== concept)[0]).filter(Boolean);
    const nodeRect = node.getBoundingClientRect();
    const canvasRect = document.getElementById('mindMapCanvas').getBoundingClientRect();
    
    subConcepts.forEach((sub, i) => {
        const angle = (i / subConcepts.length) * 2 * Math.PI;
        const subRadius = 60;
        const subX = node.offsetLeft + subRadius * Math.cos(angle);
        const subY = node.offsetTop + subRadius * Math.sin(angle);
        
        const subNode = document.createElement('div');
        subNode.className = 'mind-node mind-node-sub';
        subNode.textContent = sub;
        subNode.style.left = `${subX}px`;
        subNode.style.top = `${subY}px`;
        subNode.style.background = color.bg;
        subNode.style.borderColor = color.border;
        subNode.style.setProperty('--node-glow', color.glow);
        subNode.dataset.parent = concept;
        
        document.getElementById('mindMapCanvas').appendChild(subNode);
    });
}

function collapseNode(node) {
    node.classList.remove('expanded');
    const concept = node.dataset.concept;
    const canvas = document.getElementById('mindMapCanvas');
    const subNodes = canvas.querySelectorAll(`[data-parent="${concept}"]`);
    subNodes.forEach(sub => sub.remove());
}

function makeDraggable(node) {
    let isDragging = false;
    let startX, startY, startLeft, startTop;
    
    node.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        startLeft = node.offsetLeft;
        startTop = node.offsetTop;
        node.classList.add('dragging');
        e.preventDefault();
    });
    
    document.addEventListener('mousemove', (e) => {
        if (!isDragging || node !== document.querySelector('.mind-node.dragging')) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        node.style.left = (startLeft + dx) + 'px';
        node.style.top = (startTop + dy) + 'px';
    });
    
    document.addEventListener('mouseup', (e) => {
        if (isDragging) {
            const dragDistance = Math.sqrt(Math.pow(e.clientX - startX, 2) + Math.pow(e.clientY - startY, 2));
            isDragging = false;
            node.classList.remove('dragging');
            
            if (dragDistance < 5) {
                if (node.dataset.expanded === 'false') {
                    const concept = node.dataset.concept;
                    const contexts = node.dataset.contexts ? JSON.parse(node.dataset.contexts) : [];
                    const color = {
                        bg: node.style.background,
                        border: node.style.borderColor,
                        glow: node.style.getPropertyValue('--node-glow')
                    };
                    expandNode(node, concept, contexts, color);
                    node.dataset.expanded = 'true';
                } else {
                    collapseNode(node);
                    node.dataset.expanded = 'false';
                }
            }
        }
    });
}

window.regenerateMindMap = () => {
    generateMindMap();
    toast('🔄 Mind map regenerated with smart clustering', true);
};

// === CHATPDF UX ENHANCEMENTS ===

function renderArtifacts(artifact) {
    if (!artifact) return;
    const activeDoc = state.docs.find(d => d.id === state.activeId);
    if (activeDoc) {
        if (artifact.doc_id && !activeDoc.backendId) activeDoc.backendId = artifact.doc_id;
        activeDoc.summary = artifact.summary || activeDoc.summary || '';
        activeDoc.questions = artifact.questions || [];
        saveState();
    }
    if (!artifact || !artifact.summary) return;
    
    // Save to chat history for persistence
    if (!state.chatHistory[state.activeId]) state.chatHistory[state.activeId] = [];
    state.chatHistory[state.activeId].push({
        text: artifact.summary,
        sender: 'bot',
        artifact: artifact
    });
    saveState();
    
    const chatMessages = document.getElementById('chatMessages');
    const box = document.createElement('div');
    box.className = 'text-sm p-3 rounded-2xl border bg-emerald-50 mr-8 text-gray-900';
    
    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'font-bold text-emerald-700 mb-2';
    summaryDiv.textContent = '📄 Document Summary';
    box.appendChild(summaryDiv);
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'mb-3';
    contentDiv.textContent = artifact.summary;
    box.appendChild(contentDiv);
    
    if (artifact.questions && artifact.questions.length > 0) {
        const qHeader = document.createElement('div');
        qHeader.className = 'font-bold text-cyan-700 mb-2';
        qHeader.textContent = '💡 Suggested Questions';
        box.appendChild(qHeader);
        
        const qContainer = document.createElement('div');
        qContainer.className = 'space-y-2';
        
        artifact.questions.forEach(q => {
            const btn = document.createElement('button');
            btn.className = 'qcard w-full text-left px-3 py-2 rounded-lg border border-cyan-300 bg-white hover:bg-cyan-50 hover:border-cyan-500 transition-all text-sm';
            btn.textContent = q;
            btn.onclick = () => {
                document.getElementById('chatInput').value = q;
                sendChat();
            };
            qContainer.appendChild(btn);
        });
        
        box.appendChild(qContainer);
    }
    
    chatMessages.appendChild(box);
    box.scrollIntoView({ behavior: 'smooth' });
}

function renderAnswerWithCitations(data) {
    const chatMessages = document.getElementById('chatMessages');
    const div = document.createElement('div');
    div.className = 'text-sm p-3 rounded-2xl border bg-emerald-50 mr-8 text-gray-900';
    let html = (data.response || data.answer || '').replace(/\[(\d+)\]/g, (_, n) => 
        `<sup class="cit cursor-pointer text-blue-600 hover:text-blue-800 font-bold underline" data-cit="${n}" onclick="jumpToCitation(${n}, ${JSON.stringify(data.citations || []).replace(/"/g, '&quot;')})">[${n}]</sup>`
    );
    if (data.citations && data.citations.length > 0) {
        html += `<div class="mt-3 pt-3 border-t border-emerald-200">
            <div class="text-xs font-bold text-gray-600 mb-2">📚 Sources:</div>
            <ol class="text-xs space-y-1">
                ${data.citations.map(s => `
                    <li class="text-gray-700">
                        <span class="font-bold text-blue-600">[${s.n}]</span> 
                        ${escapeHtml(s.docName || 'Document')}${s.page ? `, p.${s.page}` : ''} 
                        ${s.text ? `— <em class="text-gray-600">${escapeHtml(s.text.substring(0, 100))}...</em>` : ''}
                    </li>
                `).join('')}
            </ol>
        </div>`;
    }
    div.innerHTML = html;
    chatMessages.appendChild(div);
    // Citations are now clickable inline
    div.scrollIntoView({ behavior: 'smooth' });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

window.exportMindMap = () => {
    const canvas = document.getElementById('mindMapCanvas');
    const nodes = Array.from(canvas.children);
    let text = `Mind Map: ${state.docs.find(d => d.id === state.activeId).name}\n\n`;
    nodes.forEach(node => {
        text += `- ${node.textContent}\n`;
    });
    const blob = new Blob([text], {type: 'text/plain'});
    downloadBlob(blob, 'mindmap.txt');
    toast('📥 Mind map exported', true);
};

window.minimizeInsights = closeInsightsPanel;
window.expandInsights = openInsightsPanel;

window.nextHighlight = () => {
    if (allHighlights.length === 0) return;
    currentHighlightIndex = (currentHighlightIndex + 1) % allHighlights.length;
    scrollToHighlight(currentHighlightIndex);
};

window.prevHighlight = () => {
    if (allHighlights.length === 0) return;
    currentHighlightIndex = (currentHighlightIndex - 1 + allHighlights.length) % allHighlights.length;
    scrollToHighlight(currentHighlightIndex);
};

function scrollToHighlight(index) {
    allHighlights.forEach((h, i) => {
        if (i === index) {
            h.style.outline = '2px solid #10b981';
            h.style.outlineOffset = '2px';
        } else {
            h.style.outline = 'none';
        }
    });
    allHighlights[index].scrollIntoView({behavior: 'smooth', block: 'center'});
    document.getElementById('highlightCount').textContent = `${index + 1} of ${allHighlights.length}`;
}

function applySmartHighlights(highlights, options = {}) {
    console.log('Applying highlights:', highlights);
    if (!highlights || highlights.length === 0) {
        console.log('No highlights to apply');
        return;
    }
    
    state.docHighlights[state.activeId] = highlights;
    saveState();
    
    const editor = document.getElementById('editor');
    editor.querySelectorAll('.smart-highlight').forEach(mark => {
        const parent = mark.parentNode;
        while (mark.firstChild) parent.insertBefore(mark.firstChild, mark);
        parent.removeChild(mark);
    });
    let content = editor.innerHTML;
    let appliedCount = 0;
    
    // Apply highlights with different colors based on type
    highlights.forEach((h, idx) => {
        const colors = {
            key: 'background: linear-gradient(120deg, #fef3c7 0%, #fde68a 100%); padding: 2px 4px; border-radius: 3px;',
            action: 'background: linear-gradient(120deg, #dbeafe 0%, #bfdbfe 100%); padding: 2px 4px; border-radius: 3px;',
            important: 'background: linear-gradient(120deg, #fecaca 0%, #fca5a5 100%); padding: 2px 4px; border-radius: 3px;'
        };
        const style = colors[h.type] || colors.key;
        const escaped = h.text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`(${escaped})`, 'gi');
        const hlId = h.id ? escapeHtmlAttr(h.id) : `auto-${idx}`;
        const newContent = content.replace(regex, `<mark class="smart-highlight" data-index="${idx}" data-hl-id="${hlId}" style="${style}" title="${h.type}">$1</mark>`);
        if (newContent !== content) appliedCount++;
        content = newContent;
    });
    
    editor.innerHTML = content;
    allHighlights = Array.from(editor.querySelectorAll('.smart-highlight'));
    currentHighlightIndex = 0;
    
    const focusRequest = options.focus || null;
    let focusIndex = -1;
    let matchedHighlight = null;
    if (focusRequest) {
        const idx = findHighlightIndex(highlights, focusRequest);
        if (focusRequest.id) {
            const byId = allHighlights.findIndex(el => el.dataset.hlId === focusRequest.id);
            if (byId !== -1) focusIndex = byId;
        }
        if (focusIndex === -1 && typeof idx === 'number' && idx >= 0 && idx < allHighlights.length) {
            const byIdx = allHighlights.findIndex(el => parseInt(el.dataset.index || '-1', 10) === idx);
            focusIndex = byIdx !== -1 ? byIdx : idx;
        }
        if (focusIndex === -1 && focusRequest.text) {
            const normalized = focusRequest.text.trim().toLowerCase();
            const byText = allHighlights.findIndex(el => (el.textContent || '').trim().toLowerCase() === normalized);
            if (byText !== -1) focusIndex = byText;
        }
        if (focusIndex !== -1) {
            matchedHighlight = focusIndex;
        }
    }

    console.log(`Applied ${appliedCount} of ${highlights.length} highlights`);
    if (appliedCount > 0) {
        toast(`✨ ${appliedCount} highlights applied`);
        const nav = document.getElementById('highlightNav');
        nav.style.display = 'flex';
        const target = matchedHighlight !== null && matchedHighlight >= 0 ? matchedHighlight : 0;
        currentHighlightIndex = target;
        document.getElementById('highlightCount').textContent = `${target + 1} of ${allHighlights.length}`;
        if (allHighlights.length > 0) scrollToHighlight(target);
    } else {
        const nav = document.getElementById('highlightNav');
        if (nav) nav.style.display = 'none';
    }
    updateInsightsVisibility();
}



function showModal(id) {
    const modal = document.getElementById(id);
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    const content = modal.querySelector('div:not(.fixed)');
    if (content) content.classList.add('dock-enter');
}

function hideModal(id) {
    document.getElementById(id).classList.add('hidden');
    document.getElementById(id).classList.remove('flex');
}

function toast(msg, isSuccess = false) {
    const div = document.createElement('div');
    div.className = 'fixed bottom-4 right-4 bg-emerald-500 text-white text-sm px-4 py-2 rounded-lg shadow-lg z-50';
    div.setAttribute('role', 'alert');
    div.setAttribute('aria-live', 'polite');
    if (isSuccess) div.classList.add('success-pulse');
    div.textContent = msg;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 3000);
}

function showProgress(percent) {
    const bar = document.getElementById('progressBar');
    bar.style.width = percent + '%';
    if (percent >= 100) setTimeout(() => bar.style.width = '0', 500);
}

window.showShortcuts = () => {
    const overlay = document.getElementById('shortcutsOverlay');
    overlay.classList.remove('hidden');
    overlay.classList.add('flex');
};

window.hideShortcuts = () => {
    const overlay = document.getElementById('shortcutsOverlay');
    overlay.classList.add('hidden');
    overlay.classList.remove('flex');
};

window.setActive = (id) => {
    state.activeId = id;
    render();
    saveState();
    // Close mobile menu after selection
    document.getElementById('leftSidebar')?.classList.remove('mobile-open');
};

window.scrollToPage = (pageIdx) => {
    const pages = document.getElementById('editor').querySelectorAll('div[style*="page-break-after"]');
    if (pages[pageIdx]) {
        pages[pageIdx].scrollIntoView({behavior: 'smooth', block: 'start'});
        document.querySelectorAll('.pdf-thumb').forEach((thumb, idx) => {
            thumb.classList.toggle('active', idx === pageIdx);
        });
    }
};

window.jumpToCitation = (citationNum, citations) => {
    const citation = citations.find(c => c.n === citationNum);
    if (!citation) return;
    
    const page = citation.page || 1;
    const text = citation.text || '';
    
    // Scroll to page
    scrollToPage(page - 1);
    
    // Highlight text in editor
    setTimeout(() => {
        const editor = document.getElementById('editor');
        const content = editor.innerHTML;
        
        // Remove old highlights
        const cleaned = content.replace(/<mark class="citation-highlight"[^>]*>(.*?)<\/mark>/gi, '$1');
        
        // Add new highlight
        if (text.length > 20) {
            const searchText = text.substring(0, 100).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const highlighted = cleaned.replace(new RegExp(`(${searchText})`, 'i'), 
                '<mark class="citation-highlight" style="background: linear-gradient(120deg, #fef3c7 0%, #fde68a 100%); padding: 2px 4px; border-radius: 3px; animation: pulse 1s ease-in-out 3;">$1</mark>');
            editor.innerHTML = highlighted;
            
            // Scroll to highlight
            const mark = editor.querySelector('.citation-highlight');
            if (mark) mark.scrollIntoView({behavior: 'smooth', block: 'center'});
        }
        
        toast(`📍 Jumped to page ${page}`, true);
    }, 300);
};

// Phase 4: Undo delete with 5s window
let deletedDoc = null;
window.deleteDoc = (id) => {
    if (state.docs.length <= 1) {
        toast('⚠️ Cannot delete last document');
        return;
    }
    if (!confirm('Delete this document?')) return;
    deletedDoc = state.docs.find(d => d.id === id);
    state.docs = state.docs.filter(d => d.id !== id);
    if (state.activeId === id) state.activeId = state.docs[0].id;
    saveState();
    render();
    const undoToast = document.createElement('div');
    undoToast.className = 'fixed bottom-4 right-4 bg-red-500 text-white text-sm px-4 py-2 rounded-lg shadow-lg z-50 flex gap-2 items-center';
    undoToast.innerHTML = 'Document deleted <button onclick="undoDelete()" class="underline font-bold">UNDO</button>';
    document.body.appendChild(undoToast);
    setTimeout(() => { undoToast.remove(); deletedDoc = null; }, 5000);
};

window.undoDelete = () => {
    if (deletedDoc) {
        state.docs.push(deletedDoc);
        state.activeId = deletedDoc.id;
        deletedDoc = null;
        saveState();
        render();
        toast('✅ Document restored', true);
    }
};

async function selectPlan(plan) {
    const errorDiv = document.getElementById('upgradeError');
    errorDiv.classList.add('hidden');
    
    if (!state.user || state.user.isGuest) {
        hideModal('upgradeModal');
        showModal('loginModal');
        toast('Please login first');
        return;
    }
    
    posthog && posthog.capture('upgrade', {plan: plan});
    
    // Show loading state
    const buttons = document.querySelectorAll('.selectPlan');
    buttons.forEach(btn => {
        btn.disabled = true;
        btn.textContent = 'Loading...';
    });
    
    try {
        const headers = {'Content-Type': 'application/json'};
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
        const res = await fetch(`${API}/subscription`, {
            method: 'POST',
            headers,
            body: JSON.stringify({
                action: 'create',
                user_id: state.user.sub,
                plan: plan
            })
        });
        
        const data = await res.json();
        
        if (res.ok && data.checkout_url) {
            errorDiv.textContent = '✅ Redirecting to Stripe checkout...';
            errorDiv.classList.remove('bg-red-50', 'border-red-200', 'text-red-700');
            errorDiv.classList.add('bg-green-50', 'border-green-200', 'text-green-700');
            errorDiv.classList.remove('hidden');
            window.location.href = data.checkout_url;
        } else {
            errorDiv.textContent = '❌ Checkout failed: ' + (data.error || 'Unknown error');
            errorDiv.classList.remove('bg-green-50', 'border-green-200', 'text-green-700');
            errorDiv.classList.add('bg-red-50', 'border-red-200', 'text-red-700');
            errorDiv.classList.remove('hidden');
            
            // Reset buttons
            buttons.forEach(btn => {
                btn.disabled = false;
                const planType = btn.dataset.plan;
                btn.textContent = planType === 'test' ? 'Test Checkout' : (planType === 'monthly' ? 'Get Monthly' : 'Get Annual');
            });
        }
    } catch (e) {
        errorDiv.textContent = '❌ Error: ' + e.message;
        errorDiv.classList.remove('bg-green-50', 'border-green-200', 'text-green-700');
        errorDiv.classList.add('bg-red-50', 'border-red-200', 'text-red-700');
        errorDiv.classList.remove('hidden');
        
        // Reset buttons
        buttons.forEach(btn => {
            btn.disabled = false;
            const planType = btn.dataset.plan;
            btn.textContent = planType === 'test' ? 'Test Checkout' : (planType === 'monthly' ? 'Get Monthly' : 'Get Annual');
        });
    }
}

// === PRODUCTION FEATURES (Approach 2) ===

// Settings Modal
function openLibrary() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/20 backdrop-blur-md flex items-center justify-center modal-enter';
    modal.style.zIndex = '100';
    modal.innerHTML = `<div class="bg-white/90 backdrop-blur-xl rounded-2xl shadow-2xl w-[600px] max-h-[80vh] flex flex-col border border-emerald-200" style="box-shadow: 0 8px 32px rgba(16,185,129,0.2), 0 0 60px rgba(6,182,212,0.15);"><div class="px-4 py-3 border-b border-emerald-200 flex items-center justify-between"><h2 class="text-lg font-bold text-emerald-700">📚 Library (${state.docs.length} docs)</h2><button onclick="this.closest('.fixed').remove()" class="text-2xl opacity-50 hover:opacity-100">×</button></div><div class="overflow-auto p-4 space-y-2">${state.docs.map(d => {
        const words = d.content.replace(/<[^>]*>/g, '').trim().split(/\s+/).filter(w => w).length;
        const tags = d.tags || [];
        return `<div class="border border-emerald-200 rounded-lg p-3 hover:bg-emerald-50/50 backdrop-blur" style="background: rgba(255,255,255,0.7);"><div class="flex justify-between items-start mb-2"><div class="flex-1"><div class="font-semibold text-sm">${d.name}</div><div class="text-xs text-gray-500">${words} words</div></div><button onclick="setActive('${d.id}');document.querySelector('.fixed').remove();" class="text-xs px-2 py-1 bg-emerald-500 text-white rounded hover:bg-emerald-600">Open</button></div><div class="flex gap-1 flex-wrap">${tags.map(t => `<span class="text-xs px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded">${t}</span>`).join('')}<button onclick="addTagToDoc('${d.id}')" class="text-xs px-2 py-0.5 border border-emerald-300 text-emerald-600 rounded hover:bg-emerald-50">+ Tag</button></div></div>`;
    }).join('')}</div></div>`;
    document.body.appendChild(modal);
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    gtag && gtag('event', 'library_opened', {doc_count: state.docs.length});
}

window.addTagToDoc = (docId) => {
    const tag = prompt('Add tag:');
    if (!tag) return;
    const doc = state.docs.find(d => d.id === docId);
    if (!doc.tags) doc.tags = [];
    if (!doc.tags.includes(tag)) {
        doc.tags.push(tag);
        saveState();
        document.querySelector('.fixed')?.remove();
        openLibrary();
        gtag && gtag('event', 'doc_tagged', {tag: tag});
    }
};

function showDocIQTips() {
    const tips = (state.docInsights[state.activeId]?.metrics?.tips) || ['Looks good!'];
    addChatMessage(`**Suggestions**\n- ${tips.join('\n- ')}`, 'bot');
}

function openSettings() {
    const s = loadSettings();
    const modal = document.createElement('div');
    modal.id = 'settingsModal';
    modal.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center';
    modal.style.zIndex = '100';
    
    // Check if user has active subscription
    let subscriptionSection = '';
    if (state.user && !state.user.isGuest && state.user.tier && state.user.tier !== 'Free') {
        subscriptionSection = `
            <div class="border-t pt-4 mt-4">
                <div class="text-sm font-semibold mb-2">Subscription</div>
                <div class="text-xs text-gray-500 mb-3">Plan: ${state.user.tier || 'Premium'}</div>
                <button onclick="cancelSubscription()" class="w-full bg-red-500 text-white rounded-lg px-4 py-2 hover:bg-red-600 text-sm">Cancel Subscription</button>
            </div>
        `;
    }
    
    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-[600px] p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">⚙️ Settings</h2>
                <button onclick="document.getElementById('settingsModal').remove()" class="text-2xl opacity-50 hover:opacity-100">×</button>
            </div>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm">Theme</span>
                    <select id="settingTheme" class="border rounded px-3 py-1 text-sm">
                        <option value="light" ${s.theme === 'light' ? 'selected' : ''}>Light</option>
                        <option value="dark" ${s.theme === 'dark' ? 'selected' : ''}>Dark</option>
                    </select>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm">Autosave interval (ms)</span>
                    <input id="settingAutosave" type="number" value="${s.autosaveMs}" min="1000" step="500" class="border rounded px-3 py-1 text-sm w-24" />
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm">Do Not Disturb</span>
                    <input id="settingDnd" type="checkbox" ${s.dnd ? 'checked' : ''} class="w-4 h-4" />
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm">Journal Mode</span>
                    <input id="settingJournal" type="checkbox" ${s.journalMode ? 'checked' : ''} class="w-4 h-4" />
                </div>
                <button onclick="saveSettingsFromModal()" class="w-full bg-emerald-500 text-white rounded-lg px-4 py-2 hover:bg-emerald-600">Save Settings</button>
                ${subscriptionSection}
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

function openAutocompleteSettings() {
    const modal = document.createElement('div');
    modal.id = 'autocompleteSettingsModal';
    modal.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center';
    modal.style.zIndex = '100';
    
    const acceptanceRate = autocompleteSuggestions > 0 ? (autocompleteAcceptances / autocompleteSuggestions * 100).toFixed(1) : 0;
    const avgTokens = autocompleteAcceptances > 0 ? Math.round(autocompleteAcceptances * 12) : 0; // estimate
    
    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-[600px] p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">✨ Autocomplete Settings</h2>
                <button onclick="document.getElementById('autocompleteSettingsModal').remove()" class="text-2xl opacity-50 hover:opacity-100">×</button>
            </div>
            
            <div class="space-y-6">
                <!-- Metrics -->
                <div class="p-4 rounded-xl bg-gradient-to-r from-emerald-50 to-cyan-50 border border-emerald-200">
                    <div class="text-sm font-semibold text-emerald-700 mb-3">📊 Performance Metrics</div>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-emerald-600">${acceptanceRate}%</div>
                            <div class="text-xs text-gray-600">Acceptance Rate</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-cyan-600">${autocompleteAcceptances}</div>
                            <div class="text-xs text-gray-600">Accepted</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600">${autocompleteSuggestions}</div>
                            <div class="text-xs text-gray-600">Shown</div>
                        </div>
                    </div>
                </div>
                
                <!-- Enable/Disable -->
                <div class="flex items-center justify-between p-4 rounded-lg border">
                    <div>
                        <div class="text-sm font-semibold">Enable Autocomplete</div>
                        <div class="text-xs text-gray-500">Show AI writing suggestions as you type</div>
                    </div>
                    <input id="autocompleteEnabled" type="checkbox" ${autocompleteSettings.enabled ? 'checked' : ''} class="w-5 h-5" />
                </div>
                
                <!-- Aggressiveness -->
                <div class="p-4 rounded-lg border">
                    <div class="text-sm font-semibold mb-3">Aggressiveness Level</div>
                    <div class="space-y-2">
                        <label class="flex items-center gap-3 p-3 rounded-lg border cursor-pointer hover:bg-gray-50 ${autocompleteSettings.aggressiveness === 'low' ? 'bg-emerald-50 border-emerald-500' : ''}">
                            <input type="radio" name="aggressiveness" value="low" ${autocompleteSettings.aggressiveness === 'low' ? 'checked' : ''} />
                            <div class="flex-1">
                                <div class="text-sm font-semibold">Low</div>
                                <div class="text-xs text-gray-500">1.5s delay, 10 tokens - Less intrusive</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 rounded-lg border cursor-pointer hover:bg-gray-50 ${autocompleteSettings.aggressiveness === 'medium' ? 'bg-emerald-50 border-emerald-500' : ''}">
                            <input type="radio" name="aggressiveness" value="medium" ${autocompleteSettings.aggressiveness === 'medium' ? 'checked' : ''} />
                            <div class="flex-1">
                                <div class="text-sm font-semibold">Medium (Recommended)</div>
                                <div class="text-xs text-gray-500">1s delay, 15 tokens - Balanced</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 rounded-lg border cursor-pointer hover:bg-gray-50 ${autocompleteSettings.aggressiveness === 'high' ? 'bg-emerald-50 border-emerald-500' : ''}">
                            <input type="radio" name="aggressiveness" value="high" ${autocompleteSettings.aggressiveness === 'high' ? 'checked' : ''} />
                            <div class="flex-1">
                                <div class="text-sm font-semibold">High</div>
                                <div class="text-xs text-gray-500">0.5s delay, 20 tokens - Most suggestions</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <button onclick="saveAutocompleteSettings()" class="w-full bg-emerald-500 text-white rounded-lg px-4 py-2 hover:bg-emerald-600">Save Settings</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

window.saveAutocompleteSettings = () => {
    autocompleteSettings.enabled = document.getElementById('autocompleteEnabled').checked;
    const selectedRadio = document.querySelector('input[name="aggressiveness"]:checked');
    if (selectedRadio) {
        autocompleteSettings.aggressiveness = selectedRadio.value;
    }
    
    localStorage.setItem('autocomplete_settings', JSON.stringify(autocompleteSettings));
    toast('✅ Autocomplete settings saved', true);
    document.getElementById('autocompleteSettingsModal').remove();
};

// Load autocomplete settings on init
const savedAutocompleteSettings = localStorage.getItem('autocomplete_settings');
if (savedAutocompleteSettings) {
    try {
        autocompleteSettings = JSON.parse(savedAutocompleteSettings);
    } catch (e) {
        console.error('Failed to load autocomplete settings:', e);
    }
}

window.saveSettingsFromModal = () => {
    const newTheme = document.getElementById('settingTheme').value;
    const currentTheme = document.body.getAttribute('data-theme');
    
    saveSettings({
        theme: newTheme,
        autosaveMs: parseInt(document.getElementById('settingAutosave').value),
        dnd: document.getElementById('settingDnd').checked,
        journalMode: document.getElementById('settingJournal').checked
    });
    
    if (newTheme !== currentTheme) {
        document.body.setAttribute('data-theme', newTheme);
        document.getElementById('themeBtn').textContent = newTheme === 'light' ? '🌞' : '🌙';
    }
    
    toast('✅ Settings saved', true);
    document.getElementById('settingsModal').remove();
};

// Health Dashboard (placeholder - will be real later)
function openHealthDashboard() {
    const modal = document.createElement('div');
    modal.id = 'healthModal';
    modal.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center';
    modal.style.zIndex = '100';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-[600px] p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">📊 Document Health</h2>
                <button onclick="document.getElementById('healthModal').remove()" class="text-2xl opacity-50 hover:opacity-100">&times;</button>
            </div>
            <div class="text-center py-8 text-gray-500">
                <p class="mb-4">Health dashboard coming soon!</p>
                <p class="text-sm">Will show: readability, tone, voice metrics, and quick fixes.</p>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

// Wire settings buttons (called after DOM ready)
function wireExtraButtons() {
    console.log('✅ Extra buttons wired');
}

// Show paywall modal when limit reached
function showPaywallModal(data) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center';
    modal.style.zIndex = '10000';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-[500px] p-8 text-center">
            <div class="text-6xl mb-4">🚀</div>
            <h2 class="text-2xl font-bold mb-2">You've Hit Your Free Limit!</h2>
            <p class="text-gray-600 mb-4">${data.message || 'Upgrade to Premium for unlimited access'}</p>
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <div class="text-sm text-gray-500 mb-1">Usage this month</div>
                <div class="text-3xl font-bold text-emerald-600">${data.used || 0} / ${data.limit || 10}</div>
                <div class="text-xs text-gray-500 mt-1">chats used</div>
            </div>
            <div class="space-y-2 text-sm text-left mb-6 bg-emerald-50 p-4 rounded-lg">
                <div class="font-semibold text-emerald-700 mb-2">Premium includes:</div>
                <div>✓ Unlimited chats</div>
                <div>✓ Unlimited documents</div>
                <div>✓ All 6 AI agents</div>
                <div>✓ Priority support</div>
            </div>
            <div class="flex gap-2">
                <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-3 rounded-lg border hover:bg-gray-50">Maybe Later</button>
                <button onclick="this.closest('.fixed').remove();showModal('upgradeModal')" class="flex-1 px-4 py-3 rounded-lg bg-gradient-to-r from-emerald-500 to-cyan-500 text-white hover:opacity-90 font-semibold">Upgrade Now</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Track that paywall was shown
    posthog && posthog.capture('paywall_shown', {reason: 'chat_limit', used: data.used, limit: data.limit});
    gtag && gtag('event', 'paywall_shown', {reason: 'chat_limit'});
}

// Show Stripe success modal
function showStripeSuccess() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center';
    modal.style.zIndex = '100';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-[500px] p-8 text-center">
            <div class="text-6xl mb-4">✅</div>
            <h2 class="text-2xl font-bold mb-2">Welcome to Premium!</h2>
            <p class="text-gray-600 mb-6">Your subscription is now active. Enjoy unlimited access to all features!</p>
            <div class="space-y-2 text-sm text-left mb-6 bg-emerald-50 p-4 rounded-lg">
                <div>✓ Unlimited chats</div>
                <div>✓ Unlimited documents</div>
                <div>✓ All 6 AI agents</div>
                <div>✓ Priority support</div>
            </div>
            <button onclick="this.closest('.fixed').remove();window.history.replaceState({}, '', '/backup.html')" class="w-full bg-emerald-500 text-white rounded-lg px-4 py-2 hover:bg-emerald-600">Start Using Premium</button>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Reload usage to reflect premium status
    if (state.user) {
        loadUsage().then(() => {
            updateAuthUI();
        });
    }
    
    posthog && posthog.capture('subscription_success');
    gtag && gtag('event', 'purchase', {value: 14.99, currency: 'USD'});
}

// Show account menu modal
function showAccountMenu(isPremium) {
    const modal = document.createElement('div');
    modal.id = 'accountMenuModal';
    modal.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center';
    modal.style.zIndex = '10001';
    
    const billingBtn = isPremium ? `<button onclick="openBillingPortal()" class="w-full text-left px-4 py-3 rounded-lg hover:bg-emerald-50 text-sm flex items-center gap-2 border-t"><span>💳</span> Manage Billing</button>` : '';
    const cancelBtn = isPremium ? `<button onclick="cancelSubscriptionInModal()" class="w-full text-left px-4 py-3 rounded-lg hover:bg-orange-50 text-sm flex items-center gap-2 text-orange-600"><span>❌</span> Cancel Subscription</button>` : '';
    
    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-[400px] p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Account</h2>
                <button onclick="document.getElementById('accountMenuModal').remove()" class="text-2xl opacity-50 hover:opacity-100">×</button>
            </div>
            <div id="accountError" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700"></div>
            <div class="space-y-2">
                <button onclick="openSettings();document.getElementById('accountMenuModal').remove()" class="w-full text-left px-4 py-3 rounded-lg hover:bg-emerald-50 text-sm flex items-center gap-2"><span>⚙️</span> Manage Account</button>
                ${billingBtn}
                ${cancelBtn}
                <button onclick="if(confirm('Sign out?'))signOut()" class="w-full text-left px-4 py-3 rounded-lg hover:bg-red-50 text-sm flex items-center gap-2 text-red-600 border-t"><span>🚪</span> Logout</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

// Cancel subscription from modal
async function cancelSubscriptionInModal() {
    if (!confirm('Are you sure you want to cancel your subscription? You will lose access to premium features at the end of your billing period.')) {
        return;
    }
    
    const errorDiv = document.getElementById('accountError');
    errorDiv.classList.add('hidden');
    
    try {
        const headers = {'Content-Type': 'application/json'};
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
        const res = await fetch(`${API}/subscription`, {
            method: 'POST',
            headers,
            body: JSON.stringify({
                action: 'cancel',
                user_id: state.user.sub
            })
        });
        
        const data = await res.json();
        
        if (res.ok) {
            document.getElementById('accountMenuModal')?.remove();
            toast('✅ Subscription canceled', true);
            await loadUsage();
            updateAuthUI();
            posthog && posthog.capture('subscription_canceled');
        } else {
            errorDiv.textContent = '❌ ' + (data.error || 'Failed to cancel subscription');
            errorDiv.classList.remove('hidden');
        }
    } catch (e) {
        errorDiv.textContent = '❌ Error: ' + e.message;
        errorDiv.classList.remove('hidden');
    }
}

// Open Stripe Billing Portal
async function openBillingPortal() {
    const modal = document.getElementById('accountMenuModal');
    const errorDiv = document.getElementById('accountError');
    
    try {
        const headers = {'Content-Type': 'application/json'};
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
        const res = await fetch(`${API}/subscription`, {
            method: 'POST',
            headers,
            body: JSON.stringify({
                action: 'portal',
                user_id: state.user.sub
            })
        });
        
        const data = await res.json();
        
        if (res.ok && data.portal_url) {
            window.location.href = data.portal_url;
        } else if (res.ok && data.is_lifetime) {
            errorDiv.textContent = '✅ ' + data.message;
            errorDiv.classList.remove('bg-red-50', 'border-red-200', 'text-red-700');
            errorDiv.classList.add('bg-green-50', 'border-green-200', 'text-green-700');
            errorDiv.classList.remove('hidden');
        } else {
            errorDiv.textContent = '❌ ' + (data.error || 'Failed to open billing portal');
            errorDiv.classList.remove('hidden');
        }
    } catch (e) {
        errorDiv.textContent = '❌ Error: ' + e.message;
        errorDiv.classList.remove('hidden');
    }
}

// Cancel subscription (from settings)
async function cancelSubscription() {
    if (!confirm('Are you sure you want to cancel your subscription? You will lose access to premium features at the end of your billing period.')) {
        return;
    }
    
    try {
        const headers = {'Content-Type': 'application/json'};
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
        const res = await fetch(`${API}/subscription`, {
            method: 'POST',
            headers,
            body: JSON.stringify({
                action: 'cancel',
                user_id: state.user.sub
            })
        });
        
        const data = await res.json();
        
        if (res.ok) {
            toast('✅ Subscription canceled', true);
            document.getElementById('settingsModal')?.remove();
            await loadUsage();
            updateAuthUI();
            posthog && posthog.capture('subscription_canceled');
        } else {
            toast('❌ Failed to cancel: ' + (data.error || 'Unknown error'));
        }
    } catch (e) {
        toast('❌ Error: ' + e.message);
    }
}

// Lightning button with dropdown menu
const insightsBtn = document.getElementById('insightsBtn');
const lightningMenu = document.getElementById('lightningMenu');
const lightningContainer = document.getElementById('lightningContainer');
const insightsPanel = document.getElementById('insightsPanel');

let isDraggingLightning = false;
let dragOffsetX = 0;
let dragOffsetY = 0;
let dragStartX = 0;
let dragStartY = 0;

if (insightsBtn) {
    insightsBtn.addEventListener('mousedown', (e) => {
        const insightsPanelOpen = !insightsPanel.classList.contains('hidden');
        const highlightPanelOpen = !document.getElementById('highlightLegend').classList.contains('hidden');
        const coEditorPanelOpen = !document.getElementById('coEditorPanel').classList.contains('hidden');
        
        if (insightsPanelOpen) {
            closeInsightsPanel();
            return;
        }
        if (highlightPanelOpen) {
            closeHighlightLegend();
            return;
        }
        if (coEditorPanelOpen) {
            closeCoEditor();
            return;
        }
        
        isDraggingLightning = true;
        dragStartX = e.clientX;
        dragStartY = e.clientY;
        dragOffsetX = e.clientX - lightningContainer.offsetLeft;
        dragOffsetY = e.clientY - lightningContainer.offsetTop;
        e.preventDefault();
    });
}

document.addEventListener('mousemove', (e) => {
    if (isDraggingLightning) {
        lightningContainer.style.left = (e.clientX - dragOffsetX) + 'px';
        lightningContainer.style.top = (e.clientY - dragOffsetY) + 'px';
        lightningContainer.style.right = 'auto';
    }
});

document.addEventListener('mouseup', (e) => {
    if (isDraggingLightning) {
        const dragDistance = Math.sqrt(Math.pow(e.clientX - dragStartX, 2) + Math.pow(e.clientY - dragStartY, 2));
        isDraggingLightning = false;
        
        if (dragDistance < 5) {
            const insightsPanelOpen = !insightsPanel.classList.contains('hidden');
            const highlightPanelOpen = !document.getElementById('highlightLegend').classList.contains('hidden');
            const coEditorPanelOpen = !document.getElementById('coEditorPanel').classList.contains('hidden');
            
            if (insightsPanelOpen) {
                closeInsightsPanel();
            } else if (highlightPanelOpen) {
                closeHighlightLegend();
            } else if (coEditorPanelOpen) {
                closeCoEditor();
            } else {
                lightningMenu.classList.toggle('hidden');
            }
        }
    }
});

// Close menu when clicking outside
document.addEventListener('click', (e) => {
    if (!lightningContainer.contains(e.target)) {
        lightningMenu.classList.add('hidden');
    }
});



// Phase 9: PDF export helper
function exportToPDF(filename, text) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 20;
    const maxWidth = pageWidth - (margin * 2);
    const lineHeight = 7;
    let y = margin;
    
    doc.setFontSize(12);
    const lines = doc.splitTextToSize(text, maxWidth);
    
    lines.forEach(line => {
        if (y + lineHeight > pageHeight - margin) {
            doc.addPage();
            y = margin;
        }
        doc.text(line, margin, y);
        y += lineHeight;
    });
    
    doc.save(`${filename}.pdf`);
}

function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

// Phase 6: Mobile menu toggle
window.toggleMobileMenu = () => {
    document.getElementById('leftSidebar').classList.toggle('mobile-open');
};

// Phase 7: Global document search
window.searchDocs = (query) => {
    render();
};

// Close mobile menu when clicking outside
document.addEventListener('click', (e) => {
    const sidebar = document.getElementById('leftSidebar');
    const menuBtn = document.getElementById('mobileMenuBtn');
    if (sidebar && sidebar.classList.contains('mobile-open') && !sidebar.contains(e.target) && e.target !== menuBtn) {
        sidebar.classList.remove('mobile-open');
    }
});

// ===== Lumina UX Features =====
const editor=document.getElementById('editor');
const hud=document.getElementById('luminaHUD');
const dock=document.getElementById('luminaDock');
const pulse=document.getElementById('thinkingPulse');
const horizon=document.getElementById('focusHorizon');

// 1. Ambient Focus Block
function updateActiveBlock(){const sel=window.getSelection();if(!sel||sel.rangeCount===0)return;let node=sel.anchorNode||sel.focusNode;if(!node)return;let el=node.nodeType===3?node.parentElement:node;while(el&&el!==editor&&!/^(P|LI|H1|H2|H3|H4|H5|H6|BLOCKQUOTE|DIV)$/i.test(el.tagName)){el=el.parentElement;}if(!el||el===editor)return;editor.querySelectorAll('.lumina-active-block').forEach(n=>n.classList.remove('lumina-active-block'));el.classList.add('lumina-active-block');}
editor.addEventListener('keyup',updateActiveBlock);editor.addEventListener('mouseup',updateActiveBlock);editor.addEventListener('input',updateActiveBlock);

// 2. Focus Horizon
function updateHorizon(){const sel=window.getSelection();if(!sel||sel.rangeCount===0)return;const r=sel.getRangeAt(0).cloneRange();r.collapse(true);const rect=r.getClientRects()[0];const eRect=editor.getBoundingClientRect();if(!rect)return;horizon.style.top=`${rect.top+window.scrollY}px`;horizon.style.left=`${eRect.left+window.scrollX}px`;horizon.style.width=`${eRect.width}px`;}
['keyup','mouseup','scroll','input'].forEach(evt=>document.addEventListener(evt,updateHorizon,{passive:true}));

// 3. Floating HUD (disabled - using toolbar tone buttons instead)
function showHUD(){}
function hideHUD(){}
// document.addEventListener('selectionchange',()=>{const sel=window.getSelection();if(!sel||sel.isCollapsed){hideHUD();return;}showHUD();});
// HUD buttons disabled
// document.getElementById('hudBold').onclick=()=>document.execCommand('bold',false,null);
// document.getElementById('hudItalic').onclick=()=>document.execCommand('italic',false,null);
// document.getElementById('hudBullets').onclick=()=>document.execCommand('insertUnorderedList',false,null);
// document.getElementById('hudAI').onclick=()=>{setThinking(true);setTimeout(()=>setThinking(false),1400);};

// 4. Fluid Dock
let dockTimer=null;
const dockTrigger=document.createElement('div');
dockTrigger.style.cssText='position:fixed;bottom:0;left:0;right:0;height:80px;pointer-events:none;z-index:89;';
document.body.appendChild(dockTrigger);
dockTrigger.addEventListener('mouseenter',()=>{dock.classList.add('visible');clearTimeout(dockTimer);});
dockTrigger.addEventListener('mouseleave',()=>{dock.classList.remove('visible');});
dock.addEventListener('mouseenter',()=>{clearTimeout(dockTimer);dock.classList.add('visible');});
dock.addEventListener('mouseleave',()=>{dock.classList.remove('visible');});
document.addEventListener('mouseup',()=>{if(dock.classList.contains('visible'))dock.classList.remove('visible');});
document.getElementById('dockFocus').onclick=()=>document.getElementById('focusBtn').click();
document.getElementById('dockThemes').onclick=()=>document.getElementById('themeBtn').click();
document.getElementById('dockAgents').onclick=()=>document.getElementById('agentsBtn').click();
document.getElementById('dockStats').onclick=()=>toast('Words: '+document.getElementById('wordCount').textContent+' | DocIQ: '+document.getElementById('docIQ').textContent);

// 5. Thinking Pulse
function setThinking(on){on?pulse.classList.add('thinking'):pulse.classList.remove('thinking');}

// Keyboard shortcuts: G=new, C=chat, S=search, L=library
document.addEventListener('keydown',(e)=>{if(e.target.matches('input,textarea,[contenteditable="true"]'))return;const k=e.key.toLowerCase();if(k==='g'){e.preventDefault();document.getElementById('newBtn').click();}else if(k==='c'){e.preventDefault();document.getElementById('chatInput').focus();}else if(k==='s'){e.preventDefault();document.getElementById('searchBtn').click();}else if(k==='l'){e.preventDefault();document.getElementById('libraryBtn').click();}else if(k==='\\' &&(e.metaKey||e.ctrlKey)){e.preventDefault();document.getElementById('toggleSidebarBtn').click();}else if(k==='.' &&(e.metaKey||e.ctrlKey)){e.preventDefault();document.getElementById('luminaDock').classList.toggle('visible');}});

// === F2: WRITING STREAKS & DAILY PROMPTS ===
function updateStreak(words) {
    const today = new Date().toDateString();
    const lastDate = state.streak.lastDate;
    
    if (lastDate !== today) {
        const yesterday = new Date(Date.now() - 86400000).toDateString();
        if (lastDate === yesterday) {
            state.streak.count++;
        } else if (lastDate !== null) {
            state.streak.count = 1;
        } else {
            state.streak.count = 1;
        }
        state.streak.lastDate = today;
        state.streak.todayWords = words;
        state.streak.goalReachedToday = false;
    } else {
        state.streak.todayWords = words;
    }
    
    document.getElementById('streakCount').textContent = state.streak.count;
    
    if (words >= state.streak.dailyGoal && !state.streak.goalReachedToday) {
        state.streak.goalReachedToday = true;
        toast('🎉 Daily goal reached!', true);
    }
    
    saveState();
}

window.showStreakModal = () => {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center';
    modal.style.zIndex = '100';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-[400px] p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">🔥 Writing Streak</h2>
                <button onclick="this.closest('.fixed').remove()" class="text-2xl opacity-50 hover:opacity-100">×</button>
            </div>
            <div class="text-center mb-6">
                <div class="text-6xl font-bold text-emerald-600">${state.streak.count}</div>
                <div class="text-sm text-gray-500">day streak</div>
            </div>
            <div class="space-y-3">
                <div class="flex justify-between text-sm">
                    <span>Today's words:</span>
                    <span class="font-bold">${state.streak.todayWords}/${state.streak.dailyGoal}</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-gradient-to-r from-emerald-500 to-cyan-500 h-2 rounded-full" style="width: ${Math.min(100, (state.streak.todayWords / state.streak.dailyGoal) * 100)}%"></div>
                </div>
                <div class="pt-3 border-t">
                    <label class="text-sm text-gray-600">Daily goal (words):</label>
                    <input type="number" id="goalInput" value="${state.streak.dailyGoal}" min="100" step="50" class="w-full border rounded-lg px-3 py-2 mt-1" />
                    <button onclick="updateDailyGoal()" class="w-full mt-2 bg-emerald-500 text-white rounded-lg px-4 py-2 hover:bg-emerald-600">Update Goal</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
};

window.updateDailyGoal = () => {
    const newGoal = parseInt(document.getElementById('goalInput').value);
    if (newGoal >= 100) {
        state.streak.dailyGoal = newGoal;
        saveState();
        updateStats();
        toast('✅ Goal updated', true);
        document.querySelector('.fixed').remove();
    }
};

// === F8: AI WRITING COACH ===
if (!state.writingStats) state.writingStats = {sessions: [], totalWords: 0, startDate: Date.now()};

function trackWritingSession() {
    const doc = state.docs.find(d => d.id === state.activeId);
    if (!doc) return;
    const words = doc.content.replace(/<[^>]*>/g, '').trim().split(/\s+/).filter(w => w).length;
    const today = new Date().toDateString();
    const todaySession = state.writingStats.sessions.find(s => s.date === today);
    if (todaySession) {
        todaySession.words = words;
        todaySession.lastActive = Date.now();
    } else {
        state.writingStats.sessions.push({date: today, words: words, lastActive: Date.now()});
    }
    state.writingStats.totalWords = state.writingStats.sessions.reduce((sum, s) => sum + s.words, 0);
    if (state.writingStats.sessions.length > 90) state.writingStats.sessions = state.writingStats.sessions.slice(-90);
    saveState();
}

function analyzeWritingPatterns() {
    const sessions = state.writingStats.sessions || [];
    if (sessions.length === 0) return null;
    const last7Days = sessions.slice(-7);
    const weekWords = last7Days.reduce((sum, s) => sum + s.words, 0);
    const avgPerDay = weekWords / 7;
    const consistency = (last7Days.filter(s => s.words > 0).length / 7) * 100;
    const doc = state.docs.find(d => d.id === state.activeId);
    const text = doc ? doc.content.replace(/<[^>]*>/g, '').toLowerCase() : '';
    const words = text.match(/\b\w+\b/g) || [];
    const uniqueWords = new Set(words).size;
    const vocabDiversity = words.length > 0 ? (uniqueWords / words.length) * 100 : 0;
    const tips = [];
    if (consistency < 50) tips.push('Try writing every day, even just 100 words');
    if (avgPerDay < 200) tips.push('Set a daily goal of 300+ words to build momentum');
    if (vocabDiversity < 30) tips.push('Expand vocabulary - try using synonyms');
    if (tips.length === 0) tips.push('Keep up the great work!');
    return {weekWords, avgPerDay: Math.round(avgPerDay), consistency: Math.round(consistency), vocabDiversity: Math.round(vocabDiversity), tips, streak: state.streak.count};
}

window.showWritingCoach = () => {
    const analysis = analyzeWritingPatterns();
    if (!analysis) { toast('Start writing to see insights!'); return; }
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center';
    modal.style.zIndex = '100';
    modal.innerHTML = `<div class="bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl w-[700px] max-h-[85vh] overflow-auto" style="border: 1px solid rgba(16,185,129,0.2); box-shadow: 0 8px 32px rgba(16,185,129,0.2), 0 0 60px rgba(6,182,212,0.15);"><div class="px-6 py-4 border-b border-emerald-200 flex items-center justify-between" style="background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(6,182,212,0.08));"><h2 class="text-xl font-bold text-emerald-700">🎓 AI Writing Coach</h2><button onclick="this.closest('.fixed').remove()" class="text-2xl opacity-50 hover:opacity-100">×</button></div><div class="p-6 space-y-6"><div class="grid grid-cols-3 gap-4"><div class="text-center p-4 rounded-xl" style="background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(6,182,212,0.05)); border: 1px solid rgba(16,185,129,0.2);"><div class="text-3xl font-bold text-emerald-600">${analysis.weekWords}</div><div class="text-xs text-gray-600 mt-1">Words this week</div></div><div class="text-center p-4 rounded-xl" style="background: linear-gradient(135deg, rgba(6,182,212,0.1), rgba(168,85,247,0.05)); border: 1px solid rgba(6,182,212,0.2);"><div class="text-3xl font-bold text-cyan-600">${analysis.avgPerDay}</div><div class="text-xs text-gray-600 mt-1">Avg words/day</div></div><div class="text-center p-4 rounded-xl" style="background: linear-gradient(135deg, rgba(168,85,247,0.1), rgba(236,72,153,0.05)); border: 1px solid rgba(168,85,247,0.2);"><div class="text-3xl font-bold text-purple-600">${analysis.streak}</div><div class="text-xs text-gray-600 mt-1">Day streak 🔥</div></div></div><div class="p-4 rounded-xl" style="background: rgba(255,255,255,0.8); border: 1px solid rgba(16,185,129,0.15);"><div class="text-sm font-semibold text-gray-700 mb-3">📈 Weekly Progress</div><div class="flex items-end gap-2 h-32">${state.writingStats.sessions.slice(-7).map((s) => {const height = Math.max(10, (s.words / Math.max(...state.writingStats.sessions.slice(-7).map(x => x.words))) * 100);return `<div class="flex-1 flex flex-col items-center gap-1"><div class="w-full rounded-t-lg" style="height: ${height}%; background: linear-gradient(180deg, #10b981, #06b6d4);"></div><div class="text-xs text-gray-500">${new Date(s.lastActive).toLocaleDateString('en-US', {weekday: 'short'})}</div></div>`;}).join('')}</div></div><div class="grid grid-cols-2 gap-4"><div class="p-4 rounded-xl" style="background: rgba(240,253,244,0.6); border: 1px solid rgba(16,185,129,0.2);"><div class="text-sm font-semibold text-emerald-700 mb-2">✍️ Consistency</div><div class="flex items-center gap-2"><div class="flex-1 bg-gray-200 rounded-full h-2"><div class="bg-gradient-to-r from-emerald-500 to-cyan-500 h-2 rounded-full" style="width: ${analysis.consistency}%"></div></div><span class="text-sm font-bold text-emerald-600">${analysis.consistency}%</span></div></div><div class="p-4 rounded-xl" style="background: rgba(240,249,255,0.6); border: 1px solid rgba(6,182,212,0.2);"><div class="text-sm font-semibold text-cyan-700 mb-2">📚 Vocabulary</div><div class="flex items-center gap-2"><div class="flex-1 bg-gray-200 rounded-full h-2"><div class="bg-gradient-to-r from-cyan-500 to-purple-500 h-2 rounded-full" style="width: ${analysis.vocabDiversity}%"></div></div><span class="text-sm font-bold text-cyan-600">${analysis.vocabDiversity}%</span></div></div></div><div class="p-4 rounded-xl" style="background: linear-gradient(135deg, rgba(16,185,129,0.05), rgba(6,182,212,0.05)); border: 1px solid rgba(16,185,129,0.15);"><div class="text-sm font-semibold text-emerald-700 mb-3">💡 Personalized Tips</div><div class="space-y-2">${analysis.tips.map(tip => `<div class="flex items-start gap-2 text-sm text-gray-700"><span class="text-emerald-500 mt-0.5">•</span><span>${tip}</span></div>`).join('')}</div></div></div></div>`;
    document.body.appendChild(modal);
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
};

const originalHandleEditorInput = handleEditorInput;
handleEditorInput = function() { originalHandleEditorInput(); trackWritingSession(); };

// R1: ENHANCED SMART HIGHLIGHTS
function handleTextSelection(){setTimeout(()=>{const sel=window.getSelection();const toolbar=document.getElementById('selectionToolbar');if(!sel||sel.isCollapsed||sel.toString().trim().length===0){toolbar.classList.remove('visible');return;}const editor=document.getElementById('editor');if(!editor.contains(sel.anchorNode)){toolbar.classList.remove('visible');return;}const range=sel.getRangeAt(0);const rect=range.getBoundingClientRect();toolbar.style.left=`${rect.left+(rect.width/2)-150}px`;toolbar.style.top=`${rect.top-50}px`;toolbar.classList.add('visible');},10);}
window.highlightSelection=(color)=>{const sel=window.getSelection();if(!sel||sel.isCollapsed)return;const text=sel.toString().trim();if(!text)return;const range=sel.getRangeAt(0);const span=document.createElement('span');span.className=`highlight-${color}`;span.setAttribute('data-highlight-id',Date.now());span.setAttribute('data-color',color);try{range.surroundContents(span);}catch(e){const fragment=range.extractContents();span.appendChild(fragment);range.insertNode(span);}if(!state.userHighlights[state.activeId])state.userHighlights[state.activeId]=[];state.userHighlights[state.activeId].push({id:span.getAttribute('data-highlight-id'),text:text,color:color,timestamp:Date.now()});saveState();updateHighlightLegend();document.getElementById('selectionToolbar').classList.remove('visible');toast(`✨ Highlighted in ${color}`,true);};
window.removeHighlight=()=>{const sel=window.getSelection();if(!sel||sel.isCollapsed)return;let node=sel.anchorNode;while(node&&node!==document.getElementById('editor')){if(node.nodeType===1&&node.className&&node.className.includes('highlight-')){const id=node.getAttribute('data-highlight-id');const parent=node.parentNode;while(node.firstChild){parent.insertBefore(node.firstChild,node);}parent.removeChild(node);if(state.userHighlights[state.activeId]){state.userHighlights[state.activeId]=state.userHighlights[state.activeId].filter(h=>h.id!==id);}saveState();updateHighlightLegend();toast('Highlight removed',true);break;}node=node.parentNode;}document.getElementById('selectionToolbar').classList.remove('visible');};
window.toggleHighlightLegend=()=>{const legend=document.getElementById('highlightLegend');legend.classList.toggle('visible');if(legend.classList.contains('visible')){updateHighlightLegend();}};
function updateHighlightLegend(){const highlights=state.userHighlights[state.activeId]||[];const content=document.getElementById('legendContent');if(highlights.length===0){content.innerHTML='<div class="text-center py-8 text-sm text-gray-500">No highlights yet.<br>Select text to highlight.</div>';return;}const colorNames={yellow:'💛 Facts',blue:'💙 Dates',green:'💚 Names',red:'❤️ Important',purple:'💜 Ideas'};content.innerHTML=highlights.map(h=>`<div class="legend-item" onclick="scrollToHighlight('${h.id}')"><div class="legend-color highlight-${h.color}"></div><div class="legend-text"><div class="font-semibold text-xs text-gray-700">${colorNames[h.color]||h.color}</div><div class="text-xs text-gray-600 truncate">${h.text.substring(0,50)}${h.text.length>50?'...':''}</div></div><div class="legend-actions"><button onclick="event.stopPropagation();deleteHighlight('${h.id}')" title="Delete">×</button></div></div>`).join('');}
window.scrollToHighlight=(id)=>{const highlights=state.userHighlights[state.activeId]||[];const h=highlights.find(x=>x.id===id);if(!h)return;const editor=document.getElementById('editor');const walker=document.createTreeWalker(editor,NodeFilter.SHOW_TEXT);const nodes=[];while(walker.nextNode()){nodes.push(walker.currentNode);}for(const node of nodes){const text=node.textContent;if(text.includes(h.text)){const parent=node.parentElement;if(parent){parent.scrollIntoView({behavior:'smooth',block:'center'});parent.style.outline='2px solid #10b981';parent.style.outlineOffset='2px';setTimeout(()=>{parent.style.outline='none';},2000);break;}}}};
window.deleteHighlight=(id)=>{const editor=document.getElementById('editor');const highlight=editor.querySelector(`[data-highlight-id="${id}"]`);if(highlight){const parent=highlight.parentNode;while(highlight.firstChild){parent.insertBefore(highlight.firstChild,highlight);}parent.removeChild(highlight);}if(state.userHighlights[state.activeId]){state.userHighlights[state.activeId]=state.userHighlights[state.activeId].filter(h=>h.id!==id);}saveState();updateHighlightLegend();toast('Highlight deleted',true);};
window.exportHighlights=()=>{const highlights=state.userHighlights[state.activeId]||[];if(highlights.length===0){toast('No highlights to export');return;}const doc=state.docs.find(d=>d.id===state.activeId);const colorNames={yellow:'Facts',blue:'Dates',green:'Names',red:'Important',purple:'Ideas'};let text=`Highlights from: ${doc.name}\n`;text+=`Exported: ${new Date().toLocaleString()}\n\n`;highlights.forEach((h,i)=>{text+=`${i+1}. [${colorNames[h.color]}] ${h.text}\n\n`;});const blob=new Blob([text],{type:'text/plain'});downloadBlob(blob,`${doc.name}-highlights.txt`);toast('📥 Highlights exported',true);};
window.clearAllHighlights=()=>{if(!confirm('Clear all highlights? This cannot be undone.'))return;const editor=document.getElementById('editor');const highlights=editor.querySelectorAll('[data-highlight-id]');highlights.forEach(h=>{const parent=h.parentNode;while(h.firstChild){parent.insertBefore(h.firstChild,h);}parent.removeChild(h);});state.userHighlights[state.activeId]=[];saveState();updateHighlightLegend();toast('All highlights cleared',true);};

function restoreHighlights(){const highlights=state.userHighlights[state.activeId]||[];if(highlights.length===0)return;const editor=document.getElementById('editor');highlights.forEach(h=>{const walker=document.createTreeWalker(editor,NodeFilter.SHOW_TEXT);const nodes=[];while(walker.nextNode()){nodes.push(walker.currentNode);}for(const node of nodes){const text=node.textContent;const idx=text.indexOf(h.text);if(idx!==-1){const range=document.createRange();range.setStart(node,idx);range.setEnd(node,idx+h.text.length);const span=document.createElement('span');span.className=`highlight-${h.color}`;span.setAttribute('data-highlight-id',h.id);span.setAttribute('data-color',h.color);try{range.surroundContents(span);}catch(e){const fragment=range.extractContents();span.appendChild(fragment);range.insertNode(span);}break;}}});}

// Initialize
updateActiveBlock();updateHorizon();updateStreak(0);trackWritingSession();
    </script>
    <div id="knowledgeGraphOverlay">
        <div class="overlay-backdrop" id="knowledgeGraphOverlayBackdrop"></div>
        <div class="overlay-content">
            <div id="knowledgeGraphOverlayHeader">
                <div class="flex flex-col gap-1">
                    <div class="text-sm font-semibold text-emerald-700">Knowledge Graph</div>
                    <div class="text-[11px] text-gray-500" id="knowledgeGraphOverlaySubtitle">Entities connected to your documents</div>
                </div>
                <div class="flex flex-wrap items-center gap-2 justify-end">
                    <input id="graphSearchInput" type="search" placeholder="Search entities/docs" class="text-[11px] px-2 py-1 rounded-lg border border-emerald-200 focus:outline-none focus:ring-1 focus:ring-emerald-400" style="min-width: 140px;" />
                    <select id="graphMinLinksSelect" class="text-[11px] px-2 py-1 rounded-lg border border-emerald-200 focus:outline-none focus:ring-1 focus:ring-emerald-400">
                        <option value="1">All connections</option>
                        <option value="2">2+ links</option>
                        <option value="3">3+ links</option>
                    </select>
                    <select id="graphMinSharedSelect" class="text-[11px] px-2 py-1 rounded-lg border border-emerald-200 focus:outline-none focus:ring-1 focus:ring-emerald-400">
                        <option value="1">≥1 shared entity</option>
                        <option value="2">≥2 shared entities</option>
                        <option value="3">≥3 shared entities</option>
                    </select>
                    <label class="flex items-center gap-1 text-[11px] text-emerald-700">
                        <input type="checkbox" id="graphIncludeEntities" class="accent-emerald-500" checked>
                        Entities
                    </label>
                    <label class="flex items-center gap-1 text-[11px] text-emerald-700">
                        <input type="checkbox" id="graphIncludeDocs" class="accent-emerald-500" checked>
                        Docs
                    </label>
                    <label class="flex items-center gap-1 text-[11px] text-emerald-700">
                        <input type="checkbox" id="graphIncludeDocLinks" class="accent-emerald-500" checked>
                        Doc links
                    </label>
                    <label class="flex items-center gap-1 text-[11px] text-emerald-700">
                        <input type="checkbox" id="graphRecentOnly" class="accent-emerald-500">
                        Recent (30d)
                    </label>
                    <button id="graphRefreshBtn" class="text-[11px] px-2 py-0.5 rounded-full border border-emerald-200 text-emerald-600 hover:bg-emerald-50">↻</button>
                    <button id="closeKnowledgeGraphOverlayBtn" class="text-[12px] px-3 py-1 rounded-full border border-emerald-200 text-emerald-600 hover:bg-emerald-50">Close</button>
                </div>
            </div>
            <svg id="knowledgeGraphSvg"></svg>
            <div id="knowledgeGraphOverlayFooter">
                <div class="legend">
                    <span><span class="legend-dot" style="background: #047857;"></span> Entity</span>
                    <span><span class="legend-dot" style="background: #0ea5e9;"></span> Document</span>
                    <span><span class="legend-dot" style="background: #f59e0b;"></span> Doc ↔ Doc</span>
                </div>
                <div id="knowledgeGraphOverlayInfo" class="flex-1 text-right text-emerald-700"></div>
            </div>
        </div>
    </div>

    <div id="entityHoverCard"></div>
</body>
</html>
