<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocumentGPT v6 — Fusion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .font-inter { font-family: Inter, system-ui, sans-serif; }
        .transition-all { transition: all 0.2s ease; }
    </style>
</head>
<body class="h-screen w-full font-inter">
    <div id="app" class="flex h-screen w-full overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-60 shrink-0 border-r backdrop-blur">
            <div class="px-3 py-2 flex items-center gap-2 border-b">
                <span class="text-sm font-semibold tracking-tight text-emerald-500">DocumentGPT v6 — Fusion</span>
                <span class="ml-auto text-[10px] opacity-65">Ctrl/Cmd‑K</span>
            </div>
            <div class="p-3 flex gap-2">
                <button id="uploadBtn" class="flex-1 rounded-xl border px-3 py-2 text-sm hover:shadow-sm">Upload</button>
                <button id="newBtn" class="flex-1 rounded-xl border px-3 py-2 text-sm hover:shadow-sm border-emerald-500 text-emerald-500">New</button>
            </div>

            <div class="px-3 pt-1 text-[11px] uppercase tracking-wider opacity-60 flex items-center justify-between">
                <span>My Documents</span>
                <button id="newFolderBtn" class="text-[10px] px-1 py-0.5 rounded border hover:bg-black/5" title="New folder">📁+</button>
            </div>
            <div id="foldersContainer" class="px-2 pb-2 space-y-1 overflow-auto max-h-60">
                <div id="uploadedDocs" class="space-y-1"></div>
            </div>

            <div class="px-3 pt-1 text-[11px] uppercase tracking-wider opacity-60">Recent</div>
            <div class="px-2 pb-16 space-y-1 overflow-auto max-h-[calc(100vh-310px)]">
                <div class="px-3 py-2 rounded-lg text-sm hover:shadow-sm border">AI assistant</div>
                <div class="px-3 py-2 rounded-lg text-sm hover:shadow-sm border">Q3 review</div>
                <div class="px-3 py-2 rounded-lg text-sm hover:shadow-sm border">Contract QA</div>
            </div>

            <div class="absolute bottom-0 left-0 right-0 p-3 flex items-center gap-2 border-t">
                <button id="loginBtn" class="text-xs px-2 py-1 rounded-lg border hover:shadow-sm">Login</button>
                <button id="priceBtn" class="text-xs px-2 py-1 rounded-lg border hover:shadow-sm">Price</button>
                <div class="ml-auto flex items-center gap-2 text-[11px] opacity-65">
                    <button id="paletteBtn">⌘K</button>
                    <button id="settingsBtn">⚙︎</button>
                </div>
            </div>
        </aside>

        <!-- Main Editor -->
        <main class="flex-1 flex flex-col">
            <!-- Top Controls -->
            <div class="flex items-center gap-2 px-3 py-2 border-b">
                <div id="tabsContainer" class="flex items-center gap-1 overflow-x-auto"></div>
                <button id="addTabBtn" class="ml-1 text-xs px-2 py-1 rounded-full border hover:shadow-sm">＋</button>

                <div class="ml-auto flex items-center gap-2">
                    <div class="flex items-center gap-2 border rounded-xl px-2 py-1 text-xs">
                        <input id="findInput" placeholder="Find text in this page" class="bg-transparent outline-none w-44" />
                    </div>
                    <div class="flex items-center gap-1 text-xs">
                        <button id="zoomOut" class="px-2 py-1 rounded-lg border">−</button>
                        <div id="zoomLabel" class="w-10 text-center">100%</div>
                        <button id="zoomIn" class="px-2 py-1 rounded-lg border">＋</button>
                    </div>
                    <button id="focusBtn" class="text-xs px-2 py-1 rounded-lg border">Focus mode</button>
                    <button id="themeBtn" class="text-xs px-2 py-1 rounded-lg border">🌞 Light</button>
                    <button id="settingsBtn2" class="text-xs px-2 py-1 rounded-lg border">Settings</button>
                </div>
            </div>

            <!-- Editor Surface -->
            <div class="flex-1 overflow-auto p-4">
                <div class="mx-auto max-w-3xl">
                    <div id="docEditor" class="rounded-2xl border shadow-sm">
                        <div class="px-4 pt-3 text-[12px] opacity-60">New document — start journaling…</div>
                        <textarea id="editor" placeholder="Your page is white and ready. Type here…" class="w-full h-[56vh] resize-none bg-transparent outline-none px-4 py-3 text-[15px] leading-7 rounded-2xl"></textarea>
                    </div>
                    <div id="pdfViewer" class="rounded-2xl border shadow-sm h-[60vh] flex items-center justify-center hidden">
                        <div class="text-center opacity-70">
                            <div class="text-sm">PDF preview</div>
                            <div id="pdfInfo" class="text-xs mt-1">Document — (placeholder)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metrics Bar -->
            <div class="text-xs px-4 py-2 flex items-center gap-4 border-t">
                <div>🥤 Mood: <span id="mood">Neutral</span></div>
                <div>🎛️ Tone: <span id="tone">Balanced</span></div>
                <div>📝 Words: <span id="words">0</span></div>
                <div>⏱️ Read time: <span id="readTime">1m</span></div>
                <div>📖 Readability: <span id="readability">74</span></div>
            </div>
        </main>

        <!-- Assistant -->
        <aside id="assistant" class="w-[340px] shrink-0 border-l backdrop-blur flex flex-col">
            <!-- Header -->
            <div class="px-3 py-2 border-b flex items-center gap-2">
                <div class="text-sm font-medium">Live assistant</div>
                <div class="ml-auto flex items-center gap-1 rounded-full p-1 border">
                    <button id="journalMode" class="px-3 py-1 text-xs rounded-full border border-emerald-500 text-emerald-500 shadow-sm">Journal</button>
                    <button id="docsMode" class="px-3 py-1 text-xs rounded-full opacity-70 hover:opacity-100">Docs</button>
                </div>
            </div>

            <!-- Suggestions/Actions -->
            <div id="suggestionsContainer" class="p-3 space-y-3 overflow-auto flex-1"></div>

            <!-- Live Assistant Toggle -->
            <div class="px-3 text-xs flex items-center gap-2 opacity-70">
                <input type="checkbox" id="liveToggle" checked /> Live Assistant
                <div id="liveStatus" class="w-2 h-2 rounded-full bg-emerald-500" title="Live assistant status"></div>
                <span id="liveStatusText" class="text-[10px] opacity-60"></span>
            </div>

            <!-- Chat -->
            <div class="border-t">
                <div id="chatMessages" class="p-3 space-y-2 max-h-32 overflow-y-auto">
                    <div class="text-sm p-3 rounded-2xl border bg-emerald-50/60 border-emerald-200">
                        Upload a document to start analyzing it. I can summarize, extract key information, and answer questions about your documents.
                    </div>
                </div>
                <div class="p-2">
                    <div class="text-[10px] uppercase tracking-wider opacity-60 mb-1">AI Agents</div>
                    <div class="flex gap-1 flex-wrap">
                        <button id="emailAgent" class="text-[10px] px-2 py-1 rounded border border-emerald-500 text-emerald-500">📧 Email</button>
                        <button id="sheetsAgent" class="text-[10px] px-2 py-1 rounded border border-emerald-500 text-emerald-500">📊 Sheets</button>
                        <button id="calendarAgent" class="text-[10px] px-2 py-1 rounded border border-emerald-500 text-emerald-500">📅 Calendar</button>
                        <button id="saveAgent" class="text-[10px] px-2 py-1 rounded border border-emerald-500 text-emerald-500">💾 Save</button>
                        <button id="exportAgent" class="text-[10px] px-2 py-1 rounded border border-emerald-500 text-emerald-500">📤 Export</button>
                        <button id="summaryAgent" class="text-[10px] px-2 py-1 rounded border border-emerald-500 text-emerald-500">📝 Summary</button>
                    </div>
                </div>
                <div class="p-2 flex items-end gap-2">
                    <textarea id="chatInput" placeholder="Ask for advice, insights, or a reframe…" class="flex-1 min-h-[70px] max-h-40 rounded-xl border p-2 text-sm resize-y"></textarea>
                    <button id="sendBtn" class="rounded-xl px-3 py-2 text-sm bg-emerald-500 text-white border-emerald-500">➤</button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="fileInput" class="hidden" accept=".pdf,.txt,.md,.docx" />

    <!-- Command Palette -->
    <div id="palette" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-start justify-center pt-28 hidden">
        <div class="w-[560px] rounded-2xl border shadow-xl overflow-hidden bg-white">
            <div class="px-3 py-2 border-b text-xs opacity-65">Command palette</div>
            <input id="paletteInput" placeholder="Type a command…" class="w-full px-4 py-3 bg-transparent outline-none text-sm" />
            <div id="paletteItems" class="max-h-72 overflow-auto"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center hidden">
        <div class="w-[400px] rounded-2xl border shadow-xl overflow-hidden bg-white">
            <div class="px-4 py-3 border-b flex items-center">
                <div class="font-medium">Login to DocumentGPT</div>
                <button id="closeLogin" class="ml-auto text-sm opacity-70">×</button>
            </div>
            <div class="p-4 space-y-4">
                <input type="email" id="loginEmail" placeholder="Email" class="w-full rounded-lg border px-3 py-2" />
                <input type="password" id="loginPassword" placeholder="Password" class="w-full rounded-lg border px-3 py-2" />
                <button id="loginSubmit" class="w-full bg-emerald-500 text-white rounded-lg px-3 py-2 hover:bg-emerald-600">Login</button>
                <div class="text-center text-sm opacity-70">
                    Don't have an account? <button id="showSignup" class="text-emerald-500 hover:underline">Sign up</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Signup Modal -->
    <div id="signupModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center hidden">
        <div class="w-[400px] rounded-2xl border shadow-xl overflow-hidden bg-white">
            <div class="px-4 py-3 border-b flex items-center">
                <div class="font-medium">Create Account</div>
                <button id="closeSignup" class="ml-auto text-sm opacity-70">×</button>
            </div>
            <div class="p-4 space-y-4">
                <input type="text" id="signupName" placeholder="Full Name" class="w-full rounded-lg border px-3 py-2" />
                <input type="email" id="signupEmail" placeholder="Email" class="w-full rounded-lg border px-3 py-2" />
                <input type="password" id="signupPassword" placeholder="Password (min 8 chars)" class="w-full rounded-lg border px-3 py-2" />
                <button id="signupSubmit" class="w-full bg-emerald-500 text-white rounded-lg px-3 py-2 hover:bg-emerald-600">Create Account</button>
                <div class="text-center text-sm opacity-70">
                    Already have an account? <button id="showLogin" class="text-emerald-500 hover:underline">Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Folder Modal -->
    <div id="folderModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center hidden">
        <div class="w-[300px] rounded-2xl border shadow-xl overflow-hidden bg-white">
            <div class="px-4 py-3 border-b flex items-center">
                <div class="font-medium">New Folder</div>
                <button id="closeFolderModal" class="ml-auto text-sm opacity-70">×</button>
            </div>
            <div class="p-4 space-y-4">
                <input type="text" id="folderName" placeholder="Folder name" class="w-full rounded-lg border px-3 py-2" />
                <button id="createFolderBtn" class="w-full bg-emerald-500 text-white rounded-lg px-3 py-2 hover:bg-emerald-600">Create Folder</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-start justify-center pt-24 hidden">
        <div class="w-[520px] rounded-2xl border shadow-xl overflow-hidden bg-white">
            <div class="px-4 py-3 border-b flex items-center">
                <div class="font-medium">Settings</div>
                <button id="closeSettings" class="ml-auto text-sm opacity-70">×</button>
            </div>
            <div class="p-4 space-y-4 text-sm">
                <div class="flex items-center gap-3">
                    <div class="w-40 opacity-70">Theme</div>
                    <button id="lightTheme" class="px-3 py-1 rounded-lg border border-emerald-500 text-emerald-500 shadow-sm">Light</button>
                    <button id="darkTheme" class="px-3 py-1 rounded-lg border">Dark</button>
                </div>
                <div class="flex items-center gap-3" id="premiumFeatures" style="display: none;">
                    <div class="w-40 opacity-70">Gmail Integration</div>
                    <button id="connectGmail" class="px-3 py-1 rounded-lg border border-emerald-500 text-emerald-500">Connect Gmail</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 text-white text-sm px-3 py-2 rounded-xl shadow-lg bg-emerald-500 hidden"></div>

    <script>
        // DocumentGPT API
        const API_BASE = 'https://i1dy8i3692.execute-api.us-east-1.amazonaws.com/prod';

        // State
        let state = {
            theme: 'light',
            mode: 'Journal',
            simpleMode: false,
            user: null,
            accessToken: localStorage.getItem('documentgpt_token'),
            folders: [],
            docs: [
                { id: 'doc1', name: 'Untitled', type: 'doc', content: "What's one intention for today?\n\n", folder_id: null }
            ],
            activeId: 'doc1',
            focus: false,
            scale: 1,
            liveAssistant: true,
            suggestions: [
                { id: 's1', text: "What's one intention for today?", type: 'static' },
                { id: 's2', text: "Note a challenge and a tiny next step.", type: 'static' }
            ]
        };

        // Helpers
        function uid() { return 'id_' + Math.random().toString(36).slice(2, 9); }

        function getActiveDoc() {
            return state.docs.find(d => d.id === state.activeId) || state.docs[0];
        }

        function analyzeText(text) {
            const words = (text.trim().match(/\b\w+\b/g) || []).length;
            const sentences = Math.max(1, (text.match(/[.!?]/g) || []).length);
            const syllables = (text.toLowerCase().match(/[aeiouy]{1,2}/g) || []).length;
            const W = Math.max(1, words);
            const score = 206.835 - 1.015 * (W / sentences) - 84.6 * (syllables / W);
            const readability = Math.max(0, Math.min(100, Math.round(score)));
            const readMins = Math.max(1, Math.round(words / 200));
            const tone = words < 40 ? "Balanced" : words < 150 ? "Reflective" : "Committed";
            const mood = words < 20 ? "Neutral" : words < 120 ? "Calm" : "Driven";
            return { words, readMins, tone, mood, readability };
        }

        function updateAnalytics() {
            const activeDoc = getActiveDoc();
            const text = activeDoc.type === 'doc' ? (activeDoc.content || '') : '';
            const analytics = analyzeText(text);
            
            document.getElementById('mood').textContent = analytics.mood;
            document.getElementById('tone').textContent = analytics.tone;
            document.getElementById('words').textContent = analytics.words;
            document.getElementById('readTime').textContent = analytics.readMins + 'm';
            document.getElementById('readability').textContent = analytics.readability;
        }

        function renderTabs() {
            const container = document.getElementById('tabsContainer');
            container.innerHTML = '';
            
            state.docs.forEach(doc => {
                const active = doc.id === state.activeId;
                const tab = document.createElement('div');
                tab.className = `group flex items-center gap-2 px-3 py-1.5 rounded-full border text-xs whitespace-nowrap hover:shadow-sm cursor-pointer ${
                    active ? 'border-emerald-500 text-emerald-500' : ''
                }`;
                tab.innerHTML = `
                    <span class="truncate max-w-[180px]">${doc.name}</span>
                    <button class="opacity-50 group-hover:opacity-100" onclick="closeTab('${doc.id}')">×</button>
                `;
                tab.addEventListener('click', (e) => {
                    if (!e.target.closest('button')) {
                        setActiveDoc(doc.id);
                    }
                });
                container.appendChild(tab);
            });
        }

        function renderUploadedDocs() {
            const container = document.getElementById('uploadedDocs');
            container.innerHTML = '';
            
            const uploadedDocs = state.docs.filter(d => d.type === 'pdf');
            
            if (uploadedDocs.length === 0) {
                container.innerHTML = '<div class="text-xs opacity-60 text-center py-2">No documents uploaded yet</div>';
                return;
            }
            
            uploadedDocs.forEach(doc => {
                const active = doc.id === state.activeId;
                const item = document.createElement('button');
                item.className = `w-full text-left px-3 py-2 rounded-lg text-sm hover:shadow-sm border ${
                    active ? 'border-l-4 border-l-emerald-500' : ''
                }`;
                item.textContent = doc.name;
                item.addEventListener('click', () => setActiveDoc(doc.id));
                container.appendChild(item);
            });
        }

        function renderSuggestions() {
            const container = document.getElementById('suggestionsContainer');
            container.innerHTML = '';
            
            if (state.mode === 'Journal' && state.liveAssistant) {
                state.suggestions.forEach(suggestion => {
                    const div = document.createElement('div');
                    div.className = 'rounded-2xl p-3 shadow-sm border';
                    div.innerHTML = `
                        <div class="text-sm">${suggestion.text}</div>
                        <div class="mt-2 flex gap-2">
                            <button onclick="acceptSuggestion('${suggestion.id}')" class="text-xs px-2 py-1 rounded-lg bg-emerald-500 text-white border-emerald-500">Accept</button>
                            <button onclick="rejectSuggestion('${suggestion.id}')" class="text-xs px-2 py-1 rounded-lg border border-emerald-500 text-emerald-500">Reject</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            } else if (state.mode === 'Docs') {
                const actions = [
                    "Summarize the document",
                    "What are the key points?", 
                    "Any important dates or numbers?",
                    "List all totals with currency",
                    "Extract → CSV",
                    "Send to email"
                ];
                
                actions.forEach(action => {
                    const button = document.createElement('button');
                    button.className = 'w-full text-left px-3 py-2 rounded-xl border text-sm hover:shadow-sm border-emerald-500 text-emerald-500';
                    button.textContent = action;
                    button.addEventListener('click', () => {
                        addChatMessage(action, 'user');
                        sendChatMessage(action);
                    });
                    container.appendChild(button);
                });
            }
            
            if (!state.liveAssistant) {
                container.innerHTML = '<div class="text-xs opacity-60 text-center py-2">Live Assistant disabled</div>';
            }
        }

        function setActiveDoc(id) {
            state.activeId = id;
            const activeDoc = getActiveDoc();
            
            renderTabs();
            renderUploadedDocs();
            
            const docEditor = document.getElementById('docEditor');
            const pdfViewer = document.getElementById('pdfViewer');
            const editor = document.getElementById('editor');
            
            if (activeDoc.type === 'doc') {
                docEditor.classList.remove('hidden');
                pdfViewer.classList.add('hidden');
                editor.value = activeDoc.content || '';
                editor.style.transform = `scale(${state.scale})`;
            } else {
                docEditor.classList.add('hidden');
                pdfViewer.classList.remove('hidden');
                document.getElementById('pdfInfo').textContent = `${activeDoc.name} — (placeholder)`;
                pdfViewer.style.transform = `scale(${state.scale})`;
            }
            
            document.getElementById('zoomLabel').textContent = Math.round(state.scale * 100) + '%';
            updateModeButtons();
            updateAnalytics();
        }

        function updateModeButtons() {
            const journalBtn = document.getElementById('journalMode');
            const docsBtn = document.getElementById('docsMode');
            
            if (state.mode === 'Journal') {
                journalBtn.className = 'px-3 py-1 text-xs rounded-full border border-emerald-500 text-emerald-500 shadow-sm';
                docsBtn.className = 'px-3 py-1 text-xs rounded-full opacity-70 hover:opacity-100';
            } else {
                journalBtn.className = 'px-3 py-1 text-xs rounded-full opacity-70 hover:opacity-100';
                docsBtn.className = 'px-3 py-1 text-xs rounded-full border border-emerald-500 text-emerald-500 shadow-sm';
            }
            
            renderSuggestions();
            
            const chatInput = document.getElementById('chatInput');
            chatInput.placeholder = state.mode === 'Journal' 
                ? 'Ask for advice, insights, or a reframe…'
                : 'Ask to summarize, extract numbers, etc…';
        }

        function closeTab(id) {
            if (state.docs.length <= 1) return;
            
            state.docs = state.docs.filter(d => d.id !== id);
            
            if (state.activeId === id) {
                state.activeId = state.docs[0].id;
            }
            
            setActiveDoc(state.activeId);
        }

        function addNewDoc() {
            const docCount = state.docs.filter(d => d.type === 'doc').length;
            const doc = {
                id: uid(),
                name: `Untitled ${docCount + 1}`,
                type: 'doc',
                content: 'New document — start journaling...\n\n'
            };
            
            state.docs.push(doc);
            setActiveDoc(doc.id);
        }

        async function handleFileUpload(file) {
            const isText = /\.(txt|md|markdown)$/i.test(file.name);
            const isPDF = /\.(pdf|docx)$/i.test(file.name);
            
            if (isText) {
                const reader = new FileReader();
                reader.onload = () => {
                    const doc = {
                        id: uid(),
                        name: file.name,
                        type: 'doc',
                        content: String(reader.result || '')
                    };
                    state.docs.push(doc);
                    setActiveDoc(doc.id);
                    
                    // Auto-switch to Journal mode for text files
                    state.mode = 'Journal';
                    updateModeButtons();
                    showToast(`📝 Loaded ${file.name} in Journal mode`);
                };
                reader.readAsText(file);
            } else if (isPDF) {
                const doc = {
                    id: uid(),
                    name: file.name,
                    type: 'pdf',
                    uploading: true
                };
                
                state.docs.push(doc);
                setActiveDoc(doc.id);
                
                // Auto-switch to Docs mode for PDFs
                state.mode = 'Docs';
                updateModeButtons();
                showToast(`📄 Uploading ${file.name} for analysis...`);
                
                try {
                    const base64Content = await fileToBase64(file);
                    
                    const response = await fetch(`${API_BASE}/upload`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            filename: file.name,
                            file_content: base64Content.split(',')[1],
                            user_id: 'web-user'
                        })
                    });

                    const result = await response.json();
                    
                    if (response.ok) {
                        const docIndex = state.docs.findIndex(d => d.id === doc.id);
                        if (docIndex !== -1) {
                            state.docs[docIndex].vectorStoreId = result.vector_store_id;
                            state.docs[docIndex].uploading = false;
                        }
                        
                        renderUploadedDocs();
                        showToast(`✅ ${file.name} ready for analysis!`);
                        addChatMessage(`📄 Document "${file.name}" is ready! Ask me anything about it, or try the AI agents below.`, 'bot');
                    } else {
                        showToast(`❌ Upload failed: ${result.error}`);
                        addChatMessage(`Upload failed: ${result.error}`, 'bot');
                    }
                } catch (error) {
                    addChatMessage(`Upload failed: ${error.message}`, 'bot');
                }
            } else {
                showToast('Unsupported file type. Use .pdf, .txt, or .md');
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function acceptSuggestion(id) {
            const suggestion = state.suggestions.find(s => s.id === id);
            if (suggestion) {
                insertAtCursor(suggestion.text);
                state.suggestions = state.suggestions.filter(s => s.id !== id);
                renderSuggestions();
            }
        }

        function rejectSuggestion(id) {
            state.suggestions = state.suggestions.filter(s => s.id !== id);
            renderSuggestions();
        }

        function insertAtCursor(text) {
            const editor = document.getElementById('editor');
            const activeDoc = getActiveDoc();
            
            if (activeDoc.type === 'doc') {
                const start = editor.selectionStart ?? activeDoc.content.length;
                const end = editor.selectionEnd ?? start;
                const before = activeDoc.content.slice(0, start);
                const after = activeDoc.content.slice(end);
                const insert = (start > 0 && !/\s$/.test(before) ? " " : "") + text + (after && !/^\s/.test(after) ? " " : "");
                
                const newContent = before + insert + after;
                const docIndex = state.docs.findIndex(d => d.id === state.activeId);
                if (docIndex !== -1) {
                    state.docs[docIndex].content = newContent;
                    editor.value = newContent;
                    updateAnalytics();
                }
                
                setTimeout(() => {
                    editor.focus();
                    const caret = (before + insert).length;
                    editor.setSelectionRange(caret, caret);
                }, 0);
            }
        }

        function addChatMessage(text, sender = 'user') {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            
            if (sender === 'user') {
                div.className = 'text-sm p-3 rounded-2xl border bg-blue-50/60 border-blue-200 ml-8';
            } else {
                div.className = 'text-sm p-3 rounded-2xl border bg-emerald-50/60 border-emerald-200 mr-8';
            }
            
            div.textContent = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function sendChatMessage(message = null) {
            const input = document.getElementById('chatInput');
            const msg = message || input.value.trim();
            if (!msg) return;
            
            const activeDoc = getActiveDoc();
            
            if (!message) {
                input.value = '';
                addChatMessage(msg, 'user');
            }
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'text-sm p-3 rounded-2xl border bg-emerald-50/60 border-emerald-200 mr-8';
            loadingDiv.textContent = '🤔 Processing...';
            document.getElementById('chatMessages').appendChild(loadingDiv);
            
            try {
                if (activeDoc.type === 'doc') {
                    const journalContent = activeDoc.content || '';
                    const contextualMessage = `[JOURNAL CONTEXT: User is working on a journal entry titled "${activeDoc.name}". Current content: "${journalContent}"] ${msg}`;
                    
                    const response = await fetch(`${API_BASE}/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            messages: [{ role: 'user', content: contextualMessage }],
                            user_email: 'user@documentgpt.io'
                        })
                    });

                    const result = await response.json();
                    loadingDiv.remove();
                    
                    if (response.ok) {
                        addChatMessage(result.response, 'bot');
                    } else {
                        addChatMessage(`Error: ${result.error}`, 'bot');
                    }
                } else {
                    if (!activeDoc.vectorStoreId) {
                        loadingDiv.remove();
                        addChatMessage('Please wait for document upload to complete.', 'bot');
                        return;
                    }
                    
                    const contextualMessage = `[DOCUMENT CONTEXT: Currently viewing "${activeDoc.name}". Prioritize information from this document, but you can also provide general knowledge if relevant.] ${msg}`;
                    
                    const response = await fetch(`${API_BASE}/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            messages: [{ role: 'user', content: contextualMessage }],
                            vector_store_id: activeDoc.vectorStoreId,
                            user_email: 'user@documentgpt.io'
                        })
                    });

                    const result = await response.json();
                    loadingDiv.remove();
                    
                    if (response.ok) {
                        addChatMessage(result.response, 'bot');
                    } else {
                        addChatMessage(`Error: ${result.error}`, 'bot');
                    }
                }
            } catch (error) {
                loadingDiv.remove();
                addChatMessage(`Chat failed: ${error.message}`, 'bot');
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('hidden');
            
            // Auto-hide based on message type
            const hideDelay = message.includes('working') ? 1000 : 
                             message.includes('completed') ? 3000 : 2000;
            
            setTimeout(() => toast.classList.add('hidden'), hideDelay);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            setActiveDoc(state.activeId);
            
            // File input
            document.getElementById('fileInput').addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    handleFileUpload(e.target.files[0]);
                    e.target.value = '';
                }
            });
            
            // Buttons
            document.getElementById('uploadBtn').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });
            document.getElementById('newBtn').addEventListener('click', addNewDoc);
            document.getElementById('addTabBtn').addEventListener('click', addNewDoc);
            
            // Mode buttons
            document.getElementById('journalMode').addEventListener('click', () => {
                state.mode = 'Journal';
                updateModeButtons();
            });
            document.getElementById('docsMode').addEventListener('click', () => {
                state.mode = 'Docs';
                updateModeButtons();
            });
            
            // Chat
            document.getElementById('sendBtn').addEventListener('click', () => sendChatMessage());
            document.getElementById('chatInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
            
            // Editor
            document.getElementById('editor').addEventListener('input', (e) => {
                const docIndex = state.docs.findIndex(d => d.id === state.activeId);
                if (docIndex !== -1) {
                    state.docs[docIndex].content = e.target.value;
                    updateAnalytics();
                    startLiveAnalysis(); // Trigger live analysis
                }
            });
            
            // Zoom
            document.getElementById('zoomIn').addEventListener('click', () => {
                state.scale = Math.min(1.5, +(state.scale + 0.1).toFixed(2));
                document.getElementById('zoomLabel').textContent = Math.round(state.scale * 100) + '%';
                setActiveDoc(state.activeId);
            });
            
            document.getElementById('zoomOut').addEventListener('click', () => {
                state.scale = Math.max(0.8, +(state.scale - 0.1).toFixed(2));
                document.getElementById('zoomLabel').textContent = Math.round(state.scale * 100) + '%';
                setActiveDoc(state.activeId);
            });
            
            // Focus mode
            document.getElementById('focusBtn').addEventListener('click', () => {
                state.focus = !state.focus;
                const sidebar = document.getElementById('sidebar');
                const assistant = document.getElementById('assistant');
                
                if (state.focus) {
                    sidebar.classList.add('hidden');
                    assistant.classList.add('hidden');
                    document.getElementById('focusBtn').textContent = 'Exit focus';
                } else {
                    sidebar.classList.remove('hidden');
                    assistant.classList.remove('hidden');
                    document.getElementById('focusBtn').textContent = 'Focus mode';
                }
            });
            
            // Theme
            document.getElementById('themeBtn').addEventListener('click', () => {
                state.theme = state.theme === 'light' ? 'dark' : 'light';
                document.getElementById('themeBtn').textContent = state.theme === 'light' ? '🌞 Light' : '🌙 Dark';
                
                if (state.theme === 'dark') {
                    document.body.className = 'h-screen w-full font-inter bg-slate-950 text-slate-100';
                } else {
                    document.body.className = 'h-screen w-full font-inter';
                }
            });
            
            // Live Assistant
            document.getElementById('liveToggle').addEventListener('change', (e) => {
                state.liveAssistant = e.target.checked;
                const status = document.getElementById('liveStatus');
                status.className = state.liveAssistant ? 'w-2 h-2 rounded-full bg-emerald-500' : 'w-2 h-2 rounded-full bg-gray-400';
                renderSuggestions();
                if (state.liveAssistant) {
                    startLiveAnalysis();
                }
            });
            
            // Modals
            document.getElementById('paletteBtn').addEventListener('click', () => {
                document.getElementById('palette').classList.toggle('hidden');
            });
            
            document.getElementById('settingsBtn').addEventListener('click', () => {
                document.getElementById('settings').classList.toggle('hidden');
            });
            
            document.getElementById('settingsBtn2').addEventListener('click', () => {
                document.getElementById('settings').classList.toggle('hidden');
            });
            
            document.getElementById('closeSettings').addEventListener('click', () => {
                document.getElementById('settings').classList.add('hidden');
            });
            
            // Close modals on outside click
            document.getElementById('palette').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    document.getElementById('palette').classList.add('hidden');
                }
            });
            
            document.getElementById('settings').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    document.getElementById('settings').classList.add('hidden');
                }
            });
            
            // AI Agents
            document.getElementById('emailAgent').addEventListener('click', () => {
                const activeDoc = getActiveDoc();
                executeAgent('Email', activeDoc.content || '');
            });
            
            document.getElementById('sheetsAgent').addEventListener('click', () => {
                const activeDoc = getActiveDoc();
                executeAgent('Sheets', activeDoc.content || '');
            });
            
            document.getElementById('calendarAgent').addEventListener('click', () => {
                const activeDoc = getActiveDoc();
                executeAgent('Calendar', activeDoc.content || '');
            });
            
            document.getElementById('saveAgent').addEventListener('click', () => {
                const activeDoc = getActiveDoc();
                executeAgent('Save', activeDoc.content || '');
            });
            
            document.getElementById('exportAgent').addEventListener('click', () => {
                const activeDoc = getActiveDoc();
                executeAgent('Export', activeDoc.content || '');
            });
            
            document.getElementById('summaryAgent').addEventListener('click', () => {
                const activeDoc = getActiveDoc();
                executeAgent('Summary', activeDoc.content || '');
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
                    e.preventDefault();
                    document.getElementById('palette').classList.toggle('hidden');
                }
            });
        });

        // Live AI Assistant
        let liveTimeout;
        
        function startLiveAnalysis() {
            if (!state.liveAssistant) return;
            
            clearTimeout(liveTimeout);
            liveTimeout = setTimeout(() => {
                const activeDoc = getActiveDoc();
                if (activeDoc.type === 'doc' && activeDoc.content) {
                    analyzeLiveWriting(activeDoc.content);
                }
            }, 3000); // Analyze after 3 seconds of no typing
        }
        
        async function analyzeLiveWriting(content) {
            if (!state.liveAssistant || content.length < 20) return;
            
            // Show analyzing indicator
            const statusEl = document.getElementById('liveStatus');
            const statusTextEl = document.getElementById('liveStatusText');
            statusEl.className = 'w-2 h-2 rounded-full bg-yellow-500 animate-pulse';
            statusTextEl.textContent = 'Analyzing...';
            
            try {
                const response = await fetch(`${API_BASE}/live-assist`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: content,
                        user_id: 'web-user'
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.suggestions && result.suggestions.length > 0) {
                    // Replace old live suggestions
                    state.suggestions = state.suggestions.filter(s => s.type !== 'live');
                    
                    result.suggestions.forEach((suggestion, index) => {
                        state.suggestions.unshift({
                            id: 'live_' + Date.now() + '_' + index,
                            text: suggestion,
                            type: 'live'
                        });
                    });
                    
                    renderSuggestions();
                    
                    // Show success indicator
                    statusEl.className = 'w-2 h-2 rounded-full bg-emerald-500';
                    statusTextEl.textContent = 'Ready';
                } else {
                    // No suggestions
                    statusEl.className = 'w-2 h-2 rounded-full bg-emerald-500';
                    statusTextEl.textContent = 'Ready';
                }
            } catch (error) {
                console.log('Live analysis failed:', error);
                statusEl.className = 'w-2 h-2 rounded-full bg-red-500';
                statusTextEl.textContent = 'Error';
                setTimeout(() => {
                    statusEl.className = 'w-2 h-2 rounded-full bg-emerald-500';
                    statusTextEl.textContent = 'Ready';
                }, 3000);
            }
        }
        
        // AI Agents
        async function executeAgent(agentType, content) {
            showToast(`🤖 ${agentType} agent working...`);
            
            try {
                const response = await fetch(`${API_BASE}/agent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agent_type: agentType.toLowerCase(),
                        content: content,
                        user_email: 'user@documentgpt.io'
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showToast(`✅ ${agentType} completed! Check chat below.`);
                    
                    // Add result with better formatting
                    const chatContainer = document.getElementById('chatMessages');
                    const div = document.createElement('div');
                    div.className = 'text-sm p-3 rounded-2xl border bg-blue-50/60 border-blue-200 mr-8';
                    div.innerHTML = `
                        <div class="font-medium text-blue-800 mb-2">🤖 ${agentType} Agent Result:</div>
                        <div class="whitespace-pre-wrap">${result.result}</div>
                    `;
                    chatContainer.appendChild(div);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    
                    // Highlight the new message briefly
                    div.style.boxShadow = '0 0 10px rgba(59, 130, 246, 0.5)';
                    setTimeout(() => {
                        div.style.boxShadow = '';
                    }, 2000);
                } else {
                    showToast(`❌ ${agentType} failed: ${result.error}`);
                }
            } catch (error) {
                showToast(`❌ ${agentType} error: ${error.message}`);
            }
        }
        
        // Global functions
        window.closeTab = closeTab;
        window.acceptSuggestion = acceptSuggestion;
        window.rejectSuggestion = rejectSuggestion;
    </script>
</body>
</html>