<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocumentsGPT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Suppress Tailwind CDN warning */
        .no-tailwind-warning { display: none; }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        neutral: {
                            800: '#262626',
                            900: '#171717',
                            950: '#0a0a0a'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-gray-50">
    <div id="app"></div>

    <script>
        // State
        let theme = localStorage.getItem('dgpt:theme') || 'auto';
        let prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let isDark = theme === 'dark' || (theme === 'auto' && prefersDark);
        let quality = 'hq';
        let tab = 'upload';
        let fileName = 'Sample.pdf';
        let docId = null;
        let status = 'IDLE';
        let progress = 0;
        let progressMessage = '';
        let pages = 0;
        let page = 1;
        let zoom = 110;
        let findTerm = '';
        let findNote = '';
        let messages = JSON.parse(localStorage.getItem('dgpt:messages') || '[]');
        let draft = '';
        let suggested = [];
        let pollInterval = null;

        const recent = [];

        const suggestions = suggested.length ? suggested : [
            'Summarize the document',
            'What are the key points?',
            'Any important dates or numbers?',
            'List all totals with currency'
        ];

        // Theme management
        function updateTheme() {
            document.documentElement.classList.toggle('dark', isDark);
            document.documentElement.style.colorScheme = isDark ? 'dark' : 'light';
            localStorage.setItem('dgpt:theme', theme);
        }

        function setTheme(newTheme) {
            theme = newTheme;
            isDark = theme === 'dark' || (theme === 'auto' && prefersDark);
            updateTheme();
            render();
        }

        // File upload
        let documentUrl = '';
        let documentContent = '';
        
        async function uploadFile(file) {
            // File type validation
            const allowedTypes = ['pdf', 'txt', 'jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'md', 'json', 'csv'];
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            if (!allowedTypes.includes(fileExt)) {
                status = 'ERROR';
                progressMessage = `Unsupported file type: .${fileExt}`;
                addMessage('system', `File type .${fileExt} is not supported. Please upload: PDF, images, or text files.`);
                render();
                return;
            }
            
            // File size validation (50MB limit)
            if (file.size > 50 * 1024 * 1024) {
                status = 'ERROR';
                progressMessage = 'File too large (max 50MB)';
                addMessage('system', 'File exceeds 50MB limit. Please choose a smaller file.');
                render();
                return;
            }

            fileName = file.name;
            status = 'UPLOADING';
            progress = 10;
            progressMessage = 'Uploading file...';
            render();

            try {
                // Step 1: Get upload URL
                const uploadResponse = await fetch('https://9voqzgx3ch.execute-api.us-east-1.amazonaws.com/prod/presign', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        filename: file.name, 
                        contentType: file.type || 'application/octet-stream' 
                    })
                });
                
                if (!uploadResponse.ok) {
                    throw new Error(`Upload failed: ${uploadResponse.status} ${uploadResponse.statusText}`);
                }
                
                const uploadData = await uploadResponse.json();
                if (!uploadData.docId || !uploadData.uploadUrl) {
                    throw new Error('Invalid upload response: missing docId or uploadUrl');
                }
                
                docId = uploadData.docId;
                documentUrl = uploadData.downloadUrl;
                
                progress = 30;
                progressMessage = 'Uploading to cloud storage...';
                render();
                
                // Step 2: Upload file to S3
                const s3Response = await fetch(uploadData.uploadUrl, {
                    method: 'PUT',
                    headers: { 'Content-Type': file.type || 'application/octet-stream' },
                    body: file
                });
                
                if (!s3Response.ok) {
                    throw new Error(`S3 upload failed: ${s3Response.status} ${s3Response.statusText}`);
                }
                
                progress = 50;
                progressMessage = 'Processing document...';
                render();
                
                // Step 3: Start polling for status
                startStatusPolling();
                
                // Step 4: Read file content for display
                if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        documentContent = e.target.result;
                        render();
                    };
                    reader.readAsText(file);
                } else if (file.type.startsWith('image/') || file.name.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i)) {
                    // For images, show preview but note they'll be processed via OCR
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        documentContent = e.target.result;
                        render();
                    };
                    reader.readAsDataURL(file);
                } else {
                    documentContent = `Processing ${fileName}...`;
                    render();
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                status = 'ERROR';
                progressMessage = 'Upload failed';
                stopStatusPolling();
                render();
            }
        }
        
        // Smart status polling with backoff
        async function startStatusPolling() {
            if (pollInterval) clearInterval(pollInterval);
            
            let attempt = 0;
            const maxAttempts = 30;
            
            async function poll() {
                try {
                    const response = await fetch(`https://9voqzgx3ch.execute-api.us-east-1.amazonaws.com/prod/documents?docId=${docId}`);
                    const data = await response.json();
                    
                    if (response.status === 200 && data.status === 'ready') {
                        status = 'READY';
                        progress = 100;
                        pages = data.pages || 1;
                        stopStatusPolling();
                        addMessage('system', `Document "${fileName}" is ready for chat!`);
                        render();
                        return;
                    }
                    
                    if (response.status === 409 || data.status === 'failed') {
                        status = 'ERROR';
                        progressMessage = data.error || 'Processing failed';
                        progress = 100;
                        stopStatusPolling();
                        addMessage('system', `Document "${fileName}" processing failed`);
                        render();
                        return;
                    }
                    
                    status = 'PROCESSING';
                    progress = Math.min(90, 20 + (attempt * 2));
                    progressMessage = data.phase === 'extracting' ? 'Extracting text...' : 
                                    data.phase === 'indexing' ? 'Creating embeddings...' : 'Processing document...';
                    render();
                    
                    attempt++;
                    if (attempt < maxAttempts) {
                        const backoff = Math.min(5000, 1000 + (attempt * 200));
                        setTimeout(poll, backoff);
                    } else {
                        status = 'READY';
                        progress = 100;
                        pages = 1;
                        addMessage('system', `Document "${fileName}" is ready for chat!`);
                        render();
                    }
                    
                } catch (error) {
                    console.error('Status poll error:', error);
                    attempt++;
                    if (attempt < maxAttempts) {
                        setTimeout(poll, 2000);
                    } else {
                        status = 'ERROR';
                        progressMessage = 'Connection error';
                        render();
                    }
                }
            }
            
            poll();
        }
        
        function stopStatusPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        // Chat
        function addMessage(role, text) {
            const id = Math.random().toString(36).slice(2);
            messages.push({ id, role, text });
            localStorage.setItem('dgpt:messages', JSON.stringify(messages));
        }

        async function chat(question) {
            const id = Math.random().toString(36).slice(2);
            addMessage('user', question);
            addMessage('assistant', '');
            render();

            try {
                const body = { messages: [{ role: 'user', content: question }] };
                if (docId && status === 'READY') body.docId = docId;

                const response = await fetch('https://9voqzgx3ch.execute-api.us-east-1.amazonaws.com/prod/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                if (response.status === 425) {
                    messages[messages.length - 1].text = '⏳ Still processing your document... Please wait a moment.';
                    render();
                    return;
                }
                
                if (response.status === 409) {
                    messages[messages.length - 1].text = '❌ Document processing failed. Switching to general chat mode.';
                    render();
                    return;
                }
                
                const data = await response.json();
                const answer = data.answer || 'Sorry, I could not complete that.';
                
                let modeNote = '';
                if (data.mode === 'rag' && data.hasContext) {
                    modeNote = ' 📄';
                } else if (data.mode === 'general') {
                    modeNote = ' 🤖';
                }
                
                messages[messages.length - 1].text = answer + modeNote;
                render();
            } catch (error) {
                console.error('Chat error:', error);
                messages[messages.length - 1].text = 'Sorry, I encountered an error. Please try again.';
                render();
            }
        }

        // Event handlers
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) uploadFile(file);
        }

        function handleDrop(event) {
            event.preventDefault();
            const file = event.dataTransfer.files[0];
            if (file) uploadFile(file);
        }

        function handleSendMessage() {
            if (draft.trim()) {
                chat(draft.trim());
                draft = '';
                render();
            }
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                const input = event.target;
                draft = input.value;
                handleSendMessage();
            }
        }
        
        function updateDraft(event) {
            draft = event.target.value;
        }

        // Helper function to create image element
        function createImageElement(src, alt) {
            return `<img src="${src}" alt="${alt}" class="max-w-full max-h-full object-contain mx-auto" />`;
        }
        
        // Render function
        function render() {
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <div class="${isDark ? 'dark' : ''}">
                    <div class="h-screen w-full transition-colors ${isDark ? 'bg-neutral-900 text-neutral-100' : 'bg-gray-50 text-gray-900'}" 
                         ondragover="event.preventDefault()" ondrop="handleDrop(event)">
                        
                        <!-- Top bar -->
                        <div class="sticky top-0 z-50 h-14 backdrop-blur flex items-center px-4 gap-3 border-b transition-colors ${isDark ? 'bg-neutral-900/80 border-white/10' : 'bg-white/80 border-gray-200'}">
                            <div class="flex items-center gap-2 font-semibold ${isDark ? 'text-emerald-400' : 'text-emerald-600'}">
                                <span class="inline-flex h-6 w-6 items-center justify-center rounded-md ${isDark ? 'bg-emerald-900/40 text-emerald-300' : 'bg-emerald-100 text-emerald-700'}">🗎</span>
                                <span>DocumentsGPT</span>
                                <span class="text-xs font-medium rounded px-1.5 py-0.5 border ${isDark ? 'text-gray-400 border-white/10' : 'text-gray-500 border-gray-200'}">v5</span>
                            </div>
                            <div class="ml-auto flex items-center gap-2 text-xs">
                                <div class="hidden sm:flex gap-1">
                                    <button onclick="quality='fast'; render()" class="px-2 py-1 rounded-full border transition-colors ${quality === 'fast' ? 'bg-gray-900 text-white border-gray-900' : (isDark ? 'bg-neutral-800 border-white/10' : 'bg-white')}">Fast</button>
                                    <button onclick="quality='hq'; render()" class="px-2 py-1 rounded-full border transition-colors ${quality === 'hq' ? 'bg-gray-900 text-white border-gray-900' : (isDark ? 'bg-neutral-800 border-white/10' : 'bg-white')}">High quality</button>
                                    <span class="px-2 py-1 rounded-full border transition-colors ${isDark ? 'bg-neutral-800 border-white/10' : 'bg-white'}">Model: GPT-4o-mini</span>
                                </div>
                                <div class="ml-1 inline-flex rounded-full overflow-hidden border ${isDark ? 'border-white/10' : 'border-gray-200'}">
                                    <button onclick="setTheme('light')" class="px-2 py-1 text-sm transition-colors ${theme==='light' && !isDark ? 'bg-gray-900 text-white' : (isDark ? 'bg-neutral-800' : 'bg-white')}">☀️</button>
                                    <button onclick="setTheme('auto')" class="px-2 py-1 text-sm transition-colors ${theme==='auto' ? 'bg-gray-900 text-white' : (isDark ? 'bg-neutral-800' : 'bg-white')}">🌓</button>
                                    <button onclick="setTheme('dark')" class="px-2 py-1 text-sm transition-colors ${theme==='dark' && isDark ? 'bg-gray-900 text-white' : (isDark ? 'bg-neutral-800' : 'bg-white')}">🌙</button>
                                </div>
                            </div>
                        </div>

                        <!-- Main grid -->
                        <div class="h-[calc(100vh-56px)] grid grid-cols-1 lg:grid-cols-[280px_1fr_420px]">
                            
                            <!-- Sidebar -->
                            <aside class="hidden lg:block p-3 overflow-y-auto border-r transition-colors ${isDark ? 'bg-neutral-900 border-white/10' : 'bg-white border-gray-200'}">
                                <div class="inline-flex rounded-lg p-1 text-sm border transition-colors ${isDark ? 'bg-neutral-800 border-white/10' : 'bg-gray-50'}">
                                    <button onclick="tab='sample'; render()" class="px-3 py-1.5 rounded-md ${tab==='sample' ? (isDark ? 'bg-neutral-900 shadow-sm' : 'bg-white shadow-sm') : (isDark ? 'text-gray-300' : 'text-gray-600')}">Sample</button>
                                    <button onclick="tab='upload'; render()" class="px-3 py-1.5 rounded-md ${tab==='upload' ? (isDark ? 'bg-neutral-900 shadow-sm' : 'bg-white shadow-sm') : (isDark ? 'text-gray-300' : 'text-gray-600')}">Upload</button>
                                </div>

                                ${tab === 'upload' ? `
                                    <div class="mt-3">
                                        <label class="block text-xs font-medium mb-1 ${isDark ? 'text-gray-400' : 'text-gray-500'}">Upload a document (drag & drop anywhere)</label>
                                        <input type="file" accept=".pdf,.txt,.jpg,.jpeg,.png,.gif,.bmp,.webp,.md,.json,.csv" onchange="handleFileSelect(event)" class="block w-full text-sm" />
                                        <div class="text-xs mt-1 ${isDark ? 'text-gray-500' : 'text-gray-400'}">Supported: PDF, images, text files (max 50MB)</div>
                                    </div>
                                ` : ''}

                                <div class="mt-6">
                                    <div class="text-xs font-semibold mb-2 ${isDark ? 'text-gray-400' : 'text-gray-500'}">ASSISTANT TOOLS</div>
                                    <div class="space-y-2">
                                        <button class="w-full text-left px-3 py-2 rounded-md border flex items-center gap-2 transition-colors ${isDark ? 'bg-neutral-900 hover:bg-neutral-800 border-white/10' : 'bg-white hover:bg-gray-50'}">
                                            <span class="inline-flex h-5 w-5 items-center justify-center rounded ${isDark ? 'bg-neutral-800' : 'bg-gray-100'}">⚖️</span>
                                            <span class="text-sm">Legal/Finance/Compliance</span>
                                        </button>
                                        <button class="w-full text-left px-3 py-2 rounded-md border flex items-center gap-2 transition-colors ${isDark ? 'bg-neutral-900 hover:bg-neutral-800 border-white/10' : 'bg-white hover:bg-gray-50'}">
                                            <span class="inline-flex h-5 w-5 items-center justify-center rounded ${isDark ? 'bg-neutral-800' : 'bg-gray-100'}">🛠️</span>
                                            <span class="text-sm">Tech/Design/PM</span>
                                        </button>
                                    </div>
                                </div>

                                <div class="mt-6">
                                    <div class="text-xs font-semibold mb-2 ${isDark ? 'text-gray-400' : 'text-gray-500'}">RECENT</div>
                                    <div class="space-y-2">
                                        ${recent.map(r => `
                                            <div class="flex items-center justify-between px-3 py-2 rounded-md cursor-pointer transition-colors ${isDark ? 'hover:bg-neutral-800' : 'hover:bg-gray-50'}">
                                                <div class="flex items-center gap-2">
                                                    <span class="inline-flex h-6 w-6 items-center justify-center rounded-full ${isDark ? 'bg-neutral-800' : 'bg-gray-100'}">👤</span>
                                                    <span class="text-sm">${r.title}</span>
                                                </div>
                                                <span class="text-xs ${isDark ? 'text-gray-400' : 'text-gray-500'}">${r.when}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </aside>

                            <!-- Center -->
                            <section class="${isDark ? 'bg-neutral-950' : 'bg-gray-50'}">
                                <div class="sticky top-0 z-40 h-14 px-4 flex items-center gap-3 border-b transition-colors ${isDark ? 'bg-neutral-900 border-white/10' : 'bg-white border-gray-200'}">
                                    <div class="flex items-center gap-2 text-sm">
                                        <span class="font-medium truncate max-w-[40vw] lg:max-w-none">${fileName}</span>
                                        <span class="${isDark ? 'text-gray-400' : 'text-gray-500'}">• ${pages || 0}p</span>
                                    </div>
                                    <div class="ml-2 inline-flex items-center gap-1 border rounded-md overflow-hidden transition-colors ${isDark ? 'border-white/10' : ''}">
                                        <button onclick="zoom = Math.max(50, zoom - 10); render()" class="px-2 py-1 transition-colors ${isDark ? 'hover:bg-neutral-800' : 'hover:bg-gray-50'}">−</button>
                                        <div class="px-2 text-sm w-[58px] text-center">${zoom}%</div>
                                        <button onclick="zoom = Math.min(200, zoom + 10); render()" class="px-2 py-1 transition-colors ${isDark ? 'hover:bg-neutral-800' : 'hover:bg-gray-50'}">+</button>
                                    </div>
                                    <div class="ml-3 text-sm">Page ${Math.min(page, Math.max(1, pages || 1))} / ${pages || 1}</div>
                                    <div class="ml-auto flex items-center gap-2">
                                        <input value="${findTerm}" oninput="findTerm = this.value" onkeydown="if(event.key==='Enter') findNote='Search simulated'" placeholder="Find text in this page" class="h-9 w-60 lg:w-72 px-3 rounded-md border text-sm transition-colors ${isDark ? 'bg-neutral-900 border-white/10' : ''}" />
                                        <button onclick="findNote='Search simulated'" class="h-9 px-3 rounded-md border text-sm transition-colors ${isDark ? 'bg-neutral-900 hover:bg-neutral-800 border-white/10' : 'bg-white hover:bg-gray-50'}">Find</button>
                                    </div>
                                </div>

                                <div class="h-[calc(100%-56px)] grid grid-cols-[96px_1fr]">
                                    <div class="border-r overflow-y-auto p-2 transition-colors ${isDark ? 'bg-neutral-950 border-white/10' : 'bg-gray-50'}">
                                        <div class="text-xs p-2 ${isDark ? 'text-gray-400' : 'text-gray-500'}">No thumbs</div>
                                    </div>

                                    <div class="relative overflow-auto p-6" style="overflow: auto;">
                                        ${(status === 'PROCESSING' || status === 'UPLOADING') ? `
                                            <div class="absolute top-4 right-6 z-10 flex items-center gap-2 text-xs px-3 py-2 rounded-lg border ${isDark ? 'bg-amber-900/40 text-amber-200 border-amber-200/30' : 'bg-amber-100 text-amber-800 border-amber-200/60'}">
                                                <div class="w-3 h-3 border-2 border-current border-t-transparent rounded-full animate-spin"></div>
                                                <div>
                                                    <div class="font-medium">${progressMessage}</div>
                                                    <div class="w-32 h-1 bg-black/20 rounded-full mt-1">
                                                        <div class="h-full bg-current rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        ` : ''}
                                        ${findNote ? `<div class="absolute top-4 left-6 z-10 text-xs px-2 py-1 rounded border ${isDark ? 'bg-sky-900/40 text-sky-200 border-sky-200/30' : 'bg-sky-100 text-sky-800 border-sky-200/60'}">${findNote}</div>` : ''}
                                        <div class="mx-auto max-w-[1100px] min-h-[900px] rounded-lg shadow-sm flex items-center justify-center relative transition-colors border ${isDark ? 'bg-neutral-900 text-gray-400 border-white/10' : 'bg-white text-gray-500'}">
                                            ${documentContent ? `
                                                <div class="w-full h-full p-4 overflow-auto">
                                                    ${(() => {
                                                        if (fileName.toLowerCase().endsWith('.pdf')) {
                                                            return `<embed src="${documentUrl}" type="application/pdf" class="w-full h-full rounded" style="transform: scale(${zoom/100}); transform-origin: center;" />`;
                                                        } else if (fileName.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i) || documentContent.startsWith('data:image')) {
                                                            // Truncate very long base64 strings for template literal
                                                            const imgSrc = documentContent.length > 50000 ? documentContent.substring(0, 50000) + '...' : documentContent;
                                                            return `<img src="${documentContent}" alt="${fileName}" class="max-w-full max-h-full object-contain mx-auto" style="transform: scale(${zoom/100}); transform-origin: center;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'" /><div style="display:none" class="text-center p-8"><div class="text-6xl mb-4">🖼️</div><h3 class="text-lg font-medium mb-2">${fileName}</h3><p class="text-sm opacity-75">Image uploaded successfully</p></div>`;
                                                        } else if (fileName.match(/\.(txt|md|json|js|py|html|css|xml|csv)$/i) || fileName.endsWith('.txt')) {
                                                            return `<div class="text-left p-4 font-mono text-sm whitespace-pre-wrap ${isDark ? 'text-gray-300' : 'text-gray-800'}" style="transform: scale(${zoom/100}); transform-origin: top left;">${documentContent.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>`;
                                                        } else {
                                                            return `<div class="text-center p-8">
                                                                <div class="text-6xl mb-4">📄</div>
                                                                <h3 class="text-lg font-medium mb-2">${fileName}</h3>
                                                                <p class="text-sm opacity-75 mb-4">File uploaded successfully - processing for chat</p>
                                                                ${documentUrl ? `<a href="${documentUrl}" target="_blank" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                                                    <span class="mr-2">📥</span> Download
                                                                </a>` : ''}
                                                            </div>`;
                                                        }
                                                    })()}
                                                </div>
                                            ` : '<div class="pointer-events-none select-none">Drop a document to view (upload begins automatically)</div>'}
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <!-- Chat -->
                            <aside class="border-t lg:border-t-0 lg:border-l flex flex-col min-h-[320px] transition-colors ${isDark ? 'bg-neutral-900 border-white/10' : 'bg-white'}">
                                <div class="flex-1 overflow-auto p-4 space-y-4">
                                    ${messages.length === 0 ? `<div class="text-center ${isDark ? 'text-gray-400' : 'text-gray-500'}"><p>Upload a document and start chatting</p></div>` : messages.map(m => `
                                        <div class="max-w-[92%] ${m.role === 'assistant' ? '' : 'ml-auto'}">
                                            <div class="rounded-2xl px-4 py-2 text-sm border transition-colors ${m.role === 'assistant' ? (isDark ? 'bg-neutral-800 border-white/10' : 'bg-gray-50') : 'bg-emerald-600 text-white border-emerald-600'}">
                                                ${m.text || '<span class="opacity-60">…</span>'}
                                            </div>
                                            <div class="mt-1 flex items-center gap-3 text-[11px] ${isDark ? 'text-gray-400' : 'text-gray-500'}">
                                                <button onclick="navigator.clipboard?.writeText(${JSON.stringify(m.text)})" class="hover:underline">Copy</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>

                                <div class="border-t p-3 transition-colors ${isDark ? 'border-white/10' : ''}">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex flex-wrap gap-2">
                                            ${suggestions.map(s => `
                                                <button onclick="chat('${s}')" class="px-3 py-1.5 rounded-full border text-xs transition-colors ${isDark ? 'hover:bg-neutral-800 border-white/10' : 'hover:bg-gray-50'}">${s}</button>
                                            `).join('')}
                                        </div>
                                        ${messages.length > 0 ? `<button onclick="clearChat()" class="px-2 py-1 text-xs rounded border transition-colors ${isDark ? 'hover:bg-neutral-800 border-white/10 text-gray-400' : 'hover:bg-gray-50 text-gray-600'}">Clear</button>` : ''}
                                    </div>
                                </div>

                                <div class="border-t p-3 transition-colors ${isDark ? 'border-white/10' : ''}">
                                    <div class="flex items-center gap-2">
                                        <label class="h-10 w-10 rounded-full border grid place-items-center cursor-pointer transition-colors ${isDark ? 'bg-neutral-900 border-white/10' : 'bg-white'}">📎
                                            <input type="file" accept=".pdf,.txt,.jpg,.jpeg,.png,.gif,.bmp,.webp,.md,.json,.csv" class="hidden" onchange="handleFileSelect(event)" />
                                        </label>
                                        <input id="chatInput" value="${draft}" oninput="updateDraft(event)" onkeydown="handleKeyDown(event)" placeholder="Ask anything…" class="flex-1 h-10 px-3 rounded-full border transition-colors ${isDark ? 'bg-neutral-900 border-white/10' : ''}" />
                                        <button onclick="handleSendMessage()" class="h-10 w-10 rounded-full bg-emerald-600 text-white">➤</button>
                                    </div>
                                    <div class="mt-2 text-[11px] ${isDark ? 'text-gray-400' : 'text-gray-500'}">Drop a file anywhere to upload • Status: <b>${status}</b>${progress > 0 ? ` • ${progress}%` : ''}${docId ? ` • ID: ${docId.slice(0,8)}...` : ''}</div>
                                </div>
                            </aside>
                        </div>
                    </div>
                </div>
            `;
            

        }

        // Initialize
        updateTheme();
        render();

        // Watch system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            prefersDark = e.matches;
            if (theme === 'auto') {
                isDark = prefersDark;
                updateTheme();
                render();
            }
        });

        // Check Step Function progress
        async function checkStepFunctionProgress() {
            try {
                // Simulate Step Function status check
                const now = Date.now();
                const uploadTime = docId ? parseInt(docId.split('_')[1]) : now;
                const elapsed = now - uploadTime;
                
                if (elapsed < 10000) {
                    return { running: true, step: 1, message: 'Starting processing...' };
                } else if (elapsed < 30000) {
                    return { running: true, step: 2, message: 'Extracting text...' };
                } else if (elapsed < 60000) {
                    return { running: true, step: 3, message: 'Creating embeddings...' };
                } else if (elapsed < 90000) {
                    return { running: true, step: 4, message: 'Finalizing...' };
                } else {
                    return { failed: true, message: 'Processing timeout' };
                }
            } catch (error) {
                return { failed: true, message: 'Processing error' };
            }
        }

        // Make functions global
        window.setTheme = setTheme;
        window.checkStepFunctionProgress = checkStepFunctionProgress;
        window.handleFileSelect = handleFileSelect;
        window.handleDrop = handleDrop;
        window.handleSendMessage = handleSendMessage;
        window.handleKeyDown = handleKeyDown;
        window.updateDraft = updateDraft;
        window.chat = chat;
        window.clearChat = () => {
            messages = [];
            localStorage.removeItem('dgpt:messages');
            render();
        };
        
        window.debugContent = () => {
            console.log('Debug Info:', {
                fileName,
                contentStart: documentContent.substring(0, 50),
                contentLength: documentContent.length,
                startsWithDataImage: documentContent.startsWith('data:image'),
                isImage: fileName.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i)
            });
        };
    </script>
</body>
</html>