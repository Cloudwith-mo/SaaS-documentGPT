<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocumentsGPT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        neutral: {
                            800: '#262626',
                            900: '#171717',
                            950: '#0a0a0a'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-gray-50">
    <div id="app"></div>

    <script>
        // State
        let theme = localStorage.getItem('dgpt:theme') || 'auto';
        let prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let isDark = theme === 'dark' || (theme === 'auto' && prefersDark);
        let quality = 'hq';
        let tab = 'upload';
        let fileName = 'Sample.pdf';
        let docId = null;
        let status = 'IDLE';
        let pages = 0;
        let page = 1;
        let zoom = 110;
        let findTerm = '';
        let findNote = '';
        let messages = [];
        let draft = '';
        let suggested = [];

        const recent = [
            { title: 'AI assistant', when: '2h ago' },
            { title: 'Q3 review', when: '2h ago' },
            { title: 'Contract QA', when: '2h ago' }
        ];

        const suggestions = suggested.length ? suggested : [
            'Summarize the document',
            'What are the key points?',
            'Any important dates or numbers?',
            'List all totals with currency'
        ];

        // Theme management
        function updateTheme() {
            document.documentElement.classList.toggle('dark', isDark);
            document.documentElement.style.colorScheme = isDark ? 'dark' : 'light';
            localStorage.setItem('dgpt:theme', theme);
        }

        function setTheme(newTheme) {
            theme = newTheme;
            isDark = theme === 'dark' || (theme === 'auto' && prefersDark);
            updateTheme();
            render();
        }

        // File upload
        let documentUrl = '';
        
        async function uploadFile(file) {
            fileName = file.name;
            status = 'PROCESSING';
            render();

            try {
                // Step 1: Get upload URL
                const uploadResponse = await fetch('https://kufufm7r9a.execute-api.us-east-1.amazonaws.com/prod/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        filename: file.name, 
                        contentType: file.type || 'application/octet-stream' 
                    })
                });
                
                const uploadData = await uploadResponse.json();
                docId = uploadData.docId;
                documentUrl = uploadData.downloadUrl;
                
                // Step 2: Upload file to S3
                const s3Response = await fetch(uploadData.uploadUrl, {
                    method: 'PUT',
                    headers: { 'Content-Type': file.type || 'application/octet-stream' },
                    body: file
                });
                
                if (!s3Response.ok) throw new Error('Upload failed');
                
                // Step 3: Process for RAG (if text file)
                if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const content = e.target.result;
                        const processResponse = await fetch('https://kufufm7r9a.execute-api.us-east-1.amazonaws.com/prod/process-document', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ docId, filename: file.name, content })
                        });
                        
                        const processData = await processResponse.json();
                        if (processData.status === 'READY') {
                            pages = processData.chunks || 1;
                            addMessage('system', `Document "${file.name}" uploaded and processed with ${processData.chunks} chunks. Ask questions about it!`);
                        }
                    };
                    reader.readAsText(file);
                } else {
                    pages = 1;
                    addMessage('system', `Document "${file.name}" uploaded successfully. Preview available in center panel.`);
                }
                
                status = 'READY';
                render();
            } catch (error) {
                console.error('Upload error:', error);
                status = 'ERROR';
                render();
            }
        }

        // Chat
        function addMessage(role, text) {
            const id = Math.random().toString(36).slice(2);
            messages.push({ id, role, text });
        }

        async function chat(question) {
            const id = Math.random().toString(36).slice(2);
            addMessage('user', question);
            addMessage('assistant', '');
            render();

            try {
                const response = await fetch('https://kufufm7r9a.execute-api.us-east-1.amazonaws.com/prod/rag-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, docId })
                });
                
                const data = await response.json();
                const answer = data.answer || 'Sorry, I could not complete that.';
                const contextNote = data.hasContext ? ' (using document context)' : '';
                messages[messages.length - 1].text = answer + contextNote;
                render();
            } catch (error) {
                console.error('Chat error:', error);
                messages[messages.length - 1].text = 'Sorry, I could not complete that.';
                render();
            }
        }

        // Event handlers
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) uploadFile(file);
        }

        function handleDrop(event) {
            event.preventDefault();
            const file = event.dataTransfer.files[0];
            if (file) uploadFile(file);
        }

        function handleSendMessage() {
            if (draft.trim()) {
                chat(draft.trim());
                draft = '';
                render();
            }
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                const input = event.target;
                draft = input.value;
                handleSendMessage();
            }
        }
        
        function updateDraft(event) {
            draft = event.target.value;
        }

        // Render function
        function render() {
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <div class="${isDark ? 'dark' : ''}">
                    <div class="h-screen w-full transition-colors ${isDark ? 'bg-neutral-900 text-neutral-100' : 'bg-gray-50 text-gray-900'}" 
                         ondragover="event.preventDefault()" ondrop="handleDrop(event)">
                        
                        <!-- Top bar -->
                        <div class="sticky top-0 z-50 h-14 backdrop-blur flex items-center px-4 gap-3 border-b transition-colors ${isDark ? 'bg-neutral-900/80 border-white/10' : 'bg-white/80 border-gray-200'}">
                            <div class="flex items-center gap-2 font-semibold ${isDark ? 'text-emerald-400' : 'text-emerald-600'}">
                                <span class="inline-flex h-6 w-6 items-center justify-center rounded-md ${isDark ? 'bg-emerald-900/40 text-emerald-300' : 'bg-emerald-100 text-emerald-700'}">üóé</span>
                                <span>DocumentsGPT</span>
                                <span class="text-xs font-medium rounded px-1.5 py-0.5 border ${isDark ? 'text-gray-400 border-white/10' : 'text-gray-500 border-gray-200'}">v5</span>
                            </div>
                            <div class="ml-auto flex items-center gap-2 text-xs">
                                <div class="hidden sm:flex gap-1">
                                    <button onclick="quality='fast'; render()" class="px-2 py-1 rounded-full border transition-colors ${quality === 'fast' ? 'bg-gray-900 text-white border-gray-900' : (isDark ? 'bg-neutral-800 border-white/10' : 'bg-white')}">Fast</button>
                                    <button onclick="quality='hq'; render()" class="px-2 py-1 rounded-full border transition-colors ${quality === 'hq' ? 'bg-gray-900 text-white border-gray-900' : (isDark ? 'bg-neutral-800 border-white/10' : 'bg-white')}">High quality</button>
                                    <span class="px-2 py-1 rounded-full border transition-colors ${isDark ? 'bg-neutral-800 border-white/10' : 'bg-white'}">Model: GPT-4o</span>
                                </div>
                                <div class="ml-1 inline-flex rounded-full overflow-hidden border ${isDark ? 'border-white/10' : 'border-gray-200'}">
                                    <button onclick="setTheme('light')" class="px-2 py-1 text-sm transition-colors ${theme==='light' && !isDark ? 'bg-gray-900 text-white' : (isDark ? 'bg-neutral-800' : 'bg-white')}">‚òÄÔ∏è</button>
                                    <button onclick="setTheme('auto')" class="px-2 py-1 text-sm transition-colors ${theme==='auto' ? 'bg-gray-900 text-white' : (isDark ? 'bg-neutral-800' : 'bg-white')}">üåì</button>
                                    <button onclick="setTheme('dark')" class="px-2 py-1 text-sm transition-colors ${theme==='dark' && isDark ? 'bg-gray-900 text-white' : (isDark ? 'bg-neutral-800' : 'bg-white')}">üåô</button>
                                </div>
                            </div>
                        </div>

                        <!-- Main grid -->
                        <div class="h-[calc(100vh-56px)] grid grid-cols-1 lg:grid-cols-[280px_1fr_420px]">
                            
                            <!-- Sidebar -->
                            <aside class="hidden lg:block p-3 overflow-y-auto border-r transition-colors ${isDark ? 'bg-neutral-900 border-white/10' : 'bg-white border-gray-200'}">
                                <div class="inline-flex rounded-lg p-1 text-sm border transition-colors ${isDark ? 'bg-neutral-800 border-white/10' : 'bg-gray-50'}">
                                    <button onclick="tab='sample'; render()" class="px-3 py-1.5 rounded-md ${tab==='sample' ? (isDark ? 'bg-neutral-900 shadow-sm' : 'bg-white shadow-sm') : (isDark ? 'text-gray-300' : 'text-gray-600')}">Sample</button>
                                    <button onclick="tab='upload'; render()" class="px-3 py-1.5 rounded-md ${tab==='upload' ? (isDark ? 'bg-neutral-900 shadow-sm' : 'bg-white shadow-sm') : (isDark ? 'text-gray-300' : 'text-gray-600')}">Upload</button>
                                </div>

                                ${tab === 'upload' ? `
                                    <div class="mt-3">
                                        <label class="block text-xs font-medium mb-1 ${isDark ? 'text-gray-400' : 'text-gray-500'}">Upload a document (drag & drop anywhere)</label>
                                        <input type="file" onchange="handleFileSelect(event)" class="block w-full text-sm" />
                                    </div>
                                ` : ''}

                                <div class="mt-6">
                                    <div class="text-xs font-semibold mb-2 ${isDark ? 'text-gray-400' : 'text-gray-500'}">ASSISTANT TOOLS</div>
                                    <div class="space-y-2">
                                        <button class="w-full text-left px-3 py-2 rounded-md border flex items-center gap-2 transition-colors ${isDark ? 'bg-neutral-900 hover:bg-neutral-800 border-white/10' : 'bg-white hover:bg-gray-50'}">
                                            <span class="inline-flex h-5 w-5 items-center justify-center rounded ${isDark ? 'bg-neutral-800' : 'bg-gray-100'}">‚öñÔ∏è</span>
                                            <span class="text-sm">Legal/Finance/Compliance</span>
                                        </button>
                                        <button class="w-full text-left px-3 py-2 rounded-md border flex items-center gap-2 transition-colors ${isDark ? 'bg-neutral-900 hover:bg-neutral-800 border-white/10' : 'bg-white hover:bg-gray-50'}">
                                            <span class="inline-flex h-5 w-5 items-center justify-center rounded ${isDark ? 'bg-neutral-800' : 'bg-gray-100'}">üõ†Ô∏è</span>
                                            <span class="text-sm">Tech/Design/PM</span>
                                        </button>
                                    </div>
                                </div>

                                <div class="mt-6">
                                    <div class="text-xs font-semibold mb-2 ${isDark ? 'text-gray-400' : 'text-gray-500'}">RECENT</div>
                                    <div class="space-y-2">
                                        ${recent.map(r => `
                                            <div class="flex items-center justify-between px-3 py-2 rounded-md cursor-pointer transition-colors ${isDark ? 'hover:bg-neutral-800' : 'hover:bg-gray-50'}">
                                                <div class="flex items-center gap-2">
                                                    <span class="inline-flex h-6 w-6 items-center justify-center rounded-full ${isDark ? 'bg-neutral-800' : 'bg-gray-100'}">üë§</span>
                                                    <span class="text-sm">${r.title}</span>
                                                </div>
                                                <span class="text-xs ${isDark ? 'text-gray-400' : 'text-gray-500'}">${r.when}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </aside>

                            <!-- Center -->
                            <section class="${isDark ? 'bg-neutral-950' : 'bg-gray-50'}">
                                <div class="sticky top-0 z-40 h-14 px-4 flex items-center gap-3 border-b transition-colors ${isDark ? 'bg-neutral-900 border-white/10' : 'bg-white border-gray-200'}">
                                    <div class="flex items-center gap-2 text-sm">
                                        <span class="font-medium truncate max-w-[40vw] lg:max-w-none">${fileName}</span>
                                        <span class="${isDark ? 'text-gray-400' : 'text-gray-500'}">‚Ä¢ ${pages || 0}p</span>
                                    </div>
                                    <div class="ml-2 inline-flex items-center gap-1 border rounded-md overflow-hidden transition-colors ${isDark ? 'border-white/10' : ''}">
                                        <button onclick="zoom = Math.max(50, zoom - 10); render()" class="px-2 py-1 transition-colors ${isDark ? 'hover:bg-neutral-800' : 'hover:bg-gray-50'}">‚àí</button>
                                        <div class="px-2 text-sm w-[58px] text-center">${zoom}%</div>
                                        <button onclick="zoom = Math.min(200, zoom + 10); render()" class="px-2 py-1 transition-colors ${isDark ? 'hover:bg-neutral-800' : 'hover:bg-gray-50'}">+</button>
                                    </div>
                                    <div class="ml-3 text-sm">Page ${Math.min(page, Math.max(1, pages || 1))} / ${pages || 1}</div>
                                    <div class="ml-auto flex items-center gap-2">
                                        <input value="${findTerm}" oninput="findTerm = this.value" onkeydown="if(event.key==='Enter') findNote='Search simulated'" placeholder="Find text in this page" class="h-9 w-60 lg:w-72 px-3 rounded-md border text-sm transition-colors ${isDark ? 'bg-neutral-900 border-white/10' : ''}" />
                                        <button onclick="findNote='Search simulated'" class="h-9 px-3 rounded-md border text-sm transition-colors ${isDark ? 'bg-neutral-900 hover:bg-neutral-800 border-white/10' : 'bg-white hover:bg-gray-50'}">Find</button>
                                    </div>
                                </div>

                                <div class="h-[calc(100%-56px)] grid grid-cols-[96px_1fr]">
                                    <div class="border-r overflow-y-auto p-2 transition-colors ${isDark ? 'bg-neutral-950 border-white/10' : 'bg-gray-50'}">
                                        <div class="text-xs p-2 ${isDark ? 'text-gray-400' : 'text-gray-500'}">No thumbs</div>
                                    </div>

                                    <div class="relative overflow-auto p-6">
                                        ${status === 'PROCESSING' ? `<div class="absolute top-4 right-6 z-10 text-xs px-2 py-1 rounded border ${isDark ? 'bg-amber-900/40 text-amber-200 border-amber-200/30' : 'bg-amber-100 text-amber-800 border-amber-200/60'}">Processing‚Ä¶</div>` : ''}
                                        ${findNote ? `<div class="absolute top-4 left-6 z-10 text-xs px-2 py-1 rounded border ${isDark ? 'bg-sky-900/40 text-sky-200 border-sky-200/30' : 'bg-sky-100 text-sky-800 border-sky-200/60'}">${findNote}</div>` : ''}
                                        <div class="mx-auto max-w-[1100px] min-h-[900px] rounded-lg shadow-sm flex items-center justify-center relative transition-colors border ${isDark ? 'bg-neutral-900 text-gray-400 border-white/10' : 'bg-white text-gray-500'}">
                                            ${documentUrl ? `
                                                <div class="w-full h-full p-4">
                                                    ${fileName.toLowerCase().endsWith('.pdf') ? 
                                                        `<embed src="${documentUrl}" type="application/pdf" class="w-full h-full rounded" />` :
                                                        fileName.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i) ?
                                                        `<img src="${documentUrl}" alt="${fileName}" class="max-w-full max-h-full object-contain mx-auto" />` :
                                                        `<div class="text-center p-8">
                                                            <div class="text-6xl mb-4">üìÑ</div>
                                                            <h3 class="text-lg font-medium mb-2">${fileName}</h3>
                                                            <p class="text-sm opacity-75 mb-4">Document uploaded successfully</p>
                                                            <a href="${documentUrl}" target="_blank" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                                                <span class="mr-2">üì•</span> Download
                                                            </a>
                                                        </div>`
                                                    }
                                                </div>
                                            ` : '<div class="pointer-events-none select-none">Drop a document to view (upload begins automatically)</div>'}
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <!-- Chat -->
                            <aside class="border-t lg:border-t-0 lg:border-l flex flex-col min-h-[320px] transition-colors ${isDark ? 'bg-neutral-900 border-white/10' : 'bg-white'}">
                                <div class="flex-1 overflow-auto p-4 space-y-4">
                                    ${messages.length === 0 ? `<div class="text-center ${isDark ? 'text-gray-400' : 'text-gray-500'}"><p>Start chatting with GPT-4o</p></div>` : messages.map(m => `
                                        <div class="max-w-[92%] ${m.role === 'assistant' ? '' : 'ml-auto'}">
                                            <div class="rounded-2xl px-4 py-2 text-sm border transition-colors ${m.role === 'assistant' ? (isDark ? 'bg-neutral-800 border-white/10' : 'bg-gray-50') : 'bg-emerald-600 text-white border-emerald-600'}">
                                                ${m.text || '<span class="opacity-60">‚Ä¶</span>'}
                                            </div>
                                            <div class="mt-1 flex items-center gap-3 text-[11px] ${isDark ? 'text-gray-400' : 'text-gray-500'}">
                                                <button onclick="navigator.clipboard?.writeText('${m.text}')" class="hover:underline">Copy</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>

                                <div class="border-t p-3 transition-colors ${isDark ? 'border-white/10' : ''}">
                                    <div class="flex flex-wrap gap-2">
                                        ${suggestions.map(s => `
                                            <button onclick="chat('${s}')" class="px-3 py-1.5 rounded-full border text-xs transition-colors ${isDark ? 'hover:bg-neutral-800 border-white/10' : 'hover:bg-gray-50'}">${s}</button>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="border-t p-3 transition-colors ${isDark ? 'border-white/10' : ''}">
                                    <div class="flex items-center gap-2">
                                        <label class="h-10 w-10 rounded-full border grid place-items-center cursor-pointer transition-colors ${isDark ? 'bg-neutral-900 border-white/10' : 'bg-white'}">üìé
                                            <input type="file" class="hidden" onchange="handleFileSelect(event)" />
                                        </label>
                                        <input id="chatInput" value="${draft}" oninput="updateDraft(event)" onkeydown="handleKeyDown(event)" placeholder="Ask anything‚Ä¶" class="flex-1 h-10 px-3 rounded-full border transition-colors ${isDark ? 'bg-neutral-900 border-white/10' : ''}" />
                                        <button onclick="handleSendMessage()" class="h-10 w-10 rounded-full bg-emerald-600 text-white">‚û§</button>
                                    </div>
                                    <div class="mt-2 text-[11px] ${isDark ? 'text-gray-400' : 'text-gray-500'}">Drop a file anywhere to upload ‚Ä¢ Status: <b>${status}</b>${docId ? ` ‚Ä¢ DocId: ${docId}` : ''}</div>
                                </div>
                            </aside>
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize
        updateTheme();
        render();

        // Watch system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            prefersDark = e.matches;
            if (theme === 'auto') {
                isDark = prefersDark;
                updateTheme();
                render();
            }
        });

        // Make functions global
        window.setTheme = setTheme;
        window.handleFileSelect = handleFileSelect;
        window.handleDrop = handleDrop;
        window.handleSendMessage = handleSendMessage;
        window.handleKeyDown = handleKeyDown;
        window.updateDraft = updateDraft;
        window.chat = chat;
    </script>
</body>
</html>