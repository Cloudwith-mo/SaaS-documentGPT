<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocumentGPT - Chat with Your Documents</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        neutral: {
                            800: '#262626',
                            900: '#171717',
                            950: '#0a0a0a'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-gray-50">
    <div id="app"></div>

    <script>
        // State
        let theme = localStorage.getItem('dgpt:theme') || 'auto';
        let prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let isDark = theme === 'dark' || (theme === 'auto' && prefersDark);
        let tab = 'upload';
        let fileName = '';
        let docId = null;
        let status = 'IDLE';
        let messages = [];
        let draft = '';

        // API Configuration - LIVE PRODUCTION API
        const API_BASE = 'https://9voqzgx3ch.execute-api.us-east-1.amazonaws.com/prod';
        const API_KEY = 'dk-test-key-123';

        // Apply theme
        function applyTheme() {
            document.documentElement.classList.toggle('dark', isDark);
        }
        applyTheme();

        // Toggle theme
        function toggleTheme() {
            isDark = !isDark;
            theme = isDark ? 'dark' : 'light';
            localStorage.setItem('dgpt:theme', theme);
            applyTheme();
            render();
        }

        // Upload function
        async function uploadDocument() {
            if (!fileName) {
                alert('Please enter a filename');
                return;
            }

            status = 'UPLOADING';
            render();

            try {
                const response = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': API_KEY,
                        'x-user-id': 'web-user-' + Date.now()
                    },
                    body: JSON.stringify({
                        filename: fileName,
                        contentType: 'text/plain'
                    })
                });

                const result = await response.json();
                
                if (result.docId) {
                    docId = result.docId;
                    status = 'READY';
                    tab = 'chat';
                    messages = [{
                        role: 'system',
                        content: `‚úÖ Document "${fileName}" uploaded successfully! Document ID: ${docId}`
                    }];
                } else {
                    status = 'ERROR';
                    console.error('Upload failed:', result);
                }
            } catch (error) {
                status = 'ERROR';
                console.error('Upload error:', error);
            }
            
            render();
        }

        // Chat function
        async function sendMessage() {
            if (!draft.trim()) return;
            
            if (!docId) {
                alert('Please upload a document first');
                return;
            }

            const userMessage = draft.trim();
            draft = '';
            messages.push({ role: 'user', content: userMessage });
            messages.push({ role: 'assistant', content: 'Thinking...' });
            render();

            try {
                const response = await fetch(`${API_BASE}/rag-chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: userMessage,
                        docId: docId
                    })
                });

                const result = await response.json();
                messages[messages.length - 1].content = result.answer || result.error || 'No response received';
                
                if (result.hasContext) {
                    messages[messages.length - 1].hasContext = true;
                }
            } catch (error) {
                messages[messages.length - 1].content = 'Error: ' + error.message;
            }
            
            render();
        }

        // Demo function
        async function tryDemo() {
            docId = 'doc_1758376193835_c767nofb67v';
            status = 'READY';
            tab = 'chat';
            fileName = 'Microsoft Demo Document';
            
            messages = [{
                role: 'system',
                content: 'üß™ Demo Mode: Using pre-loaded Microsoft document'
            }];
            
            render();
        }

        // Test API function
        async function testAPI() {
            status = 'TESTING';
            render();
            
            try {
                const response = await fetch(`${API_BASE}/rag-chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: 'What services does Microsoft offer?',
                        docId: 'doc_1758376193835_c767nofb67v'
                    })
                });

                const result = await response.json();
                
                if (result.answer) {
                    status = 'API_OK';
                    messages = [{
                        role: 'system',
                        content: '‚úÖ API Test Successful! The system is working.'
                    }, {
                        role: 'assistant',
                        content: result.answer
                    }];
                } else {
                    status = 'API_ERROR';
                }
            } catch (error) {
                status = 'API_ERROR';
                console.error('API test failed:', error);
            }
            
            render();
        }

        // Render function
        function render() {
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <div class="flex h-screen ${isDark ? 'dark' : ''}">
                    <!-- Sidebar -->
                    <div class="w-80 bg-white dark:bg-neutral-900 border-r border-gray-200 dark:border-neutral-700 flex flex-col">
                        <div class="p-6 border-b border-gray-200 dark:border-neutral-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h1 class="text-xl font-semibold text-gray-900 dark:text-white">DocumentGPT</h1>
                                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Chat with your documents</p>
                                </div>
                                <button onclick="toggleTheme()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-neutral-800">
                                    ${isDark ? '‚òÄÔ∏è' : 'üåô'}
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex-1 p-4">
                            <div class="space-y-2">
                                <button onclick="tab='upload'; render()" 
                                        class="w-full text-left px-3 py-2 rounded-lg text-sm ${tab === 'upload' ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-neutral-800'}">
                                    üì§ Upload Document
                                </button>
                                <button onclick="tab='chat'; render()" 
                                        class="w-full text-left px-3 py-2 rounded-lg text-sm ${tab === 'chat' ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-neutral-800'}">
                                    üí¨ Chat
                                </button>
                            </div>
                            
                            <div class="mt-6 space-y-2">
                                <button onclick="tryDemo()" 
                                        class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium">
                                    üß™ Try Demo
                                </button>
                                <button onclick="testAPI()" 
                                        class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium">
                                    üîß Test API
                                </button>
                            </div>
                            
                            <div class="mt-6 p-3 bg-gray-50 dark:bg-neutral-800 rounded-lg">
                                <div class="text-xs text-gray-500 dark:text-gray-400">
                                    <div>Status: <span class="font-mono ${getStatusColor()}">${status}</span></div>
                                    <div>API: Live Production</div>
                                    ${docId ? `<div>Doc: ${docId.substring(0, 20)}...</div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="flex-1 flex flex-col bg-gray-50 dark:bg-neutral-950">
                        ${tab === 'upload' ? renderUpload() : renderChat()}
                    </div>
                </div>
            `;
        }

        function getStatusColor() {
            switch(status) {
                case 'READY': case 'API_OK': return 'text-green-600';
                case 'ERROR': case 'API_ERROR': return 'text-red-600';
                case 'UPLOADING': case 'TESTING': return 'text-yellow-600';
                default: return 'text-gray-600';
            }
        }

        function renderUpload() {
            return `
                <div class="flex-1 flex items-center justify-center p-8">
                    <div class="max-w-md w-full">
                        <div class="bg-white dark:bg-neutral-900 rounded-xl shadow-sm border border-gray-200 dark:border-neutral-700 p-8">
                            <div class="text-center mb-6">
                                <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <span class="text-2xl">üìÑ</span>
                                </div>
                                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">Upload Document</h2>
                                <p class="text-gray-500 dark:text-gray-400 text-sm">Enter a filename to get started</p>
                            </div>
                            
                            <div class="space-y-4">
                                <input type="text" 
                                       placeholder="Enter filename (e.g., document.txt)"
                                       value="${fileName}"
                                       oninput="fileName = this.value"
                                       class="w-full px-4 py-3 border border-gray-200 dark:border-neutral-600 rounded-lg bg-white dark:bg-neutral-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                
                                <button onclick="uploadDocument()" 
                                        ${status === 'UPLOADING' ? 'disabled' : ''}
                                        class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg font-medium">
                                    ${status === 'UPLOADING' ? 'Uploading...' : 'Upload Document'}
                                </button>
                                
                                ${status === 'ERROR' ? '<p class="text-red-500 text-sm text-center">Upload failed. Please try again.</p>' : ''}
                                ${status === 'READY' ? '<p class="text-green-500 text-sm text-center">‚úÖ Document ready for chat!</p>' : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderChat() {
            return `
                <div class="flex-1 flex flex-col">
                    <!-- Chat Header -->
                    <div class="bg-white dark:bg-neutral-900 border-b border-gray-200 dark:border-neutral-700 p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="font-semibold text-gray-900 dark:text-white">
                                    ${fileName || 'No document selected'}
                                </h2>
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    ${docId ? `Document ID: ${docId}` : 'Upload a document to start chatting'}
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Messages -->
                    <div class="flex-1 overflow-y-auto p-4 space-y-4">
                        ${messages.length === 0 ? `
                            <div class="text-center text-gray-500 dark:text-gray-400 mt-8">
                                <div class="text-4xl mb-4">üí¨</div>
                                <p>Start a conversation about your document</p>
                                <p class="text-sm mt-2">Try the demo or upload your own document</p>
                            </div>
                        ` : messages.map(msg => `
                            <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                                <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                                    msg.role === 'user' 
                                        ? 'bg-blue-600 text-white' 
                                        : msg.role === 'system'
                                        ? 'bg-gray-100 dark:bg-neutral-800 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-neutral-700'
                                        : 'bg-white dark:bg-neutral-800 text-gray-900 dark:text-white border border-gray-200 dark:border-neutral-700'
                                }">
                                    ${msg.content}
                                    ${msg.hasContext ? '<div class="text-xs mt-1 opacity-75">‚úÖ With context</div>' : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Input -->
                    <div class="bg-white dark:bg-neutral-900 border-t border-gray-200 dark:border-neutral-700 p-4">
                        <div class="flex space-x-2">
                            <input type="text" 
                                   placeholder="${docId ? 'Ask a question about your document...' : 'Upload a document first'}"
                                   value="${draft}"
                                   ${!docId ? 'disabled' : ''}
                                   oninput="draft = this.value"
                                   onkeypress="if(event.key==='Enter') sendMessage()"
                                   class="flex-1 px-4 py-2 border border-gray-200 dark:border-neutral-600 rounded-lg bg-white dark:bg-neutral-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 dark:disabled:bg-neutral-700">
                            <button onclick="sendMessage()" 
                                    ${!docId || !draft.trim() ? 'disabled' : ''}
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg font-medium">
                                Send
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Initial render
        render();
    </script>
</body>
</html>