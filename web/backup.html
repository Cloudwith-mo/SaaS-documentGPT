<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocumentGPT - Advanced UI</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script src="https://unpkg.com/marked@9.1.6/marked.min.js"></script>
    <script src="https://unpkg.com/dompurify@3.0.5/dist/purify.min.js"></script>
    <style>
        .markdown-body { line-height: 1.6; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { margin: .75rem 0 .4rem; font-weight: 600; }
        .markdown-body p { margin: .5rem 0; }
        .markdown-body ul, .markdown-body ol { margin: .5rem 0 .5rem 1.25rem; }
        .markdown-body code { background: rgba(125,125,125,.15); padding: 2px 4px; border-radius: 4px; font-family: monospace; }
        .markdown-body pre { background: #0f172a; color: #e5e7eb; padding: 10px 12px; border-radius: 8px; overflow: auto; margin: .5rem 0; }
        .markdown-body pre code { background: transparent; }
        .markdown-body table { border-collapse: collapse; margin: .5rem 0; }
        .markdown-body th, .markdown-body td { border: 1px solid rgba(120,120,120,.2); padding: 6px 8px; }
        .markdown-body blockquote { border-left: 4px solid #e5e7eb; padding-left: 1rem; margin: .5rem 0; color: #6b7280; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const API_BASE = 'https://i1dy8i3692.execute-api.us-east-1.amazonaws.com/prod';

        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

        // API functions with streaming and meta support
        async function uploadFile(file) {
            const fd = new FormData();
            fd.append('file', file);
            const res = await fetch(`${API_BASE}/upload`, {
                method: 'POST',
                body: fd
            });
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            return {
                docId: data.vector_store_id || data.docId,
                fileUrl: data.fileUrl || '#',
                fileName: data.fileName || file.name,
                pageCount: data.pageCount
            };
        }

        async function chatWithDoc({ docId, message, meta, onToken, onDone, signal }) {
            const res = await fetch(`${API_BASE}/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'text/event-stream' },
                body: JSON.stringify({
                    messages: [{ role: 'user', content: message }],
                    vector_store_id: docId,
                    meta,
                    stream: true
                }),
                signal
            });

            const ct = res.headers.get('content-type') || '';
            if (!ct.includes('text/event-stream')) {
                if (!res.ok) throw new Error(await res.text());
                const json = await res.json();
                const answer = json.response || json.answer || '';
                onToken?.(answer);
                onDone?.();
                return { mode: 'json', answer };
            }

            // Streaming fallback - simulate for now
            const json = await res.json();
            const answer = json.response || json.answer || '';
            
            // Simulate streaming by chunking the response
            const words = answer.split(' ');
            let current = '';
            for (let i = 0; i < words.length; i++) {
                current += (i > 0 ? ' ' : '') + words[i];
                onToken?.(current);
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            onDone?.();
            
            return { mode: 'stream', abort: () => {} };
        }

        // Streaming accumulator
        function makeAccumulator(onUpdate) {
            let text = '';
            return {
                push: (chunk) => {
                    text = chunk; // For our simple implementation, just replace
                    onUpdate(text);
                },
                value: () => text
            };
        }

        // Markdown component
        function Markdown({ text }) {
            const html = useMemo(() => {
                if (!text) return '';
                const raw = marked.parse(text);
                return DOMPurify.sanitize(raw);
            }, [text]);

            return <div className="markdown-body" dangerouslySetInnerHTML={{ __html: html }} />;
        }

        // Action definitions
        const ACTIONS = [
            {
                id: 'email_summary_gmail',
                label: 'Email summary (Gmail)',
                prompt: 'Summarize the document in ~120 words and draft a Gmail email with a clear subject and bullet points.',
                meta: { flowId: 'doc_summary_outbound', action: 'email_summary', provider: 'gmail' }
            },
            {
                id: 'email_summary_outlook',
                label: 'Email summary (Outlook)',
                prompt: 'Summarize the document in ~120 words and draft an Outlook email with a clear subject and bullet points.',
                meta: { flowId: 'doc_summary_outbound', action: 'email_summary', provider: 'outlook' }
            },
            {
                id: 'post_slack',
                label: 'Post to Slack',
                prompt: 'Summarize the document into 5â€“8 bullet points suitable for Slack, include key dates/numbers.',
                meta: { flowId: 'doc_summary_outbound', action: 'slack_post' }
            },
            {
                id: 'post_teams',
                label: 'Post to Teams',
                prompt: 'Summarize the document into 5â€“8 bullet points suitable for Microsoft Teams.',
                meta: { flowId: 'doc_summary_outbound', action: 'teams_post' }
            },
            {
                id: 'export_gdoc',
                label: 'Export Google Doc',
                prompt: 'Create a clean Google Doc containing a well-structured summary with headings and a key-points list.',
                meta: { flowId: 'doc_summary_outbound', action: 'docs_export', provider: 'google' }
            },
            {
                id: 'export_word',
                label: 'Export Word (.docx)',
                prompt: 'Export a .docx with a well-structured summary and key sections preserved.',
                meta: { flowId: 'doc_summary_outbound', action: 'docs_export', provider: 'word' }
            },
            {
                id: 'translate_gmail',
                label: 'Translate + email (Gmail)',
                prompt: 'Translate the document to Spanish and draft a Gmail email with the translation.',
                meta: { flowId: 'doc_translate_outbound', action: 'email_translation', provider: 'gmail' }
            },
            {
                id: 'linkedin_draft',
                label: 'LinkedIn post draft',
                prompt: 'Write a LinkedIn-ready post (max 1300 chars) summarizing the document insights with a strong hook.',
                meta: { flowId: 'doc_summary_outbound', action: 'linkedin_draft' }
            }
        ];

        // Action Drawer Component
        function ActionDrawer({ open, onClose, onRun, disabled }) {
            return (
                <div
                    className={`fixed left-0 right-0 bottom-0 transition-transform duration-200 ${
                        open ? 'translate-y-0' : 'translate-y-full'
                    }`}
                    style={{ zIndex: 60 }}
                >
                    <div className="mx-auto max-w-[1000px] rounded-t-lg border border-gray-200 bg-white p-4 shadow-xl">
                        <div className="flex items-center justify-between mb-3">
                            <div className="text-sm font-semibold">ðŸš€ Smart Actions</div>
                            <button className="text-sm opacity-70 hover:opacity-100" onClick={onClose}>
                                Close
                            </button>
                        </div>
                        <div className="grid gap-2" style={{ gridTemplateColumns: 'repeat(auto-fill,minmax(220px,1fr))' }}>
                            {ACTIONS.map(a => (
                                <button
                                    key={a.id}
                                    disabled={disabled}
                                    onClick={() => onRun(a)}
                                    className="text-left rounded border px-3 py-2 text-sm hover:bg-gray-50 disabled:opacity-50"
                                    title={a.prompt}
                                >
                                    <div className="font-medium">{a.label}</div>
                                    <div className="text-xs text-gray-500 mt-1 line-clamp-2">{a.prompt}</div>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // PDF Viewer Component
        function PDFViewer({ doc, onFind }) {
            const canvasRef = useRef();
            const [pdf, setPdf] = useState(null);
            const [page, setPage] = useState(1);
            const [scale, setScale] = useState(1.1);
            const [findQuery, setFindQuery] = useState('');

            // Load PDF when URL changes
            useEffect(() => {
                if (!doc?.fileUrl || doc.fileUrl === '#') {
                    setPdf(null);
                    return;
                }
                
                // For demo, we'll show a placeholder since we don't have real PDF URLs
                setPdf({ numPages: 5 }); // Mock PDF object
            }, [doc?.fileUrl]);

            // Render current page (simplified for demo)
            useEffect(() => {
                if (!pdf || !canvasRef.current) return;
                
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                canvas.width = 600;
                canvas.height = 800;
                
                // Draw a simple placeholder
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#000000';
                ctx.font = '16px Arial';
                ctx.fillText(`Page ${page} of ${pdf.numPages}`, 50, 50);
                ctx.fillText(doc?.fileName || 'Document', 50, 80);
                ctx.fillText('PDF content would render here', 50, 120);
            }, [pdf, page, scale, doc?.fileName]);

            const maxPages = pdf?.numPages || 1;

            return (
                <section className="flex grow flex-col">
                    <div className="h-[48px] border-b border-gray-200 flex items-center gap-2 px-3">
                        <div className="text-sm font-medium truncate">{doc?.fileName || 'Document'}</div>
                        <div className="ml-auto flex items-center gap-2">
                            <button 
                                className="rounded border px-2 py-1 text-sm hover:bg-gray-50"
                                onClick={() => setScale(z => Math.max(0.5, +(z - 0.1).toFixed(2)))}
                            >
                                â€“
                            </button>
                            <div className="min-w-[48px] text-center text-sm">{Math.round(scale * 100)}%</div>
                            <button 
                                className="rounded border px-2 py-1 text-sm hover:bg-gray-50"
                                onClick={() => setScale(z => Math.min(2, +(z + 0.1).toFixed(2)))}
                            >
                                +
                            </button>

                            <div className="mx-2 text-sm">Page</div>
                            <input
                                value={page}
                                onChange={(e) => setPage(Math.max(1, Math.min(maxPages, parseInt(e.target.value || '1', 10))))}
                                className="w-14 rounded border px-2 py-1 text-sm"
                                type="number"
                                min={1} 
                                max={maxPages}
                            />
                            <div className="text-xs text-gray-500">/ {maxPages}</div>

                            <input
                                placeholder="Find text in document"
                                className="ml-3 w-[240px] rounded border px-2 py-1 text-sm"
                                value={findQuery}
                                onChange={(e) => setFindQuery(e.target.value)}
                                onKeyDown={(e) => {
                                    if (e.key === 'Enter' && findQuery.trim()) {
                                        onFind(findQuery.trim());
                                    }
                                }}
                            />
                        </div>
                    </div>

                    <div className="relative grow bg-gray-100 overflow-auto">
                        {doc && pdf ? (
                            <div className="w-full h-full flex items-start justify-center py-6">
                                <canvas 
                                    ref={canvasRef} 
                                    className="bg-white shadow-sm rounded border"
                                    style={{ transform: `scale(${scale})`, transformOrigin: 'top center' }}
                                />
                            </div>
                        ) : (
                            <div className="absolute inset-0 grid place-items-center text-gray-500 text-sm">
                                Drop a document to view (upload begins automatically)
                            </div>
                        )}
                    </div>
                </section>
            );
        }

        // Enhanced Chat Panel with Actions and Markdown
        function ChatPanel({ docId }) {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [status, setStatus] = useState('IDLE');
            const [drawer, setDrawer] = useState(false);
            const abortRef = useRef();

            const suggestions = [
                'Summarize the document',
                'What are the key points?',
                'Any important dates or numbers?',
                'List all totals with currency'
            ];

            const canSend = useMemo(() => docId && input.trim().length > 0 && status !== 'SENDING', [docId, input, status]);

            async function send(text, meta) {
                if (!docId) return;
                
                const id = crypto.randomUUID();
                const user = { id, role: 'user', content: text };
                setMessages(m => [...m, user]);
                setMessages(m => [...m, { id: id + ':ai', role: 'assistant', content: '' }]);
                setStatus('SENDING');

                const acc = makeAccumulator((full) => {
                    setMessages(m => m.map(msg => 
                        msg.id === id + ':ai' ? { ...msg, content: full } : msg
                    ));
                });

                try {
                    const resp = await chatWithDoc({
                        docId,
                        message: text,
                        meta,
                        onToken: (t) => acc.push(t),
                        onDone: () => setStatus('IDLE')
                    });
                    abortRef.current = resp.mode === 'stream' ? resp.abort : undefined;
                } catch (error) {
                    setMessages(m => m.map(msg => 
                        msg.id === id + ':ai' ? { ...msg, content: `Error: ${error}` } : msg
                    ));
                    setStatus('IDLE');
                }
                
                setInput('');
            }

            function runAction(action) {
                setDrawer(false);
                const instruction = `[ACTION] ${action.label}\n\n${action.prompt}\n\nIf tools are available, execute the action using provided metadata.`;
                send(instruction, action.meta);
            }

            return (
                <aside className="w-[360px] shrink-0 border-l border-gray-200 flex flex-col">
                    <div className="h-[48px] px-3 flex items-center justify-between border-b border-gray-200">
                        <div className="text-sm text-gray-600">
                            {messages.length === 0 ? 'Start chatting with GPT-4o' : 'Conversation'}
                        </div>
                        <div className="flex items-center gap-2">
                            <button 
                                className="text-xs rounded border px-2 py-1 hover:bg-gray-50"
                                onClick={() => setDrawer(v => !v)} 
                                disabled={!docId}
                            >
                                Actions
                            </button>
                            {status === 'SENDING' && (
                                <button className="text-xs underline" onClick={() => abortRef.current?.()}>
                                    Stop
                                </button>
                            )}
                        </div>
                    </div>

                    <div className="grow overflow-auto p-3 space-y-3">
                        {messages.map((m) => (
                            <div key={m.id} className="text-sm leading-6">
                                <div className="font-medium mb-1">
                                    {m.role === 'user' ? 'You' : 'Assistant'}
                                </div>
                                {m.role === 'assistant' ? (
                                    <Markdown text={m.content} />
                                ) : (
                                    <div className="whitespace-pre-wrap">{m.content}</div>
                                )}
                            </div>
                        ))}
                        {messages.length === 0 && (
                            <div className="text-sm text-gray-500 p-3">
                                Drop a file anywhere to upload â€¢ Status: <span className="font-mono">READY</span>
                            </div>
                        )}
                    </div>

                    <div className="border-t border-gray-200 p-2 flex flex-wrap gap-2">
                        {suggestions.map((s) => (
                            <button
                                key={s}
                                className="rounded-full border px-3 py-1 text-xs bg-white hover:bg-gray-50 disabled:opacity-50"
                                onClick={() => send(s)}
                                disabled={!docId}
                            >
                                {s}
                            </button>
                        ))}
                    </div>

                    <div className="p-3 flex items-center gap-2">
                        <button className="rounded-full border w-9 h-9 grid place-items-center bg-white" disabled>
                            ðŸ“Ž
                        </button>
                        <input
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            onKeyDown={(e) => {
                                if (e.key === 'Enter' && !e.shiftKey && canSend) {
                                    e.preventDefault();
                                    send(input.trim());
                                }
                            }}
                            placeholder="Ask anythingâ€¦"
                            className="grow rounded border px-3 py-2 text-sm"
                            disabled={!docId}
                        />
                        <button
                            className="rounded-full w-9 h-9 grid place-items-center bg-emerald-500 text-white disabled:opacity-40"
                            disabled={!canSend}
                            onClick={() => send(input.trim())}
                        >
                            âž¤
                        </button>
                    </div>

                    <ActionDrawer 
                        open={drawer} 
                        onClose={() => setDrawer(false)} 
                        onRun={runAction} 
                        disabled={!docId} 
                    />
                </aside>
            );
        }

        // Sidebar Component
        function Sidebar({ recents, onPick, onUpload }) {
            const fileRef = useRef();
            
            return (
                <aside className="w-[220px] shrink-0 border-r border-gray-200 p-3 bg-gray-50">
                    <div className="flex gap-2">
                        <button
                            className="rounded border px-3 py-1 text-sm bg-white hover:bg-gray-50"
                            onClick={() => fileRef.current?.click()}
                        >
                            Upload
                        </button>
                        <input
                            ref={fileRef}
                            type="file"
                            accept="application/pdf,.doc,.docx,.txt,.md,image/*"
                            className="hidden"
                            onChange={(e) => {
                                const f = e.target.files?.[0];
                                if (f) onUpload(f);
                            }}
                        />
                    </div>

                    <div className="mt-4 text-xs text-gray-500">RECENT</div>
                    <ul className="mt-2 space-y-2">
                        {recents.map((d) => (
                            <li key={d.docId}>
                                <button
                                    className="w-full text-left rounded px-2 py-1 hover:bg-gray-100 text-sm truncate"
                                    onClick={() => onPick(d)}
                                >
                                    {d.fileName}
                                </button>
                            </li>
                        ))}
                    </ul>
                </aside>
            );
        }

        // Drop Overlay Component
        function DropOverlay({ active, onDropFiles }) {
            return (
                <div
                    onDragOver={(e) => e.preventDefault()}
                    onDrop={(e) => {
                        e.preventDefault();
                        if (e.dataTransfer?.files?.length) onDropFiles(e.dataTransfer.files);
                    }}
                    className={`fixed inset-0 pointer-events-none transition ${
                        active ? 'bg-black/30' : 'bg-transparent'
                    }`}
                    style={{ zIndex: 50 }}
                >
                    {active && (
                        <div className="absolute inset-0 flex items-center justify-center">
                            <div className="pointer-events-none rounded-lg border-2 border-dashed border-white/80 bg-white/10 px-8 py-6 text-white text-lg backdrop-blur">
                                Drop files to upload
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Main App
        function App() {
            const [recents, setRecents] = useState(() => {
                try { return JSON.parse(localStorage.getItem('recents') || '[]'); } catch { return []; }
            });
            const [dragActive, setDragActive] = useState(false);
            const [doc, setDoc] = useState();
            const [status, setStatus] = useState('IDLE');

            useEffect(() => {
                localStorage.setItem('recents', JSON.stringify(recents.slice(0, 20)));
            }, [recents]);

            async function onFind(query) {
                if (!doc?.docId) return;
                // This would normally trigger a search and jump to page
                console.log('Finding:', query);
            }

            useEffect(() => {
                const onDragEnter = (e) => { e.preventDefault(); setDragActive(true); };
                const onDragLeave = (e) => { e.preventDefault(); setDragActive(false); };
                const onDrop = (e) => { e.preventDefault(); setDragActive(false); };
                window.addEventListener('dragenter', onDragEnter);
                window.addEventListener('dragleave', onDragLeave);
                window.addEventListener('drop', onDrop);
                return () => {
                    window.removeEventListener('dragenter', onDragEnter);
                    window.removeEventListener('dragleave', onDragLeave);
                    window.removeEventListener('drop', onDrop);
                };
            }, []);

            async function handleUpload(file) {
                setStatus('UPLOADING');
                try {
                    const res = await uploadFile(file);
                    const next = { docId: res.docId, fileUrl: res.fileUrl, fileName: res.fileName, pageCount: res.pageCount };
                    setDoc(next);
                    setRecents(xs => [next, ...xs.filter(x => x.docId !== next.docId)]);
                } catch (e) {
                    alert('Upload failed: ' + e.message);
                } finally {
                    setStatus('IDLE');
                }
            }

            return (
                <div className="h-screen w-screen overflow-hidden bg-white text-gray-900">
                    <div className="h-[44px] border-b border-gray-200 px-3 flex items-center justify-between">
                        <div className="font-semibold">
                            DocumentGPT <span className="text-xs font-normal text-gray-500">Advanced UI</span>
                        </div>
                        <div className="text-xs text-gray-500">
                            {status === 'UPLOADING' ? 'Uploadingâ€¦' : 'PDF.js â€¢ Streaming â€¢ Smart Actions â€¢ GPT-4o'}
                        </div>
                    </div>

                    <div className="flex h-[calc(100vh-44px)]">
                        <Sidebar
                            recents={recents}
                            onPick={setDoc}
                            onUpload={handleUpload}
                        />
                        <PDFViewer doc={doc} onFind={onFind} />
                        <ChatPanel docId={doc?.docId} />
                    </div>

                    <DropOverlay
                        active={dragActive}
                        onDropFiles={(files) => { if (files[0]) handleUpload(files[0]); }}
                    />
                </div>
            );
        }

        // Render
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>