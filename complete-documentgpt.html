<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocumentsGPT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        neutral: {
                            800: '#262626',
                            900: '#171717',
                            950: '#0a0a0a'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-gray-50">
    <div id="app"></div>

    <script>
        // Enhanced State with Persistence
        let theme = localStorage.getItem('dgpt:theme') || 'auto';
        let prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let isDark = theme === 'dark' || (theme === 'auto' && prefersDark);
        let tab = localStorage.getItem('dgpt:tab') || 'upload';
        let fileName = localStorage.getItem('dgpt:fileName') || '';
        let docId = localStorage.getItem('dgpt:docId') || null;
        let status = 'IDLE';
        let pages = parseInt(localStorage.getItem('dgpt:pages')) || 0;
        let page = parseInt(localStorage.getItem('dgpt:page')) || 1;
        let zoom = parseInt(localStorage.getItem('dgpt:zoom')) || 110;
        let findTerm = '';
        let findNote = '';
        let messages = JSON.parse(localStorage.getItem('dgpt:messages') || '[]');
        let draft = '';
        let sessionId = localStorage.getItem('dgpt:sessionId') || 'session_' + Date.now();
        let recentChats = JSON.parse(localStorage.getItem('dgpt:recentChats') || '[]');

        // Save session ID
        localStorage.setItem('dgpt:sessionId', sessionId);

        let documentContent = '';
        let documentUrl = '';

        // API Configuration - Upgraded to GPT-4o
        const API_BASE = 'https://9voqzgx3ch.execute-api.us-east-1.amazonaws.com/prod';
        const API_KEY = 'dk-test-key-123';

        // Suggested questions
        const suggestions = [
            'Summarize the document',
            'What are the key points?',
            'Any important dates or numbers?',
            'List all totals with currency',
            'Extract contact information',
            'Find action items',
            'What are the main conclusions?',
            'Identify risks or concerns'
        ];

        // Persistence functions
        function saveState() {
            localStorage.setItem('dgpt:tab', tab);
            localStorage.setItem('dgpt:fileName', fileName);
            localStorage.setItem('dgpt:docId', docId);
            localStorage.setItem('dgpt:pages', pages);
            localStorage.setItem('dgpt:page', page);
            localStorage.setItem('dgpt:zoom', zoom);
            localStorage.setItem('dgpt:messages', JSON.stringify(messages));
            
            // Save current chat to recent chats
            if (messages.length > 0) {
                const chatTitle = messages.find(m => m.role === 'user')?.text?.substring(0, 30) + '...' || 'New Chat';
                const existingIndex = recentChats.findIndex(c => c.sessionId === sessionId);
                const chatData = {
                    id: sessionId,
                    sessionId,
                    title: chatTitle,
                    when: new Date().toLocaleString(),
                    messages: messages.length,
                    docId,
                    fileName,
                    messagesData: messages
                };
                
                if (existingIndex >= 0) {
                    recentChats[existingIndex] = chatData;
                } else {
                    recentChats.unshift(chatData);
                }
                
                // Keep only last 10 chats
                recentChats = recentChats.slice(0, 10);
                localStorage.setItem('dgpt:recentChats', JSON.stringify(recentChats));
            }
        }

        function getRecentChats() {
            return recentChats;
        }

        function loadChat(chatId) {
            const chat = recentChats.find(c => c.id === chatId);
            if (chat && chat.messagesData) {
                // Don't clear current chat, just load the selected one
                sessionId = chat.sessionId;
                docId = chat.docId;
                fileName = chat.fileName || '';
                messages = chat.messagesData || [];
                localStorage.setItem('dgpt:sessionId', sessionId);
                localStorage.setItem('dgpt:docId', docId);
                localStorage.setItem('dgpt:fileName', fileName);
                localStorage.setItem('dgpt:messages', JSON.stringify(messages));
                tab = 'chat';
                render();
            }
        }

        function newChat() {
            // Archive current chat first
            saveState();
            
            // Start new session
            sessionId = 'session_' + Date.now();
            docId = null;
            fileName = '';
            messages = [];
            draft = '';
            status = 'IDLE';
            
            localStorage.setItem('dgpt:sessionId', sessionId);
            localStorage.removeItem('dgpt:docId');
            localStorage.removeItem('dgpt:fileName');
            localStorage.removeItem('dgpt:messages');
            
            tab = 'upload';
            render();
        }

        // Theme management
        function updateTheme() {
            document.documentElement.classList.toggle('dark', isDark);
            document.documentElement.style.colorScheme = isDark ? 'dark' : 'light';
            localStorage.setItem('dgpt:theme', theme);
        }

        function setTheme(newTheme) {
            theme = newTheme;
            isDark = theme === 'dark' || (theme === 'auto' && prefersDark);
            updateTheme();
            render();
        }

        // Enhanced file upload with processing activation
        async function uploadFile(file) {
            fileName = file.name;
            status = 'PROCESSING';
            render();

            try {
                // Step 1: Get upload URL
                const uploadResponse = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-api-key': API_KEY,
                        'x-user-id': sessionId
                    },
                    body: JSON.stringify({ 
                        filename: file.name, 
                        contentType: file.type || 'application/octet-stream' 
                    })
                });
                
                const uploadData = await uploadResponse.json();
                docId = uploadData.docId;
                documentUrl = uploadData.downloadUrl;
                
                // Step 2: Upload file to S3
                const s3Response = await fetch(uploadData.uploadUrl, {
                    method: 'PUT',
                    headers: { 'Content-Type': file.type || 'application/octet-stream' },
                    body: file
                });
                
                if (!s3Response.ok) throw new Error('Upload failed');
                
                // Step 3: Read file content for display
                const reader = new FileReader();
                reader.onload = async (e) => {
                    documentContent = e.target.result;
                    pages = 1; // For images, set to 1 page
                    addMessage('system', `Document "${file.name}" uploaded successfully. Content displayed in center panel.`);
                    status = 'READY';
                    tab = 'chat';
                    saveState();
                    render();
                };
                
                if (file.type.startsWith('image/')) {
                    reader.readAsDataURL(file);
                } else {
                    reader.readAsText(file);
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                status = 'ERROR';
                addMessage('system', `Upload failed: ${error.message}`);
                render();
            }
        }

        // Enhanced chat with fallback to regular GPT
        function addMessage(role, text) {
            const id = Math.random().toString(36).slice(2);
            messages.push({ id, role, text, timestamp: new Date().toISOString() });
            saveState();
        }

        async function chat(question) {
            addMessage('user', question);
            addMessage('assistant', '');
            render();

            try {
                const response = await fetch(`${API_BASE}/rag-chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        question, 
                        docId: docId || null, 
                        sessionId 
                    })
                });
                
                const data = await response.json();
                const answer = data.answer || 'Sorry, I could not complete that.';
                const contextNote = data.hasContext ? ' (using document context)' : ' (general AI response)';
                messages[messages.length - 1].text = answer + contextNote;
                saveState();
                render();
            } catch (error) {
                console.error('Chat error:', error);
                messages[messages.length - 1].text = 'Sorry, I could not complete that.';
                saveState();
                render();
            }
        }

        // Event handlers
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) uploadFile(file);
        }

        function handleDrop(event) {
            event.preventDefault();
            const file = event.dataTransfer.files[0];
            if (file) uploadFile(file);
        }

        function handleSendMessage() {
            if (draft.trim()) {
                chat(draft.trim());
                draft = '';
                render();
            }
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                draft = event.target.value;
                handleSendMessage();
            }
        }
        
        function updateDraft(event) {
            draft = event.target.value;
        }

        function searchInDocument() {
            if (!findTerm || !documentContent) {
                findNote = 'No search term or document';
                render();
                return;
            }
            
            const matches = (documentContent.match(new RegExp(findTerm, 'gi')) || []).length;
            findNote = matches > 0 ? `Found ${matches} matches for "${findTerm}"` : `No matches for "${findTerm}"`;
            render();
        }

        // Render function with enhanced UI
        function render() {
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <div class="${isDark ? 'dark' : ''}">
                    <div class="h-screen w-full transition-colors ${isDark ? 'bg-neutral-900 text-neutral-100 dark:bg-neutral-900 dark:text-neutral-100' : 'bg-gray-50 text-gray-900 dark:bg-neutral-900 dark:text-neutral-100'}" 
                         ondragover="event.preventDefault()" ondrop="handleDrop(event)">
                        
                        <!-- Top bar -->
                        <div class="sticky top-0 z-50 h-14 backdrop-blur flex items-center px-4 gap-3 border-b transition-colors ${isDark ? 'bg-neutral-900/80 border-white/10' : 'bg-white/80 border-gray-200'}">
                            <div class="flex items-center gap-2 font-semibold ${isDark ? 'text-emerald-400' : 'text-emerald-600'}">
                                <span class="inline-flex h-6 w-6 items-center justify-center rounded-md ${isDark ? 'bg-emerald-900/40 text-emerald-300' : 'bg-emerald-100 text-emerald-700'}">🗎</span>
                                <span>DocumentsGPT</span>
                                <span class="text-xs font-medium rounded px-1.5 py-0.5 border ${isDark ? 'text-gray-400 border-white/10' : 'text-gray-500 border-gray-200'}">GPT-4o</span>
                            </div>
                            <div class="ml-auto flex items-center gap-2 text-xs">
                                <span class="px-2 py-1 rounded-full border transition-colors ${isDark ? 'bg-neutral-800 border-white/10' : 'bg-white'}">High quality</span>
                                <span class="px-2 py-1 rounded-full border transition-colors ${isDark ? 'bg-neutral-800 border-white/10' : 'bg-white'}">Model: GPT-4o</span>
                                <button onclick="newChat()" class="px-2 py-1 rounded-full border transition-colors ${isDark ? 'bg-neutral-800 border-white/10 hover:bg-neutral-700' : 'bg-white hover:bg-gray-50'}">New Chat</button>
                                <div class="ml-1 inline-flex rounded-full overflow-hidden border ${isDark ? 'border-white/10' : 'border-gray-200'}">
                                    <button onclick="setTheme('light')" class="px-2 py-1 text-sm transition-colors ${theme==='light' && !isDark ? 'bg-gray-900 text-white' : (isDark ? 'bg-neutral-800' : 'bg-white')}">☀️</button>
                                    <button onclick="setTheme('auto')" class="px-2 py-1 text-sm transition-colors ${theme==='auto' ? 'bg-gray-900 text-white' : (isDark ? 'bg-neutral-800' : 'bg-white')}">🌓</button>
                                    <button onclick="setTheme('dark')" class="px-2 py-1 text-sm transition-colors ${theme==='dark' && isDark ? 'bg-gray-900 text-white' : (isDark ? 'bg-neutral-800' : 'bg-white')}">🌙</button>
                                </div>
                            </div>
                        </div>

                        <!-- Main grid -->
                        <div class="h-[calc(100vh-56px)] grid grid-cols-1 lg:grid-cols-[280px_1fr_420px]">
                            
                            <!-- Sidebar -->
                            <aside class="hidden lg:block p-3 overflow-y-auto border-r transition-colors ${isDark ? 'bg-neutral-900 border-white/10' : 'bg-white border-gray-200'}">
                                <div class="inline-flex rounded-lg p-1 text-sm border transition-colors ${isDark ? 'bg-neutral-800 border-white/10' : 'bg-gray-50'}">
                                    <button onclick="tab='upload'; saveState(); render()" class="px-3 py-1.5 rounded-md ${tab==='upload' ? (isDark ? 'bg-neutral-900 shadow-sm' : 'bg-white shadow-sm') : (isDark ? 'text-gray-300' : 'text-gray-600')}">Upload</button>
                                    <button onclick="tab='chat'; saveState(); render()" class="px-3 py-1.5 rounded-md ${tab==='chat' ? (isDark ? 'bg-neutral-900 shadow-sm' : 'bg-white shadow-sm') : (isDark ? 'text-gray-300' : 'text-gray-600')}">Chat</button>
                                </div>

                                ${tab === 'upload' ? `
                                    <div class="mt-3">
                                        <label class="block text-xs font-medium mb-1 ${isDark ? 'text-gray-400' : 'text-gray-500'}">Upload a document (drag & drop anywhere)</label>
                                        <input type="file" onchange="handleFileSelect(event)" class="block w-full text-sm" />
                                    </div>
                                ` : ''}



                                <div class="mt-6">
                                    <div class="text-xs font-semibold mb-2 ${isDark ? 'text-gray-400' : 'text-gray-500'}">RECENT CHATS</div>
                                    <div class="space-y-2 max-h-40 overflow-y-auto">
                                        ${getRecentChats().map(chat => `
                                            <div onclick="loadChat('${chat.id}')" class="flex items-center justify-between px-3 py-2 rounded-md cursor-pointer transition-colors ${isDark ? 'hover:bg-neutral-800' : 'hover:bg-gray-50'}">
                                                <div class="flex items-center gap-2">
                                                    <span class="inline-flex h-6 w-6 items-center justify-center rounded-full ${isDark ? 'bg-neutral-800' : 'bg-gray-100'}">💬</span>
                                                    <div>
                                                        <div class="text-sm font-medium truncate max-w-[120px]">${chat.title}</div>
                                                        <div class="text-xs ${isDark ? 'text-gray-400' : 'text-gray-500'}">${chat.when}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                        ${getRecentChats().length === 0 ? `<div class="text-xs ${isDark ? 'text-gray-400' : 'text-gray-500'} text-center py-4">No recent chats</div>` : ''}
                                    </div>
                                </div>
                                
                                <div class="mt-6">
                                    <div class="text-xs font-semibold mb-2 ${isDark ? 'text-gray-400' : 'text-gray-500'}">SESSION INFO</div>
                                    <div class="text-xs ${isDark ? 'text-gray-400' : 'text-gray-500'}">
                                        <div>Session: ${sessionId.substring(0, 12)}...</div>
                                        <div>Messages: ${messages.length}</div>
                                        ${docId ? `<div>Document: ${docId.substring(0, 12)}...</div>` : ''}
                                    </div>
                                </div>
                            </aside>

                            <!-- Center Document Viewer -->
                            <section class="flex flex-col ${isDark ? 'bg-neutral-950' : 'bg-gray-50'}">
                                <div class="sticky top-0 z-40 h-14 px-4 flex items-center gap-3 border-b transition-colors ${isDark ? 'bg-neutral-900 border-white/10' : 'bg-white border-gray-200'}">
                                    <div class="flex items-center gap-2 text-sm">
                                        <span class="font-medium truncate max-w-[40vw] lg:max-w-none">${fileName || 'No document'}</span>
                                        <span class="${isDark ? 'text-gray-400' : 'text-gray-500'}">• ${pages}p</span>
                                    </div>
                                    <div class="ml-2 inline-flex items-center gap-1 border rounded-md overflow-hidden transition-colors ${isDark ? 'border-white/10' : ''}">
                                        <button onclick="zoom = Math.max(50, zoom - 10); localStorage.setItem('dgpt:zoom', zoom); render()" class="px-2 py-1 transition-colors ${isDark ? 'hover:bg-neutral-800' : 'hover:bg-gray-50'}">−</button>
                                        <div class="px-2 text-sm w-[58px] text-center">${zoom}%</div>
                                        <button onclick="zoom = Math.min(200, zoom + 10); localStorage.setItem('dgpt:zoom', zoom); render()" class="px-2 py-1 transition-colors ${isDark ? 'hover:bg-neutral-800' : 'hover:bg-gray-50'}">+</button>
                                    </div>
                                    <div class="ml-auto flex items-center gap-2">
                                        <label class="h-9 w-9 rounded-md border grid place-items-center cursor-pointer transition-colors ${isDark ? 'bg-neutral-900 border-white/10 hover:bg-neutral-800' : 'bg-white hover:bg-gray-50'}">📎
                                            <input type="file" class="hidden" onchange="handleFileSelect(event)" />
                                        </label>
                                        <input value="${findTerm}" oninput="findTerm = this.value" onkeydown="if(event.key==='Enter') searchInDocument()" placeholder="Search anything..." class="h-9 w-60 lg:w-72 px-3 rounded-md border text-sm transition-colors ${isDark ? 'bg-neutral-900 border-white/10' : ''}" />
                                        <button onclick="searchInDocument()" class="h-9 px-3 rounded-md border text-sm transition-colors ${isDark ? 'bg-neutral-900 hover:bg-neutral-800 border-white/10' : 'bg-white hover:bg-gray-50'}">Find</button>
                                    </div>
                                </div>

                                <div class="flex-1 overflow-auto p-6">
                                    ${status === 'PROCESSING' ? `<div class="absolute top-4 right-6 z-10 text-xs px-2 py-1 rounded border ${isDark ? 'bg-amber-900/40 text-amber-200 border-amber-200/30' : 'bg-amber-100 text-amber-800 border-amber-200/60'}">Processing…</div>` : ''}
                                    ${findNote ? `<div class="absolute top-4 left-6 z-10 text-xs px-2 py-1 rounded border ${isDark ? 'bg-sky-900/40 text-sky-200 border-sky-200/30' : 'bg-sky-100 text-sky-800 border-sky-200/60'}">${findNote}</div>` : ''}
                                    <div class="mx-auto max-w-[1100px] min-h-[900px] rounded-lg shadow-sm flex items-center justify-center relative transition-colors border ${isDark ? 'bg-neutral-900 text-gray-400 border-white/10' : 'bg-white text-gray-500'}">
                                        ${documentContent ? `
                                            <div class="w-full h-full p-4 overflow-auto">
                                                ${fileName.match(/\\.(jpg|jpeg|png|gif|bmp|webp)$/i) ?
                                                    `<img src="${documentContent}" alt="${fileName}" class="max-w-full max-h-full object-contain mx-auto" style="transform: scale(${zoom/100}); transform-origin: center;" />` :
                                                    `<div class="text-left p-4 font-mono text-sm whitespace-pre-wrap ${isDark ? 'text-gray-300' : 'text-gray-800'}" style="transform: scale(${zoom/100}); transform-origin: top left;">${documentContent.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>`
                                                }
                                            </div>
                                        ` : '<div class="pointer-events-none select-none">Drop a document to view (upload begins automatically)</div>'}
                                    </div>
                                </div>
                            </section>

                            <!-- Enhanced Chat -->
                            <aside class="border-t lg:border-t-0 lg:border-l flex flex-col min-h-[320px] transition-colors ${isDark ? 'bg-neutral-900 border-white/10' : 'bg-white'}">
                                <div class="flex-1 overflow-auto p-4 space-y-4">
                                    ${messages.length === 0 ? `<div class="text-center ${isDark ? 'text-gray-400' : 'text-gray-500'}"><p>Start chatting with GPT-4o</p><p class="text-xs mt-1">Chat history is saved automatically</p></div>` : messages.map(m => `
                                        <div class="max-w-[92%] ${m.role === 'assistant' ? '' : 'ml-auto'}">
                                            <div class="rounded-2xl px-4 py-2 text-sm border transition-colors ${m.role === 'assistant' ? (isDark ? 'bg-neutral-800 border-white/10 dark:bg-neutral-800 dark:border-white/10' : 'bg-gray-50') : m.role === 'system' ? (isDark ? 'bg-blue-900/20 border-blue-500/30' : 'bg-blue-50 border-blue-200') : 'bg-emerald-600 text-white border-emerald-600'}">
                                                ${m.text || '<span class="opacity-60">…</span>'}
                                            </div>
                                            <div class="mt-1 flex items-center gap-3 text-[11px] ${isDark ? 'text-gray-400' : 'text-gray-500'}">
                                                <button onclick="navigator.clipboard?.writeText('${m.text}')" class="hover:underline">Copy</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>

                                <div class="border-t p-3 transition-colors ${isDark ? 'border-white/10' : ''}">
                                    <div class="flex flex-wrap gap-2">
                                        ${suggestions.map(s => `
                                            <button onclick="chat('${s}')" class="px-3 py-1.5 rounded-full border text-xs transition-colors ${isDark ? 'hover:bg-neutral-800 border-white/10' : 'hover:bg-gray-50'}">${s}</button>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="border-t p-3 transition-colors ${isDark ? 'border-white/10' : ''}">
                                    <div class="flex items-center gap-2">
                                        <label class="h-10 w-10 rounded-full border grid place-items-center cursor-pointer transition-colors ${isDark ? 'bg-neutral-900 border-white/10' : 'bg-white'}">📎
                                            <input type="file" class="hidden" onchange="handleFileSelect(event)" />
                                        </label>
                                        <input id="chatInput" value="${draft}" oninput="updateDraft(event)" onkeydown="handleKeyDown(event)" placeholder="Ask anything…" class="flex-1 h-10 px-3 rounded-full border transition-colors ${isDark ? 'bg-neutral-900 border-white/10' : ''}" />
                                        <button onclick="handleSendMessage()" class="h-10 w-10 rounded-full bg-emerald-600 text-white">➤</button>
                                    </div>
                                    <div class="mt-2 text-[11px] ${isDark ? 'text-gray-400' : 'text-gray-500'}">
                                        Drop a file anywhere to upload • Status: <b>${status}</b> • Messages saved: ${messages.length}
                                        ${docId ? ` • Document loaded` : ' • General AI mode'}
                                    </div>
                                </div>
                            </aside>
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize
        updateTheme();
        render();

        // Make functions global
        window.setTheme = setTheme;
        window.handleFileSelect = handleFileSelect;
        window.handleDrop = handleDrop;
        window.handleSendMessage = handleSendMessage;
        window.handleKeyDown = handleKeyDown;
        window.updateDraft = updateDraft;
        window.chat = chat;
        window.newChat = newChat;
        window.searchInDocument = searchInDocument;
        window.saveState = saveState;
        window.render = render;
        window.loadChat = loadChat;
    </script>
</body>
</html>